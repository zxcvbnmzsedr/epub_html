
        <html lang="en">
        <head>
        <meta charset="UTF-8"/>
        </head>
        <body>
        <div><div class="markdown-body">
    <h1>&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#36393;&#22353;&#23454;&#36341;</h1>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="style/style.css" type="text/css">

<div class="markdown-body">
    <p>
 &#35299;&#32806;&#19982;&#21010;&#28165;&#19994;&#21153;&#36793;&#30028;&#19968;&#30452;&#26159;DDD&#30340;&#26680;&#24515;&#29702;&#24565;&#12290;&#20026;&#20102;&#35299;&#32806;&#19994;&#21153;&#27969;&#31243;&#20013;&#19982;&#20027;&#27969;&#31243;&#38750;&#24378;&#30456;&#20851;&#30340;&#22806;&#37096;&#39046;&#22495;&#36923;&#36753;&#35843;&#29992;&#65292;DDD&#24341;&#20837;&#20102;
 <strong>
  &#20107;&#20214;&#39537;&#21160;&#27169;&#22411;
 </strong>
 &#26469;&#20316;&#20026;&#19981;&#21516;&#39046;&#22495;&#38388;&#30340;&#36890;&#20449;&#30340;&#19968;&#31181;&#26041;&#24335;&#12290;
</p>
<p>
 &#22240;&#27492;&#65292;&#26412;&#25991;&#23558;&#23545;DDD&#20013;&#20351;&#29992;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#24314;&#31435;&#19982;&#36393;&#22353;&#20570;&#19968;&#20010;&#31995;&#32479;&#24615;&#30340;&#20171;&#32461;&#12290;
</p>
<h2>
 &#19968;&#12289;&#20160;&#20040;&#26159;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;
</h2>
<p>
 &#19968;&#20010;&#26694;&#26550;&#65292;&#19968;&#38376;&#25216;&#26415;&#65292;&#20351;&#29992;&#20043;&#21069;&#39318;&#20808;&#35201;&#28165;&#26970;&#65292;&#20160;&#20040;&#26679;&#30340;&#19994;&#21153;&#22330;&#26223;&#38656;&#35201;&#20351;&#29992;&#36825;&#20010;&#19996;&#35199;&#65292;&#20026;&#20160;&#20040;&#35201;&#29992;&#27604;&#22914;&#20309;&#20351;&#29992;&#26356;&#21152;&#37325;&#35201;&#12290;
</p>
<p>
 &#20551;&#35774;&#25105;&#20204;&#29616;&#22312;&#26377;&#19968;&#20010;&#27604;&#36739;&#24222;&#22823;&#30340;&#21333;&#20307;&#26381;&#21153;&#30340;&#35746;&#21333;&#31995;&#32479;&#65292;&#26377;&#19979;&#38754;&#19968;&#20010;&#19994;&#21153;&#38656;&#27714;&#65306;
 <code>
  &#21019;&#24314;&#35746;&#21333;&#21518;&#65292;&#38656;&#35201;&#19979;&#21457;&#20248;&#24800;&#21048;&#65292;&#32473;&#29992;&#25143;&#22686;&#38271;&#31215;&#20998;
 </code>
 &#12290;
</p>
<p>
 &#20808;&#30475;&#19968;&#19979;&#65292;&#22823;&#22810;&#25968;&#21516;&#23398;&#22312;&#21333;&#20307;&#26381;&#21153;&#20869;&#30340;&#20889;&#27861;&#65292;&#36825;&#37324;&#20551;&#35774;&#35746;&#21333;&#12289;&#20248;&#24800;&#21048;&#12289;&#31215;&#20998;&#22343;&#20026;&#29420;&#31435;service&#12290;
</p>
<pre><code>//&#22312;orderService&#20869;&#37096;&#23450;&#20041;&#19968;&#20010;&#25918;&#19979;
@Transactional(rollbackFor = Exception.class)
public void createOrder(CreateOrderCommand command){
  //&#21019;&#24314;&#35746;&#21333;
  Long orderId = this.doCreate(command);
  //&#21457;&#36865;&#20248;&#24800;&#21048;
  couponService.sendCoupon(command,orderId);
  //&#22686;&#38271;&#31215;&#20998;
  integralService.increase(command.getUserId,orderId);
}
</code></pre>
<p>
 <img alt="image.png" src="EPUB/1b7ab46c-17d9-11ed-92a9-acde48001122">
</p>
<p>
 &#19978;&#38754;&#36825;&#26679;&#30340;&#20195;&#30721;&#22312;&#32447;&#19978;&#36816;&#34892;&#20250;&#19981;&#20250;&#26377;&#38382;&#39064;&#65311;&#19981;&#20250;&#65281;
</p>
<p>
 <strong>
  &#37027;&#20026;&#20160;&#20040;&#35201;&#25913;&#21602;&#65311;
 </strong>
</p>
<p>
 &#21407;&#22240;&#26159;&#65292;&#19994;&#21153;&#38656;&#27714;&#22312;&#19981;&#26029;&#36845;&#20195;&#30340;&#36807;&#31243;&#20013;&#65292;&#19982;&#24403;&#21069;&#19994;&#21153;&#38750;&#24378;&#30456;&#20851;&#30340;&#20027;&#27969;&#31243;&#19994;&#21153;&#65292;&#38543;&#26102;&#37117;&#26377;&#21487;&#33021;&#34987;&#26367;&#25442;&#25110;&#32773;&#21319;&#32423;&#12290;
</p>
<p>
 &#21452;11&#22823;&#20419;&#65292;&#29992;&#25143;&#19979;&#21333;&#30340;&#21516;&#26102;&#38656;&#35201;&#32473;&#27599;&#20010;&#29992;&#25143;&#36192;&#36865;&#20960;&#20010;&#23567;&#31036;&#21697;&#65292;&#37027;&#20320;&#21448;&#35201;&#20889;&#19968;&#20010;&#20989;&#25968;&#20102;&#65292;&#25340;&#25509;&#22312;&#20027;&#26041;&#27861;&#30340;&#21518;&#38754;&#12290;&#21452;11&#32467;&#26463;&#65292;&#36825;&#27573;&#35201;&#20195;&#30721;&#35201;&#34987;&#27880;&#37322;&#12290;&#21448;&#19968;&#24180;&#22823;&#20419;&#65292;&#36192;&#36865;&#30340;&#19996;&#35199;&#25913;&#21464;&#65292;&#20195;&#30721;&#21448;&#35201;&#21152;&#22238;&#26469;&#12290;&#12290;&#12290;&#12290;
</p>
<p>
 &#26469;&#26469;&#22238;&#22238;&#30340;&#65292;&#35746;&#21333;&#36923;&#36753;&#21464;&#24471;&#21448;&#33261;&#21448;&#38271;&#65292;&#27880;&#37322;&#30340;&#20195;&#30721;&#36923;&#36753;&#24456;&#22810;&#36824;&#19981;&#22909;&#38405;&#35835;&#19982;&#29702;&#35299;&#12290;
</p>
<p>
 &#22914;&#26524;&#29992;&#20102;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#65292;&#37027;&#20040;&#24403;&#31532;&#19968;&#27493;&#21019;&#24314;&#35746;&#21333;&#25104;&#21151;&#20043;&#21518;&#65292;&#21457;&#24067;&#19968;&#20010;&#21019;&#24314;&#35746;&#21333;&#25104;&#21151;&#30340;&#39046;&#22495;&#20107;&#20214;&#12290;&#20248;&#24800;&#21048;&#26381;&#21153;&#12289;&#31215;&#20998;&#26381;&#21153;&#12289;&#36192;&#36865;&#31036;&#21697;&#31561;&#31561;&#30417;&#21548;&#36825;&#20010;&#20107;&#20214;&#65292;&#23545;&#30417;&#21548;&#21040;&#30340;&#20107;&#20214;&#20570;&#20986;&#30456;&#24212;&#30340;&#22788;&#29702;&#12290;
</p>
<p>
 <strong>
  &#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#20195;&#30721;
 </strong>
</p>
<pre><code>//&#22312;orderService&#20869;&#37096;&#23450;&#20041;&#19968;&#20010;&#25918;&#19979;
@Transactional(rollbackFor = Exception.class)
public void createOrder(CreateOrderCommand command){
  //&#21019;&#24314;&#35746;&#21333;
  Long orderId = this.doCreate(command);
  publish(orderCreateEvent);
}
&#8203;
//&#21508;&#20010;&#38656;&#35201;&#30417;&#21548;&#30340;&#26381;&#21153;
public void handlerEvent(OrderCreateEvent event){
//&#36923;&#36753;&#22788;&#29702;
}
</code></pre>
<p>
 <img alt="image.png" src="EPUB/1bb3a6d2-17d9-11ed-92a9-acde48001122">
</p>
<p>
 &#20195;&#30721;&#35299;&#32806;&#65292;&#39640;&#24230;&#31526;&#21512;&#24320;&#38381;&#21407;&#21017;&#12290;
</p>
<h2>
 &#20108;&#12289;&#22914;&#20309;&#23454;&#29616;&#20107;&#20214;&#39537;&#21160;
</h2>
<p>
 Spring&#22312;4.2&#20043;&#21518;&#25552;&#20379;&#20102;
 <code>
  @EventListener
 </code>
 &#27880;&#35299;&#65292;&#35753;&#25105;&#20204;&#26356;&#20415;&#25463;&#22320;&#20351;&#29992;&#20107;&#20214;&#30417;&#21548;&#26426;&#21046;&#12290;
</p>
<p>
 &#20102;&#35299;&#36807;Spring&#21551;&#21160;&#27969;&#31243;&#30340;&#21516;&#23398;&#37117;&#30693;&#36947;&#65292;Spring&#23481;&#22120;&#21047;&#26032;&#30340;&#26102;&#20505;&#20250;&#21457;&#24067;
 <code>
  ContextRefreshedEvent
 </code>
 &#20107;&#20214;&#65292;&#22914;&#26524;&#25105;&#20204;&#38656;&#35201;&#30417;&#21548;&#27492;&#20107;&#20214;&#65292;&#30452;&#25509;&#20889;&#20010;&#30417;&#21548;&#31867;&#21363;&#21487;&#12290;
</p>
<pre><code>@Slf4j
@Component
public class ApplicationRefreshedEventListener implements &#160; ApplicationListener&lt;ContextRefreshedEvent&gt; {
&#8203;
 &#160;  @Override
 &#160;  public void onApplicationEvent(ContextRefreshedEvent event) {
 &#160; &#160; &#160;  //&#35299;&#26512;&#36825;&#20010;&#20107;&#20214;&#65292;&#20570;&#20320;&#24819;&#20570;&#30340;&#20107;&#65292;&#22079;&#22079;
 &#160;  }
}
</code></pre>
<p>
 &#22312;DDD&#20013;&#65292;&#25105;&#20204;&#21516;&#26679;&#33021;&#22815;&#21442;&#32771;Spring&#30340;&#20107;&#20214;&#30417;&#21548;&#26041;&#24335;&#26469;&#23454;&#29616;&#25105;&#20204;&#30340;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#12290;
</p>
<h3>
 1. &#23450;&#20041;&#39046;&#22495;&#20107;&#20214;
</h3>
<p>
 &#23450;&#20041;&#39046;&#22495;&#20107;&#20214;&#30340;&#26041;&#24335;&#20998;&#20026;&#20004;&#27493;&#12290;
</p>
<p>
 &#31532;&#19968;&#27493;&#65292;&#23450;&#20041;&#39046;&#22495;&#20107;&#20214;&#22522;&#31867;&#12290;&#23427;&#26159;&#25152;&#26377;&#39046;&#22495;&#20107;&#20214;&#30340;&#29238;&#31867;&#65292;&#23450;&#20041;&#20102;&#39046;&#22495;&#20107;&#20214;&#30340;&#36890;&#29992;&#23383;&#27573;&#65292;&#20195;&#30721;&#22914;&#19979;&#25152;&#31034;&#65306;
</p>
<pre><code>/**
 * &#39046;&#22495;&#20107;&#20214;&#22522;&#31867;
 *
 * @author baiyan
 */
@Getter
@Setter
@NoArgsConstructor
public abstract class BaseDomainEvent&lt;T&gt; implements Serializable {
&#8203;
 &#160;  private static final long serialVersionUID = 1465328245048581896L;
&#8203;
 &#160;  /**
 &#160; &#160; * &#39046;&#22495;&#20107;&#20214;id
 &#160; &#160; */
 &#160;  private String domainId;
&#8203;
 &#160;  /**
 &#160; &#160; * &#21457;&#29983;&#26102;&#38388;
 &#160; &#160; */
 &#160;  private LocalDateTime occurredOn;
&#8203;
 &#160;  /**
 &#160; &#160; * &#39046;&#22495;&#20107;&#20214;&#25968;&#25454;
 &#160; &#160; */
 &#160;  private T data;
&#8203;
 &#160;  public BaseDomainEvent(String domainId, T data) {
 &#160; &#160; &#160;  this.domainId = domainId;
 &#160; &#160; &#160;  this.data = data;
 &#160; &#160; &#160;  this.occurredOn = LocalDateTime.now();
 &#160;  }
&#8203;
}
</code></pre>
<p>
 &#31532;&#20108;&#27493;&#65292;&#23450;&#20041;&#20855;&#20307;&#30340;&#19994;&#21153;&#39046;&#22495;&#20107;&#20214;&#65292;&#27604;&#22914;&#29992;&#25143;&#26032;&#22686;&#20107;&#20214;&#65292;&#20415;&#20110;&#29305;&#23450;&#30340;&#20107;&#20214;&#31867;&#22411;&#34987;&#29305;&#23450;&#20107;&#20214;&#22788;&#29702;&#31867;&#30417;&#21548;&#21040;&#24182;&#22788;&#29702;&#12290;&#20195;&#30721;&#22914;&#19979;&#65306;
</p>
<pre><code>/**
 * &#29992;&#25143;&#26032;&#22686;&#39046;&#22495;&#20107;&#20214;
 *
 * @author baiyan
 */
public class UserCreateEvent extends BaseDomainEvent&lt;User&gt; {
&#8203;
 &#160;  public UserCreateEvent(User user) {
 &#160; &#160; &#160;  super(//&#20165;&#20570;&#28436;&#31034;&#65292;&#39046;&#22495;&#20107;&#20214;id&#20026;&#38450;&#27490;&#37325;&#22797;&#24314;&#35758;&#33258;&#23450;&#20041;&#38634;&#33457;id
 &#160; &#160; &#160; &#160; &#160; &#160; &#160;  UUID.fastUUID().toString(),
 &#160; &#160; &#160; &#160; &#160; &#160; &#160;  user
 &#160; &#160; &#160;  );
 &#160;  }
&#8203;
}
</code></pre>
<h3>
 2. &#23450;&#20041;&#32479;&#19968;&#30340;&#19994;&#21153;&#24635;&#32447;&#21457;&#36865;&#20107;&#20214;
</h3>
<p>
 &#25105;&#20204;&#21487;&#20197;&#23450;&#20041;&#19968;&#20010;&#32479;&#19968;&#30340;&#19994;&#21153;&#20107;&#20214;&#21457;&#36865;&#20837;&#21475;&#65292;&#26041;&#20415;&#25105;&#20204;&#23545;&#20110;&#20107;&#20214;&#21457;&#36865;&#21069;&#21518;&#20570;&#19968;&#20123;&#26085;&#24535;&#35760;&#24405;&#31561;&#39069;&#22806;&#25805;&#20316;&#12290;
</p>
<p>
 &#25509;&#21475;&#20195;&#30721;&#22914;&#19979;&#65306;
</p>
<pre><code>/**
 * &#39046;&#22495;&#20107;&#20214;&#21457;&#24067;&#25509;&#21475;
 *
 * @author baiyan
 */
public interface DomainEventPublisher {
&#8203;
 &#160;  /**
 &#160; &#160; * &#21457;&#24067;&#20107;&#20214;
 &#160; &#160; *
 &#160; &#160; * @param event event
 &#160; &#160; */
 &#160;  &lt;EVENT extends BaseDomainEvent&gt; void publish(EVENT event);
}
</code></pre>
<p>
 &#25509;&#21475;&#30340;&#23454;&#29616;&#31867;&#22312;&#21457;&#36865;&#39046;&#22495;&#20107;&#20214;&#21069;&#35760;&#24405;&#26085;&#24535;&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;
</p>
<pre><code>/**
 * &#39046;&#22495;&#20107;&#20214;&#21457;&#24067;&#23454;&#29616;&#31867;
 *
 * @author baiyan
 */
@Component
@Slf4j
public class DomainEventPublisherImpl implements DomainEventPublisher {
&#8203;
 &#160;  @Autowired
 &#160;  private ApplicationEventPublisher applicationEventPublisher;
&#8203;
 &#160;  @Override
 &#160;  public &lt;EVENT extends BaseDomainEvent&gt; void publish(EVENT event) {
 &#160; &#160; &#160;  log.info("&#21457;&#24067;&#20107;&#20214;,evnt:{}", GsonUtil.gsonToString(event));
 &#160; &#160; &#160;  applicationEventPublisher.publishEvent(event);
 &#160;  }
&#8203;
&#8203;
}
</code></pre>
<p>
 &#24403;&#28982;&#36825;&#37324;&#21487;&#20197;&#33258;&#24049;&#26681;&#25454;&#19994;&#21153;&#38656;&#27714;&#33258;&#34892;&#25193;&#23637;&#39046;&#22495;&#20107;&#20214;&#21457;&#36865;&#21069;&#21518;&#30340;&#19994;&#21153;&#36923;&#36753;&#65292;&#36825;&#37324;&#22475;&#20010;&#23567;&#20239;&#31508;&#65292;&#25105;&#20204;&#22312; CQRS &#31687;&#36824;&#20250;&#23545;&#27492;&#20570;&#20108;&#27425;&#25193;&#23637;&#21734;~
</p>
<h3>
 3. &#24212;&#29992;&#26381;&#21153;&#21457;&#36865;&#39046;&#22495;&#20107;&#20214;
</h3>
<pre><code>@Slf4j
@Service
public class UserApplicationServiceImpl implements UserApplicationService {
&#8203;
 &#160;  @Autowired
 &#160;  DomainEventPublisher domainEventPublisher;
&#8203;
 &#160;  @Override
 &#160;  @Transactional(rollbackFor = Exception.class)
 &#160;  public void create(CreateUserCommand command){
 &#160; &#160; &#160; 
 &#160; &#160; &#160; //&#30465;&#30053;&#19981;&#24517;&#35201;&#30340;&#19994;&#21153;&#36923;&#36753;&#20195;&#30721;&#12290;&#12290;&#12290;
 &#160; &#160; &#160; &#160;
 &#160; &#160; &#160;  //&#21457;&#24067;&#29992;&#25143;&#26032;&#24314;&#30340;&#39046;&#22495;&#20107;&#20214;
 &#160; &#160; &#160;  domainEventPublisher.publish(new UserCreateEvent(user));
 &#160;  }
}
</code></pre>
<p>
 &#22914;&#19978;&#20195;&#30721;&#65292;&#29992;&#25143;&#24212;&#29992;&#26381;&#21153;&#22312;&#22788;&#29702;&#23436;&#24403;&#21069;&#19994;&#21153;&#21518;&#65292;&#36890;&#36807;&#20107;&#20214;&#21457;&#36865;&#24635;&#32447;
 <code>
  DomainEventPublisher
 </code>
 &#21457;&#36865;&#29992;&#25143;&#26032;&#22686;&#39046;&#22495;&#20107;&#20214;&#36890;&#30693;&#20854;&#20182;&#39046;&#22495;&#27169;&#22411;&#12290;
</p>
<h3>
 4. &#19994;&#21153;&#30417;&#21548;&#31867;&#22788;&#29702;&#20107;&#20214;
</h3>
<pre><code>@Component
@Slf4j
public class UserEventHandler {
&#8203;
 &#160;  @EventListener
 &#160;  public void handleEvent(UserCreateEvent event) {
 &#160; &#160; &#160; //&#29992;&#25143;&#21024;&#38500;&#21518;&#65292;&#21518;&#32493;&#25191;&#34892;&#24378;&#30456;&#20851;&#30340;&#38142;&#24335;&#35843;&#29992;&#36923;&#36753;
 &#160;  }
&#8203;
}
</code></pre>
<p>
 &#23545;&#24212;&#30340;&#19994;&#21153;&#22788;&#29702;&#31867;&#30417;&#21548;&#29992;&#25143;&#26032;&#22686;&#26102;&#38388;&#65292;&#36827;&#34892;&#21518;&#32493;&#22788;&#29702;&#12290;
</p>
<p>
 &#33267;&#27492;&#65292;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#22312;DDD&#20013;&#23601;&#25645;&#24314;&#23436;&#25104;&#20102;&#65292;&#26159;&#19981;&#26159;&#29305;&#21035;&#23481;&#26131;&#29702;&#35299;&#36824;&#22909;&#19978;&#25163;&#65311;
</p>
<h2>
 &#19977;&#12289;&#20107;&#20214;&#39537;&#21160;&#20043;&#20107;&#21153;&#31649;&#29702;
</h2>
<p>
 &#21040;&#36825;&#37324;&#20320;&#26377;&#27809;&#26377;&#19968;&#28857;&#23567;&#30097;&#38382;&#21602;&#65311;
</p>
<p>
 <strong>
  &#22914;&#26524;&#20351;&#29992;&#20102;&#20107;&#20214;&#20043;&#21518;&#65292;&#37027;&#20107;&#20214;&#22788;&#29702;&#36923;&#36753;&#30340;&#25104;&#21151;&#19982;&#21542;&#20250;&#24433;&#21709;&#21040;&#24212;&#29992;&#26381;&#21153;&#20869;&#30340;&#20027;&#36923;&#36753;&#21602;&#65311;
 </strong>
</p>
<p>
 <strong>
  &#20107;&#21153;&#36824;&#26159;&#19968;&#20307;&#30340;&#21527;&#65311;
 </strong>
</p>
<p>
 &#19979;&#38754;&#36825;&#20010;&#19994;&#21153;&#22330;&#26223;&#25105;&#30456;&#20449;&#36824;&#26159;&#24456;&#24120;&#35265;&#30340;&#65306;&#25105;&#20204;&#22312;&#23436;&#25104;&#26576;&#20123;&#19994;&#21153;&#36923;&#36753;&#22788;&#29702;&#21518;&#65292;&#35760;&#24405;&#25805;&#20316;&#35760;&#24405;&#12290;
</p>
<p>
 &#20351;&#29992;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#30340;&#35805;&#23601;&#21464;&#25104;&#20102;&#25105;&#20204;&#22312;&#24212;&#29992;&#26381;&#21153;&#32534;&#25490;&#23436;&#19994;&#21153;&#36923;&#36753;&#20043;&#21518;&#65292;&#21457;&#36865;&#19968;&#20010;&#24403;&#21069;&#19994;&#21153;&#30340;&#39046;&#22495;&#20107;&#20214;&#65292;&#21518;&#32493;&#25805;&#20316;&#35760;&#24405;&#30417;&#21548;&#31867;&#23558;&#20107;&#20214;&#20869;&#23481;&#23384;&#20648;&#33267;ES&#12290;&#20294;&#26159;&#26377;&#30340;&#26102;&#20505;&#21487;&#33021;&#22240;&#20026;&#32593;&#32476;&#27874;&#21160;&#21407;&#22240;&#65292;ES&#38598;&#32676;&#21709;&#24212;&#36229;&#26102;&#20102;&#65292;&#25805;&#20316;&#35760;&#24405;&#20837;&#24211;&#22833;&#36133;&#65292;&#21363;&#30417;&#21548;&#31867;&#25243;&#20986;&#24322;&#24120;&#12290;
</p>
<p>
 &#36825;&#26102;&#20174;&#19994;&#21153;&#36923;&#36753;&#19978;&#26469;&#30475;&#65292;&#25805;&#20316;&#35760;&#24405;&#30340;&#20837;&#24211;&#22833;&#36133;&#65292;&#19981;&#24212;&#35813;&#24433;&#21709;&#21040;&#20027;&#27969;&#31243;&#30340;&#36923;&#36753;&#25191;&#34892;&#65292;&#38656;&#35201;&#20107;&#21153;&#29420;&#31435;&#12290;&#20134;&#25110;&#26159;&#65292;&#22914;&#26524;&#20027;&#27969;&#31243;&#25191;&#34892;&#20986;&#38169;&#20102;&#65292;&#37027;&#20040;&#25105;&#20204;&#38656;&#35201;&#35302;&#21457;&#19968;&#20010;&#20107;&#20214;&#65292;&#21457;&#36865;&#38025;&#38025;&#28040;&#24687;&#21040;&#32676;&#37324;&#36827;&#34892;&#32447;&#19978;&#19994;&#21153;&#30417;&#25511;&#65292;&#38656;&#35201;&#22312;&#20027;&#26041;&#27861;&#36923;&#36753;&#20013;&#25243;&#20986;&#24322;&#24120;&#20877;&#35843;&#29992;&#27492;&#20107;&#20214;&#12290;
 <strong>
  &#32780;&#27492;&#26102;&#22914;&#26524;&#25105;&#20204;&#20351;&#29992;&#30340;&#26159;
  <code>
   @EventListener
  </code>
  &#65292;&#23427;&#30340;&#20107;&#21153;&#36923;&#36753;&#26159;&#38543;&#30528;&#20107;&#20214;&#21457;&#36865;&#26041;&#30340;&#12290;
 </strong>
 &#20063;&#23601;&#26159;&#35828;&#22914;&#26524;&#20027;&#27969;&#31243;&#25253;&#38169;&#65292;&#21518;&#32493;&#30340;&#21578;&#35686;&#36890;&#30693;&#23558;&#26080;&#27861;&#25509;&#21463;&#65292;&#22914;&#26524;&#20107;&#20214;&#30417;&#21548;&#22788;&#29702;&#25253;&#38169;&#65292;&#20027;&#27969;&#31243;&#25968;&#25454;&#23558;&#20837;&#24211;&#22833;&#36133;&#12290;
</p>
<p>
 &#20026;&#20102;&#35299;&#20915;&#19978;&#36848;&#38382;&#39064;&#65292;Spring&#20026;&#25105;&#20204;&#25552;&#20379;&#20102;&#20004;&#31181;&#26041;&#24335;&#65306;
</p>
<ol>
 <li>
  <code>
   @TransactionalEventListener
  </code>
  &#27880;&#35299;&#12290;
 </li>
 <li>
  &#20107;&#21153;&#21516;&#27493;&#31649;&#29702;&#22120;
  <code>
   TransactionSynchronizationManager
  </code>
  &#12290;
 </li>
</ol>
<p>
 <strong>
  &#26412;&#25991;&#38024;&#23545;
  <code>
   @TransactionalEventListener
  </code>
  &#36827;&#34892;&#19968;&#19979;&#35299;&#26512;&#12290;
 </strong>
</p>
<p>
 Spring&#22312;4.2&#29256;&#26412;&#20043;&#21518;&#25903;&#25345;&#20102;
 <code>
  @TransactionalEventListener
 </code>
 &#65292;&#23427;&#33021;&#22815;&#23454;&#29616;&#22312;&#25511;&#21046;&#20107;&#21153;&#30340;&#21516;&#26102;&#65292;&#23436;&#25104;&#23545;&#20107;&#20214;&#30340;&#22788;&#29702;&#12290;&#25105;&#20204;&#21487;&#20197;&#20174;&#21629;&#21517;&#19978;&#30452;&#25509;&#30475;&#20986;&#65292;&#23427;&#23601;&#26159;&#20010;
 <code>
  EventListener
 </code>
 &#12290;
</p>
<p>
 &#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#36825;&#20010;&#27880;&#35299;&#30340;&#35299;&#26512;&#65306;
</p>
<pre><code>//&#34987;@EventListener&#26631;&#27880;&#65292;&#34920;&#31034;&#23427;&#33021;&#22815;&#30417;&#21548;&#20107;&#20214;
@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@EventListener
public @interface TransactionalEventListener {
&#8203;
  //&#34920;&#31034;&#24403;&#21069;&#20107;&#20214;&#36319;&#38543;&#28040;&#24687;&#21457;&#36865;&#26041;&#20107;&#21153;&#30340;&#20986;&#21457;&#26102;&#26426;&#65292;&#40664;&#35748;&#20026;&#28040;&#24687;&#21457;&#36865;&#26041;&#20107;&#21153;&#25552;&#20132;&#20043;&#21518;&#25165;&#36827;&#34892;&#22788;&#29702;&#12290;
 &#160; TransactionPhase phase() default TransactionPhase.AFTER_COMMIT;
&#8203;
 &#160; //true&#26102;&#19981;&#35770;&#21457;&#36865;&#26041;&#26159;&#21542;&#23384;&#22312;&#20107;&#21153;&#22343;&#20986;&#21457;&#24403;&#21069;&#20107;&#20214;&#22788;&#29702;&#36923;&#36753;
 &#160; boolean fallbackExecution() default false;
&#8203;
 &#160; //&#30417;&#21548;&#30340;&#20107;&#20214;&#20855;&#20307;&#31867;&#22411;&#65292;&#36824;&#26159;&#24314;&#35758;&#25351;&#23450;&#19968;&#19979;&#65292;&#36991;&#20813;&#30417;&#21548;&#21040;&#23376;&#31867;&#30340;&#19968;&#20123;&#24773;&#20917;&#20986;&#29616;
 &#160; @AliasFor(annotation = EventListener.class, attribute = "classes")
 &#160; Class&lt;?&gt;[] value() default {};
&#8203;
 &#160; //&#25351;&#21521;@EventListener&#23545;&#24212;&#30340;&#20540;
 &#160; @AliasFor(annotation = EventListener.class, attribute = "classes")
 &#160; Class&lt;?&gt;[] classes() default {};
&#8203;
 &#160; //&#25351;&#21521;@EventListener&#23545;&#24212;&#30340;&#20540;
 &#160; String condition() default "";
&#8203;
}
</code></pre>
<pre><code>public enum TransactionPhase {
 &#160; // &#25351;&#23450;&#30446;&#26631;&#26041;&#27861;&#22312;&#20107;&#21153;commit&#20043;&#21069;&#25191;&#34892;
 &#160; BEFORE_COMMIT,
&#8203;
 &#160; // &#25351;&#23450;&#30446;&#26631;&#26041;&#27861;&#22312;&#20107;&#21153;commit&#20043;&#21518;&#25191;&#34892;
 &#160;  AFTER_COMMIT,
&#8203;
 &#160;  // &#25351;&#23450;&#30446;&#26631;&#26041;&#27861;&#22312;&#20107;&#21153;rollback&#20043;&#21518;&#25191;&#34892;
 &#160;  AFTER_ROLLBACK,
&#8203;
 &#160; // &#25351;&#23450;&#30446;&#26631;&#26041;&#27861;&#22312;&#20107;&#21153;&#23436;&#25104;&#26102;&#25191;&#34892;&#65292;&#36825;&#37324;&#30340;&#23436;&#25104;&#26159;&#25351;&#26080;&#35770;&#20107;&#21153;&#26159;&#25104;&#21151;&#25552;&#20132;&#36824;&#26159;&#20107;&#21153;&#22238;&#28378;&#20102;
 &#160; AFTER_COMPLETION
  }
</code></pre>
<p>
 &#25105;&#20204;&#30693;&#36947;&#65292;Spring&#30340;&#20107;&#20214;&#30417;&#21548;&#26426;&#21046;&#22312;&#40664;&#35748;&#24773;&#20917;&#19979;&#24182;&#19981;&#26159;&#35299;&#32806;&#30340;&#65292;&#32780;&#26159;&#21516;&#27493;&#22320;&#26469;&#23558;&#20195;&#30721;&#36827;&#34892;&#35299;&#32806;&#12290;&#32780;
 <code>
  @TransactionEventListener
 </code>
 &#22312;&#36825;&#31181;&#26041;&#24335;&#30340;&#22522;&#30784;&#20043;&#19978;&#65292;&#21152;&#20837;&#20102;&#22238;&#35843;&#30340;&#26041;&#24335;&#65292;&#36825;&#26679;&#23601;&#33021;&#22815;&#22312;&#20107;&#21153;&#36827;&#34892; Commited&#12289;Rollback &#31561;&#26102;&#20505;&#25165;&#21435;&#36827;&#34892;Event&#30340;&#22788;&#29702;&#65292;&#26469;&#36798;&#21040;&#20107;&#21153;&#21516;&#27493;&#30340;&#30446;&#30340;&#12290;
</p>
<h2>
 &#22235;&#12289;&#23454;&#36341;&#21450;&#36393;&#22353;
</h2>
<p>
 &#22312;&#20102;&#35299;&#23436;&#27010;&#24565;&#20043;&#21518;&#65292;&#23601;&#35201;&#23454;&#38469;&#24212;&#29992;&#23545;&#27604;&#19968;&#19979;
 <code>
  @TransactionEventListener
 </code>
 &#19982;
 <code>
  @EventListener
 </code>
 &#23427;&#20204;&#30340;&#21306;&#21035;&#12290;
</p>
<p>
 <strong>
  &#25105;&#20204;&#20551;&#35774;&#26377;&#36825;&#26679;&#19968;&#20010;&#19994;&#21153;&#38656;&#27714;&#65306;&#26032;&#22686;&#29992;&#25143;&#65292;&#20851;&#32852;&#35282;&#33394;&#65292;&#22686;&#21152;&#20851;&#32852;&#35282;&#33394;&#36171;&#26435;&#25805;&#20316;&#35760;&#24405;&#12290;
 </strong>
</p>
<p>
 &#38024;&#23545;&#36825;&#20010;&#19994;&#21153;&#38656;&#27714;&#65292;&#25105;&#24819;&#35201;&#23454;&#29616;&#22914;&#19979;&#20004;&#31181;&#20107;&#21153;&#31649;&#29702;&#26041;&#24335;&#12290;
</p>
<ul>
 <li>
  <code>
   &#32479;&#19968;&#20107;&#21153;
  </code>
  &#65306;&#19978;&#36848;&#19977;&#20010;&#25805;&#20316;&#20107;&#21153;&#19968;&#20307;&#65292;&#26080;&#35770;&#21738;&#20010;&#21457;&#29983;&#24322;&#24120;&#65292;&#25968;&#25454;&#32479;&#19968;&#22238;&#28378;&#12290;
 </li>
 <li>
  <code>
   &#29420;&#31435;&#20107;&#21153;
  </code>
  &#65306;&#19978;&#36848;&#19977;&#20010;&#25805;&#20316;&#20107;&#21153;&#29420;&#31435;&#65292;&#20107;&#20214;&#19968;&#26086;&#21457;&#24067;&#65292;&#21518;&#32493;&#21457;&#29983;&#20219;&#24847;&#24322;&#24120;&#22343;&#19981;&#24433;&#21709;&#12290;
 </li>
</ul>
<p>
 &#25105;&#20204;&#26469;&#30475;&#30475;&#22914;&#20309;&#20351;&#29992;
 <code>
  @TransactionEventListener
 </code>
 &#19982;
 <code>
  @EventListener
 </code>
 &#26469;&#23454;&#29616;&#36825;&#31181;&#31649;&#29702;&#26041;&#24335;&#65292;&#20351;&#29992;&#36807;&#31243;&#20013;&#21448;&#26377;&#20160;&#20040;&#27880;&#24847;&#28857;&#19982;&#22353;&#28857;&#12290;
</p>
<h3>
 1. &#32479;&#19968;&#20107;&#21153;
</h3>
<p>
 &#30001;&#20110;&#20195;&#30721;&#27604;&#36739;&#31616;&#21333;&#65292;&#30452;&#25509;&#25353;&#29031;&#27493;&#39588;&#32473;&#20986;&#28304;&#30721;&#22914;&#19979;&#65292;&#20027;&#35201;&#20998;&#20026;&#20197;&#19979;&#19977;&#27493;&#12290;
</p>
<p>
 <strong>
  &#65288;1&#65289;&#29992;&#25143;&#26032;&#22686;
 </strong>
</p>
<pre><code>@Service
@Slf4j
public class UserApplicationServiceImpl implements UserApplicationService {
&#8203;
 &#160;  @Autowired
 &#160;  DomainEventPublisher domainEventPublisher;
&#8203;
 &#160;  @Transactional(rollbackFor = Exception.class)
 &#160;  public void createUser(){
 &#160; &#160; &#160;  //&#30465;&#30053;&#38750;&#20851;&#38190;&#20195;&#30721;
 &#160; &#160; &#160;  save(user);
 &#160; &#160; &#160;  domainEventPublisher.publish(new UserCreateEvent(save));
 &#160;  }
}
</code></pre>
<p>
 &#29992;&#25143;&#24212;&#29992;&#26381;&#21153;&#32534;&#25490;&#23436;&#36923;&#36753;&#21518;&#21457;&#36865;&#29992;&#25143;&#26032;&#22686;&#20107;&#20214;&#12290;
</p>
<p>
 <strong>
  &#65288;2&#65289;&#29992;&#25143;&#26032;&#22686;&#20107;&#20214;&#22788;&#29702;
 </strong>
</p>
<pre><code>@Component
@Slf4j
public class UserEventHandler {
&#8203;
 &#160;  @Autowired
 &#160;  DomainEventPublisher domainEventPublisher;
&#8203;
 &#160;  @Autowired
 &#160;  UserRoleApplicationService userRoleApplicationService;
&#8203;
 &#160;  @EventListener
 &#160;  public void handleEvent(UserEvent event) {
 &#160; &#160; &#160;  log.info("&#25509;&#21463;&#21040;&#29992;&#25143;&#26032;&#22686;&#20107;&#20214;&#65306;"+event.toString());
 &#160; &#160; &#160;  //&#30465;&#30053;&#37096;&#20998;&#25968;&#25454;&#32452;&#35013;&#19982;&#35299;&#26512;&#36923;&#36753;
 &#160; &#160; &#160;  userRoleApplicationService.save(userRole);
 &#160; &#160; &#160;  domainEventPublisher.publishEvent(userRoleEvent);
 &#160;  }
&#8203;
}
</code></pre>
<p>
 &#26631;&#27880;&#20102;
 <code>
  @EventListener
 </code>
 &#30340;&#29992;&#25143;&#20107;&#20214;&#30417;&#21548;&#31867;&#25343;&#21040;&#25968;&#25454;&#36827;&#34892;&#36923;&#36753;&#22788;&#29702;&#65292;&#28982;&#21518;&#20877;&#27425;&#21457;&#36865;&#19968;&#20010;&#26032;&#30340;
 <strong>
  &#29992;&#25143;&#35282;&#33394;&#20851;&#32852;&#26032;&#22686;&#20107;&#20214;
 </strong>
 &#12290;
</p>
<p>
 <strong>
  &#65288;3&#65289;&#29992;&#25143;&#35282;&#33394;&#20107;&#20214;&#22788;&#29702;
 </strong>
</p>
<pre><code>@Component
@Slf4j
public class UserRoleEventHandler {
&#8203;
 &#160;  @Autowired
 &#160;  UserRoleRecordApplicationService userRoleRecordApplicationService;
&#8203;
 &#160;  @EventListener
 &#160;  public void handleEvent(UserRoleEvent event) {
 &#160; &#160; &#160;  log.info("&#25509;&#21463;&#21040;userRole&#20107;&#20214;&#65306;"+event.toString());
 &#160; &#160; &#160;  //&#30465;&#30053;&#37096;&#20998;&#25968;&#25454;&#32452;&#35013;&#19982;&#35299;&#26512;&#36923;&#36753;
 &#160; &#160; &#160;  userRoleRecordApplicationService.save(record);
 &#160;  }
&#8203;
}
</code></pre>
<p>
 &#26368;&#21518;&#29992;&#25143;&#35282;&#33394;&#20107;&#20214;&#30417;&#21548;&#31867;&#25343;&#21040;&#20107;&#20214;&#21518;&#65292;&#36827;&#34892;&#25805;&#20316;&#35760;&#24405;&#20837;&#24211;&#12290;
</p>
<p>
 &#22312;&#21069;&#38754;&#24050;&#32463;&#35828;&#36807;&#65292;
 <code>
  @EventListener
 </code>
 &#26631;&#27880;&#30340;&#26041;&#27861;&#26159;&#34987;&#21152;&#20837;&#22312;&#20027;&#27969;&#31243;&#25191;&#34892;&#36923;&#36753;&#30340;&#20107;&#21153;&#20013;&#30340;&#65292;&#19982;&#20027;&#27969;&#31243;&#20107;&#21153;&#19968;&#20307;&#12290;
</p>
<p>
 &#22240;&#27492;&#20197;&#19978;&#19977;&#27573;&#36923;&#36753;&#21363;&#22788;&#20110;&#21516;&#19968;&#20107;&#21153;&#20013;&#65292;&#20219;&#24847;&#26041;&#27861;&#20869;&#25243;&#20986;&#24322;&#24120;&#65292;&#25152;&#26377;&#25968;&#25454;&#30340;&#25554;&#20837;&#36923;&#36753;&#37117;&#20250;&#22238;&#28378;&#12290;
</p>
<p>
 &#29616;&#22312;&#20877;&#26469;&#35828;&#19968;&#35828;&#36825;&#19977;&#27573;&#20195;&#30721;&#20013;&#30340;&#22353;&#28857;&#12290;
</p>
<p>
 <strong>
  &#36393;&#22353; 1&#65306;
 </strong>
</p>
<p>
 &#20005;&#26684;&#24847;&#20041;&#19978;&#26469;&#35828;&#36825;&#37324;&#19981;&#31639;&#26159;&#25226;&#20027;&#36923;&#36753;&#20174;&#19994;&#21153;&#20013;&#25286;&#20998;&#20986;&#26469;&#20102;&#65292;&#36824;&#26159;&#22312;&#21516;&#27493;&#30340;&#20107;&#21153;&#20013;&#65292;&#24403;&#28982;&#36825;&#20010;&#20063;&#26159;&#26377;&#36866;&#37197;&#22330;&#26223;&#30340;&#65292;&#22823;&#23478;&#20026;&#20102;&#20195;&#30721;&#31616;&#27905;&#24615;&#19982;&#20989;&#25968;&#32423;&#36923;&#36753;&#28165;&#26224;&#21487;&#20197;&#36825;&#20040;&#20570;&#12290;&#20294;&#26159;&#36825;&#26679;&#20570;&#20854;&#23454;&#19981;&#26159;&#37027;&#20040;DDD&#65292;DDD&#20013;&#24212;&#29992;&#26381;&#21153;&#30340;&#19968;&#20010;&#26041;&#27861;&#21363;&#20026;&#19968;&#20010;&#29992;&#20363;&#65292;&#37324;&#38754;&#36143;&#31359;&#20102;&#20027;&#27969;&#31243;&#30340;&#36923;&#36753;&#65292;&#26082;&#28982;&#26159;&#24403;&#21069;&#31995;&#32479;&#20869;&#24378;&#19968;&#33268;&#24615;&#30340;&#19994;&#21153;&#65292;&#37027;&#23601;&#24212;&#35813;&#22312;&#19968;&#20010;&#24212;&#29992;&#26381;&#21153;&#20013;&#20307;&#29616;&#12290;&#24403;&#28982;&#36825;&#20010;&#26159;&#23646;&#20110;&#19994;&#21153;&#36793;&#30028;&#30340;&#12290;&#20030;&#20363;&#30340;&#22330;&#26223;&#26469;&#30475;&#65292;&#29992;&#25143;&#19982;&#36171;&#26435;&#26174;&#28982;&#19981;&#26159;&#24378;&#19968;&#33268;&#24615;&#30340;&#25805;&#20316;&#65292;&#36171;&#26435;&#22833;&#36133;&#65292;&#19981;&#24212;&#35813;&#24433;&#21709;&#25105;&#26032;&#22686;&#29992;&#25143;&#65292;&#25152;&#20197;&#36825;&#20010;&#22330;&#26223;&#19979;&#20570;DDD&#25913;&#36896;&#65292;&#19981;&#24314;&#35758;&#20351;&#29992;&#32479;&#19968;&#20107;&#21153;&#12290;
</p>
<p>
 <strong>
  &#36393;&#22353; 2&#65306;
 </strong>
</p>
<p>
 Listener&#37324;&#38754;&#30340;&#25191;&#34892;&#36923;&#36753;&#21487;&#33021;&#27604;&#36739;&#32791;&#26102;&#65292;&#38656;&#35201;&#20570;&#24322;&#27493;&#21270;&#22788;&#29702;&#65292;&#22312;
 <code>
  UserEventHandler
 </code>
 &#26041;&#27861;&#19978;&#26631;&#27880;
 <code>
  @Async
 </code>
 &#65292;&#37027;&#20040;&#36825;&#37324;&#19982;&#20027;&#36923;&#36753;&#30340;&#26041;&#27861;&#20107;&#21153;&#23601;&#38548;&#31163;&#24320;&#20102;&#65292;&#30417;&#21548;&#22120;&#20869;&#30340;&#20107;&#21153;&#24320;&#22987;&#29420;&#31435;&#65292;&#23558;&#19981;&#20250;&#24433;&#21709;&#21040;userService&#20869;&#30340;&#20107;&#21153;&#12290;&#20363;&#22914;&#20854;&#20182;&#20195;&#30721;&#19981;&#21464;&#30340;&#24773;&#20917;&#19979;&#29992;&#25143;&#35282;&#33394;&#26381;&#21153;&#20195;&#30721;&#20462;&#25913;&#22914;&#19979;&#65306;
</p>
<pre><code>@Component
@Slf4j
public class UserEventHandler {
&#8203;
 &#160;  @Autowired
 &#160;  DomainEventPublisher domainEventPublisher;
&#8203;
 &#160;  @Autowired
 &#160;  UserRoleService userRoleService;
&#8203;
 &#160;  @EventListener
 &#160;  @Async
 &#160;  public void handleEvent(UserEvent event) {
 &#160; &#160; &#160;  log.info("&#25509;&#21463;&#21040;&#29992;&#25143;&#26032;&#22686;&#20107;&#20214;&#65306;"+event.toString());
 &#160; &#160; &#160;  //&#30465;&#30053;&#37096;&#20998;&#25968;&#25454;&#32452;&#35013;&#19982;&#35299;&#26512;&#36923;&#36753;
 &#160; &#160; &#160;  userRoleService.save(userRole);
 &#160; &#160; &#160;  domainEventPublisher.publishEvent(userRoleEvent);
 &#160; &#160; &#160;  throw new RuntimeException("&#21046;&#36896;&#19968;&#19979;&#24322;&#24120;");
 &#160;  }
&#8203;
}
</code></pre>
<p>
 &#20250;&#21457;&#29616;&#65292;&#29992;&#25143;&#26032;&#22686;&#20102;&#65292;&#29992;&#25143;&#35282;&#33394;&#20851;&#32852;&#20851;&#31995;&#26032;&#22686;&#20102;&#65292;&#20294;&#26159;&#25805;&#20316;&#35760;&#24405;&#27809;&#26377;&#26032;&#22686;&#12290;&#31532;&#19968;&#20010;&#32467;&#26524;&#22909;&#29702;&#35299;&#65292;&#31532;&#20108;&#20010;&#32467;&#26524;&#23601;&#22855;&#24618;&#20102;&#65292;&#20107;&#20214;&#30417;&#21548;&#37324;&#38754;&#25243;&#20102;&#24322;&#24120;&#65292;&#20294;&#26159;&#23621;&#28982;&#25968;&#25454;&#20445;&#23384;&#25104;&#21151;&#20102;&#12290;
</p>
<p>
 &#36825;&#37324;&#20854;&#23454;&#26159;&#22240;&#20026;
 <code>
  UserEventHandler
 </code>
 &#30340;
 <code>
  handleEvent
 </code>
 &#26041;&#27861;&#22806;&#23618;&#20026;&#23884;&#22871;
 <code>
  @Transactional
 </code>
 &#65292;
 <code>
  userRoleService.save
 </code>
 &#25805;&#20316;&#32467;&#26463;&#65292;&#20107;&#21153;&#23601;&#25552;&#20132;&#20102;&#65292;&#21518;&#32493;&#30340;&#25243;&#24322;&#24120;&#20063;&#19981;&#24433;&#21709;&#12290;&#20026;&#20102;&#20445;&#25345;&#20107;&#21153;&#19968;&#33268;&#65292;&#22312;&#26041;&#27861;&#19978;&#21152;&#19968;&#20010;
 <code>
  @Transactional
 </code>
 &#21363;&#21487;&#12290;
</p>
<h3>
 2. &#29420;&#31435;&#20107;&#21153;
</h3>
<p>
 <code>
  @EventListener
 </code>
 &#20316;&#20026;&#39537;&#21160;&#21152;&#36733;&#19994;&#21153;&#12289;&#20998;&#25955;&#20195;&#30721;&#31649;&#29702;&#36824;&#26159;&#27604;&#36739;&#22909;&#29992;&#30340;&#12290;&#20294;&#26159;&#22312;DDD&#23618;&#38754;&#65292;&#20107;&#21153;&#25968;&#25454;&#34987;&#26434;&#31941;&#22312;&#19968;&#36215;&#65292;&#20986;&#20102;&#38382;&#39064;&#19968;&#23618;&#23618;&#25214;&#20063;&#40635;&#28902;&#65292;&#32780;&#19988;&#25968;&#25454;&#25414;&#32465;&#36739;&#22810;&#65292;&#25105;&#36824;&#26159;&#27604;&#36739;&#24314;&#35758;&#20351;&#29992;
 <code>
  @TransactionalEventListener
 </code>
 &#12290;
</p>
<p>
 &#25105;&#20204;&#26469;&#30475;&#30475;&#20351;&#29992;
 <code>
  @TransactionalEventListener
 </code>
 &#22914;&#20309;&#23454;&#29616;&#19978;&#36848;&#38656;&#27714;&#65292;&#20351;&#29992;&#36807;&#31243;&#20013;&#21448;&#20250;&#26377;&#20160;&#20040;&#26679;&#30340;&#22353;&#12290;
</p>
<p>
 <strong>
  &#65288;1&#65289;&#29992;&#25143;&#26032;&#22686;
 </strong>
</p>
<pre><code>@Service
@Slf4j
public class UserServiceImpl implements UserService {
&#8203;
 &#160;  @Autowired
 &#160;  DomainEventPublisher domainEventPublisher;
&#8203;
 &#160;  @Transactional(rollbackFor = Exception.class)
 &#160;  public void createUser(){
 &#160; &#160; &#160;  //&#30465;&#30053;&#38750;&#20851;&#38190;&#20195;&#30721;
 &#160; &#160; &#160;  save(user);
 &#160; &#160; &#160;  domainEventPublisher.publishEvent(userEvent);
 &#160;  }
}
</code></pre>
<p>
 <strong>
  &#65288;2&#65289;&#29992;&#25143;&#35282;&#33394;&#20851;&#32852;
 </strong>
</p>
<pre><code>@Component
@Slf4j
public class UserEventHandler {
&#8203;
 &#160;  @Autowired
 &#160;  DomainEventPublisher domainEventPublisher;
&#8203;
 &#160;  @Autowired
 &#160;  UserRoleApplicationService userRoleApplicationService;
&#8203;
 &#160;  @TransactionalEventListener
 &#160;  public void handleEvent(UserEvent event) {
 &#160; &#160; &#160;  log.info("&#25509;&#21463;&#21040;&#29992;&#25143;&#26032;&#22686;&#20107;&#20214;&#65306;"+event.toString());
 &#160; &#160; &#160;  //&#30465;&#30053;&#37096;&#20998;&#25968;&#25454;&#32452;&#35013;&#19982;&#35299;&#26512;&#36923;&#36753;
 &#160; &#160; &#160;  userRoleApplicationService.save(userRole);
 &#160; &#160; &#160;  domainEventPublisher.publishEvent(userRoleEvent);
 &#160;  }
&#8203;
}
</code></pre>
<p>
 <strong>
  &#65288;3&#65289;&#29992;&#25143;&#35282;&#33394;&#25805;&#20316;&#35760;&#24405;
 </strong>
</p>
<pre><code>@Component
@Slf4j
public class UserRoleEventHandler {
&#8203;
 &#160;  @Autowired
 &#160;  UserRoleRecordApplicationService userRoleRecordApplicationService;
&#8203;
 &#160;  @TransactionalEventListener
 &#160;  public void handleEvent(UserRoleEvent event) {
 &#160; &#160; &#160;  log.info("&#25509;&#21463;&#21040;userRole&#20107;&#20214;&#65306;"+event.toString());
 &#160; &#160; &#160;  //&#30465;&#30053;&#37096;&#20998;&#25968;&#25454;&#32452;&#35013;&#19982;&#35299;&#26512;&#36923;&#36753;
 &#160; &#160; &#160;  userRoleRecordApplicationService.save(record);
 &#160;  }
&#8203;
}
</code></pre>
<p>
 &#19982;&#32479;&#19968;&#20107;&#21153;&#19968;&#26679;&#30340;&#19994;&#21153;&#20195;&#30721;&#65292;&#21482;&#26159;&#25226;&#27880;&#35299;&#20174;
 <code>
  @EventListener
 </code>
 &#26356;&#25442;&#20026;
 <code>
  @TransactionalEventListener
 </code>
 &#12290;&#20294;&#26159;&#19978;&#36848;&#36923;&#36753;&#25191;&#34892;&#20043;&#21518;&#21457;&#29616;&#20102;&#19968;&#20010;&#31070;&#22855;&#30340;&#38382;&#39064;&#65292;
 <strong>
  &#29992;&#25143;&#35282;&#33394;&#25805;&#20316;&#35760;&#24405;
 </strong>
 &#25968;&#25454;&#27809;&#26377;&#20837;&#24211;&#12290;
</p>
<p>
 &#25419;&#19968;&#25419;&#36923;&#36753;&#30475;&#30475;&#65292;&#25442;&#20102;&#20010;&#27880;&#35299;&#65292;&#23601;&#20986;&#29616;&#36825;&#20010;&#38382;&#39064;&#20102;&#12290;&#27604;&#36739;&#19968;&#19979;&#20004;&#20010;&#27880;&#35299;&#30340;&#21306;&#21035;&#12290;
 <code>
  @TransactionalEventListener
 </code>
 &#20107;&#21153;&#29420;&#31435;&#65292;&#19988;&#40664;&#35748;&#27880;&#35299;
 <code>
  phase
 </code>
 &#21442;&#25968;&#20540;&#20026;
 <strong>
  TransactionPhase.AFTER_COMMIT
 </strong>
 &#65292;&#21363;&#20026;&#20027;&#36923;&#36753;&#26041;&#27861;&#20107;&#21153;&#25552;&#20132;&#21518;&#22312;&#25191;&#34892;&#12290;&#32780;&#25105;&#20204;&#30693;&#36947;Spring&#20013;&#20107;&#21153;&#30340;&#25552;&#20132;&#20851;&#38190;&#20195;&#30721;&#22312;
 <code>
  AbstractPlatformTransactionManager.commitTransactionAfterReturning
 </code>
 &#12290;
</p>
<pre><code>protected void commitTransactionAfterReturning(@Nullable TransactionInfo txInfo) {
 &#160; if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) {
 &#160; &#160;  if (logger.isTraceEnabled()) {
 &#160; &#160; &#160; &#160; logger.trace("Completing transaction for [" + txInfo.getJoinpointIdentification() + "]");
 &#160; &#160;  }
 &#160; &#160;  //&#26029;&#28857;&#22788;
 &#160; &#160;  txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());
 &#160; }
}
</code></pre>
<p>
 &#37197;&#32622;&#25991;&#20214;&#20013;&#28155;&#21152;&#20197;&#19979;&#37197;&#32622;&#65306;
</p>
<pre><code>logging:
  level:
 &#160;  org:
 &#160; &#160;  mybatis: debug
</code></pre>
<p>
 &#22312;&#19978;&#36848;&#20195;&#30721;&#30340;&#22320;&#26041;&#25171;&#19978;&#26029;&#28857;&#65292;&#20877;&#27425;&#25191;&#34892;&#36923;&#36753;&#12290;
</p>
<p>
 &#21457;&#29616;&#65292;&#31532;&#19968;&#27425;
 <code>
  userApplicationService
 </code>
 &#20445;&#23384;&#25968;&#25454;&#36827;&#20837;&#27492;&#26029;&#28857;&#65292;&#28982;&#21518;&#36827;&#20837;&#21040;
 <code>
  userRoleApplicationService.save
 </code>
 &#36923;&#36753;&#65292;&#27492;&#22788;&#19981;&#36827;&#20837;&#26029;&#28857;&#65292;&#21518;&#32493;&#30340;&#25805;&#20316;&#35760;&#24405;&#30340;&#20107;&#20214;&#22788;&#29702;&#26041;&#27861;&#20063;&#27809;&#26377;&#36827;&#20837;&#12290;
</p>
<p>
 &#20877;&#26469;&#30475;&#19968;&#19979;&#26085;&#24535;&#65306;
</p>
<pre><code>- 2021-09-07 19:54:38.166, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Creating a new SqlSession
- 2021-09-07 19:54:38.166, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@77a74846]
- 2021-09-07 19:54:38.167, DEBUG, [,,], [http-nio-8088-exec-6], o.m.s.t.SpringManagedTransaction - JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@1832a0d9] will be managed by Spring
- 2021-09-07 19:54:38.184, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@77a74846]
- 2021-09-07 19:54:51.423, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@77a74846]
- 2021-09-07 19:54:51.423, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@77a74846]
- 2021-09-07 19:54:51.423, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@77a74846]
- 2021-09-07 19:54:51.430,  INFO, [,,], [http-nio-8088-exec-6], com.examp.event.demo.UserEventHandler - &#25509;&#21463;&#21040;&#29992;&#25143;&#26032;&#22686;&#20107;&#20214;&#65306;com.examp.event.demo.UserEvent@385db2f9
- 2021-09-07 19:54:53.602, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Creating a new SqlSession
- 2021-09-07 19:54:53.602, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@9af2818] was not registered for synchronization because synchronization is not active
- 2021-09-07 19:54:53.603, DEBUG, [,,], [http-nio-8088-exec-6], o.m.s.t.SpringManagedTransaction - JDBC Connection [com.mysql.cj.jdbc.ConnectionImpl@1832a0d9] will be managed by Spring
- 2021-09-07 19:54:53.622, DEBUG, [,,], [http-nio-8088-exec-6], org.mybatis.spring.SqlSessionUtils - Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@9af2818]
</code></pre>
<p>
 &#27880;&#24847;&#30475;&#25509;&#21463;&#21040;
 <code>
  &#29992;&#25143;&#26032;&#22686;&#20107;&#20214;
 </code>
 &#20043;&#21518;&#30340;&#26085;&#24535;&#65292;
 <code>
  SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@9af2818] was not registered for synchronization because synchronization is not active
 </code>
 &#35828;&#26126;&#24403;&#21069;&#20107;&#20214;&#26159;&#26080;&#20107;&#21153;&#25191;&#34892;&#30340;&#36923;&#36753;&#12290;&#20877;&#22238;&#36807;&#22836;&#21435;&#30475;&#19968;&#19979;
 <code>
  @TransactionalEventListener
 </code>
 &#65292;&#40664;&#35748;&#37197;&#32622;&#26159;&#22312;&#20107;&#21153;&#25552;&#20132;&#21518;&#25165;&#36827;&#34892;&#20107;&#20214;&#25191;&#34892;&#30340;&#65292;&#20294;&#26159;&#36825;&#37324;&#20107;&#21153;&#37117;&#27809;&#26377;&#65292;&#33258;&#28982;&#20063;&#23601;&#19981;&#20250;&#35302;&#21457;&#20107;&#20214;&#20102;&#12290;
</p>
<p>
 <strong>
  &#30475;&#22270;&#24635;&#32467;&#19968;&#19979;&#19978;&#36848; Bug
 </strong>
 &#65306;
</p>
<p>
 <img alt="image-20210907200823192.png" src="EPUB/1bd8b4ae-17d9-11ed-92a9-acde48001122">
</p>
<ol>
 <li>
  &#21019;&#24314;&#29992;&#25143;&#21518;&#65292;&#29992;&#25143;&#24212;&#29992;&#26381;&#21153;&#25552;&#20132;&#20107;&#21153;&#65292;&#35302;&#21457;userRole&#20107;&#20214;&#36923;&#36753;&#22788;&#29702;&#12290;
 </li>
 <li>
  &#27492;&#26102;userRole&#20107;&#20214;&#36923;&#36753;&#22788;&#29702;&#22312;&#40664;&#35748;&#20107;&#20214;&#20256;&#25773;&#26426;&#21046;&#19979;&#65292;&#21152;&#20837;&#20107;&#21153;&#22833;&#36133;&#65292;&#20197;&#38750;&#20107;&#21153;&#26041;&#24335;&#36816;&#34892;
 </li>
 <li>
  &#30001;&#20110;userRole&#26159;&#20197;&#38750;&#20107;&#21153;&#26041;&#24335;&#36816;&#34892;&#30340;&#65292;&#21017;&#19981;&#25552;&#20132;&#20107;&#21153;&#65292;&#21017;&#26080;&#27861;&#35302;&#21457;&#25805;&#20316;&#35760;&#24405;&#20107;&#20214;&#30417;&#21548;
 </li>
</ol>
<p>
 <strong>
  &#37027;&#24590;&#20040;&#35299;&#20915;&#19978;&#38754;&#30340;&#38382;&#39064;&#21602;&#65311;&#36825;&#37324;&#26377;&#20004;&#31181;&#26041;&#24335;&#12290;
 </strong>
</p>
<ol>
 <li>
  <p>
   &#21487;&#20197;&#23545;&#30417;&#21548;&#27492;&#20107;&#20214;&#30340;&#36923;&#36753;&#26080;&#33041;&#26631;&#27880;
   <code>
    @TransactionalEventListener(fallbackExecution = true)
   </code>
   &#65292;&#26080;&#35770;&#20107;&#20214;&#21457;&#36865;&#26041;&#26159;&#21542;&#26377;&#20107;&#21153;&#37117;&#20250;&#35302;&#21457;&#20107;&#20214;&#12290;
  </p>
 </li>
 <li>
  <p>
   &#22312;&#31532;&#20108;&#20010;&#21457;&#24067;&#20107;&#20214;&#30340;&#19978;&#38754;&#26631;&#27880;&#19968;&#20010;
   <code>
    @Transactional(propagation = Propagation.REQUIRES_NEW)
   </code>
   &#65292;&#20999;&#35760;&#19981;&#21487;&#30452;&#25509;&#26631;&#27880;
   <code>
    @Transactional
   </code>
   &#65292;&#36825;&#26679;&#22240;&#20026;userApplicationService&#19978;&#20107;&#21153;&#24050;&#32463;&#25552;&#20132;&#65292;&#32780;
   <code>
    @Transactional
   </code>
   &#40664;&#35748;&#20107;&#21153;&#20256;&#25773;&#26426;&#21046;&#20026;
   <code>
    Propagation.REQUIRED
   </code>
   &#65292;&#22914;&#26524;&#24403;&#21069;&#27809;&#26377;&#20107;&#21153;&#65292;&#23601;&#26032;&#24314;&#19968;&#20010;&#20107;&#21153;&#65292;&#22914;&#26524;&#24050;&#32463;&#23384;&#22312;&#19968;&#20010;&#20107;&#21153;&#65292;&#21152;&#20837;&#21040;&#36825;&#20010;&#20107;&#21153;&#20013;&#12290;
  </p>
 </li>
</ol>
<h2>
 &#20116;&#12289;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#22312; DDD &#30340;&#24212;&#29992;&#27880;&#24847;&#28857;
</h2>
<p>
 &#33267;&#27492;&#25105;&#24819;&#20320;&#24212;&#35813;&#23545;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#26377;&#20102;&#19968;&#20010;&#28165;&#26224;&#30340;&#35748;&#30693;&#20102;&#65292;&#37027;&#20040;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#24212;&#29992;&#22312;DDD&#20013;&#26377;&#20160;&#20040;&#38656;&#35201;&#27880;&#24847;&#30340;&#21527;&#65311;
</p>
<ol>
 <li>
  &#32858;&#21512;&#30340;&#21629;&#20196;&#24615;&#25805;&#20316;&#29702;&#35770;&#19978;&#37117;&#24212;&#35813;&#21457;&#24067;&#39046;&#22495;&#20107;&#20214;&#24182;&#23384;&#20648;&#65292;&#20415;&#20110;&#36923;&#36753;&#25193;&#23637;&#19982;&#21518;&#32493;&#20107;&#20214;&#28335;&#28304;&#12290;
 </li>
 <li>
  &#32479;&#19968;&#20107;&#21153;&#30340;&#22788;&#29702;&#26041;&#24335;&#19981;&#26159;DDD&#30340;&#21021;&#34935;&#65292;&#22914;&#26524;&#36935;&#21040;&#20102;&#20107;&#20214;&#22788;&#29702;&#36923;&#36753;&#19982;&#20027;&#27969;&#31243;&#36923;&#36753;&#20107;&#21153;&#19968;&#20307;&#30340;&#22330;&#26223;&#65292;&#38656;&#35201;&#37325;&#26032;&#24605;&#32771;&#24212;&#29992;&#26381;&#21153;&#30340;&#32534;&#25490;&#36923;&#36753;&#26159;&#21542;&#21512;&#29702;&#25110;&#32773;&#39046;&#22495;&#27169;&#22411;&#21010;&#20998;&#26159;&#21542;&#27491;&#30830;&#12290;
 </li>
</ol>
<h2>
 &#20845;&#12289;&#24635;&#32467;
</h2>
<p>
 &#26412;&#25991;&#30528;&#37325;&#20171;&#32461;&#20102;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#30340;&#27010;&#24565;&#19982;&#24212;&#29992;&#65292;&#24182;&#23545;&#23454;&#38469;&#21487;&#33021;&#20986;&#29616;&#30340;&#19994;&#21153;&#36923;&#36753;&#20570;&#20102;&#20998;&#26512;&#19982;&#36991;&#22353;&#65292;&#26368;&#21518;&#24378;&#35843;&#20102;DDD&#24212;&#29992;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#38656;&#35201;&#27880;&#24847;&#30340;&#28857;&#12290;
</p>
<p>
 &#33267;&#27492;&#20320;&#24212;&#35813;&#23545;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#24050;&#32463;&#26377;&#20102;&#19968;&#20010;&#28165;&#26224;&#30340;&#35748;&#30693;&#65292;&#20294;&#21487;&#33021;&#23545;&#20110;&#22914;&#20309;&#22312;DDD&#20013;&#24212;&#29992;&#36824;&#26159;&#26377;&#20123;&#27169;&#31946;&#12290;
</p>
<p>
 &#21315;&#35328;&#19975;&#35821;&#27719;&#25104;&#19968;&#21477;&#35805;&#65306;
 <strong>
  &#19982;&#32858;&#21512;&#26680;&#24515;&#36923;&#36753;&#26377;&#20851;&#30340;&#65292;&#36208;&#24212;&#29992;&#26381;&#21153;&#32534;&#25490;&#65307;&#19982;&#26680;&#24515;&#36923;&#36753;&#26080;&#20851;&#30340;&#65292;&#36208;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#65292;&#37319;&#29992;&#29420;&#31435;&#20107;&#21153;&#27169;&#24335;
 </strong>
 &#12290;&#33267;&#20110;&#25968;&#25454;&#19968;&#33268;&#24615;&#65292;&#23601;&#26681;&#25454;&#20320;&#33258;&#24049;&#30456;&#20851;&#30340;&#19994;&#21153;&#26469;&#20915;&#23450;&#20102;&#65292;&#26041;&#27861;&#19982;&#36393;&#22353;&#32463;&#39564;&#37117;&#24050;&#32463;&#21578;&#35785;&#20320;&#20102;&#12290;
</p>
<p>
 &#21516;&#26679;&#65292;&#22312;&#36825;&#19968;&#35762;&#30340;&#23398;&#20064;&#36807;&#31243;&#20013;&#65292;&#22914;&#26524;&#20320;&#36935;&#21040;&#20160;&#20040;&#38382;&#39064;&#25110;&#32773;&#26377;&#22909;&#30340;&#32463;&#39564;&#35201;&#20998;&#20139;&#65292;&#27426;&#36814;&#20320;&#22312;&#30041;&#35328;&#21306;&#19982;&#25105;&#20998;&#20139;&#65292;&#25105;&#20204;&#19968;&#36215;&#20132;&#27969;&#65292;&#19968;&#36215;&#36827;&#27493;&#12290;
</p>
</div>

</div>
</div>

        </body>
        
        