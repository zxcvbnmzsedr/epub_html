<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
  <head>
    <title>7　随需应变：网站的可扩展架构</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles1.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<h2 class="calibre7" id="calibre_pb_3"><a id="sec005" class="calibre8"></a>
 7.3　利用分布式服务打造可复用的业务平台</h2>
<p class="calibre1">使用分布式服务是降低系统耦合性的另一个重要手段。如果说分布式消息队列通过消息对象分解系统耦合性，不同子系统处理同一个消息；那么分布式服务则通过接口分解系统耦合性，不同子系统通过相同的接口描述进行服务调用。</p>
<p class="calibre1">回顾网站架构发展历程，网站在由小到大的演化过程中，表现为整个网站是由单一应用系统逐步膨胀发展变化而来，随着网站功能的日益复杂，网站应用系统会逐渐成为一个巨无霸，如图7.3所示。一个应用中聚合了大量的应用和服务组件，这个巨无霸给整个网站的开发、维护、部署都带来了巨大的麻烦。</p>
<div class="kindle-cn-bodycontent-div-alone"><img class="kindle-cn-bodycontent-image-alone80-withnote" alt="" src="../images/00082.jpeg"/>
<p class="kindle-cn-picture-txt-withfewcharactors">图7.3　巨无霸系统示意图</p>
</div>
<p class="calibre1">巨无霸应用系统带来如下几点问题。</p>
<p class="calibre1">1．编译、部署困难：对于网站开发工程师而言，打包构建一个巨型应用是一件痛苦的事情，也许只是修改了一行代码，输入build命令后，抽完一支烟，回来一看，还在building；又去喝了一杯水，回来一看，还在building；又去了一次厕所，回来一看，还在building；好不容易build结束，一看编译失败，还得重来……</p>
<p class="calibre1">2．代码分支管理困难：复用的代码模块由多个团队共同维护修改，代码merge的时候总会发生冲突。代码merge一般发生在网站发布的时候，经常和发布过程中出现的其他问题互相纠结在一起，顾此失彼，导致每次发布都要拖到半夜三更。</p>
<p class="calibre1">3．数据库连接耗尽：巨型的应用、大量的访问，必然需要将这个应用部署在一个大规模的服务器集群上，应用与数据库的连接通常使用数据库连接池，以每个应用10个连接计，一个数百台服务器集群的应用将需要在数据库上创建数千个连接。数据库服务器上，每个连接都会占用一些昂贵的系统资源，以至于数据库缺乏足够的系统资源进行一般的数据操作。</p>
<p class="calibre1">4．新增业务困难：想要在一个已经如乱麻般的系统中增加新业务，维护旧功能，难度可想而知：一脚踩进去，发现全都是雷，什么都不敢碰。许多新工程师来公司半年了，还是不能接手业务，因为不知道水有多深。于是就出现这种怪现象：熟悉网站产品的“老人”忙得要死，加班加点干活；不熟悉网站产品的新人一帮忙就出乱，跟着加班加点；整个公司热火朝天，加班加点，却还是经常出故障，新产品迟迟不能上线。</p>
<p class="calibre1">解决方案就是拆分，将模块独立部署，降低系统耦合性。拆分可以分为纵向拆分和横向拆分两种。</p>
<p class="calibre1">纵向拆分：将一个大应用拆分为多个小应用，如果新增业务较为独立，那么就直接将其设计部署为一个独立的Web应用系统。</p>
<p class="calibre1">横向拆分：将复用的业务拆分出来，独立部署为分布式服务，新增业务只需要调用这些分布式服务，不需要依赖具体的模块代码，即可快速搭建一个应用系统，而模块内业务逻辑变化的时候，只要接口保持一致就不会影响业务程序和其他模块。如图7.4所示。</p>
<div class="kindle-cn-bodycontent-div-alone"><img class="kindle-cn-bodycontent-image-alone80-withnote" alt="" src="../images/00083.jpeg"/>
<p class="kindle-cn-picture-txt-withfewcharactors">图7.4　业务及模块拆分独立部署的分布式服务架构</p>
</div>
<p class="calibre1">纵向拆分相对较为简单，通过梳理业务，将较少相关的业务剥离，使其成为独立的Web应用。而对于横向拆分，不但需要识别可复用的业务，设计服务接口，规范服务依赖关系，还需要一个完善的分布式服务管理框架。</p>
<h3 class="calibre9"><a id="sec006"></a>
 7.3.1　Web Service与企业级分布式服务</h3>
<p class="calibre1">Web Service曾经是企业应用系统开发领域最时髦的词汇之一，用以整合异构系统及构建分布式系统。Web Service原理架构如图7.5所示。</p>
<div class="kindle-cn-bodycontent-div-alone"><img class="kindle-cn-bodycontent-image-alone50-withnote" alt="" src="../images/00084.jpeg"/>
<p class="kindle-cn-picture-txt-withfewcharactors">图7.5　WebService架构原理</p>
<p class="kindle-cn-picture-txt-withmanycharactors">（图片来源：http://zh.wikipedia.org/zh/Web％E6％9C％8D％E5％8A％A1）</p>
</div>
<p class="calibre1">服务提供者通过WSDL（Web Services Description Language，Web服务描述语言）向注册中心（Service Broker）描述自身提供的服务接口属性，注册中心使用UDDI（Universal Description, Discovery, and Integration，统一描述、发现和集成）发布服务提供者提供的服务，服务请求者从注册中心检索到服务信息后，通过SOAP （Simple Object Access Protocol，简单对象访问协议 ）和服务提供者通信，使用相关服务。</p>
<p class="calibre1">Web Service虽然有成熟的技术规范和产品实现，并在企业应用领域有许多成功的案例，但也有如下固有的缺点。</p>
<p class="calibre1">1．臃肿的注册与发现机制。</p>
<p class="calibre1">2．低效的XML序列化手段。</p>
<p class="calibre1">3．开销相对较高的HTTP远程通信。</p>
<p class="calibre1">4．复杂的部署与维护手段。</p>
<p class="calibre1">这些问题导致Web Service难以满足大型网站对系统高性能、高可用、易部署、易维护的要求。</p>
<h3 class="calibre9"><a id="sec007"></a>
 7.3.2　大型网站分布式服务的需求与特点</h3>
<p class="calibre1">对于大型网站，除了Web Service所提供的服务注册与发现，服务调用等标准功能，还需要分布式服务框架能够支持如下特性。</p>
<p class="kindle-cn-bold1">负载均衡</p>
<p class="calibre1">对热门服务，比如登录服务或者商品服务，访问量非常大，服务需要部署在一个集群上。分布式服务框架要能够支持服务请求者使用可配置的负载均衡算法访问服务，使服务提供者集群实现负载均衡。</p>
<p class="kindle-cn-bold1">失效转移</p>
<p class="calibre1">可复用的服务通常会被多个应用调用，一旦该服务不可用，就会影响到很多应用的可用性。因此对于大型网站的分布式服务而言，即使是很少访问的简单服务，也需要集群部署，分布式服务框架支持服务提供者的失效转移机制，当某个服务实例不可用，就将访问切换到其他服务实例上，以实现服务整体高可用。</p>
<p class="kindle-cn-bold1">高效的远程通信</p>
<p class="calibre1">对于大型网站，核心服务每天的调用次数会达到数以亿计，如果没有高效的远程通信手段，服务调用会成为整个系统性能的瓶颈。</p>
<p class="kindle-cn-bold1">整合异构系统</p>
<p class="calibre1">由于历史发展和组织分割，网站服务可能会使用不同的语言开发并部署于不同的平台，分布式服务框架需要整合这些异构的系统。</p>
<p class="kindle-cn-bold1">对应用最少侵入</p>
<p class="calibre1">网站技术是为业务服务的，是否使用分布式服务需要根据业务发展规划，分布式服务也需要渐进式的演化，甚至会出现反复，即使用了分布式服务后又退回到集中式部署，分布式服务框架需要支持这种渐进式演化和反复。当然服务模块本身需要支持可集中式部署，也可分布式部署。</p>
<p class="kindle-cn-bold1">版本管理</p>
<p class="calibre1">为了应对快速变化的需求，服务升级不可避免，如果仅仅是服务内部实现逻辑升级，那么这种升级对服务请求者而言是透明的，无需关注。但如果服务的访问接口也发生了变化，就需要服务请求者和服务提供者同时升级才不会导致服务调用失败。企业应用系统可以申请停机维护，同时升级接口。但是网站服务不可能中断，因此分布式服务框架需要支持服务多版本发布，服务提供者先升级接口发布新版本的服务，并同时提供旧版本的服务供请求者调用，当请求者调用接口升级后才可以关闭旧版本服务。</p>
<p class="kindle-cn-bold1">实时监控</p>
<p class="calibre1">对于网站应用而言，没有监控的服务是不可能实现高可用的。分布式服务框架还需要监控服务提供者和调用者的各项指标，提供运维和运营支持。</p>
<h3 class="calibre9"><a id="sec008"></a>
 7.3.3　分布式服务框架设计</h3>
<p class="calibre1">大型网站需要更简单更高效的分布式服务框架构建其SOA（Service Oriented Architecture面向服务的体系架构）。据称Facebook利用Thrift（一个开源的远程服务调用框架）管理其分布式服务，服务的注册、发现及调用都通过Thrift完成，但对于一个大型网站可以使用的分布式服务框架，仅有Thrift还远远不够，遗憾的是，Facebook没有开源其基于Thrift的分布式服务框架。目前国内有较多成功实施案例的开源分布式服务框架是阿里巴巴的Dubbo（http://code.alibabatech.com/wiki/display/dubbo/Home/）。</p>
<p class="calibre1">我们以阿里巴巴分布式开源框架Dubbo为例，分析其架构设计，如图7.6所示。</p>
<div class="kindle-cn-bodycontent-div-alone"><img class="kindle-cn-bodycontent-image-alone80-withnote" alt="" src="../images/00085.jpeg"/>
<p class="kindle-cn-picture-txt-withfewcharactors">图7.6　分布式服务框架Dubbo的架构原理</p>
</div>
<p class="calibre1">服务消费者程序通过服务接口使用服务，而服务接口通过代理加载具体服务，具体服务可以是本地的代码模块，也可以是远程的服务，因此对应用较少侵入：应用程序只需要调用服务接口，服务框架根据配置自动调用本地或远程实现。</p>
<p class="calibre1">服务框架客户端模块通过服务注册中心加载服务提供者列表（服务提供者启动后自动向服务注册中心注册自己可提供的服务接口列表），查找需要的服务接口，并根据配置的负载均衡策略将服务调用请求发送到某台服务提供者服务器。如果服务调用失败，客户端模块会自动从服务提供者列表选择一个可提供同样服务的另一台服务器重新请求服务，实现服务的自动失效转移，保证服务高可用。</p>
<p class="calibre1">Dubbo的远程服务通信模块支持多种通信协议和数据序列化协议，使用NIO通信框架，具有较高的网络通信性能。</p>
</body>
</html>
