<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
  <head>
    <title>10　维基百科的高性能架构设计分析</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../page_styles1.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<h2 class="calibre7" id="calibre_pb_2"><a id="sec002" class="calibre8"></a>
 10.2　Wikipedia性能优化策略</h2>
<p class="calibre1">作为一个百科服务类网站，Wikipedia主要面临的挑战是如何应对来自全球各地的巨量并发的词条查询请求。相对其他网站，Wikipedia的业务比较简单，用户操作大部分是只读的，这些前提使Wikipedia的性能优化约束变得简单，可以让技术团队将每一种性能优化手段都发挥到极致，且业务束缚较少。因此Wikipedia的性能优化比较有典型意义。</p>
<h3 class="calibre9"><a id="sec003"></a>
 10.2.1　Wikipedia前端性能优化</h3>
<p class="calibre1">所谓网站前端是指应用服务器（也就是PHP服务器）之前的部分，包括DNS服务、CDN服务、反向代理服务、静态资源服务等，如图10.3所示。对Wikipedia而言，80％以上的用户请求可以通过前端服务返回，请求根本不会到达应用服务器，这也就使得网站最复杂、最有挑战的应用服务端和存储端压力骤减。</p>
<div class="kindle-cn-bodycontent-div-alone"><img class="kindle-cn-bodycontent-image-alone50-withnote" alt="" src="../images/00113.jpeg"/>
<p class="kindle-cn-picture-txt-withfewcharactors">图10.3　Wikipedia的前端架构</p>
</div>
<p class="calibre1">Wikipedia前端架构的核心是反向代理服务器Squid集群，大约部署有数十台服务器，请求通过LVS负载均衡地分发到每台Squid服务器，热点词条被缓存在这里，大量请求可直接返回响应，请求无需发送到Apache服务器，减轻应用负载压力。Squid缓存不能命中的请求再通过LVS发送到Apache应用服务器集群，如果有词条信息更新，应用服务器使用Invalidation Notification服务通知Squid缓存失效，重新访问应用服务器更新词条。</p>
<p class="calibre1">而在反向代理Squid之前，则是被Wikipedia技术团队称为“圣杯”的CDN服务，CDN服务对于Wikipedia性能优化居功至伟。因为用户查询的词条大部分集中在比重很小的热点词条上，将这些词条内容页面缓存在CDN服务器上，而CDN服务器又部署在离用户浏览器最近的地方，用户请求直接从CDN返回，响应速度非常快，这些请求甚至根本不会到达Wikipedia数据中心的Squid服务器，服务器压力减小，节省的资源可以更快地处理其他未被CDN缓存的请求。</p>
<p class="calibre1">Wikipedia CDN缓存的几条准则为：</p>
<ul class="kindle-cn-ul-disc">
<li class="calibre11">内容页面不包含动态信息，以免页面内容缓存很快失效或者包含过时信息。</li>
<li class="calibre11">每个内容页面有唯一的REST风格的URL，以便CDN快速查找并避免重复缓存。</li>
<li class="calibre11">在HTML响应头写入缓存控制信息，通过应用控制内容是否缓存及缓存有效期等。</li>
</ul>
<h3 class="calibre9"><a id="sec004"></a>
 10.2.2　Wikipedia服务端性能优化</h3>
<p class="calibre1">服务端主要是PHP服务器，这里是网站业务逻辑的核心部分，运行的模块都比较复杂笨重，需要消耗较多的资源，Wikipedia将最好的服务器部署在这里（和数据库配置一样的服务器），从硬件上改善性能。</p>
<p class="calibre1">除了硬件改善，Wikipedia还使用许多其他开源组件对应用层进行如下优化。</p>
<ul class="kindle-cn-ul-disc">
<li class="calibre11">使用APC，这是一个PHP字节码缓存模块，可以加速代码执行减少资源消耗。</li>
<li class="calibre11">使用Imagemagick进行图片处理和转化。</li>
<li class="calibre11">使用Tex进行文本格式化，特别是将科学公式内容转换成图片格式。</li>
<li class="calibre11">替换PHP的字符串查找函数strtr（），使用更优化的算法重构。</li>
</ul>
<h3 class="calibre9"><a id="sec005"></a>
 10.2.3　Wikipedia后端性能优化</h3>
<p class="calibre1">包括缓存、存储、数据库等被应用服务器依赖的服务都可以归类为后端服务。后端服务通常是一些有状态的服务，即需要提供数据存储服务，这些服务大多建立在网络通信和磁盘操作基础上，是性能的瓶颈，也是性能优化的重灾区。</p>
<p class="calibre1">后端优化最主要的手段是使用缓存，将热点数据缓存在分布式缓存系统的内存中，加速应用服务器的数据读操作速度，减轻存储和数据库服务器的负载。Wikipedia的缓存使用策略如下：</p>
<ul class="kindle-cn-ul-disc">
<li class="calibre11">热点特别集中的数据直接缓存到应用服务器的本地内存中，因为要占用应用服务器的内存且每台服务器都需要重复缓存这些数据，因此这些数据量很小，但是读取频率极高。</li>
<li class="calibre11">缓存数据的内容尽量是应用服务器可以直接使用的格式，比如HTML格式，以减少应用服务器从缓存中获取数据后解析构造数据的代价。</li>
<li class="calibre11">使用缓存服务器存储session对象。</li>
<li class="calibre11">相比数据库，Memcached的持久化连接非常廉价，如有需要就创建一个Memcached连接。</li>
</ul>
<p class="calibre1">作为存储核心资产的MySQL数据库，Wikipedia也做了如下优化：</p>
<ul class="kindle-cn-ul-disc">
<li class="calibre11">使用较大的服务器内存。在Wikipedia应用场景中，增加内存比增加其他资源更能改善MySQL性能。</li>
<li class="calibre11">使用RAID0磁盘阵列以加速磁盘访问，RAID0虽然加速磁盘访问，但是却降低了数据库的持久可靠性（一块盘坏了，整个数据库的数据都不完整了）。显然Wikipedia认为性能问题迫在眉睫，而数据可靠性问题可以通过其他手段解决（如MySQL主从复制，数据异步备份等）。</li>
<li class="calibre11">将数据库事务一致性设置在较低水平，加快宕机恢复速度。</li>
<li class="calibre11">如果Master数据库宕机，立即将应用切换到Salve数据库，同时关闭数据写服务，这意味着关闭词条编辑功能。Wikipedia通过约束业务获得更大的技术方案选择余地，很多时候业务后退一小步，技术就可以前进一大步。</li>
</ul>
</body>
</html>
