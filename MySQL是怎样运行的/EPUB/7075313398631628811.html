
        <html lang="en">
        <head>
        <meta charset="UTF-8"/>
        </head>
        <body>
        <div><div class="markdown-body">
    <h1>&#19987;&#39064;&#24335;&#35762;&#35299; &#8212;&#8212; MySQL&#20171;&#20110;&#26222;&#36890;&#35835;&#21644;&#38145;&#23450;&#35835;&#30340;&#21152;&#38145;&#26041;&#24335;&#8212;&#8212; semi-consistent read</h1>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="style/style.css" type="text/css">

<div class="markdown-body">
    <h1>
 MySQL&#20171;&#20110;&#26222;&#36890;&#35835;&#21644;&#38145;&#23450;&#35835;&#30340;&#21152;&#38145;&#26041;&#24335;&#8212;&#8212; semi-consistent read
</h1>
<p>
 &#26631;&#31614;&#65306; MySQL&#26159;&#24590;&#26679;&#36816;&#34892;&#30340;
</p>
<hr>
<h2>
 &#20107;&#21069;&#20934;&#22791;
</h2>
<p>
 &#20026;&#20102;&#25925;&#20107;&#30340;&#39034;&#21033;&#21457;&#23637;&#65292;&#25105;&#20204;&#20808;&#24314;&#19968;&#20010;&#34920;&#65292;&#24182;&#21521;&#34920;&#20013;&#25554;&#20837;&#19968;&#20123;&#35760;&#24405;&#65292;&#19979;&#36793;&#26159;SQL&#35821;&#21477;&#65306;
</p>
<pre><code>CREATE TABLE hero (
    number INT,
    name VARCHAR(100),
    country varchar(100),
    PRIMARY KEY (number),
    KEY idx_name (name)
) Engine=InnoDB CHARSET=utf8;

INSERT INTO hero VALUES
    (1, 'l&#21016;&#22791;', '&#34560;'),
    (3, 'z&#35832;&#33883;&#20142;', '&#34560;'),
    (8, 'c&#26361;&#25805;', '&#39759;'),
    (15, 'x&#33600;&#24423;', '&#39759;'),
    (20, 's&#23385;&#26435;', '&#21556;');
</code></pre>
<p>
 &#29616;&#22312;
 <code>
  hero
 </code>
 &#34920;&#20013;&#30340;&#35760;&#24405;&#24773;&#20917;&#23601;&#22914;&#19979;&#25152;&#31034;&#65306;
</p>
<pre><code>mysql&gt; SELECT * FROM hero;
+--------+------------+---------+
| number | name       | country |
+--------+------------+---------+
|      1 | l&#21016;&#22791;      | &#34560;      |
|      3 | z&#35832;&#33883;&#20142;    | &#34560;      |
|      8 | c&#26361;&#25805;      | &#39759;      |
|     15 | x&#33600;&#24423;      | &#39759;      |
|     20 | s&#23385;&#26435;      | &#21556;      |
+--------+------------+---------+
5 rows in set (0.01 sec)
</code></pre>
<h2>
 &#29616;&#35937;
</h2>
<p>
 &#22312;&#23567;&#20876;&#31572;&#30097;&#32676;&#37324;&#26377;&#19968;&#20301;&#21516;&#23398;&#25552;&#20102;&#19968;&#20010;&#38382;&#39064;&#65306;&#35828;&#26159;&#22312;
 <code>
  READ COMMITTED
 </code>
 &#38548;&#31163;&#32423;&#21035;&#19979;&#21457;&#29983;&#20102;&#19968;&#20214;&#30334;&#24605;&#19981;&#24471;&#20854;&#35299;&#30340;&#20107;&#20799;&#12290;&#22909;&#30340;&#65292;&#39318;&#20808;&#26500;&#36896;&#29615;&#22659;&#65292;&#23558;&#24403;&#21069;&#20250;&#35805;&#40664;&#35748;&#30340;&#38548;&#31163;&#32423;&#21035;&#35774;&#32622;&#25104;
 <code>
  READ COMMITTED
 </code>
 &#65306;
</p>
<pre><code>mysql&gt; SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<p>
 &#20107;&#21153;
 <code>
  T1
 </code>
 &#20808;&#25191;&#34892;&#65306;
</p>
<pre><code># T1&#20013;&#65292;&#38548;&#31163;&#32423;&#21035;&#20026;READ COMMITTED
mysql&gt; BEGIN;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SELECT * FROM hero WHERE country = '&#39759;' FOR UPDATE;
+--------+---------+---------+
| number | name    | country |
+--------+---------+---------+
|      8 | c&#26361;&#25805;   | &#39759;      |
|     15 | x&#33600;&#24423;   | &#39759;      |
+--------+---------+---------+
2 rows in set (0.01 sec)
</code></pre>
<p>
 <code>
  country
 </code>
 &#21015;&#24182;&#19981;&#26159;&#32034;&#24341;&#21015;&#65292;&#25152;&#20197;&#26412;&#26465;&#35821;&#21477;&#25191;&#34892;&#26102;&#32943;&#23450;&#26159;&#20351;&#29992;&#25195;&#25551;&#32858;&#31751;&#32034;&#24341;&#30340;&#20840;&#34920;&#25195;&#25551;&#26041;&#24335;&#26469;&#25191;&#34892;&#65292;
 <code>
  EXPLAIN
 </code>
 &#35821;&#21477;&#20063;&#35777;&#26126;&#20102;&#25105;&#20204;&#30340;&#24819;&#27861;&#65306;
</p>
<pre><code>mysql&gt; EXPLAIN SELECT * FROM hero WHERE country = '&#39759;' FOR UPDATE;
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | hero  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    5 |    20.00 | Using where |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 1 warning (0.02 sec)
</code></pre>
<p>
 &#25105;&#20204;&#20043;&#21069;&#23398;&#36807;MySQL&#35821;&#21477;&#30340;&#21152;&#38145;&#20998;&#26512;&#65292;&#30693;&#36947;
 <span>
  &#22312;
  <code>
   READ COMMITTED
  </code>
  &#38548;&#31163;&#32423;&#21035;&#19979;&#65292;&#22914;&#26524;&#37319;&#29992;&#20840;&#34920;&#25195;&#25551;&#30340;&#26041;&#24335;&#25191;&#34892;&#26597;&#35810;&#35821;&#21477;&#26102;&#65292;InnoDB&#23384;&#20648;&#24341;&#25806;&#23558;&#20381;&#27425;&#23545;&#27599;&#26465;&#35760;&#24405;&#21152;&#27491;&#32463;&#35760;&#24405;&#38145;&#65292;&#22312;server&#23618;&#27979;&#35797;&#35813;&#35760;&#24405;&#26159;&#21542;&#31526;&#21512;WHERE&#26465;&#20214;&#65292;&#22914;&#26524;&#19981;&#31526;&#21512;&#21017;&#23558;&#21152;&#22312;&#35813;&#35760;&#24405;&#19978;&#30340;&#38145;&#37322;&#25918;&#25481;
 </span>
 &#12290;&#26412;&#20363;&#20013;&#20351;&#29992;
 <code>
  FOR UPDATE
 </code>
 &#35821;&#21477;&#65292;&#32943;&#23450;&#21152;&#30340;&#26159;X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;&#12290;&#21482;&#26377;&#20004;&#26465;&#35760;&#24405;&#31526;&#21512;
 <code>
  WHERE
 </code>
 &#26465;&#20214;&#65292;&#25152;&#20197;&#26368;&#32456;&#20854;&#23454;&#21482;&#23545;&#36825;&#20004;&#26465;&#31526;&#21512;&#26465;&#20214;&#30340;&#35760;&#24405;&#21152;&#20102;
 <code>
  X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
 </code>
 &#65288;&#23601;&#26159;
 <code>
  number
 </code>
 &#21015;&#20540;&#20026;
 <code>
  8
 </code>
 &#21644;
 <code>
  15
 </code>
 &#30340;&#20004;&#26465;&#35760;&#24405;&#65289;&#12290;&#24403;&#28982;&#65292;&#25105;&#20204;&#21487;&#20197;&#20351;&#29992;
 <code>
  SHOW ENGINE INNODB STATUS
 </code>
 &#21629;&#20196;&#35777;&#26126;&#25105;&#20204;&#30340;&#20998;&#26512;&#65306;
</p>
<pre><code>mysql&gt; SHOW ENGINE INNODB STATUS\G
... &#30465;&#30053;&#20102;&#24456;&#22810;&#20869;&#23481;

------------
TRANSACTIONS
------------
Trx id counter 39764
Purge done for trx's n:o &lt; 39763 undo n:o &lt; 0 state: running but idle
History list length 36
Total number of lock structs in row lock hash table 1
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 281479653009568, not started
0 lock struct(s), heap size 1160, 0 row lock(s)
---TRANSACTION 281479653012832, not started
0 lock struct(s), heap size 1160, 0 row lock(s)
---TRANSACTION 39763, ACTIVE 468 sec
2 lock struct(s), heap size 1160, 2 row lock(s)
MySQL thread id 19, OS thread handle 123145470611456, query id 586 localhost 127.0.0.1 root
TABLE LOCK table `xiaohaizi`.`hero` trx id 39763 lock mode IX
RECORD LOCKS space id 287 page no 3 n bits 72 index PRIMARY of table `xiaohaizi`.`hero` trx id 39763 lock_mode X locks rec but not gap
Record lock, heap no 4 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 80000008; asc     ;;
 1: len 6; hex 000000009b4a; asc      J;;
 2: len 7; hex 80000001d3012a; asc       *;;
 3: len 7; hex 63e69bb9e6938d; asc c      ;;
 4: len 3; hex e9ad8f; asc    ;;

Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 8000000f; asc     ;;
 1: len 6; hex 000000009b4a; asc      J;;
 2: len 7; hex 80000001d30137; asc       7;;
 3: len 7; hex 78e88d80e5bda7; asc x      ;;
 4: len 3; hex e9ad8f; asc    ;;

 ... &#30465;&#30053;&#20102;&#24456;&#22810;&#20869;&#23481;
</code></pre>
<p>
 &#20854;&#20013;
 <code>
  id
 </code>
 &#20026;
 <code>
  39763
 </code>
 &#30340;&#20107;&#21153;&#23601;&#26159;&#25351;
 <code>
  T1
 </code>
 &#65292;&#21487;&#20197;&#30475;&#20986;&#23427;&#20026;
 <code>
  heap no
 </code>
 &#20540;&#20026;
 <code>
  4
 </code>
 &#21644;
 <code>
  5
 </code>
 &#30340;&#20004;&#26465;&#35760;&#24405;&#21152;&#20102;
 <code>
  X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
 </code>
 &#65288;lock_mode X locks rec but not gap&#65289;&#12290;
</p>
<p>
 &#28982;&#21518;&#20877;&#24320;&#21551;&#19968;&#20010;&#38548;&#31163;&#32423;&#21035;&#20063;&#20026;
 <code>
  READ COMMITTED
 </code>
 &#30340;&#20107;&#21153;
 <code>
  T2
 </code>
 &#65292;&#22312;&#20854;&#20013;&#25191;&#34892;&#65306;
</p>
<pre><code># T2&#20013;&#65292;&#38548;&#31163;&#32423;&#21035;&#20026;READ COMMITTED
mysql&gt; BEGIN;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SELECT * FROM hero WHERE country = '&#21556;' FOR UPDATE;
(&#36827;&#20837;&#38459;&#22622;&#29366;&#24577;)
</code></pre>
<p>
 &#24456;&#26174;&#28982;&#65292;&#36825;&#26465;&#35821;&#21477;&#20063;&#20250;&#37319;&#29992;&#20840;&#34920;&#25195;&#25551;&#30340;&#26041;&#24335;&#26469;&#25191;&#34892;&#65292;&#20250;&#20381;&#27425;&#21435;&#33719;&#21462;&#27599;&#19968;&#26465;&#32858;&#31751;&#32034;&#24341;&#35760;&#24405;&#30340;&#38145;&#12290;&#19981;&#36807;&#22240;&#20026;
 <code>
  number
 </code>
 &#20540;&#20026;
 <code>
  8
 </code>
 &#30340;&#35760;&#24405;&#24050;&#32463;&#34987;
 <code>
  T1
 </code>
 &#21152;&#20102;
 <code>
  X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
 </code>
 &#65292;
 <code>
  T2
 </code>
 &#24819;&#24471;&#21364;&#24471;&#19981;&#21040;&#65292;&#21482;&#33021;&#30524;&#24052;&#24052;&#30340;&#36827;&#34892;&#38459;&#22622;&#29366;&#24577;&#65292;&#27492;&#26102;&#30340;
 <code>
  SHOW ENGINE INNODB STATUS
 </code>
 &#20063;&#33021;&#35777;&#26126;&#25105;&#20204;&#30340;&#29468;&#24819;&#65288;&#21482;&#25130;&#21462;&#20102;&#19968;&#37096;&#20998;&#65289;&#65306;
</p>
<pre><code>---TRANSACTION 39764, ACTIVE 34 sec fetching rows
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1160, 1 row lock(s)
MySQL thread id 20, OS thread handle 123145471168512, query id 590 localhost 127.0.0.1 root Sending data
SELECT * FROM hero WHERE country = '&#21556;' FOR UPDATE
------- TRX HAS BEEN WAITING 34 SEC FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 287 page no 3 n bits 72 index PRIMARY of table `xiaohaizi`.`hero` trx id 39764 lock_mode X locks rec but not gap waiting
Record lock, heap no 4 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 80000008; asc     ;;
 1: len 6; hex 000000009b4a; asc      J;;
 2: len 7; hex 80000001d3012a; asc       *;;
 3: len 7; hex 63e69bb9e6938d; asc c      ;;
 4: len 3; hex e9ad8f; asc    ;;
</code></pre>
<p>
 &#21487;&#20197;&#30475;&#21040;
 <code>
  T2
 </code>
 &#27491;&#22312;&#31561;&#24453;&#33719;&#21462;
 <code>
  heap no
 </code>
 &#20026;
 <code>
  4
 </code>
 &#30340;&#35760;&#24405;&#19978;&#30340;
 <code>
  X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
 </code>
 &#65288;lock_mode X locks rec but not gap waiting&#65289;&#12290;
</p>
<p>
 &#20197;&#19978;&#26159;&#24456;&#27491;&#24120;&#30340;&#38459;&#22622;&#36923;&#36753;&#65292;&#25105;&#20204;&#37117;&#21487;&#20197;&#20998;&#26512;&#20986;&#26469;&#65292;&#19981;&#36807;&#22914;&#26524;&#22312;
 <code>
  T2
 </code>
 &#20013;&#25191;&#34892;&#19979;&#36793;&#30340;
 <code>
  UPDATE
 </code>
 &#35821;&#21477;&#65306;
</p>
<pre><code># T2&#20013;&#65292;&#38548;&#31163;&#32423;&#21035;&#20026;READ COMMITTED
mysql&gt; BEGIN;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; UPDATE hero SET name = 'xxx' WHERE country = '&#21556;';
Query OK, 1 row affected (0.02 sec)
Rows matched: 1  Changed: 1  Warnings: 0
</code></pre>
<p>
 WTF? &#31455;&#28982;&#27809;&#26377;&#38459;&#22622;&#65292;&#23601;&#36825;&#20040;&#38543;&#24847;&#22320;&#25191;&#34892;&#25104;&#21151;&#20102;&#65311;&#21516;&#26679;&#30340;
 <code>
  WHERE
 </code>
 &#26465;&#20214;&#65292;&#21516;&#26679;&#30340;&#25191;&#34892;&#35745;&#21010;&#65292;&#24590;&#20040;
 <code>
  SELECT ... FOR UPDATE
 </code>
 &#21644;
 <code>
  UPDATE
 </code>
 &#35821;&#21477;&#30340;&#21152;&#38145;&#24773;&#20917;&#19981;&#19968;&#26679;&#65311;
</p>
<h2>
 &#21407;&#22240;
</h2>
<p>
 &#21704;&#21704;&#65292;&#26159;&#30340;&#65292;&#30340;&#30830;&#19981;&#19968;&#26679;&#12290;&#20854;&#23454;MySQL&#25903;&#25345;3&#31181;&#31867;&#22411;&#30340;&#35835;&#35821;&#21477;&#65306;
</p>
<ul>
 <li>
  <p>
   &#26222;&#36890;&#35835;&#65288;&#20063;&#31216;&#19968;&#33268;&#24615;&#35835;&#65292;&#33521;&#25991;&#21517;&#65306;Consistent Read&#65289;&#12290;
  </p>
  <p>
   &#36825;&#20010;&#23601;&#26159;&#25351;&#26222;&#36890;&#30340;SELECT&#35821;&#21477;&#65292;&#22312;&#26411;&#23614;&#19981;&#21152;
   <code>
    FOR UPDATE
   </code>
   &#25110;&#32773;
   <code>
    LOCK IN SHARE MODE
   </code>
   &#30340;SELECT&#35821;&#21477;&#12290;&#26222;&#36890;&#35835;&#30340;&#25191;&#34892;&#26041;&#24335;&#26159;&#29983;&#25104;
   <code>
    ReadView
   </code>
   &#30452;&#25509;&#21033;&#29992;MVCC&#26426;&#21046;&#26469;&#36827;&#34892;&#35835;&#21462;&#65292;&#24182;&#19981;&#20250;&#23545;&#35760;&#24405;&#36827;&#34892;&#21152;&#38145;&#12290;
  </p>
  <blockquote>
   <p>
    &#23567;&#36148;&#22763;&#65306;
    <br>
    <br>
    &#23545;&#20110;SERIALIZABLE&#38548;&#31163;&#32423;&#21035;&#26469;&#35828;&#65292;&#22914;&#26524;autocommit&#31995;&#32479;&#21464;&#37327;&#34987;&#35774;&#32622;&#20026;OFF&#65292;&#37027;&#26222;&#36890;&#35835;&#30340;&#35821;&#21477;&#20250;&#36716;&#21464;&#20026;&#38145;&#23450;&#35835;&#65292;&#21644;&#22312;&#26222;&#36890;&#30340;SELECT&#35821;&#21477;&#21518;&#36793;&#21152;LOCK IN SHARE MODE&#36798;&#25104;&#30340;&#25928;&#26524;&#19968;&#26679;&#12290;
   </p>
  </blockquote>
 </li>
 <li>
  <p>
   &#38145;&#23450;&#35835;&#65288;&#33521;&#25991;&#21517;&#65306;Locking Read&#65289;&#12290;
  </p>
  <p>
   &#36825;&#20010;&#23601;&#26159;&#20107;&#21153;&#22312;&#35835;&#21462;&#35760;&#24405;&#20043;&#21069;&#65292;&#38656;&#35201;&#20808;&#33719;&#21462;&#35813;&#35760;&#24405;&#23545;&#24212;&#30340;&#38145;&#12290;&#24403;&#28982;&#65292;&#33719;&#21462;&#20160;&#20040;&#31867;&#22411;&#30340;&#38145;&#21462;&#20915;&#20110;&#24403;&#21069;&#20107;&#21153;&#30340;&#38548;&#31163;&#32423;&#21035;&#12289;&#35821;&#21477;&#30340;&#25191;&#34892;&#35745;&#21010;&#12289;&#26597;&#35810;&#26465;&#20214;&#31561;&#22240;&#32032;&#65292;&#20855;&#20307;&#21487;&#21442;&#35265;&#65306;
  </p>
 </li>
 <li>
  <p>
   &#21322;&#19968;&#33268;&#24615;&#35835;&#65288;&#33521;&#25991;&#21517;&#65306;Semi-Consistent Read&#65289;&#12290;
  </p>
  <p>
   &#36825;&#26159;&#19968;&#31181;&#22841;&#22312;&#26222;&#36890;&#35835;&#21644;&#38145;&#23450;&#35835;&#20043;&#38388;&#30340;&#19968;&#31181;&#35835;&#21462;&#26041;&#24335;&#12290;&#23427;&#21482;&#22312;
   <code>
    READ COMMITTED
   </code>
   &#38548;&#31163;&#32423;&#21035;&#19979;&#65288;&#25110;&#32773;&#22312;&#24320;&#21551;&#20102;innodb_locks_unsafe_for_binlog&#31995;&#32479;&#21464;&#37327;&#30340;&#24773;&#20917;&#19979;&#65289;&#20351;&#29992;
   <code>
    UPDATE
   </code>
   &#35821;&#21477;&#26102;&#25165;&#20250;&#20351;&#29992;&#12290;&#20855;&#20307;&#30340;&#21547;&#20041;&#23601;&#26159;&#24403;
   <code>
    UPDATE
   </code>
   &#35821;&#21477;&#35835;&#21462;&#24050;&#32463;&#34987;&#20854;&#20182;&#20107;&#21153;&#21152;&#20102;&#38145;&#30340;&#35760;&#24405;&#26102;&#65292;
   <code>
    InnoDB
   </code>
   &#20250;&#23558;&#35813;&#35760;&#24405;&#30340;&#26368;&#26032;&#25552;&#20132;&#30340;&#29256;&#26412;&#35835;&#20986;&#26469;&#65292;&#28982;&#21518;&#21028;&#26029;&#35813;&#29256;&#26412;&#26159;&#21542;&#19982;
   <code>
    UPDATE
   </code>
   &#35821;&#21477;&#20013;&#30340;
   <code>
    WHERE
   </code>
   &#26465;&#20214;&#30456;&#21305;&#37197;&#65292;&#22914;&#26524;&#19981;&#21305;&#37197;&#21017;&#19981;&#23545;&#35813;&#35760;&#24405;&#21152;&#38145;&#65292;&#20174;&#32780;&#36339;&#21040;&#19979;&#19968;&#26465;&#35760;&#24405;&#65307;&#22914;&#26524;&#21305;&#37197;&#21017;&#20877;&#27425;&#35835;&#21462;&#35813;&#35760;&#24405;&#24182;&#23545;&#20854;&#36827;&#34892;&#21152;&#38145;&#12290;&#36825;&#26679;&#23376;&#22788;&#29702;&#21482;&#26159;&#20026;&#20102;&#35753;
   <code>
    UPDATE
   </code>
   &#35821;&#21477;&#23613;&#37327;&#23569;&#34987;&#21035;&#30340;&#35821;&#21477;&#38459;&#22622;&#12290;
  </p>
  <blockquote>
   <p>
    &#23567;&#36148;&#22763;&#65306;
    <br>
    <br>
    &#21322;&#19968;&#33268;&#24615;&#35835;&#21482;&#36866;&#29992;&#20110;&#23545;&#32858;&#31751;&#32034;&#24341;&#35760;&#24405;&#21152;&#38145;&#30340;&#24773;&#20917;&#65292;&#24182;&#19981;&#36866;&#29992;&#20110;&#23545;&#20108;&#32423;&#32034;&#24341;&#35760;&#24405;&#21152;&#38145;&#30340;&#24773;&#20917;&#12290;
   </p>
  </blockquote>
 </li>
</ul>
<p>
 &#24456;&#26174;&#28982;&#65292;&#25105;&#20204;&#19978;&#36793;&#25152;&#21792;&#21480;&#30340;&#20363;&#23376;&#20013;&#26159;&#22240;&#20026;&#20107;&#21153;
 <code>
  T2
 </code>
 &#25191;&#34892;
 <code>
  UPDATE
 </code>
 &#35821;&#21477;&#26102;&#20351;&#29992;&#20102;&#21322;&#19968;&#33268;&#24615;&#35835;&#65292;&#21028;&#26029;
 <code>
  number
 </code>
 &#21015;&#20540;&#20026;
 <code>
  8
 </code>
 &#21644;
 <code>
  15
 </code>
 &#36825;&#20004;&#26465;&#35760;&#24405;&#30340;&#26368;&#26032;&#25552;&#20132;&#29256;&#26412;&#30340;
 <code>
  country
 </code>
 &#21015;&#20540;&#22343;&#19981;&#20026;
 <code>
  UPDATE
 </code>
 &#35821;&#21477;&#20013;
 <code>
  WHERE
 </code>
 &#26465;&#20214;&#20013;&#30340;
 <code>
  '&#21556;'
 </code>
 &#65292;&#25152;&#20197;&#30452;&#25509;&#23601;&#36339;&#36807;&#23427;&#20204;&#65292;&#19981;&#23545;&#23427;&#20204;&#21152;&#38145;&#20102;&#12290;
</p>
<p>
 &#26412;&#30693;&#35782;&#28857;&#23481;&#26131;&#34987;&#24573;&#30053;&#65292;&#21508;&#20301;&#21516;&#23398;&#22312;&#24037;&#20316;&#36807;&#31243;&#20013;&#20998;&#26512;&#30340;&#26102;&#20505;&#21035;&#24536;&#35760;&#32771;&#34385;&#19968;&#19979;
 <code>
  Semi-Consistent Read
 </code>
 &#21908;&#65292;&#30721;&#23383;&#19981;&#26131;&#65292;&#26377;&#24110;&#21161;&#24110;&#30528;&#36716;&#21457;&#21908;&#65292;&#20040;&#20040;&#21714;&#65374;
</p>
<h1>
 &#27515;&#38145;&#20998;&#26512;
</h1>
<p>
 &#26631;&#31614;&#65306; MySQL&#26159;&#24590;&#26679;&#36816;&#34892;&#30340;
</p>
<hr>
<p>
 &#22914;&#26524;&#25105;&#20204;&#30340;&#19994;&#21153;&#22788;&#22312;&#19968;&#20010;&#38750;&#24120;&#21021;&#32423;&#30340;&#38454;&#27573;&#65292;&#24182;&#21457;&#31243;&#24230;&#27604;&#36739;&#20302;&#65292;&#37027;&#20040;&#25105;&#20204;&#21487;&#20197;&#20960;&#24180;&#37117;&#36935;&#19981;&#21040;&#19968;&#27425;&#27515;&#38145;&#38382;&#39064;&#30340;&#21457;&#29983;&#65292;&#21453;&#20043;&#65292;&#25105;&#20204;&#19994;&#21153;&#30340;&#24182;&#21457;&#31243;&#24230;&#38750;&#24120;&#39640;&#65292;&#37027;&#20040;&#26102;&#19981;&#26102;&#29190;&#20986;&#30340;&#27515;&#38145;&#38382;&#39064;&#32943;&#23450;&#35753;&#25105;&#20204;&#38750;&#24120;&#25376;&#22836;&#12290;&#19981;&#36807;&#22312;&#27515;&#38145;&#38382;&#39064;&#21457;&#29983;&#26102;&#65292;&#24456;&#22810;&#27809;&#26377;&#32463;&#39564;&#30340;&#21516;&#23398;&#30340;&#31532;&#19968;&#21453;&#24212;&#23601;&#26159;&#25104;&#20026;&#19968;&#30452;&#40501;&#40479;&#65306;&#36825;&#29609;&#24847;&#20799;&#24456;&#39640;&#28145;&#65292;&#25105;&#20063;&#30475;&#19981;&#25026;&#65292;&#21548;&#22825;&#30001;&#21629;&#21543;&#65292;&#21448;&#19981;&#26159;&#19968;&#30452;&#21457;&#29983;&#12290;&#20854;&#23454;&#22914;&#26524;&#22823;&#23478;&#35748;&#30495;&#30740;&#35835;&#20102;&#25105;&#20204;&#20043;&#21069;&#20889;&#20102;3&#31687;&#20851;&#20110;
 <code>
  MySQL
 </code>
 &#20013;&#35821;&#21477;&#21152;&#38145;&#20998;&#26512;&#30340;&#25991;&#31456;&#65292;&#21152;&#19978;&#26412;&#31687;&#20851;&#20110;&#27515;&#38145;&#26085;&#24535;&#30340;&#20998;&#26512;&#65292;&#37027;&#20040;&#35299;&#20915;&#27515;&#38145;&#38382;&#39064;&#24212;&#35813;&#20063;&#19981;&#26159;&#37027;&#20040;&#25720;&#19981;&#30528;&#22836;&#33041;&#30340;&#20107;&#24773;&#20102;&#12290;
</p>
<h2>
 &#20934;&#22791;&#24037;&#20316;
</h2>
<p>
 &#20026;&#20102;&#25925;&#20107;&#30340;&#39034;&#21033;&#21457;&#23637;&#65292;&#25105;&#20204;&#38656;&#35201;&#24314;&#19968;&#20010;&#34920;&#65306;
</p>
<pre><code>CREATE TABLE hero (
    id INT,
    name VARCHAR(100),
    country varchar(100),
    PRIMARY KEY (id),
    KEY idx_name (name)
) Engine=InnoDB CHARSET=utf8;
</code></pre>
<p>
 &#25105;&#20204;&#20026;hero&#34920;&#30340;id&#21015;&#21019;&#24314;&#20102;&#32858;&#31751;&#32034;&#24341;&#65292;&#20026;name&#21015;&#21019;&#24314;&#20102;&#19968;&#20010;&#20108;&#32423;&#32034;&#24341;&#12290;&#36825;&#20010;hero&#34920;&#20027;&#35201;&#26159;&#20026;&#20102;&#23384;&#20648;&#19977;&#22269;&#26102;&#30340;&#19968;&#20123;&#33521;&#38596;&#65292;&#25105;&#20204;&#21521;&#34920;&#20013;&#25554;&#20837;&#19968;&#20123;&#35760;&#24405;&#65306;
</p>
<pre><code>INSERT INTO hero VALUES
    (1, 'l&#21016;&#22791;', '&#34560;'),
    (3, 'z&#35832;&#33883;&#20142;', '&#34560;'),
    (8, 'c&#26361;&#25805;', '&#39759;'),
    (15, 'x&#33600;&#24423;', '&#39759;'),
    (20, 's&#23385;&#26435;', '&#21556;');
</code></pre>
<p>
 &#29616;&#22312;&#34920;&#20013;&#30340;&#25968;&#25454;&#23601;&#26159;&#36825;&#26679;&#30340;&#65306;
</p>
<pre><code>mysql&gt; SELECT * FROM hero;
+----+------------+---------+
| id | name       | country |
+----+------------+---------+
|  1 | l&#21016;&#22791;      | &#34560;      |
|  3 | z&#35832;&#33883;&#20142;    | &#34560;      |
|  8 | c&#26361;&#25805;      | &#39759;      |
| 15 | x&#33600;&#24423;      | &#39759;      |
| 20 | s&#23385;&#26435;      | &#21556;      |
+----+------------+---------+
5 rows in set (0.00 sec)
</code></pre>
<p>
 &#20934;&#22791;&#24037;&#20316;&#23601;&#20570;&#23436;&#20102;&#12290;
</p>
<h2>
 &#21019;&#24314;&#27515;&#38145;&#24773;&#26223;
</h2>
<p>
 &#25105;&#20204;&#20808;&#21019;&#24314;&#19968;&#20010;&#21457;&#29983;&#27515;&#38145;&#30340;&#24773;&#26223;&#65292;&#22312;
 <code>
  Session A
 </code>
 &#21644;
 <code>
  Session B
 </code>
 &#20013;&#20998;&#21035;&#25191;&#34892;&#20004;&#20010;&#20107;&#21153;&#65292;&#20855;&#20307;&#24773;&#20917;&#22914;&#19979;&#65306;
</p>
<p>
 <img alt="" src="EPUB/4de812e8-13d6-11ed-838d-acde48001122">
</p>
<p>
 &#25105;&#20204;&#20998;&#26512;&#19968;&#19979;&#65306;
</p>
<ul>
 <li>
  <p>
   &#20174;&#31532;&#9314;&#27493;&#20013;&#21487;&#20197;&#30475;&#20986;&#65292;
   <code>
    Session A
   </code>
   &#20013;&#30340;&#20107;&#21153;&#20808;&#23545;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#30340;
   <code>
    id
   </code>
   &#20540;&#20026;1&#30340;&#35760;&#24405;&#21152;&#20102;&#19968;&#20010;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#12290;
  </p>
 </li>
 <li>
  <p>
   &#20174;&#31532;&#9315;&#27493;&#20013;&#21487;&#20197;&#30475;&#20986;&#65292;
   <code>
    Session B
   </code>
   &#20013;&#30340;&#20107;&#21153;&#23545;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#30340;
   <code>
    id
   </code>
   &#20540;&#20026;3&#30340;&#35760;&#24405;&#21152;&#20102;&#19968;&#20010;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#12290;
  </p>
 </li>
 <li>
  <p>
   &#20174;&#31532;&#9316;&#27493;&#20013;&#21487;&#20197;&#30475;&#20986;&#65292;
   <code>
    Session A
   </code>
   &#20013;&#30340;&#20107;&#21153;&#25509;&#30528;&#24819;&#23545;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#30340;
   <code>
    id
   </code>
   &#20540;&#20026;3&#30340;&#35760;&#24405;&#20063;&#21152;&#20102;&#19968;&#20010;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65292;&#20294;&#26159;&#19982;&#31532;&#9315;&#27493;&#20013;
   <code>
    Session B
   </code>
   &#20013;&#30340;&#20107;&#21153;&#21152;&#30340;&#38145;&#20914;&#31361;&#65292;&#25152;&#20197;
   <code>
    Session A
   </code>
   &#36827;&#20837;&#38459;&#22622;&#29366;&#24577;&#65292;&#31561;&#24453;&#33719;&#21462;&#38145;&#12290;
  </p>
 </li>
 <li>
  <p>
   &#20174;&#31532;&#9317;&#27493;&#20013;&#21487;&#20197;&#30475;&#20986;&#65292;
   <code>
    Session B
   </code>
   &#20013;&#30340;&#20107;&#21153;&#24819;&#23545;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#30340;
   <code>
    id
   </code>
   &#20540;&#20026;1&#30340;&#35760;&#24405;&#21152;&#20102;&#19968;&#20010;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65292;&#20294;&#26159;&#19982;&#31532;&#9314;&#27493;&#20013;
   <code>
    Session A
   </code>
   &#20013;&#30340;&#20107;&#21153;&#21152;&#30340;&#38145;&#20914;&#31361;&#65292;&#32780;&#27492;&#26102;
   <code>
    Session A
   </code>
   &#21644;
   <code>
    Session B
   </code>
   &#20013;&#30340;&#20107;&#21153;&#24490;&#29615;&#31561;&#24453;&#23545;&#26041;&#25345;&#26377;&#30340;&#38145;&#65292;&#27515;&#38145;&#21457;&#29983;&#65292;&#34987;
   <code>
    MySQL
   </code>
   &#26381;&#21153;&#22120;&#30340;&#27515;&#38145;&#26816;&#27979;&#26426;&#21046;&#26816;&#27979;&#21040;&#20102;&#65292;&#25152;&#20197;&#36873;&#25321;&#20102;&#19968;&#20010;&#20107;&#21153;&#36827;&#34892;&#22238;&#28378;&#65292;&#24182;&#21521;&#23458;&#25143;&#31471;&#21457;&#36865;&#19968;&#26465;&#28040;&#24687;&#65306;
  </p>
  <pre><code>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction
</code></pre>
 </li>
</ul>
<p>
 &#20197;&#19978;&#26159;&#25105;&#20204;&#20174;&#35821;&#21477;&#21152;&#20102;&#20160;&#20040;&#38145;&#30340;&#35282;&#24230;&#20986;&#21457;&#26469;&#36827;&#34892;&#27515;&#38145;&#24773;&#20917;&#20998;&#26512;&#30340;&#65292;&#20294;&#26159;&#23454;&#38469;&#24212;&#29992;&#20013;&#25105;&#20204;&#21487;&#33021;&#21387;&#26681;&#20799;&#19981;&#30693;&#36947;&#21040;&#24213;&#26159;&#21738;&#20960;&#26465;&#35821;&#21477;&#20135;&#29983;&#20102;&#27515;&#38145;&#65292;&#25105;&#20204;&#38656;&#35201;&#26681;&#25454;
 <code>
  MySQL
 </code>
 &#22312;&#27515;&#38145;&#21457;&#29983;&#26102;&#20135;&#29983;&#30340;&#27515;&#38145;&#26085;&#24535;&#26469;&#36870;&#21521;&#23450;&#20301;&#19968;&#19979;&#21040;&#24213;&#26159;&#20160;&#20040;&#35821;&#21477;&#20135;&#29983;&#20102;&#27515;&#38145;&#65292;&#20174;&#32780;&#20877;&#20248;&#21270;&#25105;&#20204;&#30340;&#19994;&#21153;&#12290;
</p>
<h3>
 &#26597;&#30475;&#27515;&#38145;&#26085;&#24535;
</h3>
<p>
 &#35774;&#35745;
 <code>
  InnoDB
 </code>
 &#30340;&#22823;&#21460;&#32473;&#25105;&#20204;&#25552;&#20379;&#20102;
 <code>
  SHOW ENGINE INNODB STATUS
 </code>
 &#21629;&#20196;&#26469;&#26597;&#30475;&#20851;&#20110;InnoDB&#23384;&#20648;&#24341;&#25806;&#30340;&#19968;&#20123;&#29366;&#24577;&#20449;&#24687;&#65292;&#20854;&#20013;&#23601;&#21253;&#25324;&#20102;&#31995;&#32479;&#26368;&#36817;&#19968;&#27425;&#21457;&#29983;&#27515;&#38145;&#26102;&#30340;&#21152;&#38145;&#24773;&#20917;&#12290;&#22312;&#19978;&#36793;&#20363;&#23376;&#20013;&#30340;&#27515;&#38145;&#21457;&#29983;&#26102;&#65292;&#25105;&#20204;&#36816;&#34892;&#19968;&#19979;&#36825;&#20010;&#21629;&#20196;&#65306;
</p>
<pre><code>mysql&gt; SHOW ENGINE INNODB STATUS\G
...&#30465;&#30053;&#20102;&#22909;&#22810;&#20854;&#20182;&#20449;&#24687;
------------------------
LATEST DETECTED DEADLOCK
------------------------
2019-06-20 13:39:19 0x70000697e000
*** (1) TRANSACTION:
TRANSACTION 30477, ACTIVE 10 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1160, 2 row lock(s)
MySQL thread id 2, OS thread handle 123145412648960, query id 46 localhost 127.0.0.1 root statistics
select * from hero where id = 3 for update
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 171 page no 3 n bits 72 index PRIMARY of table `dahaizi`.`hero` trx id 30477 lock_mode X locks rec but not gap waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 80000003; asc     ;;
 1: len 6; hex 000000007517; asc     u ;;
 2: len 7; hex 80000001d0011d; asc        ;;
 3: len 10; hex 7ae8afb8e8919be4baae; asc z         ;;
 4: len 3; hex e89c80; asc    ;;

*** (2) TRANSACTION:
TRANSACTION 30478, ACTIVE 8 sec starting index read
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1160, 2 row lock(s)
MySQL thread id 3, OS thread handle 123145412927488, query id 47 localhost 127.0.0.1 root statistics
select * from hero where id = 1 for update
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 171 page no 3 n bits 72 index PRIMARY of table `dahaizi`.`hero` trx id 30478 lock_mode X locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 80000003; asc     ;;
 1: len 6; hex 000000007517; asc     u ;;
 2: len 7; hex 80000001d0011d; asc        ;;
 3: len 10; hex 7ae8afb8e8919be4baae; asc z         ;;
 4: len 3; hex e89c80; asc    ;;

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 171 page no 3 n bits 72 index PRIMARY of table `dahaizi`.`hero` trx id 30478 lock_mode X locks rec but not gap waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 000000007517; asc     u ;;
 2: len 7; hex 80000001d00110; asc        ;;
 3: len 7; hex 6ce58898e5a487; asc l      ;;
 4: len 3; hex e89c80; asc    ;;

*** WE ROLL BACK TRANSACTION (2)
------------
...&#30465;&#30053;&#20102;&#22909;&#22810;&#20854;&#20182;&#20449;&#24687;
</code></pre>
<p>
 &#25105;&#20204;&#21482;&#20851;&#24515;&#26368;&#36817;&#21457;&#29983;&#30340;&#27515;&#38145;&#20449;&#24687;&#65292;&#25152;&#20197;&#23601;&#25226;&#20197;
 <code>
  LATEST DETECTED DEADLOCK
 </code>
 &#36825;&#19968;&#37096;&#20998;&#32473;&#21333;&#29420;&#25552;&#20986;&#26469;&#20998;&#26512;&#19968;&#19979;&#12290;&#19979;&#36793;&#25105;&#20204;&#23601;&#36880;&#34892;&#30475;&#19968;&#19979;&#36825;&#20010;&#36755;&#20986;&#30340;&#27515;&#38145;&#26085;&#24535;&#37117;&#26159;&#20160;&#20040;&#24847;&#24605;&#65306;
</p>
<ul>
 <li>
  <p>
   &#39318;&#20808;&#30475;&#31532;&#19968;&#21477;&#65306;
  </p>
  <pre><code>2019-06-20 13:39:19 0x70000697e000
</code></pre>
  <p>
   &#36825;&#21477;&#35805;&#30340;&#24847;&#24605;&#23601;&#26159;&#27515;&#38145;&#21457;&#29983;&#30340;&#26102;&#38388;&#26159;&#65306;2019-06-20 13:39:19&#65292;&#21518;&#36793;&#30340;&#19968;&#20018;&#21313;&#20845;&#36827;&#21046;
   <code>
    0x70000697e000
   </code>
   &#34920;&#31034;&#30340;&#25805;&#20316;&#31995;&#32479;&#20026;&#24403;&#21069;session&#20998;&#37197;&#30340;&#32447;&#31243;&#30340;&#32447;&#31243;id&#12290;
  </p>
 </li>
 <li>
  <p>
   &#28982;&#21518;&#26159;&#20851;&#20110;&#27515;&#38145;&#21457;&#29983;&#26102;&#31532;&#19968;&#20010;&#20107;&#21153;&#30340;&#26377;&#20851;&#20449;&#24687;&#65306;
  </p>
  <pre><code>*** (1) TRANSACTION:

# &#20026;&#20107;&#21153;&#20998;&#37197;&#30340;id&#20026;30477&#65292;&#20107;&#21153;&#22788;&#20110;ACTIVE&#29366;&#24577;&#24050;&#32463;10&#31186;&#20102;&#65292;&#20107;&#21153;&#29616;&#22312;&#27491;&#22312;&#20570;&#30340;&#25805;&#20316;&#23601;&#26159;&#65306;&#8220;starting index read&#8221;
TRANSACTION 30477, ACTIVE 10 sec starting index read

# &#27492;&#20107;&#21153;&#20351;&#29992;&#20102;1&#20010;&#34920;&#65292;&#20026;1&#20010;&#34920;&#19978;&#20102;&#38145;&#65288;&#27492;&#22788;&#19981;&#26159;&#35828;&#20026;&#35813;&#34920;&#21152;&#20102;&#34920;&#38145;&#65292;&#21482;&#35201;&#19981;&#26159;&#36827;&#34892;&#19968;&#33268;&#24615;&#35835;&#30340;&#34920;&#65292;&#37117;&#38656;&#35201;&#21152;&#38145;&#65292;&#20855;&#20307;&#24590;&#20040;&#21152;&#38145;&#35831;&#30475;&#21152;&#38145;&#35821;&#21477;&#20998;&#26512;&#25110;&#32773;&#23567;&#20876;&#31456;&#33410;&#65289;
mysql tables in use 1, locked 1

# &#27492;&#20107;&#21153;&#22788;&#20110;LOCK WAIT&#29366;&#24577;&#65292;&#25317;&#26377;3&#20010;&#38145;&#32467;&#26500;&#65288;2&#20010;&#34892;&#38145;&#32467;&#26500;&#65292;1&#20010;&#34920;&#32423;&#21035;X&#22411;&#24847;&#21521;&#38145;&#32467;&#26500;&#65292;&#38145;&#32467;&#26500;&#22312;&#23567;&#20876;&#20013;&#37325;&#28857;&#20171;&#32461;&#36807;&#65289;&#65292;heap size&#26159;&#20026;&#20102;&#23384;&#20648;&#38145;&#32467;&#26500;&#32780;&#30003;&#35831;&#30340;&#20869;&#23384;&#22823;&#23567;&#65288;&#25105;&#20204;&#21487;&#20197;&#24573;&#30053;&#65289;&#65292;&#20854;&#20013;&#26377;2&#20010;&#34892;&#38145;&#30340;&#32467;&#26500;
LOCK WAIT 3 lock struct(s), heap size 1160, 2 row lock(s)

# &#26412;&#20107;&#21153;&#25152;&#22312;&#32447;&#31243;&#30340;id&#26159;2&#65288;MySQL&#33258;&#24049;&#21629;&#21517;&#30340;&#32447;&#31243;id&#65289;&#65292;&#35813;&#32447;&#31243;&#22312;&#25805;&#20316;&#31995;&#32479;&#32423;&#21035;&#30340;id&#23601;&#26159;&#37027;&#19968;&#38271;&#20018;&#25968;&#23383;&#65292;&#24403;&#21069;&#26597;&#35810;&#30340;id&#20026;46&#65288;MySQL&#20869;&#37096;&#20351;&#29992;&#65292;&#21487;&#20197;&#24573;&#30053;&#65289;&#65292;&#36824;&#26377;&#29992;&#25143;&#21517;&#20027;&#26426;&#20449;&#24687;
MySQL thread id 2, OS thread handle 123145412648960, query id 46 localhost 127.0.0.1 root statistics

# &#26412;&#20107;&#21153;&#21457;&#29983;&#38459;&#22622;&#30340;&#35821;&#21477;
select * from hero where id = 3 for update

# &#26412;&#20107;&#21153;&#24403;&#21069;&#22312;&#31561;&#24453;&#33719;&#21462;&#30340;&#38145;&#65306;
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:

# &#31561;&#24453;&#33719;&#21462;&#30340;&#34920;&#31354;&#38388;ID&#20026;151&#65292;&#39029;&#21495;&#20026;3&#65292;&#20063;&#23601;&#26159;&#34920;hero&#30340;PRIMAY&#32034;&#24341;&#20013;&#30340;&#26576;&#26465;&#35760;&#24405;&#30340;&#38145;&#65288;n_bits&#26159;&#20026;&#20102;&#23384;&#20648;&#26412;&#39029;&#38754;&#30340;&#38145;&#20449;&#24687;&#32780;&#20998;&#37197;&#30340;&#19968;&#20018;&#20869;&#23384;&#31354;&#38388;&#65292;&#23567;&#20876;&#20013;&#26377;&#35814;&#32454;&#20171;&#32461;&#65289;&#65292;&#35813;&#38145;&#30340;&#31867;&#22411;&#26159;X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;&#65288;rec but not gap&#65289;
RECORD LOCKS space id 171 page no 3 n bits 72 index PRIMARY of table `dahaizi`.`hero` trx id 30477 lock_mode X locks rec but not gap waiting

# &#35813;&#35760;&#24405;&#22312;&#39029;&#38754;&#20013;&#30340;heap_no&#20026;2&#65292;&#20855;&#20307;&#30340;&#35760;&#24405;&#20449;&#24687;&#22914;&#19979;&#65306;
Record lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

# &#36825;&#26159;&#20027;&#38190;&#20540;
0: len 4; hex 80000003; asc     ;;

# &#36825;&#26159;trx_id&#38544;&#34255;&#21015;
1: len 6; hex 000000007517; asc     u ;;

# &#36825;&#26159;roll_pointer&#38544;&#34255;&#21015;
2: len 7; hex 80000001d0011d; asc        ;;

# &#36825;&#26159;name&#21015;
3: len 10; hex 7ae8afb8e8919be4baae; asc z         ;;

# &#36825;&#26159;country&#21015;
4: len 3; hex e89c80; asc    ;;
</code></pre>
  <p>
   &#20174;&#36825;&#20010;&#20449;&#24687;&#20013;&#21487;&#20197;&#30475;&#20986;&#65292;
   <code>
    Session A
   </code>
   &#20013;&#30340;&#20107;&#21153;&#20026;2&#26465;&#35760;&#24405;&#29983;&#25104;&#20102;&#38145;&#32467;&#26500;&#65292;&#20294;&#26159;&#20854;&#20013;&#26377;&#19968;&#26465;&#35760;&#24405;&#19978;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65288;rec but not gap&#65289;&#24182;&#27809;&#26377;&#33719;&#21462;&#21040;&#65292;&#27809;&#26377;&#33719;&#21462;&#21040;&#38145;&#30340;&#36825;&#26465;&#35760;&#24405;&#30340;&#20301;&#32622;&#26159;&#65306;&#34920;&#31354;&#38388;ID&#20026;151&#65292;&#39029;&#21495;&#20026;3&#65292;heap_no&#20026;2&#12290;&#24403;&#28982;&#65292;&#35774;&#35745;
   <code>
    InnoDB
   </code>
   &#30340;&#22823;&#21460;&#36824;&#36148;&#24515;&#30340;&#32473;&#20986;&#20102;&#36825;&#26465;&#35760;&#24405;&#30340;&#35814;&#32454;&#24773;&#20917;&#65292;&#23427;&#30340;&#20027;&#38190;&#20540;&#20026;
   <code>
    80000003
   </code>
   &#65292;&#36825;&#20854;&#23454;&#26159;InnoDB&#20869;&#37096;&#23384;&#20648;&#20351;&#29992;&#30340;&#26684;&#24335;&#65292;&#20854;&#23454;&#23601;&#20195;&#34920;&#25968;&#23383;
   <code>
    3
   </code>
   &#65292;&#20063;&#23601;&#26159;&#35813;&#20107;&#21153;&#22312;&#31561;&#24453;&#33719;&#21462;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#20027;&#38190;&#20540;&#20026;
   <code>
    3
   </code>
   &#30340;&#37027;&#26465;&#35760;&#24405;&#30340;
   <code>
    X&#22411;
   </code>
   &#27491;&#32463;&#35760;&#24405;&#38145;&#12290;
  </p>
 </li>
 <li>
  <p>
   &#28982;&#21518;&#26159;&#20851;&#20110;&#27515;&#38145;&#21457;&#29983;&#26102;&#31532;&#20108;&#20010;&#20107;&#21153;&#30340;&#26377;&#20851;&#20449;&#24687;&#65306;
  </p>
  <p>
   &#20854;&#20013;&#30340;&#22823;&#37096;&#20998;&#20449;&#24687;&#25105;&#20204;&#37117;&#24050;&#32463;&#20171;&#32461;&#36807;&#20102;&#65292;&#25105;&#20204;&#23601;&#25361;&#37325;&#35201;&#30340;&#35828;&#65306;
  </p>
  <pre><code>*** (2) TRANSACTION:
TRANSACTION 30478, ACTIVE 8 sec starting index read
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1160, 2 row lock(s)
MySQL thread id 3, OS thread handle 123145412927488, query id 47 localhost 127.0.0.1 root statistics
select * from hero where id = 1 for update

# &#34920;&#31034;&#35813;&#20107;&#21153;&#33719;&#21462;&#21040;&#30340;&#38145;&#20449;&#24687;
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 171 page no 3 n bits 72 index PRIMARY of table `dahaizi`.`hero` trx id 30478 lock_mode X locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

# &#20027;&#38190;&#20540;&#20026;3
0: len 4; hex 80000003; asc     ;;
1: len 6; hex 000000007517; asc     u ;;
2: len 7; hex 80000001d0011d; asc        ;;
3: len 10; hex 7ae8afb8e8919be4baae; asc z         ;;
4: len 3; hex e89c80; asc    ;;

# &#34920;&#31034;&#35813;&#20107;&#21153;&#31561;&#24453;&#33719;&#21462;&#30340;&#38145;&#20449;&#24687;
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 171 page no 3 n bits 72 index PRIMARY of table `dahaizi`.`hero` trx id 30478 lock_mode X locks rec but not gap waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

# &#20027;&#38190;&#20540;&#20026;1
0: len 4; hex 80000001; asc     ;;
1: len 6; hex 000000007517; asc     u ;;
2: len 7; hex 80000001d00110; asc        ;;
3: len 7; hex 6ce58898e5a487; asc l      ;;
4: len 3; hex e89c80; asc    ;;
</code></pre>
  <p>
   &#20174;&#19978;&#36793;&#30340;&#36755;&#20986;&#21487;&#20197;&#30475;&#20986;&#26469;&#65292;
   <code>
    Session B
   </code>
   &#20013;&#30340;&#20107;&#21153;&#33719;&#21462;&#20102;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#20027;&#38190;&#20540;&#20026;
   <code>
    3
   </code>
   &#30340;&#35760;&#24405;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65292;&#31561;&#24453;&#33719;&#21462;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#20027;&#38190;&#20540;&#20026;
   <code>
    1
   </code>
   &#30340;&#35760;&#24405;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65288;&#38544;&#21547;&#30340;&#24847;&#24605;&#23601;&#26159;&#36825;&#20010;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;&#20027;&#38190;&#20540;&#20026;
   <code>
    1
   </code>
   &#30340;&#35760;&#24405;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#24050;&#32463;&#34987;
   <code>
    SESSION A
   </code>
   &#20013;&#30340;&#20107;&#21153;&#33719;&#21462;&#21040;&#20102;&#65289;&#12290;
  </p>
 </li>
 <li>
  <p>
   &#30475;&#26368;&#21518;&#19968;&#37096;&#20998;&#65306;
  </p>
  <pre><code>*** WE ROLL BACK TRANSACTION (2)
</code></pre>
  <p>
   &#26368;&#32456;InnoDB&#23384;&#20648;&#24341;&#25806;&#20915;&#23450;&#22238;&#28378;&#31532;2&#20010;&#39135;&#29289;&#65292;&#20063;&#23601;&#26159;
   <code>
    Session B
   </code>
   &#20013;&#30340;&#37027;&#20010;&#20107;&#21153;&#12290;
  </p>
 </li>
</ul>
<h2>
 &#24605;&#32034;&#20998;&#26512;&#30340;&#24605;&#36335;
</h2>
<ol>
 <li>
  <p>
   &#26597;&#30475;&#27515;&#38145;&#26085;&#24535;&#26102;&#65292;&#39318;&#20808;&#30475;&#19968;&#19979;&#21457;&#29983;&#27515;&#38145;&#30340;&#20107;&#21153;&#31561;&#24453;&#33719;&#21462;&#38145;&#30340;&#35821;&#21477;&#37117;&#26159;&#21861;&#12290;
  </p>
  <p>
   &#26412;&#20363;&#20013;&#65292;&#21457;&#29616;
   <code>
    SESSION A
   </code>
   &#21457;&#29983;&#38459;&#22622;&#30340;&#35821;&#21477;&#26159;&#65306;
  </p>
  <pre><code>select * from hero where id = 3 for update
</code></pre>
  <p>
   <code>
    SESSION B
   </code>
   &#21457;&#29983;&#38459;&#22622;&#30340;&#35821;&#21477;&#26159;&#65306;
  </p>
  <pre><code>select * from hero where id = 1 for update
</code></pre>
  <p>
   &#28982;&#21518;&#20999;&#35760;&#65306;
   <span>
    &#21040;&#33258;&#24049;&#30340;&#19994;&#21153;&#20195;&#30721;&#20013;&#25214;&#20986;&#36825;&#20004;&#26465;&#35821;&#21477;&#25152;&#22312;&#20107;&#21153;&#30340;&#20854;&#20182;&#35821;&#21477;
   </span>
   &#12290;
  </p>
 </li>
 <li>
  <p>
   &#25214;&#21040;&#21457;&#29983;&#27515;&#38145;&#30340;&#20107;&#21153;&#20013;&#25152;&#26377;&#30340;&#35821;&#21477;&#20043;&#21518;&#65292;&#23545;&#29031;&#30528;&#20107;&#21153;&#33719;&#21462;&#21040;&#30340;&#38145;&#21644;&#27491;&#22312;&#31561;&#24453;&#30340;&#38145;&#30340;&#20449;&#24687;&#26469;&#20998;&#26512;&#27515;&#38145;&#21457;&#29983;&#36807;&#31243;&#12290;
  </p>
  <p>
   &#20174;&#27515;&#38145;&#26085;&#24535;&#20013;&#21487;&#20197;&#30475;&#20986;&#26469;&#65292;
   <code>
    SESSION A
   </code>
   &#33719;&#21462;&#20102;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;
   <code>
    id
   </code>
   &#20540;&#20026;1&#30340;&#35760;&#24405;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65288;&#36825;&#20854;&#23454;&#26159;&#20174;
   <code>
    SESSION B
   </code>
   &#27491;&#22312;&#31561;&#24453;&#30340;&#38145;&#20013;&#33719;&#21462;&#30340;&#65289;&#65292;&#26597;&#30475;
   <code>
    SESSION A
   </code>
   &#20013;&#30340;&#35821;&#21477;&#65292;&#21457;&#29616;&#26159;&#19979;&#36793;&#36825;&#20010;&#35821;&#21477;&#36896;&#25104;&#30340;&#65288;&#23545;&#29031;&#30528;&#35821;&#21477;&#21152;&#38145;&#20998;&#26512;&#37027;&#19977;&#31687;&#25991;&#31456;&#65289;:
  </p>
  <pre><code>select * from hero where id = 1 for update;
</code></pre>
  <p>
   &#36824;&#26377;
   <code>
    SESSION B
   </code>
   &#33719;&#21462;&#20102;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;
   <code>
    id
   </code>
   &#20540;&#20026;3&#30340;&#35760;&#24405;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65292;&#26597;&#30475;
   <code>
    SESSION B
   </code>
   &#20013;&#30340;&#35821;&#21477;&#65292;&#21457;&#29616;&#26159;&#19979;&#36793;&#36825;&#20010;&#35821;&#21477;&#36896;&#25104;&#30340;&#65288;&#23545;&#29031;&#30528;&#35821;&#21477;&#21152;&#38145;&#20998;&#26512;&#37027;&#19977;&#31687;&#25991;&#31456;&#65289;:
  </p>
  <pre><code>select * from hero where id = 3 for update;
</code></pre>
  <p>
   &#28982;&#21518;&#30475;
   <code>
    SESSION A
   </code>
   &#27491;&#22312;&#31561;&#24453;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;
   <code>
    id
   </code>
   &#20540;&#20026;3&#30340;&#35760;&#24405;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65292;&#36825;&#20010;&#26159;&#30001;&#20110;&#19979;&#36793;&#36825;&#20010;&#35821;&#21477;&#36896;&#25104;&#30340;&#65306;
  </p>
  <pre><code>select * from hero where id = 3 for update;
</code></pre>
  <p>
   &#28982;&#21518;&#30475;
   <code>
    SESSION B
   </code>
   &#27491;&#22312;&#31561;&#24453;
   <code>
    hero
   </code>
   &#34920;&#32858;&#31751;&#32034;&#24341;
   <code>
    id
   </code>
   &#20540;&#20026;1&#30340;&#35760;&#24405;&#30340;
   <code>
    X&#22411;&#27491;&#32463;&#35760;&#24405;&#38145;
   </code>
   &#65292;&#36825;&#20010;&#26159;&#30001;&#20110;&#19979;&#36793;&#36825;&#20010;&#35821;&#21477;&#36896;&#25104;&#30340;&#65306;
  </p>
  <pre><code>select * from hero where id = 1 for update;
</code></pre>
  <p>
   &#28982;&#21518;&#25972;&#20010;&#27515;&#38145;&#24418;&#25104;&#36807;&#31243;&#23601;&#26681;&#25454;&#27515;&#38145;&#26085;&#24535;&#32473;&#36824;&#21407;&#20986;&#26469;&#20102;&#12290;
  </p>
 </li>
</ol>
</div>

</div>
</div>

        </body>
        
        