
        <html lang="en">
        <head>
        <meta charset="UTF-8"/>
        </head>
        <body>
        <div><div class="markdown-body">
    <h1>&#12300;&#28304;&#30721;&#35299;&#35835;&#12301;&#26381;&#21153;&#35843;&#29992;&#36807;&#31243;</h1><div class="lake-content" typography="classic">
 <p class="ne-p" id="uadb995f1">
  <span class="ne-text">
   &#26412;&#25991;&#20171;&#32461;&#20102;&#26381;&#21153;&#35843;&#29992;&#36807;&#31243;&#30340;&#21407;&#29702;&#21644;&#23454;&#29616;&#32454;&#33410;
  </span>
 </p>
 <p class="ne-p" id="u8c3a906c">
  <br>
 </p>
 <h2 id="25970172">
  <span class="ne-text">
   1. &#31616;&#20171;
  </span>
 </h2>
 <p class="ne-p" id="ubad0c944">
  <br>
 </p>
 <p class="ne-p" id="u02e9ba64">
  <span class="ne-text">
   &#22312;&#21069;&#38754;&#30340;&#25991;&#31456;&#20013;&#65292;&#25105;&#20204;&#20998;&#26512;&#20102; Dubbo SPI&#12289;&#26381;&#21153;&#23548;&#20986;&#19982;&#24341;&#20837;&#12289;&#20197;&#21450;&#38598;&#32676;&#23481;&#38169;&#26041;&#38754;&#30340;&#20195;&#30721;&#12290;&#32463;&#36807;&#21069;&#25991;&#30340;&#38138;&#22443;&#65292;&#26412;&#31687;&#25991;&#31456;&#25105;&#20204;&#32456;&#20110;&#21487;&#20197;&#20998;&#26512;&#26381;&#21153;&#35843;&#29992;&#36807;&#31243;&#20102;&#12290;Dubbo &#26381;&#21153;&#35843;&#29992;&#36807;&#31243;&#27604;&#36739;&#22797;&#26434;&#65292;&#21253;&#21547;&#20247;&#22810;&#27493;&#39588;&#65292;&#27604;&#22914;&#21457;&#36865;&#35831;&#27714;&#12289;&#32534;&#35299;&#30721;&#12289;&#26381;&#21153;&#38477;&#32423;&#12289;&#36807;&#28388;&#22120;&#38142;&#22788;&#29702;&#12289;&#24207;&#21015;&#21270;&#12289;&#32447;&#31243;&#27966;&#21457;&#20197;&#21450;&#21709;&#24212;&#35831;&#27714;&#31561;&#27493;&#39588;&#12290;&#38480;&#20110;&#31687;&#24133;&#21407;&#22240;&#65292;&#26412;&#31687;&#25991;&#31456;&#26080;&#27861;&#23545;&#25152;&#26377;&#30340;&#27493;&#39588;&#19968;&#19968;&#36827;&#34892;&#20998;&#26512;&#12290;&#26412;&#31687;&#25991;&#31456;&#23558;&#20250;&#37325;&#28857;&#20998;&#26512;&#35831;&#27714;&#30340;&#21457;&#36865;&#19982;&#25509;&#25910;&#12289;&#32534;&#35299;&#30721;&#12289;&#32447;&#31243;&#27966;&#21457;&#20197;&#21450;&#21709;&#24212;&#30340;&#21457;&#36865;&#19982;&#25509;&#25910;&#31561;&#36807;&#31243;&#65292;&#33267;&#20110;&#26381;&#21153;&#38477;&#32423;&#12289;&#36807;&#28388;&#22120;&#38142;&#21644;&#24207;&#21015;&#21270;&#22823;&#23478;&#33258;&#34892;&#36827;&#34892;&#20998;&#26512;&#65292;&#20063;&#21487;&#20197;&#23558;&#20854;&#24403;&#25104;&#19968;&#20010;&#40657;&#30418;&#65292;&#26242;&#26102;&#24573;&#30053;&#20063;&#27809;&#20851;&#31995;&#12290;&#20171;&#32461;&#23436;&#26412;&#31687;&#25991;&#31456;&#35201;&#20998;&#26512;&#30340;&#20869;&#23481;&#65292;&#25509;&#19979;&#26469;&#25105;&#20204;&#36827;&#20837;&#27491;&#39064;&#21543;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u4bb1b302">
  <br>
 </p>
 <h2 id="12d5e36b">
  <span class="ne-text">
   2. &#28304;&#30721;&#20998;&#26512;
  </span>
 </h2>
 <p class="ne-p" id="ubab7ed1b">
  <br>
 </p>
 <p class="ne-p" id="u74e07daa">
  <span class="ne-text">
   &#22312;&#36827;&#34892;&#28304;&#30721;&#20998;&#26512;&#20043;&#21069;&#65292;&#25105;&#20204;&#20808;&#26469;&#36890;&#36807;&#19968;&#24352;&#22270;&#20102;&#35299; Dubbo &#26381;&#21153;&#35843;&#29992;&#36807;&#31243;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ub1a87b67">
  <br>
 </p>
 <p class="ne-p" id="u53011be0">
  <img class="ne-image" id="i0Dv7" src="EPUB/imgi0Dv7" width="1368">
 </p>
 <p class="ne-p" id="u4e9a3045">
  <br>
 </p>
 <p class="ne-p" id="ua4da78b1">
  <span class="ne-text">
   &#39318;&#20808;&#26381;&#21153;&#28040;&#36153;&#32773;&#36890;&#36807;&#20195;&#29702;&#23545;&#35937; Proxy &#21457;&#36215;&#36828;&#31243;&#35843;&#29992;&#65292;&#25509;&#30528;&#36890;&#36807;&#32593;&#32476;&#23458;&#25143;&#31471; Client &#23558;&#32534;&#30721;&#21518;&#30340;&#35831;&#27714;&#21457;&#36865;&#32473;&#26381;&#21153;&#25552;&#20379;&#26041;&#30340;&#32593;&#32476;&#23618;&#19978;&#65292;&#20063;&#23601;&#26159; Server&#12290;Server &#22312;&#25910;&#21040;&#35831;&#27714;&#21518;&#65292;&#39318;&#20808;&#35201;&#20570;&#30340;&#20107;&#24773;&#26159;&#23545;&#25968;&#25454;&#21253;&#36827;&#34892;&#35299;&#30721;&#12290;&#28982;&#21518;&#23558;&#35299;&#30721;&#21518;&#30340;&#35831;&#27714;&#21457;&#36865;&#33267;&#20998;&#21457;&#22120; Dispatcher&#65292;&#20877;&#30001;&#20998;&#21457;&#22120;&#23558;&#35831;&#27714;&#27966;&#21457;&#21040;&#25351;&#23450;&#30340;&#32447;&#31243;&#27744;&#19978;&#65292;&#26368;&#21518;&#30001;&#32447;&#31243;&#27744;&#35843;&#29992;&#20855;&#20307;&#30340;&#26381;&#21153;&#12290;&#36825;&#23601;&#26159;&#19968;&#20010;&#36828;&#31243;&#35843;&#29992;&#35831;&#27714;&#30340;&#21457;&#36865;&#19982;&#25509;&#25910;&#36807;&#31243;&#12290;&#33267;&#20110;&#21709;&#24212;&#30340;&#21457;&#36865;&#19982;&#25509;&#25910;&#36807;&#31243;&#65292;&#36825;&#24352;&#22270;&#20013;&#27809;&#26377;&#34920;&#29616;&#20986;&#26469;&#12290;&#23545;&#20110;&#36825;&#20004;&#20010;&#36807;&#31243;&#65292;&#25105;&#20204;&#20063;&#20250;&#36827;&#34892;&#35814;&#32454;&#20998;&#26512;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u590929a0">
  <br>
 </p>
 <h3 id="84df0b01">
  <span class="ne-text">
   2.1 &#26381;&#21153;&#35843;&#29992;&#26041;&#24335;
  </span>
 </h3>
 <p class="ne-p" id="ub4dc5f5f">
  <br>
 </p>
 <p class="ne-p" id="u3d4026d2">
  <span class="ne-text">
   Dubbo &#25903;&#25345;&#21516;&#27493;&#21644;&#24322;&#27493;&#20004;&#31181;&#35843;&#29992;&#26041;&#24335;&#65292;&#20854;&#20013;&#24322;&#27493;&#35843;&#29992;&#36824;&#21487;&#32454;&#20998;&#20026;&#8220;&#26377;&#36820;&#22238;&#20540;&#8221;&#30340;&#24322;&#27493;&#35843;&#29992;&#21644;&#8220;&#26080;&#36820;&#22238;&#20540;&#8221;&#30340;&#24322;&#27493;&#35843;&#29992;&#12290;&#25152;&#35859;&#8220;&#26080;&#36820;&#22238;&#20540;&#8221;&#24322;&#27493;&#35843;&#29992;&#26159;&#25351;&#26381;&#21153;&#28040;&#36153;&#26041;&#21482;&#31649;&#35843;&#29992;&#65292;&#20294;&#19981;&#20851;&#24515;&#35843;&#29992;&#32467;&#26524;&#65292;&#27492;&#26102; Dubbo &#20250;&#30452;&#25509;&#36820;&#22238;&#19968;&#20010;&#31354;&#30340; RpcResult&#12290;&#33509;&#35201;&#20351;&#29992;&#24322;&#27493;&#29305;&#24615;&#65292;&#38656;&#35201;&#26381;&#21153;&#28040;&#36153;&#26041;&#25163;&#21160;&#36827;&#34892;&#37197;&#32622;&#12290;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;Dubbo &#20351;&#29992;&#21516;&#27493;&#35843;&#29992;&#26041;&#24335;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u95ff25d6">
  <br>
 </p>
 <p class="ne-p" id="u446642ef">
  <span class="ne-text">
   &#26412;&#33410;&#20197;&#21450;&#20854;&#20182;&#31456;&#33410;&#23558;&#20250;&#20351;&#29992; Dubbo &#23448;&#26041;&#25552;&#20379;&#30340; Demo &#20998;&#26512;&#25972;&#20010;&#35843;&#29992;&#36807;&#31243;&#65292;&#19979;&#38754;&#25105;&#20204;&#20174; DemoService &#25509;&#21475;&#30340;&#20195;&#29702;&#31867;&#24320;&#22987;&#36827;&#34892;&#20998;&#26512;&#12290;Dubbo &#40664;&#35748;&#20351;&#29992; Javassist &#26694;&#26550;&#20026;&#26381;&#21153;&#25509;&#21475;&#29983;&#25104;&#21160;&#24577;&#20195;&#29702;&#31867;&#65292;&#22240;&#27492;&#25105;&#20204;&#38656;&#35201;&#20808;&#23558;&#20195;&#29702;&#31867;&#36827;&#34892;&#21453;&#32534;&#35793;&#25165;&#33021;&#30475;&#21040;&#28304;&#30721;&#12290;&#36825;&#37324;&#20351;&#29992;&#38463;&#37324;&#24320;&#28304; Java &#24212;&#29992;&#35786;&#26029;&#24037;&#20855;
  </span>
  <a class="ne-link" data-href="https://github.com/alibaba/arthas" href="https://github.com/alibaba/arthas" target="_blank">
   <span class="ne-text">
    Arthas
   </span>
  </a>
  <span class="ne-text">
   &#21453;&#32534;&#35793;&#20195;&#29702;&#31867;&#65292;&#32467;&#26524;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u78c4111c">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="e0abd887">/**
 * Arthas &#21453;&#32534;&#35793;&#27493;&#39588;&#65306;
 * 1. &#21551;&#21160; Arthas
 *    java -jar arthas-boot.jar
 *
 * 2. &#36755;&#20837;&#32534;&#21495;&#36873;&#25321;&#36827;&#31243;
 *    Arthas &#21551;&#21160;&#21518;&#65292;&#20250;&#25171;&#21360; Java &#24212;&#29992;&#36827;&#31243;&#21015;&#34920;&#65292;&#22914;&#19979;&#65306;
 *    [1]: 11232 org.jetbrains.jps.cmdline.Launcher
 *    [2]: 22370 org.jetbrains.jps.cmdline.Launcher
 *    [3]: 22371 com.alibaba.dubbo.demo.consumer.Consumer
 *    [4]: 22362 com.alibaba.dubbo.demo.provider.Provider
 *    [5]: 2074 org.apache.zookeeper.server.quorum.QuorumPeerMain
 * &#36825;&#37324;&#36755;&#20837;&#32534;&#21495; 3&#65292;&#35753; Arthas &#20851;&#32852;&#21040;&#21551;&#21160;&#31867;&#20026; com.....Consumer &#30340; Java &#36827;&#31243;&#19978;
 *
 * 3. &#30001;&#20110; Demo &#39033;&#30446;&#20013;&#21482;&#26377;&#19968;&#20010;&#26381;&#21153;&#25509;&#21475;&#65292;&#22240;&#27492;&#27492;&#25509;&#21475;&#30340;&#20195;&#29702;&#31867;&#31867;&#21517;&#20026; proxy0&#65292;&#27492;&#26102;&#20351;&#29992; sc &#21629;&#20196;&#25628;&#32034;&#36825;&#20010;&#31867;&#21517;&#12290;
 *    $ sc *.proxy0
 *    com.alibaba.dubbo.common.bytecode.proxy0
 *
 * 4. &#20351;&#29992; jad &#21629;&#20196;&#21453;&#32534;&#35793; com.alibaba.dubbo.common.bytecode.proxy0
 *    $ jad com.alibaba.dubbo.common.bytecode.proxy0
 *
 * &#26356;&#22810;&#20351;&#29992;&#26041;&#27861;&#35831;&#21442;&#32771; Arthas &#23448;&#26041;&#25991;&#26723;&#65306;
 *   https://alibaba.github.io/arthas/quick-start.html
 */
public class proxy0 implements ClassGenerator.DC, EchoService, DemoService {
    // &#26041;&#27861;&#25968;&#32452;
    public static Method[] methods;
    private InvocationHandler handler;

    public proxy0(InvocationHandler invocationHandler) {
        this.handler = invocationHandler;
    }

    public proxy0() {
    }

    public String sayHello(String string) {
        // &#23558;&#21442;&#25968;&#23384;&#20648;&#21040; Object &#25968;&#32452;&#20013;
        Object[] arrobject = new Object[]{string};
        // &#35843;&#29992; InvocationHandler &#23454;&#29616;&#31867;&#30340; invoke &#26041;&#27861;&#24471;&#21040;&#35843;&#29992;&#32467;&#26524;
        Object object = this.handler.invoke(this, methods[0], arrobject);
        // &#36820;&#22238;&#35843;&#29992;&#32467;&#26524;
        return (String)object;
    }

    /** &#22238;&#22768;&#27979;&#35797;&#26041;&#27861; */
    public Object $echo(Object object) {
        Object[] arrobject = new Object[]{object};
        Object object2 = this.handler.invoke(this, methods[1], arrobject);
        return object2;
    }
}</pre>
 <p class="ne-p" id="u1d77a473">
  <br>
 </p>
 <p class="ne-p" id="uc2b3ec1b">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#20195;&#29702;&#31867;&#30340;&#36923;&#36753;&#27604;&#36739;&#31616;&#21333;&#12290;&#39318;&#20808;&#23558;&#36816;&#34892;&#26102;&#21442;&#25968;&#23384;&#20648;&#21040;&#25968;&#32452;&#20013;&#65292;&#28982;&#21518;&#35843;&#29992; InvocationHandler &#25509;&#21475;&#23454;&#29616;&#31867;&#30340; invoke &#26041;&#27861;&#65292;&#24471;&#21040;&#35843;&#29992;&#32467;&#26524;&#65292;&#26368;&#21518;&#23558;&#32467;&#26524;&#36716;&#22411;&#24182;&#36820;&#22238;&#32473;&#35843;&#29992;&#26041;&#12290;&#20851;&#20110;&#20195;&#29702;&#31867;&#30340;&#36923;&#36753;&#23601;&#35828;&#36825;&#20040;&#22810;&#65292;&#32487;&#32493;&#21521;&#19979;&#20998;&#26512;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u37e2dd6e">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="4c35b1a4">public class InvokerInvocationHandler implements InvocationHandler {

    private final Invoker&lt;?&gt; invoker;

    public InvokerInvocationHandler(Invoker&lt;?&gt; handler) {
        this.invoker = handler;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        String methodName = method.getName();
        Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();
        
        // &#25318;&#25130;&#23450;&#20041;&#22312; Object &#31867;&#20013;&#30340;&#26041;&#27861;&#65288;&#26410;&#34987;&#23376;&#31867;&#37325;&#20889;&#65289;&#65292;&#27604;&#22914; wait/notify
        if (method.getDeclaringClass() == Object.class) {
            return method.invoke(invoker, args);
        }
        
        // &#22914;&#26524; toString&#12289;hashCode &#21644; equals &#31561;&#26041;&#27861;&#34987;&#23376;&#31867;&#37325;&#20889;&#20102;&#65292;&#36825;&#37324;&#20063;&#30452;&#25509;&#35843;&#29992;
        if ("toString".equals(methodName) &amp;&amp; parameterTypes.length == 0) {
            return invoker.toString();
        }
        if ("hashCode".equals(methodName) &amp;&amp; parameterTypes.length == 0) {
            return invoker.hashCode();
        }
        if ("equals".equals(methodName) &amp;&amp; parameterTypes.length == 1) {
            return invoker.equals(args[0]);
        }
        
        // &#23558; method &#21644; args &#23553;&#35013;&#21040; RpcInvocation &#20013;&#65292;&#24182;&#25191;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;
        return invoker.invoke(new RpcInvocation(method, args)).recreate();
    }
}</pre>
 <p class="ne-p" id="u69265c54">
  <br>
 </p>
 <p class="ne-p" id="u9c381af4">
  <span class="ne-text">
   InvokerInvocationHandler &#20013;&#30340; invoker &#25104;&#21592;&#21464;&#37327;&#31867;&#22411;&#20026; MockClusterInvoker&#65292;MockClusterInvoker &#20869;&#37096;&#23553;&#35013;&#20102;&#26381;&#21153;&#38477;&#32423;&#36923;&#36753;&#12290;&#19979;&#38754;&#31616;&#21333;&#30475;&#19968;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ua3550d1d">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="ba298b76">public class MockClusterInvoker&lt;T&gt; implements Invoker&lt;T&gt; {
    
    private final Invoker&lt;T&gt; invoker;
    
    public Result invoke(Invocation invocation) throws RpcException {
        Result result = null;

        // &#33719;&#21462; mock &#37197;&#32622;&#20540;
        String value = directory.getUrl().getMethodParameter(invocation.getMethodName(), Constants.MOCK_KEY, Boolean.FALSE.toString()).trim();
        if (value.length() == 0 || value.equalsIgnoreCase("false")) {
            // &#26080; mock &#36923;&#36753;&#65292;&#30452;&#25509;&#35843;&#29992;&#20854;&#20182; Invoker &#23545;&#35937;&#30340; invoke &#26041;&#27861;&#65292;
            // &#27604;&#22914; FailoverClusterInvoker
            result = this.invoker.invoke(invocation);
        } else if (value.startsWith("force")) {
            // force:xxx &#30452;&#25509;&#25191;&#34892; mock &#36923;&#36753;&#65292;&#19981;&#21457;&#36215;&#36828;&#31243;&#35843;&#29992;
            result = doMockInvoke(invocation, null);
        } else {
            // fail:xxx &#34920;&#31034;&#28040;&#36153;&#26041;&#23545;&#35843;&#29992;&#26381;&#21153;&#22833;&#36133;&#21518;&#65292;&#20877;&#25191;&#34892; mock &#36923;&#36753;&#65292;&#19981;&#25243;&#20986;&#24322;&#24120;
            try {
                // &#35843;&#29992;&#20854;&#20182; Invoker &#23545;&#35937;&#30340; invoke &#26041;&#27861;
                result = this.invoker.invoke(invocation);
            } catch (RpcException e) {
                if (e.isBiz()) {
                    throw e;
                } else {
                    // &#35843;&#29992;&#22833;&#36133;&#65292;&#25191;&#34892; mock &#36923;&#36753;
                    result = doMockInvoke(invocation, e);
                }
            }
        }
        return result;
    }
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="ub9c5d306">
  <br>
 </p>
 <p class="ne-p" id="uc0011db9">
  <span class="ne-text">
   &#26381;&#21153;&#38477;&#32423;&#19981;&#26159;&#26412;&#25991;&#37325;&#28857;&#65292;&#22240;&#27492;&#36825;&#37324;&#23601;&#19981;&#20998;&#26512; doMockInvoke &#26041;&#27861;&#20102;&#12290;&#32771;&#34385;&#21040;&#21069;&#25991;&#24050;&#32463;&#35814;&#32454;&#20998;&#26512;&#36807; FailoverClusterInvoker&#65292;&#22240;&#27492;&#26412;&#33410;&#30053;&#36807; FailoverClusterInvoker&#65292;&#30452;&#25509;&#20998;&#26512; DubboInvoker&#12290;
  </span>
 </p>
 <p class="ne-p" id="u62ca909f">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="d6fdf44e">public abstract class AbstractInvoker&lt;T&gt; implements Invoker&lt;T&gt; {
    
    public Result invoke(Invocation inv) throws RpcException {
        if (destroyed.get()) {
            throw new RpcException("Rpc invoker for service ...");
        }
        RpcInvocation invocation = (RpcInvocation) inv;
        // &#35774;&#32622; Invoker
        invocation.setInvoker(this);
        if (attachment != null &amp;&amp; attachment.size() &gt; 0) {
            // &#35774;&#32622; attachment
            invocation.addAttachmentsIfAbsent(attachment);
        }
        Map&lt;String, String&gt; contextAttachments = RpcContext.getContext().getAttachments();
        if (contextAttachments != null &amp;&amp; contextAttachments.size() != 0) {
            // &#28155;&#21152; contextAttachments &#21040; RpcInvocation#attachment &#21464;&#37327;&#20013;
            invocation.addAttachments(contextAttachments);
        }
        if (getUrl().getMethodParameter(invocation.getMethodName(), Constants.ASYNC_KEY, false)) {
            // &#35774;&#32622;&#24322;&#27493;&#20449;&#24687;&#21040; RpcInvocation#attachment &#20013;
            invocation.setAttachment(Constants.ASYNC_KEY, Boolean.TRUE.toString());
        }
        RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);

        try {
            // &#25277;&#35937;&#26041;&#27861;&#65292;&#30001;&#23376;&#31867;&#23454;&#29616;
            return doInvoke(invocation);
        } catch (InvocationTargetException e) {
            // ...
        } catch (RpcException e) {
            // ...
        } catch (Throwable e) {
            return new RpcResult(e);
        }
    }

    protected abstract Result doInvoke(Invocation invocation) throws Throwable;
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="uda5f23b4">
  <br>
 </p>
 <p class="ne-p" id="u5176350b">
  <span class="ne-text">
   &#19978;&#38754;&#30340;&#20195;&#30721;&#26469;&#33258; AbstractInvoker &#31867;&#65292;&#20854;&#20013;&#22823;&#37096;&#20998;&#20195;&#30721;&#29992;&#20110;&#28155;&#21152;&#20449;&#24687;&#21040; RpcInvocation#attachment &#21464;&#37327;&#20013;&#65292;&#28155;&#21152;&#23436;&#27605;&#21518;&#65292;&#35843;&#29992; doInvoke &#25191;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;&#12290;doInvoke &#26159;&#19968;&#20010;&#25277;&#35937;&#26041;&#27861;&#65292;&#38656;&#35201;&#30001;&#23376;&#31867;&#23454;&#29616;&#65292;&#19979;&#38754;&#21040; DubboInvoker &#20013;&#30475;&#19968;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u664c9dfe">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="926d5be0">public class DubboInvoker&lt;T&gt; extends AbstractInvoker&lt;T&gt; {
    
    private final ExchangeClient[] clients;
    
    protected Result doInvoke(final Invocation invocation) throws Throwable {
        RpcInvocation inv = (RpcInvocation) invocation;
        final String methodName = RpcUtils.getMethodName(invocation);
        // &#35774;&#32622; path &#21644; version &#21040; attachment &#20013;
        inv.setAttachment(Constants.PATH_KEY, getUrl().getPath());
        inv.setAttachment(Constants.VERSION_KEY, version);

        ExchangeClient currentClient;
        if (clients.length == 1) {
            // &#20174; clients &#25968;&#32452;&#20013;&#33719;&#21462; ExchangeClient
            currentClient = clients[0];
        } else {
            currentClient = clients[index.getAndIncrement() % clients.length];
        }
        try {
            // &#33719;&#21462;&#24322;&#27493;&#37197;&#32622;
            boolean isAsync = RpcUtils.isAsync(getUrl(), invocation);
            // isOneway &#20026; true&#65292;&#34920;&#31034;&#8220;&#21333;&#21521;&#8221;&#36890;&#20449;
            boolean isOneway = RpcUtils.isOneway(getUrl(), invocation);
            int timeout = getUrl().getMethodParameter(methodName, Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);

            // &#24322;&#27493;&#26080;&#36820;&#22238;&#20540;
            if (isOneway) {
                boolean isSent = getUrl().getMethodParameter(methodName, Constants.SENT_KEY, false);
                // &#21457;&#36865;&#35831;&#27714;
                currentClient.send(inv, isSent);
                // &#35774;&#32622;&#19978;&#19979;&#25991;&#20013;&#30340; future &#23383;&#27573;&#20026; null
                RpcContext.getContext().setFuture(null);
                // &#36820;&#22238;&#19968;&#20010;&#31354;&#30340; RpcResult
                return new RpcResult();
            } 

            // &#24322;&#27493;&#26377;&#36820;&#22238;&#20540;
            else if (isAsync) {
                // &#21457;&#36865;&#35831;&#27714;&#65292;&#24182;&#24471;&#21040;&#19968;&#20010; ResponseFuture &#23454;&#20363;
                ResponseFuture future = currentClient.request(inv, timeout);
                // &#35774;&#32622; future &#21040;&#19978;&#19979;&#25991;&#20013;
                RpcContext.getContext().setFuture(new FutureAdapter&lt;Object&gt;(future));
                // &#26242;&#26102;&#36820;&#22238;&#19968;&#20010;&#31354;&#32467;&#26524;
                return new RpcResult();
            } 

            // &#21516;&#27493;&#35843;&#29992;
            else {
                RpcContext.getContext().setFuture(null);
                // &#21457;&#36865;&#35831;&#27714;&#65292;&#24471;&#21040;&#19968;&#20010; ResponseFuture &#23454;&#20363;&#65292;&#24182;&#35843;&#29992;&#35813;&#23454;&#20363;&#30340; get &#26041;&#27861;&#36827;&#34892;&#31561;&#24453;
                return (Result) currentClient.request(inv, timeout).get();
            }
        } catch (TimeoutException e) {
            throw new RpcException(..., "Invoke remote method timeout....");
        } catch (RemotingException e) {
            throw new RpcException(..., "Failed to invoke remote method: ...");
        }
    }
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="uc268ec7d">
  <br>
 </p>
 <p class="ne-p" id="u5f198a24">
  <span class="ne-text">
   &#19978;&#38754;&#30340;&#20195;&#30721;&#21253;&#21547;&#20102; Dubbo &#23545;&#21516;&#27493;&#21644;&#24322;&#27493;&#35843;&#29992;&#30340;&#22788;&#29702;&#36923;&#36753;&#65292;&#25630;&#25026;&#20102;&#19978;&#38754;&#30340;&#20195;&#30721;&#65292;&#20250;&#23545; Dubbo &#30340;&#21516;&#27493;&#21644;&#24322;&#27493;&#35843;&#29992;&#26041;&#24335;&#26377;&#26356;&#28145;&#20837;&#30340;&#20102;&#35299;&#12290;Dubbo &#23454;&#29616;&#21516;&#27493;&#21644;&#24322;&#27493;&#35843;&#29992;&#27604;&#36739;&#20851;&#38190;&#30340;&#19968;&#28857;&#23601;&#22312;&#20110;&#30001;&#35841;&#35843;&#29992; ResponseFuture &#30340; get &#26041;&#27861;&#12290;&#21516;&#27493;&#35843;&#29992;&#27169;&#24335;&#19979;&#65292;&#30001;&#26694;&#26550;&#33258;&#36523;&#35843;&#29992; ResponseFuture &#30340; get &#26041;&#27861;&#12290;&#24322;&#27493;&#35843;&#29992;&#27169;&#24335;&#19979;&#65292;&#21017;&#30001;&#29992;&#25143;&#35843;&#29992;&#35813;&#26041;&#27861;&#12290;ResponseFuture &#26159;&#19968;&#20010;&#25509;&#21475;&#65292;&#19979;&#38754;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#23427;&#30340;&#40664;&#35748;&#23454;&#29616;&#31867; DefaultFuture &#30340;&#28304;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u1c51c2f4">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="9ed6a833">public class DefaultFuture implements ResponseFuture {
    
    private static final Map&lt;Long, Channel&gt; CHANNELS = 
        new ConcurrentHashMap&lt;Long, Channel&gt;();

    private static final Map&lt;Long, DefaultFuture&gt; FUTURES = 
        new ConcurrentHashMap&lt;Long, DefaultFuture&gt;();
    
    private final long id;
    private final Channel channel;
    private final Request request;
    private final int timeout;
    private final Lock lock = new ReentrantLock();
    private final Condition done = lock.newCondition();
    private volatile Response response;
    
    public DefaultFuture(Channel channel, Request request, int timeout) {
        this.channel = channel;
        this.request = request;
        
        // &#33719;&#21462;&#35831;&#27714; id&#65292;&#36825;&#20010; id &#24456;&#37325;&#35201;&#65292;&#21518;&#38754;&#36824;&#20250;&#35265;&#21040;
        this.id = request.getId();
        this.timeout = timeout &gt; 0 ? timeout : channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
        // &#23384;&#20648; &lt;requestId, DefaultFuture&gt; &#26144;&#23556;&#20851;&#31995;&#21040; FUTURES &#20013;
        FUTURES.put(id, this);
        CHANNELS.put(id, channel);
    }
    
    @Override
    public Object get() throws RemotingException {
        return get(timeout);
    }

    @Override
    public Object get(int timeout) throws RemotingException {
        if (timeout &lt;= 0) {
            timeout = Constants.DEFAULT_TIMEOUT;
        }
        
        // &#26816;&#27979;&#26381;&#21153;&#25552;&#20379;&#26041;&#26159;&#21542;&#25104;&#21151;&#36820;&#22238;&#20102;&#35843;&#29992;&#32467;&#26524;
        if (!isDone()) {
            long start = System.currentTimeMillis();
            lock.lock();
            try {
                // &#24490;&#29615;&#26816;&#27979;&#26381;&#21153;&#25552;&#20379;&#26041;&#26159;&#21542;&#25104;&#21151;&#36820;&#22238;&#20102;&#35843;&#29992;&#32467;&#26524;
                while (!isDone()) {
                    // &#22914;&#26524;&#35843;&#29992;&#32467;&#26524;&#23578;&#26410;&#36820;&#22238;&#65292;&#36825;&#37324;&#31561;&#24453;&#19968;&#27573;&#26102;&#38388;
                    done.await(timeout, TimeUnit.MILLISECONDS);
                    // &#22914;&#26524;&#35843;&#29992;&#32467;&#26524;&#25104;&#21151;&#36820;&#22238;&#65292;&#25110;&#31561;&#24453;&#36229;&#26102;&#65292;&#27492;&#26102;&#36339;&#20986; while &#24490;&#29615;&#65292;&#25191;&#34892;&#21518;&#32493;&#30340;&#36923;&#36753;
                    if (isDone() || System.currentTimeMillis() - start &gt; timeout) {
                        break;
                    }
                }
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            } finally {
                lock.unlock();
            }
            
            // &#22914;&#26524;&#35843;&#29992;&#32467;&#26524;&#20173;&#26410;&#36820;&#22238;&#65292;&#21017;&#25243;&#20986;&#36229;&#26102;&#24322;&#24120;
            if (!isDone()) {
                throw new TimeoutException(sent &gt; 0, channel, getTimeoutMessage(false));
            }
        }
        
        // &#36820;&#22238;&#35843;&#29992;&#32467;&#26524;
        return returnFromResponse();
    }
    
    @Override
    public boolean isDone() {
        // &#36890;&#36807;&#26816;&#27979; response &#23383;&#27573;&#20026;&#31354;&#19982;&#21542;&#65292;&#21028;&#26029;&#26159;&#21542;&#25910;&#21040;&#20102;&#35843;&#29992;&#32467;&#26524;
        return response != null;
    }
    
    private Object returnFromResponse() throws RemotingException {
        Response res = response;
        if (res == null) {
            throw new IllegalStateException("response cannot be null");
        }
        
        // &#22914;&#26524;&#35843;&#29992;&#32467;&#26524;&#30340;&#29366;&#24577;&#20026; Response.OK&#65292;&#21017;&#34920;&#31034;&#35843;&#29992;&#36807;&#31243;&#27491;&#24120;&#65292;&#26381;&#21153;&#25552;&#20379;&#26041;&#25104;&#21151;&#36820;&#22238;&#20102;&#35843;&#29992;&#32467;&#26524;
        if (res.getStatus() == Response.OK) {
            return res.getResult();
        }
        
        // &#25243;&#20986;&#24322;&#24120;
        if (res.getStatus() == Response.CLIENT_TIMEOUT || res.getStatus() == Response.SERVER_TIMEOUT) {
            throw new TimeoutException(res.getStatus() == Response.SERVER_TIMEOUT, channel, res.getErrorMessage());
        }
        throw new RemotingException(channel, res.getErrorMessage());
    }
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="u15370c96">
  <br>
 </p>
 <p class="ne-p" id="u0af3dd52">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#24403;&#26381;&#21153;&#28040;&#36153;&#32773;&#36824;&#26410;&#25509;&#25910;&#21040;&#35843;&#29992;&#32467;&#26524;&#26102;&#65292;&#29992;&#25143;&#32447;&#31243;&#35843;&#29992; get &#26041;&#27861;&#20250;&#34987;&#38459;&#22622;&#20303;&#12290;&#21516;&#27493;&#35843;&#29992;&#27169;&#24335;&#19979;&#65292;&#26694;&#26550;&#33719;&#24471; DefaultFuture &#23545;&#35937;&#21518;&#65292;&#20250;&#31435;&#21363;&#35843;&#29992; get &#26041;&#27861;&#36827;&#34892;&#31561;&#24453;&#12290;&#32780;&#24322;&#27493;&#27169;&#24335;&#19979;&#21017;&#26159;&#23558;&#35813;&#23545;&#35937;&#23553;&#35013;&#21040; FutureAdapter &#23454;&#20363;&#20013;&#65292;&#24182;&#23558; FutureAdapter &#23454;&#20363;&#35774;&#32622;&#21040; RpcContext &#20013;&#65292;&#20379;&#29992;&#25143;&#20351;&#29992;&#12290;FutureAdapter &#26159;&#19968;&#20010;&#36866;&#37197;&#22120;&#65292;&#29992;&#20110;&#23558; Dubbo &#20013;&#30340; ResponseFuture &#19982; JDK &#20013;&#30340; Future &#36827;&#34892;&#36866;&#37197;&#12290;&#36825;&#26679;&#24403;&#29992;&#25143;&#32447;&#31243;&#35843;&#29992; Future &#30340; get &#26041;&#27861;&#26102;&#65292;&#32463;&#36807; FutureAdapter &#36866;&#37197;&#65292;&#26368;&#32456;&#20250;&#35843;&#29992; ResponseFuture &#23454;&#29616;&#31867;&#23545;&#35937;&#30340; get &#26041;&#27861;&#65292;&#20063;&#23601;&#26159; DefaultFuture &#30340; get &#26041;&#27861;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ucc238f77">
  <br>
 </p>
 <p class="ne-p" id="ub86a4a49">
  <span class="ne-text">
   &#21040;&#36825;&#37324;&#20851;&#20110; Dubbo &#20960;&#31181;&#35843;&#29992;&#26041;&#24335;&#30340;&#20195;&#30721;&#36923;&#36753;&#23601;&#20998;&#26512;&#23436;&#20102;&#65292;&#19979;&#38754;&#26469;&#20998;&#26512;&#35831;&#27714;&#25968;&#25454;&#30340;&#21457;&#36865;&#19982;&#25509;&#25910;&#65292;&#20197;&#21450;&#21709;&#24212;&#25968;&#25454;&#30340;&#21457;&#36865;&#19982;&#25509;&#25910;&#36807;&#31243;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u87423e42">
  <br>
 </p>
 <h3 id="fb2ff6b0">
  <span class="ne-text">
   2.2 &#26381;&#21153;&#28040;&#36153;&#26041;&#21457;&#36865;&#35831;&#27714;
  </span>
 </h3>
 <p class="ne-p" id="ua49f2ff4">
  <br>
 </p>
 <h4 id="003ef895">
  <span class="ne-text">
   2.2.1 &#21457;&#36865;&#35831;&#27714;
  </span>
 </h4>
 <p class="ne-p" id="u978a4955">
  <br>
 </p>
 <p class="ne-p" id="u3c8d75ca">
  <span class="ne-text">
   &#26412;&#33410;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#21516;&#27493;&#35843;&#29992;&#27169;&#24335;&#19979;&#65292;&#26381;&#21153;&#28040;&#36153;&#26041;&#26159;&#22914;&#20309;&#21457;&#36865;&#35843;&#29992;&#35831;&#27714;&#30340;&#12290;&#22312;&#28145;&#20837;&#20998;&#26512;&#28304;&#30721;&#21069;&#65292;&#25105;&#20204;&#20808;&#26469;&#30475;&#19968;&#24352;&#22270;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u1738c7ab">
  <br>
 </p>
 <p class="ne-p" id="u8bb25fd9">
  <img class="ne-image" id="ctQq0" src="EPUB/imgctQq0" width="1365">
 </p>
 <p class="ne-p" id="u1698e9ef">
  <br>
 </p>
 <p class="ne-p" id="u41686864">
  <span class="ne-text">
   &#36825;&#24352;&#22270;&#23637;&#31034;&#20102;&#26381;&#21153;&#28040;&#36153;&#26041;&#21457;&#36865;&#35831;&#27714;&#36807;&#31243;&#30340;&#37096;&#20998;&#35843;&#29992;&#26632;&#65292;&#30053;&#20026;&#22797;&#26434;&#12290;&#20174;&#19978;&#22270;&#21487;&#20197;&#30475;&#20986;&#65292;&#32463;&#36807;&#22810;&#27425;&#35843;&#29992;&#21518;&#65292;&#25165;&#23558;&#35831;&#27714;&#25968;&#25454;&#36865;&#33267; Netty NioClientSocketChannel&#12290;&#36825;&#26679;&#20570;&#30340;&#21407;&#22240;&#26159;&#36890;&#36807; Exchange &#23618;&#20026;&#26694;&#26550;&#24341;&#20837; Request &#21644; Response &#35821;&#20041;&#65292;&#36825;&#19968;&#28857;&#20250;&#22312;&#25509;&#19979;&#26469;&#30340;&#28304;&#30721;&#20998;&#26512;&#36807;&#31243;&#20013;&#20250;&#30475;&#21040;&#12290;&#20854;&#20182;&#30340;&#23601;&#19981;&#22810;&#35828;&#20102;&#65292;&#19979;&#38754;&#24320;&#22987;&#36827;&#34892;&#20998;&#26512;&#12290;&#39318;&#20808;&#20998;&#26512; ReferenceCountExchangeClient &#30340;&#28304;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u75932cd0">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="47754833">final class ReferenceCountExchangeClient implements ExchangeClient {

    private final URL url;
    private final AtomicInteger referenceCount = new AtomicInteger(0);

    public ReferenceCountExchangeClient(ExchangeClient client, ConcurrentMap&lt;String, LazyConnectExchangeClient&gt; ghostClientMap) {
        this.client = client;
        // &#24341;&#29992;&#35745;&#25968;&#33258;&#22686;
        referenceCount.incrementAndGet();
        this.url = client.getUrl();
        
        // ...
    }

    @Override
    public ResponseFuture request(Object request) throws RemotingException {
        // &#30452;&#25509;&#35843;&#29992;&#34987;&#35013;&#39280;&#23545;&#35937;&#30340;&#21516;&#31614;&#21517;&#26041;&#27861;
        return client.request(request);
    }

    @Override
    public ResponseFuture request(Object request, int timeout) throws RemotingException {
        // &#30452;&#25509;&#35843;&#29992;&#34987;&#35013;&#39280;&#23545;&#35937;&#30340;&#21516;&#31614;&#21517;&#26041;&#27861;
        return client.request(request, timeout);
    }

    /** &#24341;&#29992;&#35745;&#25968;&#33258;&#22686;&#65292;&#35813;&#26041;&#27861;&#30001;&#22806;&#37096;&#35843;&#29992; */
    public void incrementAndGetCount() {
        // referenceCount &#33258;&#22686;
        referenceCount.incrementAndGet();
    }
    
        @Override
    public void close(int timeout) {
        // referenceCount &#33258;&#20943;
        if (referenceCount.decrementAndGet() &lt;= 0) {
            if (timeout == 0) {
                client.close();
            } else {
                client.close(timeout);
            }
            client = replaceWithLazyClient();
        }
    }
    
    // &#30465;&#30053;&#37096;&#20998;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="ua5f8824c">
  <br>
 </p>
 <p class="ne-p" id="u76b9a130">
  <span class="ne-text">
   ReferenceCountExchangeClient &#20869;&#37096;&#23450;&#20041;&#20102;&#19968;&#20010;&#24341;&#29992;&#35745;&#25968;&#21464;&#37327; referenceCount&#65292;&#27599;&#24403;&#35813;&#23545;&#35937;&#34987;&#24341;&#29992;&#19968;&#27425; referenceCount &#37117;&#20250;&#36827;&#34892;&#33258;&#22686;&#12290;&#27599;&#24403; close &#26041;&#27861;&#34987;&#35843;&#29992;&#26102;&#65292;referenceCount &#36827;&#34892;&#33258;&#20943;&#12290;ReferenceCountExchangeClient &#20869;&#37096;&#20165;&#23454;&#29616;&#20102;&#19968;&#20010;&#24341;&#29992;&#35745;&#25968;&#30340;&#21151;&#33021;&#65292;&#20854;&#20182;&#26041;&#27861;&#24182;&#26080;&#22797;&#26434;&#36923;&#36753;&#65292;&#22343;&#26159;&#30452;&#25509;&#35843;&#29992;&#34987;&#35013;&#39280;&#23545;&#35937;&#30340;&#30456;&#20851;&#26041;&#27861;&#12290;&#25152;&#20197;&#36825;&#37324;&#23601;&#19981;&#22810;&#35828;&#20102;&#65292;&#32487;&#32493;&#21521;&#19979;&#20998;&#26512;&#65292;&#36825;&#27425;&#26159; HeaderExchangeClient&#12290;
  </span>
 </p>
 <p class="ne-p" id="uf9437cde">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="46d8b419">public class HeaderExchangeClient implements ExchangeClient {

    private static final ScheduledThreadPoolExecutor scheduled = new ScheduledThreadPoolExecutor(2, new NamedThreadFactory("dubbo-remoting-client-heartbeat", true));
    private final Client client;
    private final ExchangeChannel channel;
    private ScheduledFuture&lt;?&gt; heartbeatTimer;
    private int heartbeat;
    private int heartbeatTimeout;

    public HeaderExchangeClient(Client client, boolean needHeartbeat) {
        if (client == null) {
            throw new IllegalArgumentException("client == null");
        }
        this.client = client;
        
        // &#21019;&#24314; HeaderExchangeChannel &#23545;&#35937;
        this.channel = new HeaderExchangeChannel(client);
        
        // &#20197;&#19979;&#20195;&#30721;&#22343;&#19982;&#24515;&#36339;&#26816;&#27979;&#36923;&#36753;&#26377;&#20851;
        String dubbo = client.getUrl().getParameter(Constants.DUBBO_VERSION_KEY);
        this.heartbeat = client.getUrl().getParameter(Constants.HEARTBEAT_KEY, dubbo != null &amp;&amp; dubbo.startsWith("1.0.") ? Constants.DEFAULT_HEARTBEAT : 0);
        this.heartbeatTimeout = client.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * 3);
        if (heartbeatTimeout &lt; heartbeat * 2) {
            throw new IllegalStateException("heartbeatTimeout &lt; heartbeatInterval * 2");
        }
        if (needHeartbeat) {
            // &#24320;&#21551;&#24515;&#36339;&#26816;&#27979;&#23450;&#26102;&#22120;
            startHeartbeatTimer();
        }
    }

    @Override
    public ResponseFuture request(Object request) throws RemotingException {
        // &#30452;&#25509; HeaderExchangeChannel &#23545;&#35937;&#30340;&#21516;&#31614;&#21517;&#26041;&#27861;
        return channel.request(request);
    }

    @Override
    public ResponseFuture request(Object request, int timeout) throws RemotingException {
        // &#30452;&#25509; HeaderExchangeChannel &#23545;&#35937;&#30340;&#21516;&#31614;&#21517;&#26041;&#27861;
        return channel.request(request, timeout);
    }

    @Override
    public void close() {
        doClose();
        channel.close();
    }
    
    private void doClose() {
        // &#20572;&#27490;&#24515;&#36339;&#26816;&#27979;&#23450;&#26102;&#22120;
        stopHeartbeatTimer();
    }

    private void startHeartbeatTimer() {
        stopHeartbeatTimer();
        if (heartbeat &gt; 0) {
            heartbeatTimer = scheduled.scheduleWithFixedDelay(
                    new HeartBeatTask(new HeartBeatTask.ChannelProvider() {
                        @Override
                        public Collection&lt;Channel&gt; getChannels() {
                            return Collections.&lt;Channel&gt;singletonList(HeaderExchangeClient.this);
                        }
                    }, heartbeat, heartbeatTimeout),
                    heartbeat, heartbeat, TimeUnit.MILLISECONDS);
        }
    }

    private void stopHeartbeatTimer() {
        if (heartbeatTimer != null &amp;&amp; !heartbeatTimer.isCancelled()) {
            try {
                heartbeatTimer.cancel(true);
                scheduled.purge();
            } catch (Throwable e) {
                if (logger.isWarnEnabled()) {
                    logger.warn(e.getMessage(), e);
                }
            }
        }
        heartbeatTimer = null;
    }
    
    // &#30465;&#30053;&#37096;&#20998;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="u6d3093cc">
  <br>
 </p>
 <p class="ne-p" id="ue80b2a41">
  <span class="ne-text">
   HeaderExchangeClient &#20013;&#24456;&#22810;&#26041;&#27861;&#21482;&#26377;&#19968;&#34892;&#20195;&#30721;&#65292;&#21363;&#35843;&#29992; HeaderExchangeChannel &#23545;&#35937;&#30340;&#21516;&#31614;&#21517;&#26041;&#27861;&#12290;&#37027; HeaderExchangeClient &#26377;&#20160;&#20040;&#29992;&#22788;&#21602;&#65311;&#31572;&#26696;&#26159;&#23553;&#35013;&#20102;&#19968;&#20123;&#20851;&#20110;&#24515;&#36339;&#26816;&#27979;&#30340;&#36923;&#36753;&#12290;&#24515;&#36339;&#26816;&#27979;&#24182;&#38750;&#26412;&#25991;&#25152;&#20851;&#27880;&#30340;&#28857;&#65292;&#22240;&#27492;&#23601;&#19981;&#22810;&#35828;&#20102;&#65292;&#32487;&#32493;&#21521;&#19979;&#30475;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u724cbcc9">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="7cbdcb2d">final class HeaderExchangeChannel implements ExchangeChannel {
    
    private final Channel channel;
    
    HeaderExchangeChannel(Channel channel) {
        if (channel == null) {
            throw new IllegalArgumentException("channel == null");
        }
        
        // &#36825;&#37324;&#30340; channel &#25351;&#21521;&#30340;&#26159; NettyClient
        this.channel = channel;
    }
    
    @Override
    public ResponseFuture request(Object request) throws RemotingException {
        return request(request, channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT));
    }

    @Override
    public ResponseFuture request(Object request, int timeout) throws RemotingException {
        if (closed) {
            throw new RemotingException(..., "Failed to send request ...);
        }
        // &#21019;&#24314; Request &#23545;&#35937;
        Request req = new Request();
        req.setVersion(Version.getProtocolVersion());
        // &#35774;&#32622;&#21452;&#21521;&#36890;&#20449;&#26631;&#24535;&#20026; true
        req.setTwoWay(true);
        // &#36825;&#37324;&#30340; request &#21464;&#37327;&#31867;&#22411;&#20026; RpcInvocation
        req.setData(request);
                                        
        // &#21019;&#24314; DefaultFuture &#23545;&#35937;
        DefaultFuture future = new DefaultFuture(channel, req, timeout);
        try {
            // &#35843;&#29992; NettyClient &#30340; send &#26041;&#27861;&#21457;&#36865;&#35831;&#27714;
            channel.send(req);
        } catch (RemotingException e) {
            future.cancel();
            throw e;
        }
        // &#36820;&#22238; DefaultFuture &#23545;&#35937;
        return future;
    }
}</pre>
 <p class="ne-p" id="u0a04fa69">
  <br>
 </p>
 <p class="ne-p" id="u00658de7">
  <span class="ne-text">
   &#21040;&#36825;&#37324;&#22823;&#23478;&#32456;&#20110;&#30475;&#21040;&#20102; Request &#35821;&#20041;&#20102;&#65292;&#19978;&#38754;&#30340;&#26041;&#27861;&#39318;&#20808;&#23450;&#20041;&#20102;&#19968;&#20010; Request &#23545;&#35937;&#65292;&#28982;&#21518;&#20877;&#23558;&#35813;&#23545;&#35937;&#20256;&#32473; NettyClient &#30340; send &#26041;&#27861;&#65292;&#36827;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;&#12290;&#38656;&#35201;&#35828;&#26126;&#30340;&#26159;&#65292;NettyClient &#20013;&#24182;&#26410;&#23454;&#29616; send &#26041;&#27861;&#65292;&#35813;&#26041;&#27861;&#32487;&#25215;&#33258;&#29238;&#31867; AbstractPeer&#65292;&#19979;&#38754;&#30452;&#25509;&#20998;&#26512; AbstractPeer &#30340;&#20195;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u9858484a">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="27d8b368">public abstract class AbstractPeer implements Endpoint, ChannelHandler {
    
    @Override
    public void send(Object message) throws RemotingException {
        // &#35813;&#26041;&#27861;&#30001; AbstractClient &#31867;&#23454;&#29616;
        send(message, url.getParameter(Constants.SENT_KEY, false));
    }
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;
}

public abstract class AbstractClient extends AbstractEndpoint implements Client {
    
    @Override
    public void send(Object message, boolean sent) throws RemotingException {
        if (send_reconnect &amp;&amp; !isConnected()) {
            connect();
        }
        
        // &#33719;&#21462; Channel&#65292;getChannel &#26159;&#19968;&#20010;&#25277;&#35937;&#26041;&#27861;&#65292;&#20855;&#20307;&#30001;&#23376;&#31867;&#23454;&#29616;
        Channel channel = getChannel();
        if (channel == null || !channel.isConnected()) {
            throw new RemotingException(this, "message can not send ...");
        }
        
        // &#32487;&#32493;&#21521;&#19979;&#35843;&#29992;
        channel.send(message, sent);
    }
    
    protected abstract Channel getChannel();
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="u9ed433ff">
  <br>
 </p>
 <p class="ne-p" id="u610a6dd3">
  <span class="ne-text">
   &#40664;&#35748;&#24773;&#20917;&#19979;&#65292;Dubbo &#20351;&#29992; Netty &#20316;&#20026;&#24213;&#23618;&#30340;&#36890;&#20449;&#26694;&#26550;&#65292;&#22240;&#27492;&#19979;&#38754;&#25105;&#20204;&#21040; NettyClient &#31867;&#20013;&#30475;&#19968;&#19979; getChannel &#26041;&#27861;&#30340;&#23454;&#29616;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u8a41d1d2">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="85c39fec">public class NettyClient extends AbstractClient {
    
    // &#36825;&#37324;&#30340; Channel &#20840;&#38480;&#23450;&#21517;&#31216;&#20026; org.jboss.netty.channel.Channel
    private volatile Channel channel;

    @Override
    protected com.alibaba.dubbo.remoting.Channel getChannel() {
        Channel c = channel;
        if (c == null || !c.isConnected())
            return null;
        // &#33719;&#21462;&#19968;&#20010; NettyChannel &#31867;&#22411;&#23545;&#35937;
        return NettyChannel.getOrAddChannel(c, getUrl(), this);
    }
}

final class NettyChannel extends AbstractChannel {

    private static final ConcurrentMap&lt;org.jboss.netty.channel.Channel, NettyChannel&gt; channelMap = 
        new ConcurrentHashMap&lt;org.jboss.netty.channel.Channel, NettyChannel&gt;();

    private final org.jboss.netty.channel.Channel channel;
    
    /** &#31169;&#26377;&#26500;&#36896;&#26041;&#27861; */
    private NettyChannel(org.jboss.netty.channel.Channel channel, URL url, ChannelHandler handler) {
        super(url, handler);
        if (channel == null) {
            throw new IllegalArgumentException("netty channel == null;");
        }
        this.channel = channel;
    }

    static NettyChannel getOrAddChannel(org.jboss.netty.channel.Channel ch, URL url, ChannelHandler handler) {
        if (ch == null) {
            return null;
        }
        
        // &#23581;&#35797;&#20174;&#38598;&#21512;&#20013;&#33719;&#21462; NettyChannel &#23454;&#20363;
        NettyChannel ret = channelMap.get(ch);
        if (ret == null) {
            // &#22914;&#26524; ret = null&#65292;&#21017;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340; NettyChannel &#23454;&#20363;
            NettyChannel nc = new NettyChannel(ch, url, handler);
            if (ch.isConnected()) {
                // &#23558; &lt;Channel, NettyChannel&gt; &#38190;&#20540;&#23545;&#23384;&#20837; channelMap &#38598;&#21512;&#20013;
                ret = channelMap.putIfAbsent(ch, nc);
            }
            if (ret == null) {
                ret = nc;
            }
        }
        return ret;
    }
}</pre>
 <p class="ne-p" id="u6f4c7986">
  <br>
 </p>
 <p class="ne-p" id="u5f8633be">
  <span class="ne-text">
   &#33719;&#21462;&#21040; NettyChannel &#23454;&#20363;&#21518;&#65292;&#21363;&#21487;&#36827;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;&#12290;&#19979;&#38754;&#30475;&#19968;&#19979; NettyChannel &#30340; send &#26041;&#27861;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u78c16177">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="f001d151">public void send(Object message, boolean sent) throws RemotingException {
    super.send(message, sent);

    boolean success = true;
    int timeout = 0;
    try {
        // &#21457;&#36865;&#28040;&#24687;(&#21253;&#21547;&#35831;&#27714;&#21644;&#21709;&#24212;&#28040;&#24687;)
        ChannelFuture future = channel.write(message);
        
        // sent &#30340;&#20540;&#28304;&#20110; &lt;dubbo:method sent="true/false" /&gt; &#20013; sent &#30340;&#37197;&#32622;&#20540;&#65292;&#26377;&#20004;&#31181;&#37197;&#32622;&#20540;&#65306;
        //   1. true: &#31561;&#24453;&#28040;&#24687;&#21457;&#20986;&#65292;&#28040;&#24687;&#21457;&#36865;&#22833;&#36133;&#23558;&#25243;&#20986;&#24322;&#24120;
        //   2. false: &#19981;&#31561;&#24453;&#28040;&#24687;&#21457;&#20986;&#65292;&#23558;&#28040;&#24687;&#25918;&#20837; IO &#38431;&#21015;&#65292;&#21363;&#21051;&#36820;&#22238;
        // &#40664;&#35748;&#24773;&#20917;&#19979; sent = false&#65307;
        if (sent) {
            timeout = getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
            // &#31561;&#24453;&#28040;&#24687;&#21457;&#20986;&#65292;&#33509;&#22312;&#35268;&#23450;&#26102;&#38388;&#27809;&#33021;&#21457;&#20986;&#65292;success &#20250;&#34987;&#32622;&#20026; false
            success = future.await(timeout);
        }
        Throwable cause = future.getCause();
        if (cause != null) {
            throw cause;
        }
    } catch (Throwable e) {
        throw new RemotingException(this, "Failed to send message ...");
    }

    // &#33509; success &#20026; false&#65292;&#36825;&#37324;&#25243;&#20986;&#24322;&#24120;
    if (!success) {
        throw new RemotingException(this, "Failed to send message ...");
    }
}</pre>
 <p class="ne-p" id="uc7f920c5">
  <br>
 </p>
 <p class="ne-p" id="u9fa4679c">
  <span class="ne-text">
   &#32463;&#21382;&#22810;&#27425;&#35843;&#29992;&#65292;&#21040;&#36825;&#37324;&#35831;&#27714;&#25968;&#25454;&#30340;&#21457;&#36865;&#36807;&#31243;&#23601;&#32467;&#26463;&#20102;&#65292;&#36807;&#31243;&#28459;&#38271;&#12290;&#20026;&#20102;&#20415;&#20110;&#22823;&#23478;&#38405;&#35835;&#20195;&#30721;&#65292;&#36825;&#37324;&#20197; DemoService &#20026;&#20363;&#65292;&#23558; sayHello &#26041;&#27861;&#30340;&#25972;&#20010;&#35843;&#29992;&#36335;&#24452;&#36148;&#20986;&#26469;&#12290;
  </span>
 </p>
 <p class="ne-p" id="uc529e7a6">
  <br>
 </p>
 <pre class="ne-codeblock language-fallback" data-language="fallback" id="55d475a5">proxy0#sayHello(String)
  &#8212;&gt; InvokerInvocationHandler#invoke(Object, Method, Object[])
    &#8212;&gt; MockClusterInvoker#invoke(Invocation)
      &#8212;&gt; AbstractClusterInvoker#invoke(Invocation)
        &#8212;&gt; FailoverClusterInvoker#doInvoke(Invocation, List&lt;Invoker&lt;T&gt;&gt;, LoadBalance)
          &#8212;&gt; Filter#invoke(Invoker, Invocation)  // &#21253;&#21547;&#22810;&#20010; Filter &#35843;&#29992;
            &#8212;&gt; ListenerInvokerWrapper#invoke(Invocation) 
              &#8212;&gt; AbstractInvoker#invoke(Invocation) 
                &#8212;&gt; DubboInvoker#doInvoke(Invocation)
                  &#8212;&gt; ReferenceCountExchangeClient#request(Object, int)
                    &#8212;&gt; HeaderExchangeClient#request(Object, int)
                      &#8212;&gt; HeaderExchangeChannel#request(Object, int)
                        &#8212;&gt; AbstractPeer#send(Object)
                          &#8212;&gt; AbstractClient#send(Object, boolean)
                            &#8212;&gt; NettyChannel#send(Object, boolean)
                              &#8212;&gt; NioClientSocketChannel#write(Object)</pre>
 <p class="ne-p" id="u98c0ca4b">
  <br>
 </p>
 <p class="ne-p" id="u550e1eba">
  <span class="ne-text">
   &#22312; Netty &#20013;&#65292;&#20986;&#31449;&#25968;&#25454;&#22312;&#21457;&#20986;&#20043;&#21069;&#36824;&#38656;&#35201;&#36827;&#34892;&#32534;&#30721;&#25805;&#20316;&#65292;&#25509;&#19979;&#26469;&#25105;&#20204;&#26469;&#20998;&#26512;&#19968;&#19979;&#35831;&#27714;&#25968;&#25454;&#30340;&#32534;&#30721;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u7a4ab679">
  <br>
 </p>
 <h4 id="cc10f4bc">
  <span class="ne-text">
   2.2.2 &#35831;&#27714;&#32534;&#30721;
  </span>
 </h4>
 <p class="ne-p" id="ubf4c0e29">
  <br>
 </p>
 <p class="ne-p" id="uf946ddbb">
  <span class="ne-text">
   &#22312;&#20998;&#26512;&#35831;&#27714;&#32534;&#30721;&#36923;&#36753;&#20043;&#21069;&#65292;&#25105;&#20204;&#20808;&#26469;&#30475;&#19968;&#19979; Dubbo &#25968;&#25454;&#21253;&#32467;&#26500;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u46ebd764">
  <br>
 </p>
 <p class="ne-p" id="u9c8b7590">
  <img class="ne-image" id="QHF2J" src="EPUB/imgQHF2J" width="1316">
 </p>
 <p class="ne-p" id="u7b242d48">
  <br>
 </p>
 <p class="ne-p" id="u04b58a52">
  <span class="ne-text">
   Dubbo &#25968;&#25454;&#21253;&#20998;&#20026;&#28040;&#24687;&#22836;&#21644;&#28040;&#24687;&#20307;&#65292;&#28040;&#24687;&#22836;&#29992;&#20110;&#23384;&#20648;&#19968;&#20123;&#20803;&#20449;&#24687;&#65292;&#27604;&#22914;&#39764;&#25968;&#65288;Magic&#65289;&#65292;&#25968;&#25454;&#21253;&#31867;&#22411;&#65288;Request/Response&#65289;&#65292;&#28040;&#24687;&#20307;&#38271;&#24230;&#65288;Data Length&#65289;&#31561;&#12290;&#28040;&#24687;&#20307;&#20013;&#29992;&#20110;&#23384;&#20648;&#20855;&#20307;&#30340;&#35843;&#29992;&#28040;&#24687;&#65292;&#27604;&#22914;&#26041;&#27861;&#21517;&#31216;&#65292;&#21442;&#25968;&#21015;&#34920;&#31561;&#12290;&#19979;&#38754;&#31616;&#21333;&#21015;&#20030;&#19968;&#19979;&#28040;&#24687;&#22836;&#30340;&#20869;&#23481;&#12290;
  </span>
 </p>
 <table class="ne-table" id="897b0261" style="width: 750px">
  <tbody>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="u9fffadd3">
      <span class="ne-text">
       &#20559;&#31227;&#37327;(Bit)
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u0212aa27">
      <span class="ne-text">
       &#23383;&#27573;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u593ae43a">
      <span class="ne-text">
       &#21462;&#20540;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="u614acad0">
      <span class="ne-text">
       0 ~ 7
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u94cd3cce">
      <span class="ne-text">
       &#39764;&#25968;&#39640;&#20301;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u0155b61c">
      <span class="ne-text">
       0xda00
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="ubc5742be">
      <span class="ne-text">
       8 ~ 15
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u052b32e2">
      <span class="ne-text">
       &#39764;&#25968;&#20302;&#20301;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="udffcfb19">
      <span class="ne-text">
       0xbb
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="u706059f2">
      <span class="ne-text">
       16
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u6e0b2b87">
      <span class="ne-text">
       &#25968;&#25454;&#21253;&#31867;&#22411;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="ua0a9abf7">
      <span class="ne-text">
       0 - Response, 1 - Request
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="u1f724853">
      <span class="ne-text">
       17
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="uba8ac5af">
      <span class="ne-text">
       &#35843;&#29992;&#26041;&#24335;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u8d9ea8d2">
      <span class="ne-text">
       &#20165;&#22312;&#31532;16&#20301;&#34987;&#35774;&#20026;1&#30340;&#24773;&#20917;&#19979;&#26377;&#25928;&#65292;0 - &#21333;&#21521;&#35843;&#29992;&#65292;1 - &#21452;&#21521;&#35843;&#29992;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="ue816e58e">
      <span class="ne-text">
       18
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u184a5b4b">
      <span class="ne-text">
       &#20107;&#20214;&#26631;&#35782;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="uad3e8647">
      <span class="ne-text">
       0 - &#24403;&#21069;&#25968;&#25454;&#21253;&#26159;&#35831;&#27714;&#25110;&#21709;&#24212;&#21253;&#65292;1 - &#24403;&#21069;&#25968;&#25454;&#21253;&#26159;&#24515;&#36339;&#21253;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="uc9e88b54">
      <span class="ne-text">
       19 ~ 23
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u4f3ba4a5">
      <span class="ne-text">
       &#24207;&#21015;&#21270;&#22120;&#32534;&#21495;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u947e9575">
      <span class="ne-text">
       2 - Hessian2Serialization 3 - JavaSerialization 4 - CompactedJavaSerialization 6 - FastJsonSerialization 7 - NativeJavaSerialization 8 - KryoSerialization 9 - FstSerialization
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="uf22939be">
      <span class="ne-text">
       24 ~ 31
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u59b9f292">
      <span class="ne-text">
       &#29366;&#24577;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="ua4c3703b">
      <span class="ne-text">
       20 - OK 30 - CLIENT_TIMEOUT 31 - SERVER_TIMEOUT 40 - BAD_REQUEST 50 - BAD_RESPONSE &#8230;&#8230;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="u874bef3b">
      <span class="ne-text">
       32 ~ 95
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u9b49d11e">
      <span class="ne-text">
       &#35831;&#27714;&#32534;&#21495;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="ue3d0e23d">
      <span class="ne-text">
       &#20849;8&#23383;&#33410;&#65292;&#36816;&#34892;&#26102;&#29983;&#25104;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="250">
     <p class="ne-p" id="u426e19f4">
      <span class="ne-text">
       96 ~ 127
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="ufee193d5">
      <span class="ne-text">
       &#28040;&#24687;&#20307;&#38271;&#24230;
      </span>
     </p>
    </td>
    <td width="250">
     <p class="ne-p" id="u59827f9e">
      <span class="ne-text">
       &#36816;&#34892;&#26102;&#35745;&#31639;
      </span>
     </p>
    </td>
   </tr>
  </tbody>
 </table>
 <p class="ne-p" id="ua8818289">
  <br>
 </p>
 <p class="ne-p" id="u9e2be53f">
  <span class="ne-text">
   &#20102;&#35299;&#20102; Dubbo &#25968;&#25454;&#21253;&#26684;&#24335;&#65292;&#25509;&#19979;&#26469;&#25105;&#20204;&#23601;&#21487;&#20197;&#25506;&#32034;&#32534;&#30721;&#36807;&#31243;&#20102;&#12290;&#36825;&#27425;&#25105;&#20204;&#24320;&#38376;&#35265;&#23665;&#65292;&#30452;&#25509;&#20998;&#26512;&#32534;&#30721;&#36923;&#36753;&#25152;&#22312;&#31867;&#12290;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u5bdd417d">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="aeee49e3">public class ExchangeCodec extends TelnetCodec {

    // &#28040;&#24687;&#22836;&#38271;&#24230;
    protected static final int HEADER_LENGTH = 16;
    // &#39764;&#25968;&#20869;&#23481;
    protected static final short MAGIC = (short) 0xdabb;
    protected static final byte MAGIC_HIGH = Bytes.short2bytes(MAGIC)[0];
    protected static final byte MAGIC_LOW = Bytes.short2bytes(MAGIC)[1];
    protected static final byte FLAG_REQUEST = (byte) 0x80;
    protected static final byte FLAG_TWOWAY = (byte) 0x40;
    protected static final byte FLAG_EVENT = (byte) 0x20;
    protected static final int SERIALIZATION_MASK = 0x1f;
    private static final Logger logger = LoggerFactory.getLogger(ExchangeCodec.class);

    public Short getMagicCode() {
        return MAGIC;
    }

    @Override
    public void encode(Channel channel, ChannelBuffer buffer, Object msg) throws IOException {
        if (msg instanceof Request) {
            // &#23545; Request &#23545;&#35937;&#36827;&#34892;&#32534;&#30721;
            encodeRequest(channel, buffer, (Request) msg);
        } else if (msg instanceof Response) {
            // &#23545; Response &#23545;&#35937;&#36827;&#34892;&#32534;&#30721;&#65292;&#21518;&#38754;&#20998;&#26512;
            encodeResponse(channel, buffer, (Response) msg);
        } else {
            super.encode(channel, buffer, msg);
        }
    }

    protected void encodeRequest(Channel channel, ChannelBuffer buffer, Request req) throws IOException {
        Serialization serialization = getSerialization(channel);

        // &#21019;&#24314;&#28040;&#24687;&#22836;&#23383;&#33410;&#25968;&#32452;&#65292;&#38271;&#24230;&#20026; 16
        byte[] header = new byte[HEADER_LENGTH];

        // &#35774;&#32622;&#39764;&#25968;
        Bytes.short2bytes(MAGIC, header);

        // &#35774;&#32622;&#25968;&#25454;&#21253;&#31867;&#22411;&#65288;Request/Response&#65289;&#21644;&#24207;&#21015;&#21270;&#22120;&#32534;&#21495;
        header[2] = (byte) (FLAG_REQUEST | serialization.getContentTypeId());

        // &#35774;&#32622;&#36890;&#20449;&#26041;&#24335;(&#21333;&#21521;/&#21452;&#21521;)
        if (req.isTwoWay()) {
            header[2] |= FLAG_TWOWAY;
        }
        
        // &#35774;&#32622;&#20107;&#20214;&#26631;&#35782;
        if (req.isEvent()) {
            header[2] |= FLAG_EVENT;
        }

        // &#35774;&#32622;&#35831;&#27714;&#32534;&#21495;&#65292;8&#20010;&#23383;&#33410;&#65292;&#20174;&#31532;4&#20010;&#23383;&#33410;&#24320;&#22987;&#35774;&#32622;
        Bytes.long2bytes(req.getId(), header, 4);

        // &#33719;&#21462; buffer &#24403;&#21069;&#30340;&#20889;&#20301;&#32622;
        int savedWriteIndex = buffer.writerIndex();
        // &#26356;&#26032; writerIndex&#65292;&#20026;&#28040;&#24687;&#22836;&#39044;&#30041; 16 &#20010;&#23383;&#33410;&#30340;&#31354;&#38388;
        buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);
        ChannelBufferOutputStream bos = new ChannelBufferOutputStream(buffer);
        // &#21019;&#24314;&#24207;&#21015;&#21270;&#22120;&#65292;&#27604;&#22914; Hessian2ObjectOutput
        ObjectOutput out = serialization.serialize(channel.getUrl(), bos);
        if (req.isEvent()) {
            // &#23545;&#20107;&#20214;&#25968;&#25454;&#36827;&#34892;&#24207;&#21015;&#21270;&#25805;&#20316;
            encodeEventData(channel, out, req.getData());
        } else {
            // &#23545;&#35831;&#27714;&#25968;&#25454;&#36827;&#34892;&#24207;&#21015;&#21270;&#25805;&#20316;
            encodeRequestData(channel, out, req.getData(), req.getVersion());
        }
        out.flushBuffer();
        if (out instanceof Cleanable) {
            ((Cleanable) out).cleanup();
        }
        bos.flush();
        bos.close();
        
        // &#33719;&#21462;&#20889;&#20837;&#30340;&#23383;&#33410;&#25968;&#65292;&#20063;&#23601;&#26159;&#28040;&#24687;&#20307;&#38271;&#24230;
        int len = bos.writtenBytes();
        checkPayload(channel, len);

        // &#23558;&#28040;&#24687;&#20307;&#38271;&#24230;&#20889;&#20837;&#21040;&#28040;&#24687;&#22836;&#20013;
        Bytes.int2bytes(len, header, 12);

        // &#23558; buffer &#25351;&#38024;&#31227;&#21160;&#21040; savedWriteIndex&#65292;&#20026;&#20889;&#28040;&#24687;&#22836;&#20570;&#20934;&#22791;
        buffer.writerIndex(savedWriteIndex);
        // &#20174; savedWriteIndex &#19979;&#26631;&#22788;&#20889;&#20837;&#28040;&#24687;&#22836;
        buffer.writeBytes(header);
        // &#35774;&#32622;&#26032;&#30340; writerIndex&#65292;writerIndex = &#21407;&#20889;&#19979;&#26631; + &#28040;&#24687;&#22836;&#38271;&#24230; + &#28040;&#24687;&#20307;&#38271;&#24230;
        buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);
    }
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="ubf06fca0">
  <br>
 </p>
 <p class="ne-p" id="u5621ef76">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159;&#35831;&#27714;&#23545;&#35937;&#30340;&#32534;&#30721;&#36807;&#31243;&#65292;&#35813;&#36807;&#31243;&#39318;&#20808;&#20250;&#36890;&#36807;&#20301;&#36816;&#31639;&#23558;&#28040;&#24687;&#22836;&#20889;&#20837;&#21040; header &#25968;&#32452;&#20013;&#12290;&#28982;&#21518;&#23545; Request &#23545;&#35937;&#30340; data &#23383;&#27573;&#25191;&#34892;&#24207;&#21015;&#21270;&#25805;&#20316;&#65292;&#24207;&#21015;&#21270;&#21518;&#30340;&#25968;&#25454;&#26368;&#32456;&#20250;&#23384;&#20648;&#21040; ChannelBuffer &#20013;&#12290;&#24207;&#21015;&#21270;&#25805;&#20316;&#25191;&#34892;&#23436;&#21518;&#65292;&#21487;&#24471;&#21040;&#25968;&#25454;&#24207;&#21015;&#21270;&#21518;&#30340;&#38271;&#24230; len&#65292;&#32039;&#25509;&#30528;&#23558; len &#20889;&#20837;&#21040; header &#25351;&#23450;&#20301;&#32622;&#22788;&#12290;&#26368;&#21518;&#20877;&#23558;&#28040;&#24687;&#22836;&#23383;&#33410;&#25968;&#32452; header &#20889;&#20837;&#21040; ChannelBuffer &#20013;&#65292;&#25972;&#20010;&#32534;&#30721;&#36807;&#31243;&#23601;&#32467;&#26463;&#20102;&#12290;&#26412;&#33410;&#30340;&#26368;&#21518;&#65292;&#25105;&#20204;&#20877;&#26469;&#30475;&#19968;&#19979; Request &#23545;&#35937;&#30340; data &#23383;&#27573;&#24207;&#21015;&#21270;&#36807;&#31243;&#65292;&#20063;&#23601;&#26159; encodeRequestData &#26041;&#27861;&#30340;&#36923;&#36753;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u7c7ba701">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="6a768c6b">public class DubboCodec extends ExchangeCodec implements Codec2 {
    
	protected void encodeRequestData(Channel channel, ObjectOutput out, Object data, String version) throws IOException {
        RpcInvocation inv = (RpcInvocation) data;

        // &#20381;&#27425;&#24207;&#21015;&#21270; dubbo version&#12289;path&#12289;version
        out.writeUTF(version);
        out.writeUTF(inv.getAttachment(Constants.PATH_KEY));
        out.writeUTF(inv.getAttachment(Constants.VERSION_KEY));

        // &#24207;&#21015;&#21270;&#35843;&#29992;&#26041;&#27861;&#21517;
        out.writeUTF(inv.getMethodName());
        // &#23558;&#21442;&#25968;&#31867;&#22411;&#36716;&#25442;&#20026;&#23383;&#31526;&#20018;&#65292;&#24182;&#36827;&#34892;&#24207;&#21015;&#21270;
        out.writeUTF(ReflectUtils.getDesc(inv.getParameterTypes()));
        Object[] args = inv.getArguments();
        if (args != null)
            for (int i = 0; i &lt; args.length; i++) {
                // &#23545;&#36816;&#34892;&#26102;&#21442;&#25968;&#36827;&#34892;&#24207;&#21015;&#21270;
                out.writeObject(encodeInvocationArgument(channel, inv, i));
            }
        
        // &#24207;&#21015;&#21270; attachments
        out.writeObject(inv.getAttachments());
    }
}</pre>
 <p class="ne-p" id="u7d07c9b9">
  <br>
 </p>
 <p class="ne-p" id="uf8158bb0">
  <span class="ne-text">
   &#33267;&#27492;&#65292;&#20851;&#20110;&#26381;&#21153;&#28040;&#36153;&#26041;&#21457;&#36865;&#35831;&#27714;&#30340;&#36807;&#31243;&#23601;&#20998;&#26512;&#23436;&#20102;&#65292;&#25509;&#19979;&#26469;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#26381;&#21153;&#25552;&#20379;&#26041;&#26159;&#22914;&#20309;&#25509;&#25910;&#35831;&#27714;&#30340;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u162ae896">
  <br>
 </p>
 <h3 id="953717bc">
  <span class="ne-text">
   2.3 &#26381;&#21153;&#25552;&#20379;&#26041;&#25509;&#25910;&#35831;&#27714;
  </span>
 </h3>
 <p class="ne-p" id="ub651a5dc">
  <br>
 </p>
 <p class="ne-p" id="u5a63476f">
  <span class="ne-text">
   &#21069;&#38754;&#35828;&#36807;&#65292;&#40664;&#35748;&#24773;&#20917;&#19979; Dubbo &#20351;&#29992; Netty &#20316;&#20026;&#24213;&#23618;&#30340;&#36890;&#20449;&#26694;&#26550;&#12290;Netty &#26816;&#27979;&#21040;&#26377;&#25968;&#25454;&#20837;&#31449;&#21518;&#65292;&#39318;&#20808;&#20250;&#36890;&#36807;&#35299;&#30721;&#22120;&#23545;&#25968;&#25454;&#36827;&#34892;&#35299;&#30721;&#65292;&#24182;&#23558;&#35299;&#30721;&#21518;&#30340;&#25968;&#25454;&#20256;&#36882;&#32473;&#19979;&#19968;&#20010;&#20837;&#31449;&#22788;&#29702;&#22120;&#30340;&#25351;&#23450;&#26041;&#27861;&#12290;&#25152;&#20197;&#22312;&#36827;&#34892;&#21518;&#32493;&#30340;&#20998;&#26512;&#20043;&#21069;&#65292;&#25105;&#20204;&#20808;&#26469;&#30475;&#19968;&#19979;&#25968;&#25454;&#35299;&#30721;&#36807;&#31243;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u82478bc6">
  <br>
 </p>
 <h4 id="9d5009e9">
  <span class="ne-text">
   2.3.1 &#35831;&#27714;&#35299;&#30721;
  </span>
 </h4>
 <p class="ne-p" id="uc25dc41e">
  <br>
 </p>
 <p class="ne-p" id="ue377a483">
  <span class="ne-text">
   &#36825;&#37324;&#30452;&#25509;&#20998;&#26512;&#35831;&#27714;&#25968;&#25454;&#30340;&#35299;&#30721;&#36923;&#36753;&#65292;&#24573;&#30053;&#20013;&#38388;&#36807;&#31243;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ucdc90e93">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="011ecdb1">public class ExchangeCodec extends TelnetCodec {
    
    @Override
    public Object decode(Channel channel, ChannelBuffer buffer) throws IOException {
        int readable = buffer.readableBytes();
        // &#21019;&#24314;&#28040;&#24687;&#22836;&#23383;&#33410;&#25968;&#32452;
        byte[] header = new byte[Math.min(readable, HEADER_LENGTH)];
        // &#35835;&#21462;&#28040;&#24687;&#22836;&#25968;&#25454;
        buffer.readBytes(header);
        // &#35843;&#29992;&#37325;&#36733;&#26041;&#27861;&#36827;&#34892;&#21518;&#32493;&#35299;&#30721;&#24037;&#20316;
        return decode(channel, buffer, readable, header);
    }

    @Override
    protected Object decode(Channel channel, ChannelBuffer buffer, int readable, byte[] header) throws IOException {
        // &#26816;&#26597;&#39764;&#25968;&#26159;&#21542;&#30456;&#31561;
        if (readable &gt; 0 &amp;&amp; header[0] != MAGIC_HIGH
                || readable &gt; 1 &amp;&amp; header[1] != MAGIC_LOW) {
            int length = header.length;
            if (header.length &lt; readable) {
                header = Bytes.copyOf(header, readable);
                buffer.readBytes(header, length, readable - length);
            }
            for (int i = 1; i &lt; header.length - 1; i++) {
                if (header[i] == MAGIC_HIGH &amp;&amp; header[i + 1] == MAGIC_LOW) {
                    buffer.readerIndex(buffer.readerIndex() - header.length + i);
                    header = Bytes.copyOf(header, i);
                    break;
                }
            }
            // &#36890;&#36807; telnet &#21629;&#20196;&#34892;&#21457;&#36865;&#30340;&#25968;&#25454;&#21253;&#19981;&#21253;&#21547;&#28040;&#24687;&#22836;&#65292;&#25152;&#20197;&#36825;&#37324;
            // &#35843;&#29992; TelnetCodec &#30340; decode &#26041;&#27861;&#23545;&#25968;&#25454;&#21253;&#36827;&#34892;&#35299;&#30721;
            return super.decode(channel, buffer, readable, header);
        }
        
        // &#26816;&#27979;&#21487;&#35835;&#25968;&#25454;&#37327;&#26159;&#21542;&#23569;&#20110;&#28040;&#24687;&#22836;&#38271;&#24230;&#65292;&#33509;&#23567;&#20110;&#21017;&#31435;&#21363;&#36820;&#22238; DecodeResult.NEED_MORE_INPUT
        if (readable &lt; HEADER_LENGTH) {
            return DecodeResult.NEED_MORE_INPUT;
        }

        // &#20174;&#28040;&#24687;&#22836;&#20013;&#33719;&#21462;&#28040;&#24687;&#20307;&#38271;&#24230;
        int len = Bytes.bytes2int(header, 12);
        // &#26816;&#27979;&#28040;&#24687;&#20307;&#38271;&#24230;&#26159;&#21542;&#36229;&#20986;&#38480;&#21046;&#65292;&#36229;&#20986;&#21017;&#25243;&#20986;&#24322;&#24120;
        checkPayload(channel, len);

        int tt = len + HEADER_LENGTH;
        // &#26816;&#27979;&#21487;&#35835;&#30340;&#23383;&#33410;&#25968;&#26159;&#21542;&#23567;&#20110;&#23454;&#38469;&#30340;&#23383;&#33410;&#25968;
        if (readable &lt; tt) {
            return DecodeResult.NEED_MORE_INPUT;
        }
        
        ChannelBufferInputStream is = new ChannelBufferInputStream(buffer, len);

        try {
            // &#32487;&#32493;&#36827;&#34892;&#35299;&#30721;&#24037;&#20316;
            return decodeBody(channel, is, header);
        } finally {
            if (is.available() &gt; 0) {
                try {
                    StreamUtils.skipUnusedStream(is);
                } catch (IOException e) {
                    logger.warn(e.getMessage(), e);
                }
            }
        }
    }
}</pre>
 <p class="ne-p" id="u2ab688ab">
  <br>
 </p>
 <p class="ne-p" id="u0d8b2709">
  <span class="ne-text">
   &#19978;&#38754;&#26041;&#27861;&#36890;&#36807;&#26816;&#27979;&#28040;&#24687;&#22836;&#20013;&#30340;&#39764;&#25968;&#26159;&#21542;&#19982;&#35268;&#23450;&#30340;&#39764;&#25968;&#30456;&#31561;&#65292;&#25552;&#21069;&#25318;&#25130;&#25481;&#38750;&#24120;&#35268;&#25968;&#25454;&#21253;&#65292;&#27604;&#22914;&#36890;&#36807; telnet &#21629;&#20196;&#34892;&#21457;&#20986;&#30340;&#25968;&#25454;&#21253;&#12290;&#25509;&#30528;&#20877;&#23545;&#28040;&#24687;&#20307;&#38271;&#24230;&#65292;&#20197;&#21450;&#21487;&#35835;&#23383;&#33410;&#25968;&#36827;&#34892;&#26816;&#27979;&#12290;&#26368;&#21518;&#35843;&#29992; decodeBody &#26041;&#27861;&#36827;&#34892;&#21518;&#32493;&#30340;&#35299;&#30721;&#24037;&#20316;&#65292;ExchangeCodec &#20013;&#23454;&#29616;&#20102; decodeBody &#26041;&#27861;&#65292;&#20294;&#22240;&#20854;&#23376;&#31867; DubboCodec &#35206;&#20889;&#20102;&#35813;&#26041;&#27861;&#65292;&#25152;&#20197;&#22312;&#36816;&#34892;&#26102; DubboCodec &#20013;&#30340; decodeBody &#26041;&#27861;&#20250;&#34987;&#35843;&#29992;&#12290;&#19979;&#38754;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#35813;&#26041;&#27861;&#30340;&#20195;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u9402fa61">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="cb5787c2">public class DubboCodec extends ExchangeCodec implements Codec2 {

    @Override
    protected Object decodeBody(Channel channel, InputStream is, byte[] header) throws IOException {
        // &#33719;&#21462;&#28040;&#24687;&#22836;&#20013;&#30340;&#31532;&#19977;&#20010;&#23383;&#33410;&#65292;&#24182;&#36890;&#36807;&#36923;&#36753;&#19982;&#36816;&#31639;&#24471;&#21040;&#24207;&#21015;&#21270;&#22120;&#32534;&#21495;
        byte flag = header[2], proto = (byte) (flag &amp; SERIALIZATION_MASK);
        Serialization s = CodecSupport.getSerialization(channel.getUrl(), proto);
        // &#33719;&#21462;&#35843;&#29992;&#32534;&#21495;
        long id = Bytes.bytes2long(header, 4);
        // &#36890;&#36807;&#36923;&#36753;&#19982;&#36816;&#31639;&#24471;&#21040;&#35843;&#29992;&#31867;&#22411;&#65292;0 - Response&#65292;1 - Request
        if ((flag &amp; FLAG_REQUEST) == 0) {
            // &#23545;&#21709;&#24212;&#32467;&#26524;&#36827;&#34892;&#35299;&#30721;&#65292;&#24471;&#21040; Response &#23545;&#35937;&#12290;&#36825;&#20010;&#38750;&#26412;&#33410;&#20869;&#23481;&#65292;&#21518;&#38754;&#20877;&#20998;&#26512;
            // ...
        } else {
            // &#21019;&#24314; Request &#23545;&#35937;
            Request req = new Request(id);
            req.setVersion(Version.getProtocolVersion());
            // &#36890;&#36807;&#36923;&#36753;&#19982;&#36816;&#31639;&#24471;&#21040;&#36890;&#20449;&#26041;&#24335;&#65292;&#24182;&#35774;&#32622;&#21040; Request &#23545;&#35937;&#20013;
            req.setTwoWay((flag &amp; FLAG_TWOWAY) != 0);
            
            // &#36890;&#36807;&#20301;&#36816;&#31639;&#26816;&#27979;&#25968;&#25454;&#21253;&#26159;&#21542;&#20026;&#20107;&#20214;&#31867;&#22411;
            if ((flag &amp; FLAG_EVENT) != 0) {
                // &#35774;&#32622;&#24515;&#36339;&#20107;&#20214;&#21040; Request &#23545;&#35937;&#20013;
                req.setEvent(Request.HEARTBEAT_EVENT);
            }
            try {
                Object data;
                if (req.isHeartbeat()) {
                    // &#23545;&#24515;&#36339;&#21253;&#36827;&#34892;&#35299;&#30721;&#65292;&#35813;&#26041;&#27861;&#24050;&#34987;&#26631;&#27880;&#20026;&#24223;&#24323;
                    data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));
                } else if (req.isEvent()) {
                    // &#23545;&#20107;&#20214;&#25968;&#25454;&#36827;&#34892;&#35299;&#30721;
                    data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));
                } else {
                    DecodeableRpcInvocation inv;
                    // &#26681;&#25454; url &#21442;&#25968;&#21028;&#26029;&#26159;&#21542;&#22312; IO &#32447;&#31243;&#19978;&#23545;&#28040;&#24687;&#20307;&#36827;&#34892;&#35299;&#30721;
                    if (channel.getUrl().getParameter(
                            Constants.DECODE_IN_IO_THREAD_KEY,
                            Constants.DEFAULT_DECODE_IN_IO_THREAD)) {
                        inv = new DecodeableRpcInvocation(channel, req, is, proto);
                        // &#22312;&#24403;&#21069;&#32447;&#31243;&#65292;&#20063;&#23601;&#26159; IO &#32447;&#31243;&#19978;&#36827;&#34892;&#21518;&#32493;&#30340;&#35299;&#30721;&#24037;&#20316;&#12290;&#27492;&#24037;&#20316;&#23436;&#25104;&#21518;&#65292;&#21487;&#23558;
                        // &#35843;&#29992;&#26041;&#27861;&#21517;&#12289;attachment&#12289;&#20197;&#21450;&#35843;&#29992;&#21442;&#25968;&#35299;&#26512;&#20986;&#26469;
                        inv.decode();
                    } else {
                        // &#20165;&#21019;&#24314; DecodeableRpcInvocation &#23545;&#35937;&#65292;&#20294;&#19981;&#22312;&#24403;&#21069;&#32447;&#31243;&#19978;&#25191;&#34892;&#35299;&#30721;&#36923;&#36753;
                        inv = new DecodeableRpcInvocation(channel, req,
                                new UnsafeByteArrayInputStream(readMessageData(is)), proto);
                    }
                    data = inv;
                }
                
                // &#35774;&#32622; data &#21040; Request &#23545;&#35937;&#20013;
                req.setData(data);
            } catch (Throwable t) {
                // &#33509;&#35299;&#30721;&#36807;&#31243;&#20013;&#20986;&#29616;&#24322;&#24120;&#65292;&#21017;&#23558; broken &#23383;&#27573;&#35774;&#20026; true&#65292;
                // &#24182;&#23558;&#24322;&#24120;&#23545;&#35937;&#35774;&#32622;&#21040; Reqeust &#23545;&#35937;&#20013;
                req.setBroken(true);
                req.setData(t);
            }
            return req;
        }
    }
}</pre>
 <p class="ne-p" id="u226443f9">
  <br>
 </p>
 <p class="ne-p" id="u4f8656ee">
  <span class="ne-text">
   &#22914;&#19978;&#65292;decodeBody &#23545;&#37096;&#20998;&#23383;&#27573;&#36827;&#34892;&#20102;&#35299;&#30721;&#65292;&#24182;&#23558;&#35299;&#30721;&#24471;&#21040;&#30340;&#23383;&#27573;&#23553;&#35013;&#21040; Request &#20013;&#12290;&#38543;&#21518;&#20250;&#35843;&#29992; DecodeableRpcInvocation &#30340; decode &#26041;&#27861;&#36827;&#34892;&#21518;&#32493;&#30340;&#35299;&#30721;&#24037;&#20316;&#12290;&#27492;&#24037;&#20316;&#23436;&#25104;&#21518;&#65292;&#21487;&#23558;&#35843;&#29992;&#26041;&#27861;&#21517;&#12289;attachment&#12289;&#20197;&#21450;&#35843;&#29992;&#21442;&#25968;&#35299;&#26512;&#20986;&#26469;&#12290;&#19979;&#38754;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979; DecodeableRpcInvocation &#30340; decode &#26041;&#27861;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u2ed034b6">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="ac055433">public class DecodeableRpcInvocation extends RpcInvocation implements Codec, Decodeable {
    
	@Override
    public Object decode(Channel channel, InputStream input) throws IOException {
        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), serializationType)
                .deserialize(channel.getUrl(), input);

        // &#36890;&#36807;&#21453;&#24207;&#21015;&#21270;&#24471;&#21040; dubbo version&#65292;&#24182;&#20445;&#23384;&#21040; attachments &#21464;&#37327;&#20013;
        String dubboVersion = in.readUTF();
        request.setVersion(dubboVersion);
        setAttachment(Constants.DUBBO_VERSION_KEY, dubboVersion);

        // &#36890;&#36807;&#21453;&#24207;&#21015;&#21270;&#24471;&#21040; path&#65292;version&#65292;&#24182;&#20445;&#23384;&#21040; attachments &#21464;&#37327;&#20013;
        setAttachment(Constants.PATH_KEY, in.readUTF());
        setAttachment(Constants.VERSION_KEY, in.readUTF());

        // &#36890;&#36807;&#21453;&#24207;&#21015;&#21270;&#24471;&#21040;&#35843;&#29992;&#26041;&#27861;&#21517;
        setMethodName(in.readUTF());
        try {
            Object[] args;
            Class&lt;?&gt;[] pts;
            // &#36890;&#36807;&#21453;&#24207;&#21015;&#21270;&#24471;&#21040;&#21442;&#25968;&#31867;&#22411;&#23383;&#31526;&#20018;&#65292;&#27604;&#22914; Ljava/lang/String;
            String desc = in.readUTF();
            if (desc.length() == 0) {
                pts = DubboCodec.EMPTY_CLASS_ARRAY;
                args = DubboCodec.EMPTY_OBJECT_ARRAY;
            } else {
                // &#23558; desc &#35299;&#26512;&#20026;&#21442;&#25968;&#31867;&#22411;&#25968;&#32452;
                pts = ReflectUtils.desc2classArray(desc);
                args = new Object[pts.length];
                for (int i = 0; i &lt; args.length; i++) {
                    try {
                        // &#35299;&#26512;&#36816;&#34892;&#26102;&#21442;&#25968;
                        args[i] = in.readObject(pts[i]);
                    } catch (Exception e) {
                        if (log.isWarnEnabled()) {
                            log.warn("Decode argument failed: " + e.getMessage(), e);
                        }
                    }
                }
            }
            
            // &#35774;&#32622;&#21442;&#25968;&#31867;&#22411;&#25968;&#32452;
            setParameterTypes(pts);

            // &#36890;&#36807;&#21453;&#24207;&#21015;&#21270;&#24471;&#21040;&#21407; attachment &#30340;&#20869;&#23481;
            Map&lt;String, String&gt; map = (Map&lt;String, String&gt;) in.readObject(Map.class);
            if (map != null &amp;&amp; map.size() &gt; 0) {
                Map&lt;String, String&gt; attachment = getAttachments();
                if (attachment == null) {
                    attachment = new HashMap&lt;String, String&gt;();
                }
                // &#23558; map &#19982;&#24403;&#21069;&#23545;&#35937;&#20013;&#30340; attachment &#38598;&#21512;&#36827;&#34892;&#34701;&#21512;
                attachment.putAll(map);
                setAttachments(attachment);
            }
            
            // &#23545; callback &#31867;&#22411;&#30340;&#21442;&#25968;&#36827;&#34892;&#22788;&#29702;
            for (int i = 0; i &lt; args.length; i++) {
                args[i] = decodeInvocationArgument(channel, this, pts, i, args[i]);
            }

            // &#35774;&#32622;&#21442;&#25968;&#21015;&#34920;
            setArguments(args);

        } catch (ClassNotFoundException e) {
            throw new IOException(StringUtils.toString("Read invocation data failed.", e));
        } finally {
            if (in instanceof Cleanable) {
                ((Cleanable) in).cleanup();
            }
        }
        return this;
    }
}</pre>
 <p class="ne-p" id="u980343eb">
  <br>
 </p>
 <p class="ne-p" id="u96fa8239">
  <span class="ne-text">
   &#19978;&#38754;&#30340;&#26041;&#27861;&#36890;&#36807;&#21453;&#24207;&#21015;&#21270;&#23558;&#35832;&#22914; path&#12289;version&#12289;&#35843;&#29992;&#26041;&#27861;&#21517;&#12289;&#21442;&#25968;&#21015;&#34920;&#31561;&#20449;&#24687;&#20381;&#27425;&#35299;&#26512;&#20986;&#26469;&#65292;&#24182;&#35774;&#32622;&#21040;&#30456;&#24212;&#30340;&#23383;&#27573;&#20013;&#65292;&#26368;&#32456;&#24471;&#21040;&#19968;&#20010;&#20855;&#26377;&#23436;&#25972;&#35843;&#29992;&#20449;&#24687;&#30340; DecodeableRpcInvocation &#23545;&#35937;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u6043fcca">
  <br>
 </p>
 <p class="ne-p" id="u2cb432a6">
  <span class="ne-text">
   &#21040;&#36825;&#37324;&#65292;&#35831;&#27714;&#25968;&#25454;&#35299;&#30721;&#30340;&#36807;&#31243;&#23601;&#20998;&#26512;&#23436;&#20102;&#12290;&#27492;&#26102;&#25105;&#20204;&#24471;&#21040;&#20102;&#19968;&#20010; Request &#23545;&#35937;&#65292;&#36825;&#20010;&#23545;&#35937;&#20250;&#34987;&#20256;&#36865;&#21040;&#19979;&#19968;&#20010;&#20837;&#31449;&#22788;&#29702;&#22120;&#20013;&#65292;&#25105;&#20204;&#32487;&#32493;&#24448;&#19979;&#30475;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u5de7ad44">
  <br>
 </p>
 <h4 id="35834306">
  <span class="ne-text">
   2.3.2 &#35843;&#29992;&#26381;&#21153;
  </span>
 </h4>
 <p class="ne-p" id="u263d3c59">
  <br>
 </p>
 <p class="ne-p" id="u68841653">
  <span class="ne-text">
   &#35299;&#30721;&#22120;&#23558;&#25968;&#25454;&#21253;&#35299;&#26512;&#25104; Request &#23545;&#35937;&#21518;&#65292;NettyHandler &#30340; messageReceived &#26041;&#27861;&#32039;&#25509;&#30528;&#20250;&#25910;&#21040;&#36825;&#20010;&#23545;&#35937;&#65292;&#24182;&#23558;&#36825;&#20010;&#23545;&#35937;&#32487;&#32493;&#21521;&#19979;&#20256;&#36882;&#12290;&#36825;&#26399;&#38388;&#35813;&#23545;&#35937;&#20250;&#34987;&#20381;&#27425;&#20256;&#36882;&#32473; NettyServer&#12289;MultiMessageHandler&#12289;HeartbeatHandler &#20197;&#21450; AllChannelHandler&#12290;&#26368;&#21518;&#30001; AllChannelHandler &#23558;&#35813;&#23545;&#35937;&#23553;&#35013;&#21040; Runnable &#23454;&#29616;&#31867;&#23545;&#35937;&#20013;&#65292;&#24182;&#23558; Runnable &#25918;&#20837;&#32447;&#31243;&#27744;&#20013;&#25191;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;&#36923;&#36753;&#12290;&#25972;&#20010;&#35843;&#29992;&#26632;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u89cc3c2c">
  <br>
 </p>
 <pre class="ne-codeblock language-fallback" data-language="fallback" id="0e55c924">NettyHandler#messageReceived(ChannelHandlerContext, MessageEvent)
  &#8212;&gt; AbstractPeer#received(Channel, Object)
    &#8212;&gt; MultiMessageHandler#received(Channel, Object)
      &#8212;&gt; HeartbeatHandler#received(Channel, Object)
        &#8212;&gt; AllChannelHandler#received(Channel, Object)
          &#8212;&gt; ExecutorService#execute(Runnable)    // &#30001;&#32447;&#31243;&#27744;&#25191;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;&#36923;&#36753;</pre>
 <p class="ne-p" id="u5eaa1810">
  <br>
 </p>
 <p class="ne-p" id="u7794b1cc">
  <span class="ne-text">
   &#32771;&#34385;&#21040;&#31687;&#24133;&#65292;&#20197;&#21450;&#24456;&#22810;&#20013;&#38388;&#35843;&#29992;&#30340;&#36923;&#36753;&#24182;&#38750;&#21313;&#20998;&#37325;&#35201;&#65292;&#25152;&#20197;&#36825;&#37324;&#23601;&#19981;&#23545;&#35843;&#29992;&#26632;&#20013;&#30340;&#27599;&#20010;&#26041;&#27861;&#37117;&#36827;&#34892;&#20998;&#26512;&#20102;&#12290;&#36825;&#37324;&#25105;&#20204;&#30452;&#25509;&#20998;&#26512;&#35843;&#29992;&#26632;&#20013;&#30340;&#20998;&#26512;&#31532;&#19968;&#20010;&#21644;&#26368;&#21518;&#19968;&#20010;&#35843;&#29992;&#26041;&#27861;&#36923;&#36753;&#12290;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ud45c6851">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="93e33ef8">@Sharable
public class NettyHandler extends SimpleChannelHandler {
    
    private final Map&lt;String, Channel&gt; channels = new ConcurrentHashMap&lt;String, Channel&gt;();

    private final URL url;

    private final ChannelHandler handler;
    
    public NettyHandler(URL url, ChannelHandler handler) {
        if (url == null) {
            throw new IllegalArgumentException("url == null");
        }
        if (handler == null) {
            throw new IllegalArgumentException("handler == null");
        }
        this.url = url;
        
        // &#36825;&#37324;&#30340; handler &#31867;&#22411;&#20026; NettyServer
        this.handler = handler;
    }
    
	public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {
        // &#33719;&#21462; NettyChannel
        NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);
        try {
            // &#32487;&#32493;&#21521;&#19979;&#35843;&#29992;
            handler.received(channel, e.getMessage());
        } finally {
            NettyChannel.removeChannelIfDisconnected(ctx.getChannel());
        }
    }
}</pre>
 <p class="ne-p" id="u8eceffc7">
  <br>
 </p>
 <p class="ne-p" id="u00e6f7e9">
  <span class="ne-text">
   &#22914;&#19978;&#65292;NettyHandler &#20013;&#30340; messageReceived &#36923;&#36753;&#27604;&#36739;&#31616;&#21333;&#12290;&#39318;&#20808;&#26681;&#25454;&#19968;&#20123;&#20449;&#24687;&#33719;&#21462; NettyChannel &#23454;&#20363;&#65292;&#28982;&#21518;&#23558; NettyChannel &#23454;&#20363;&#20197;&#21450; Request &#23545;&#35937;&#21521;&#19979;&#20256;&#36882;&#12290;&#19979;&#38754;&#20877;&#26469;&#30475;&#30475; AllChannelHandler &#30340;&#36923;&#36753;&#65292;&#22312;&#35814;&#32454;&#20998;&#26512;&#20195;&#30721;&#20043;&#21069;&#65292;&#25105;&#20204;&#20808;&#26469;&#20102;&#35299;&#19968;&#19979; Dubbo &#20013;&#30340;&#32447;&#31243;&#27966;&#21457;&#27169;&#22411;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u9f13f1f3">
  <br>
 </p>
 <h5 id="c12395ca">
  <span class="ne-text">
   2.3.2.1 &#32447;&#31243;&#27966;&#21457;&#27169;&#22411;
  </span>
 </h5>
 <p class="ne-p" id="ufb9b2d18">
  <br>
 </p>
 <p class="ne-p" id="ue8656f01">
  <span class="ne-text">
   Dubbo &#23558;&#24213;&#23618;&#36890;&#20449;&#26694;&#26550;&#20013;&#25509;&#25910;&#35831;&#27714;&#30340;&#32447;&#31243;&#31216;&#20026; IO &#32447;&#31243;&#12290;&#22914;&#26524;&#19968;&#20123;&#20107;&#20214;&#22788;&#29702;&#36923;&#36753;&#21487;&#20197;&#24456;&#24555;&#25191;&#34892;&#23436;&#65292;&#27604;&#22914;&#21482;&#22312;&#20869;&#23384;&#25171;&#19968;&#20010;&#26631;&#35760;&#65292;&#27492;&#26102;&#30452;&#25509;&#22312; IO &#32447;&#31243;&#19978;&#25191;&#34892;&#35813;&#27573;&#36923;&#36753;&#21363;&#21487;&#12290;&#20294;&#22914;&#26524;&#20107;&#20214;&#30340;&#22788;&#29702;&#36923;&#36753;&#27604;&#36739;&#32791;&#26102;&#65292;&#27604;&#22914;&#35813;&#27573;&#36923;&#36753;&#20250;&#21457;&#36215;&#25968;&#25454;&#24211;&#26597;&#35810;&#25110;&#32773; HTTP &#35831;&#27714;&#12290;&#27492;&#26102;&#25105;&#20204;&#23601;&#19981;&#24212;&#35813;&#35753;&#20107;&#20214;&#22788;&#29702;&#36923;&#36753;&#22312; IO &#32447;&#31243;&#19978;&#25191;&#34892;&#65292;&#32780;&#26159;&#24212;&#35813;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#20013;&#21435;&#25191;&#34892;&#12290;&#21407;&#22240;&#20063;&#24456;&#31616;&#21333;&#65292;IO &#32447;&#31243;&#20027;&#35201;&#29992;&#20110;&#25509;&#25910;&#35831;&#27714;&#65292;&#22914;&#26524; IO &#32447;&#31243;&#34987;&#21344;&#28385;&#65292;&#23558;&#23548;&#33268;&#23427;&#19981;&#33021;&#25509;&#25910;&#26032;&#30340;&#35831;&#27714;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ub15a2feb">
  <br>
 </p>
 <p class="ne-p" id="ubfd3e687">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159;&#32447;&#31243;&#27966;&#21457;&#30340;&#32972;&#26223;&#65292;&#19979;&#38754;&#25105;&#20204;&#20877;&#26469;&#36890;&#36807; Dubbo &#35843;&#29992;&#22270;&#65292;&#30475;&#19968;&#19979;&#32447;&#31243;&#27966;&#21457;&#22120;&#25152;&#22788;&#30340;&#20301;&#32622;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u554727b9">
  <br>
 </p>
 <p class="ne-p" id="ub7f803e0">
  <img class="ne-image" id="odu3d" src="EPUB/imgodu3d" width="1380">
 </p>
 <p class="ne-p" id="u79c27636">
  <br>
 </p>
 <p class="ne-p" id="udf245268">
  <span class="ne-text">
   &#22914;&#19978;&#22270;&#65292;&#32418;&#26694;&#20013;&#30340; Dispatcher &#23601;&#26159;&#32447;&#31243;&#27966;&#21457;&#22120;&#12290;&#38656;&#35201;&#35828;&#26126;&#30340;&#26159;&#65292;Dispatcher &#30495;&#23454;&#30340;&#32844;&#36131;&#21019;&#24314;&#20855;&#26377;&#32447;&#31243;&#27966;&#21457;&#33021;&#21147;&#30340; ChannelHandler&#65292;&#27604;&#22914; AllChannelHandler&#12289;MessageOnlyChannelHandler &#21644; ExecutionChannelHandler &#31561;&#65292;&#20854;&#26412;&#36523;&#24182;&#19981;&#20855;&#22791;&#32447;&#31243;&#27966;&#21457;&#33021;&#21147;&#12290;Dubbo &#25903;&#25345; 5 &#31181;&#19981;&#21516;&#30340;&#32447;&#31243;&#27966;&#21457;&#31574;&#30053;&#65292;&#19979;&#38754;&#36890;&#36807;&#19968;&#20010;&#34920;&#26684;&#21015;&#20030;&#19968;&#19979;&#12290;
  </span>
 </p>
 <table class="ne-table" id="49e8acab" style="width: 750px">
  <tbody>
   <tr style="height: 33px">
    <td width="375">
     <p class="ne-p" id="uf9475947">
      <span class="ne-text">
       &#31574;&#30053;
      </span>
     </p>
    </td>
    <td width="375">
     <p class="ne-p" id="ubdd9fb25">
      <span class="ne-text">
       &#29992;&#36884;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="375">
     <p class="ne-p" id="u2c4019b2">
      <span class="ne-text">
       all
      </span>
     </p>
    </td>
    <td width="375">
     <p class="ne-p" id="u751e60ef">
      <span class="ne-text">
       &#25152;&#26377;&#28040;&#24687;&#37117;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#65292;&#21253;&#25324;&#35831;&#27714;&#65292;&#21709;&#24212;&#65292;&#36830;&#25509;&#20107;&#20214;&#65292;&#26029;&#24320;&#20107;&#20214;&#31561;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="375">
     <p class="ne-p" id="uaf0f6445">
      <span class="ne-text">
       direct
      </span>
     </p>
    </td>
    <td width="375">
     <p class="ne-p" id="u2351d2a7">
      <span class="ne-text">
       &#25152;&#26377;&#28040;&#24687;&#37117;&#19981;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#65292;&#20840;&#37096;&#22312; IO &#32447;&#31243;&#19978;&#30452;&#25509;&#25191;&#34892;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="375">
     <p class="ne-p" id="u5abfa5cd">
      <span class="ne-text">
       message
      </span>
     </p>
    </td>
    <td width="375">
     <p class="ne-p" id="u11f564b8">
      <span class="ne-text">
       &#21482;&#26377;
      </span>
      <strong>
       <span class="ne-text">
        &#35831;&#27714;
       </span>
      </strong>
      <span class="ne-text">
       &#21644;
      </span>
      <strong>
       <span class="ne-text">
        &#21709;&#24212;
       </span>
      </strong>
      <span class="ne-text">
       &#28040;&#24687;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#65292;&#20854;&#23427;&#28040;&#24687;&#22343;&#22312; IO &#32447;&#31243;&#19978;&#25191;&#34892;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="375">
     <p class="ne-p" id="uaf8cf4da">
      <span class="ne-text">
       execution
      </span>
     </p>
    </td>
    <td width="375">
     <p class="ne-p" id="u2e159b23">
      <span class="ne-text">
       &#21482;&#26377;
      </span>
      <strong>
       <span class="ne-text">
        &#35831;&#27714;
       </span>
      </strong>
      <span class="ne-text">
       &#28040;&#24687;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#65292;&#19981;&#21547;&#21709;&#24212;&#12290;&#20854;&#23427;&#28040;&#24687;&#22343;&#22312; IO &#32447;&#31243;&#19978;&#25191;&#34892;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="375">
     <p class="ne-p" id="u72c02282">
      <span class="ne-text">
       connection
      </span>
     </p>
    </td>
    <td width="375">
     <p class="ne-p" id="u28af84c4">
      <span class="ne-text">
       &#22312; IO &#32447;&#31243;&#19978;&#65292;&#23558;&#36830;&#25509;&#26029;&#24320;&#20107;&#20214;&#25918;&#20837;&#38431;&#21015;&#65292;&#26377;&#24207;&#36880;&#20010;&#25191;&#34892;&#65292;&#20854;&#23427;&#28040;&#24687;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;
      </span>
     </p>
    </td>
   </tr>
  </tbody>
 </table>
 <p class="ne-p" id="u1623feb0">
  <br>
 </p>
 <p class="ne-p" id="ua7b89ab1">
  <span class="ne-text">
   &#40664;&#35748;&#37197;&#32622;&#19979;&#65292;Dubbo &#20351;&#29992;
  </span>
  <code class="ne-code">
   <span class="ne-text">
    all
   </span>
  </code>
  <span class="ne-text">
   &#27966;&#21457;&#31574;&#30053;&#65292;&#21363;&#23558;&#25152;&#26377;&#30340;&#28040;&#24687;&#37117;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#20013;&#12290;&#19979;&#38754;&#25105;&#20204;&#26469;&#20998;&#26512;&#19968;&#19979; AllChannelHandler &#30340;&#20195;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u74cfecbd">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="4101c8c7">public class AllChannelHandler extends WrappedChannelHandler {

    public AllChannelHandler(ChannelHandler handler, URL url) {
        super(handler, url);
    }

    /** &#22788;&#29702;&#36830;&#25509;&#20107;&#20214; */
    @Override
    public void connected(Channel channel) throws RemotingException {
        // &#33719;&#21462;&#32447;&#31243;&#27744;
        ExecutorService cexecutor = getExecutorService();
        try {
            // &#23558;&#36830;&#25509;&#20107;&#20214;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#20013;&#22788;&#29702;
            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.CONNECTED));
        } catch (Throwable t) {
            throw new ExecutionException(..., " error when process connected event .", t);
        }
    }

    /** &#22788;&#29702;&#26029;&#24320;&#20107;&#20214; */
    @Override
    public void disconnected(Channel channel) throws RemotingException {
        ExecutorService cexecutor = getExecutorService();
        try {
            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.DISCONNECTED));
        } catch (Throwable t) {
            throw new ExecutionException(..., "error when process disconnected event .", t);
        }
    }

    /** &#22788;&#29702;&#35831;&#27714;&#21644;&#21709;&#24212;&#28040;&#24687;&#65292;&#36825;&#37324;&#30340; message &#21464;&#37327;&#31867;&#22411;&#21487;&#33021;&#26159; Request&#65292;&#20063;&#21487;&#33021;&#26159; Response */
    @Override
    public void received(Channel channel, Object message) throws RemotingException {
        ExecutorService cexecutor = getExecutorService();
        try {
            // &#23558;&#35831;&#27714;&#21644;&#21709;&#24212;&#28040;&#24687;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#20013;&#22788;&#29702;
            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.RECEIVED, message));
        } catch (Throwable t) {
            if(message instanceof Request &amp;&amp; t instanceof RejectedExecutionException){
                Request request = (Request)message;
                // &#22914;&#26524;&#36890;&#20449;&#26041;&#24335;&#20026;&#21452;&#21521;&#36890;&#20449;&#65292;&#27492;&#26102;&#23558; Server side ... threadpool is exhausted 
                // &#38169;&#35823;&#20449;&#24687;&#23553;&#35013;&#21040; Response &#20013;&#65292;&#24182;&#36820;&#22238;&#32473;&#26381;&#21153;&#28040;&#36153;&#26041;&#12290;
                if(request.isTwoWay()){
                    String msg = "Server side(" + url.getIp() + "," + url.getPort() 
                        + ") threadpool is exhausted ,detail msg:" + t.getMessage();
                    Response response = new Response(request.getId(), request.getVersion());
                    response.setStatus(Response.SERVER_THREADPOOL_EXHAUSTED_ERROR);
                    response.setErrorMessage(msg);
                    // &#36820;&#22238;&#21253;&#21547;&#38169;&#35823;&#20449;&#24687;&#30340; Response &#23545;&#35937;
                    channel.send(response);
                    return;
                }
            }
            throw new ExecutionException(..., " error when process received event .", t);
        }
    }

    /** &#22788;&#29702;&#24322;&#24120;&#20449;&#24687; */
    @Override
    public void caught(Channel channel, Throwable exception) throws RemotingException {
        ExecutorService cexecutor = getExecutorService();
        try {
            cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.CAUGHT, exception));
        } catch (Throwable t) {
            throw new ExecutionException(..., "error when process caught event ...");
        }
    }
}</pre>
 <p class="ne-p" id="u98fb1124">
  <br>
 </p>
 <p class="ne-p" id="u76b2c4d5">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#35831;&#27714;&#23545;&#35937;&#20250;&#34987;&#23553;&#35013; ChannelEventRunnable &#20013;&#65292;ChannelEventRunnable &#23558;&#20250;&#26159;&#26381;&#21153;&#35843;&#29992;&#36807;&#31243;&#30340;&#26032;&#36215;&#28857;&#12290;&#25152;&#20197;&#25509;&#19979;&#26469;&#25105;&#20204;&#20197; ChannelEventRunnable &#20026;&#36215;&#28857;&#21521;&#19979;&#25506;&#32034;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u861e4268">
  <br>
 </p>
 <h5 id="1a5b6577">
  <span class="ne-text">
   2.3.2.2 &#35843;&#29992;&#26381;&#21153;
  </span>
 </h5>
 <p class="ne-p" id="u5e44c8a9">
  <br>
 </p>
 <p class="ne-p" id="u3021a105">
  <span class="ne-text">
   &#26412;&#23567;&#33410;&#65292;&#25105;&#20204;&#20174; ChannelEventRunnable &#24320;&#22987;&#20998;&#26512;&#65292;&#35813;&#31867;&#30340;&#20027;&#35201;&#20195;&#30721;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ud7d77003">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="67a0dfed">public class ChannelEventRunnable implements Runnable {
    
    private final ChannelHandler handler;
    private final Channel channel;
    private final ChannelState state;
    private final Throwable exception;
    private final Object message;
    
    @Override
    public void run() {
        // &#26816;&#27979;&#36890;&#36947;&#29366;&#24577;&#65292;&#23545;&#20110;&#35831;&#27714;&#25110;&#21709;&#24212;&#28040;&#24687;&#65292;&#27492;&#26102; state = RECEIVED
        if (state == ChannelState.RECEIVED) {
            try {
                // &#23558; channel &#21644; message &#20256;&#32473; ChannelHandler &#23545;&#35937;&#65292;&#36827;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;
                handler.received(channel, message);
            } catch (Exception e) {
                logger.warn("... operation error, channel is ... message is ...");
            }
        } 
        
        // &#20854;&#20182;&#28040;&#24687;&#31867;&#22411;&#36890;&#36807; switch &#36827;&#34892;&#22788;&#29702;
        else {
            switch (state) {
            case CONNECTED:
                try {
                    handler.connected(channel);
                } catch (Exception e) {
                    logger.warn("... operation error, channel is ...");
                }
                break;
            case DISCONNECTED:
                // ...
            case SENT:
                // ...
            case CAUGHT:
                // ...
            default:
                logger.warn("unknown state: " + state + ", message is " + message);
            }
        }

    }
}</pre>
 <p class="ne-p" id="u4e467dc4">
  <br>
 </p>
 <p class="ne-p" id="u9f5949a2">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#35831;&#27714;&#21644;&#21709;&#24212;&#28040;&#24687;&#20986;&#29616;&#39057;&#29575;&#26126;&#26174;&#27604;&#20854;&#20182;&#31867;&#22411;&#28040;&#24687;&#39640;&#65292;&#25152;&#20197;&#36825;&#37324;&#23545;&#35813;&#31867;&#22411;&#30340;&#28040;&#24687;&#36827;&#34892;&#20102;&#38024;&#23545;&#24615;&#21028;&#26029;&#12290;ChannelEventRunnable &#20165;&#26159;&#19968;&#20010;&#20013;&#36716;&#31449;&#65292;&#23427;&#30340; run &#26041;&#27861;&#20013;&#24182;&#19981;&#21253;&#21547;&#20855;&#20307;&#30340;&#35843;&#29992;&#36923;&#36753;&#65292;&#20165;&#29992;&#20110;&#23558;&#21442;&#25968;&#20256;&#32473;&#20854;&#20182; ChannelHandler &#23545;&#35937;&#36827;&#34892;&#22788;&#29702;&#65292;&#35813;&#23545;&#35937;&#31867;&#22411;&#20026; DecodeHandler&#12290;
  </span>
 </p>
 <p class="ne-p" id="uddf8aa5d">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="aea3aaec">public class DecodeHandler extends AbstractChannelHandlerDelegate {

    public DecodeHandler(ChannelHandler handler) {
        super(handler);
    }

    @Override
    public void received(Channel channel, Object message) throws RemotingException {
        if (message instanceof Decodeable) {
            // &#23545; Decodeable &#25509;&#21475;&#23454;&#29616;&#31867;&#23545;&#35937;&#36827;&#34892;&#35299;&#30721;
            decode(message);
        }

        if (message instanceof Request) {
            // &#23545; Request &#30340; data &#23383;&#27573;&#36827;&#34892;&#35299;&#30721;
            decode(((Request) message).getData());
        }

        if (message instanceof Response) {
            // &#23545; Request &#30340; result &#23383;&#27573;&#36827;&#34892;&#35299;&#30721;
            decode(((Response) message).getResult());
        }

        // &#25191;&#34892;&#21518;&#32493;&#36923;&#36753;
        handler.received(channel, message);
    }

    private void decode(Object message) {
        // Decodeable &#25509;&#21475;&#30446;&#21069;&#26377;&#20004;&#20010;&#23454;&#29616;&#31867;&#65292;
        // &#20998;&#21035;&#20026; DecodeableRpcInvocation &#21644; DecodeableRpcResult
        if (message != null &amp;&amp; message instanceof Decodeable) {
            try {
                // &#25191;&#34892;&#35299;&#30721;&#36923;&#36753;
                ((Decodeable) message).decode();
            } catch (Throwable e) {
                if (log.isWarnEnabled()) {
                    log.warn("Call Decodeable.decode failed: " + e.getMessage(), e);
                }
            }
        }
    }
}</pre>
 <p class="ne-p" id="u6e8ef8e4">
  <br>
 </p>
 <p class="ne-p" id="ub4f91ecc">
  <span class="ne-text">
   DecodeHandler &#20027;&#35201;&#26159;&#21253;&#21547;&#20102;&#19968;&#20123;&#35299;&#30721;&#36923;&#36753;&#12290;2.2.1 &#33410;&#20998;&#26512;&#35831;&#27714;&#35299;&#30721;&#26102;&#35828;&#36807;&#65292;&#35831;&#27714;&#35299;&#30721;&#21487;&#22312; IO &#32447;&#31243;&#19978;&#25191;&#34892;&#65292;&#20063;&#21487;&#22312;&#32447;&#31243;&#27744;&#20013;&#25191;&#34892;&#65292;&#36825;&#20010;&#21462;&#20915;&#20110;&#36816;&#34892;&#26102;&#37197;&#32622;&#12290;DecodeHandler &#23384;&#22312;&#30340;&#24847;&#20041;&#23601;&#26159;&#20445;&#35777;&#35831;&#27714;&#25110;&#21709;&#24212;&#23545;&#35937;&#21487;&#22312;&#32447;&#31243;&#27744;&#20013;&#34987;&#35299;&#30721;&#12290;&#35299;&#30721;&#23436;&#27605;&#21518;&#65292;&#23436;&#20840;&#35299;&#30721;&#21518;&#30340; Request &#23545;&#35937;&#20250;&#32487;&#32493;&#21521;&#21518;&#20256;&#36882;&#65292;&#19979;&#19968;&#31449;&#26159; HeaderExchangeHandler&#12290;
  </span>
 </p>
 <p class="ne-p" id="u53748ab1">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="0833181d">public class HeaderExchangeHandler implements ChannelHandlerDelegate {

    private final ExchangeHandler handler;

    public HeaderExchangeHandler(ExchangeHandler handler) {
        if (handler == null) {
            throw new IllegalArgumentException("handler == null");
        }
        this.handler = handler;
    }

    @Override
    public void received(Channel channel, Object message) throws RemotingException {
        channel.setAttribute(KEY_READ_TIMESTAMP, System.currentTimeMillis());
        ExchangeChannel exchangeChannel = HeaderExchangeChannel.getOrAddChannel(channel);
        try {
            // &#22788;&#29702;&#35831;&#27714;&#23545;&#35937;
            if (message instanceof Request) {
                Request request = (Request) message;
                if (request.isEvent()) {
                    // &#22788;&#29702;&#20107;&#20214;
                    handlerEvent(channel, request);
                } 
                // &#22788;&#29702;&#26222;&#36890;&#30340;&#35831;&#27714;
                else {
                    // &#21452;&#21521;&#36890;&#20449;
                    if (request.isTwoWay()) {
                        // &#21521;&#21518;&#35843;&#29992;&#26381;&#21153;&#65292;&#24182;&#24471;&#21040;&#35843;&#29992;&#32467;&#26524;
                        Response response = handleRequest(exchangeChannel, request);
                        // &#23558;&#35843;&#29992;&#32467;&#26524;&#36820;&#22238;&#32473;&#26381;&#21153;&#28040;&#36153;&#31471;
                        channel.send(response);
                    } 
                    // &#22914;&#26524;&#26159;&#21333;&#21521;&#36890;&#20449;&#65292;&#20165;&#21521;&#21518;&#35843;&#29992;&#25351;&#23450;&#26381;&#21153;&#21363;&#21487;&#65292;&#26080;&#38656;&#36820;&#22238;&#35843;&#29992;&#32467;&#26524;
                    else {
                        handler.received(exchangeChannel, request.getData());
                    }
                }
            }      
            // &#22788;&#29702;&#21709;&#24212;&#23545;&#35937;&#65292;&#26381;&#21153;&#28040;&#36153;&#26041;&#20250;&#25191;&#34892;&#27492;&#22788;&#36923;&#36753;&#65292;&#21518;&#38754;&#20998;&#26512;
            else if (message instanceof Response) {
                handleResponse(channel, (Response) message);
            } else if (message instanceof String) {
                // telnet &#30456;&#20851;&#65292;&#24573;&#30053;
            } else {
                handler.received(exchangeChannel, message);
            }
        } finally {
            HeaderExchangeChannel.removeChannelIfDisconnected(channel);
        }
    }

    Response handleRequest(ExchangeChannel channel, Request req) throws RemotingException {
        Response res = new Response(req.getId(), req.getVersion());
        // &#26816;&#27979;&#35831;&#27714;&#26159;&#21542;&#21512;&#27861;&#65292;&#19981;&#21512;&#27861;&#21017;&#36820;&#22238;&#29366;&#24577;&#30721;&#20026; BAD_REQUEST &#30340;&#21709;&#24212;
        if (req.isBroken()) {
            Object data = req.getData();

            String msg;
            if (data == null)
                msg = null;
            else if
                (data instanceof Throwable) msg = StringUtils.toString((Throwable) data);
            else
                msg = data.toString();
            res.setErrorMessage("Fail to decode request due to: " + msg);
            // &#35774;&#32622; BAD_REQUEST &#29366;&#24577;
            res.setStatus(Response.BAD_REQUEST);

            return res;
        }
        
        // &#33719;&#21462; data &#23383;&#27573;&#20540;&#65292;&#20063;&#23601;&#26159; RpcInvocation &#23545;&#35937;
        Object msg = req.getData();
        try {
            // &#32487;&#32493;&#21521;&#19979;&#35843;&#29992;
            Object result = handler.reply(channel, msg);
            // &#35774;&#32622; OK &#29366;&#24577;&#30721;
            res.setStatus(Response.OK);
            // &#35774;&#32622;&#35843;&#29992;&#32467;&#26524;
            res.setResult(result);
        } catch (Throwable e) {
            // &#33509;&#35843;&#29992;&#36807;&#31243;&#20986;&#29616;&#24322;&#24120;&#65292;&#21017;&#35774;&#32622; SERVICE_ERROR&#65292;&#34920;&#31034;&#26381;&#21153;&#31471;&#24322;&#24120;
            res.setStatus(Response.SERVICE_ERROR);
            res.setErrorMessage(StringUtils.toString(e));
        }
        return res;
    }
}</pre>
 <p class="ne-p" id="u7327efbf">
  <br>
 </p>
 <p class="ne-p" id="u1c8bf8b7">
  <span class="ne-text">
   &#21040;&#36825;&#37324;&#65292;&#25105;&#20204;&#30475;&#21040;&#20102;&#27604;&#36739;&#28165;&#26224;&#30340;&#35831;&#27714;&#21644;&#21709;&#24212;&#36923;&#36753;&#12290;&#23545;&#20110;&#21452;&#21521;&#36890;&#20449;&#65292;HeaderExchangeHandler &#39318;&#20808;&#21521;&#21518;&#36827;&#34892;&#35843;&#29992;&#65292;&#24471;&#21040;&#35843;&#29992;&#32467;&#26524;&#12290;&#28982;&#21518;&#23558;&#35843;&#29992;&#32467;&#26524;&#23553;&#35013;&#21040; Response &#23545;&#35937;&#20013;&#65292;&#26368;&#21518;&#20877;&#23558;&#35813;&#23545;&#35937;&#36820;&#22238;&#32473;&#26381;&#21153;&#28040;&#36153;&#26041;&#12290;&#22914;&#26524;&#35831;&#27714;&#19981;&#21512;&#27861;&#65292;&#25110;&#32773;&#35843;&#29992;&#22833;&#36133;&#65292;&#21017;&#23558;&#38169;&#35823;&#20449;&#24687;&#23553;&#35013;&#21040; Response &#23545;&#35937;&#20013;&#65292;&#24182;&#36820;&#22238;&#32473;&#26381;&#21153;&#28040;&#36153;&#26041;&#12290;&#25509;&#19979;&#26469;&#25105;&#20204;&#32487;&#32493;&#21521;&#21518;&#20998;&#26512;&#65292;&#25226;&#21097;&#20313;&#30340;&#35843;&#29992;&#36807;&#31243;&#20998;&#26512;&#23436;&#12290;&#19979;&#38754;&#20998;&#26512;&#23450;&#20041;&#22312; DubboProtocol &#31867;&#20013;&#30340;&#21311;&#21517;&#31867;&#23545;&#35937;&#36923;&#36753;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u4bd3fe32">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="15c8d764">public class DubboProtocol extends AbstractProtocol {

    public static final String NAME = "dubbo";
    
    private ExchangeHandler requestHandler = new ExchangeHandlerAdapter() {

        @Override
        public Object reply(ExchangeChannel channel, Object message) throws RemotingException {
            if (message instanceof Invocation) {
                Invocation inv = (Invocation) message;
                // &#33719;&#21462; Invoker &#23454;&#20363;
                Invoker&lt;?&gt; invoker = getInvoker(channel, inv);
                if (Boolean.TRUE.toString().equals(inv.getAttachments().get(IS_CALLBACK_SERVICE_INVOKE))) {
                    // &#22238;&#35843;&#30456;&#20851;&#65292;&#24573;&#30053;
                }
                RpcContext.getContext().setRemoteAddress(channel.getRemoteAddress());
                // &#36890;&#36807; Invoker &#35843;&#29992;&#20855;&#20307;&#30340;&#26381;&#21153;
                return invoker.invoke(inv);
            }
            throw new RemotingException(channel, "Unsupported request: ...");
        }
        
        // &#24573;&#30053;&#20854;&#20182;&#26041;&#27861;
    }
    
    Invoker&lt;?&gt; getInvoker(Channel channel, Invocation inv) throws RemotingException {
        // &#24573;&#30053;&#22238;&#35843;&#21644;&#26412;&#22320;&#23384;&#26681;&#30456;&#20851;&#36923;&#36753;
        // ...
        
        int port = channel.getLocalAddress().getPort();
        
        // &#35745;&#31639; service key&#65292;&#26684;&#24335;&#20026; groupName/serviceName:serviceVersion:port&#12290;&#27604;&#22914;&#65306;
        //   dubbo/com.alibaba.dubbo.demo.DemoService:1.0.0:20880
        String serviceKey = serviceKey(port, path, inv.getAttachments().get(Constants.VERSION_KEY), inv.getAttachments().get(Constants.GROUP_KEY));

        // &#20174; exporterMap &#26597;&#25214;&#19982; serviceKey &#30456;&#23545;&#24212;&#30340; DubboExporter &#23545;&#35937;&#65292;
        // &#26381;&#21153;&#23548;&#20986;&#36807;&#31243;&#20013;&#20250;&#23558; &lt;serviceKey, DubboExporter&gt; &#26144;&#23556;&#20851;&#31995;&#23384;&#20648;&#21040; exporterMap &#38598;&#21512;&#20013;
        DubboExporter&lt;?&gt; exporter = (DubboExporter&lt;?&gt;) exporterMap.get(serviceKey);

        if (exporter == null)
            throw new RemotingException(channel, "Not found exported service ...");

        // &#33719;&#21462; Invoker &#23545;&#35937;&#65292;&#24182;&#36820;&#22238;
        return exporter.getInvoker();
    }
    
    // &#24573;&#30053;&#20854;&#20182;&#26041;&#27861;
}</pre>
 <p class="ne-p" id="ue68808b3">
  <br>
 </p>
 <p class="ne-p" id="uac151c6e">
  <span class="ne-text">
   &#20197;&#19978;&#36923;&#36753;&#29992;&#20110;&#33719;&#21462;&#19982;&#25351;&#23450;&#26381;&#21153;&#23545;&#24212;&#30340; Invoker &#23454;&#20363;&#65292;&#24182;&#36890;&#36807; Invoker &#30340; invoke &#26041;&#27861;&#35843;&#29992;&#26381;&#21153;&#36923;&#36753;&#12290;invoke &#26041;&#27861;&#23450;&#20041;&#22312; AbstractProxyInvoker &#20013;&#65292;&#20195;&#30721;&#22914;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u9ff3848e">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="7847fb48">public abstract class AbstractProxyInvoker&lt;T&gt; implements Invoker&lt;T&gt; {

    @Override
    public Result invoke(Invocation invocation) throws RpcException {
        try {
            // &#35843;&#29992; doInvoke &#25191;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;&#65292;&#24182;&#23558;&#35843;&#29992;&#32467;&#26524;&#23553;&#35013;&#21040; RpcResult &#20013;&#65292;&#24182;
            return new RpcResult(doInvoke(proxy, invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments()));
        } catch (InvocationTargetException e) {
            return new RpcResult(e.getTargetException());
        } catch (Throwable e) {
            throw new RpcException("Failed to invoke remote proxy method ...");
        }
    }
    
    protected abstract Object doInvoke(T proxy, String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments) throws Throwable;
}</pre>
 <p class="ne-p" id="u602b1b2d">
  <br>
 </p>
 <p class="ne-p" id="u7c3ed3f3">
  <span class="ne-text">
   &#22914;&#19978;&#65292;doInvoke &#26159;&#19968;&#20010;&#25277;&#35937;&#26041;&#27861;&#65292;&#36825;&#20010;&#38656;&#35201;&#30001;&#20855;&#20307;&#30340; Invoker &#23454;&#20363;&#23454;&#29616;&#12290;Invoker &#23454;&#20363;&#26159;&#22312;&#36816;&#34892;&#26102;&#36890;&#36807; JavassistProxyFactory &#21019;&#24314;&#30340;&#65292;&#21019;&#24314;&#36923;&#36753;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ue386695c">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="6b479faf">public class JavassistProxyFactory extends AbstractProxyFactory {
    
    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;

    @Override
    public &lt;T&gt; Invoker&lt;T&gt; getInvoker(T proxy, Class&lt;T&gt; type, URL url) {
        final Wrapper wrapper = Wrapper.getWrapper(proxy.getClass().getName().indexOf('$') &lt; 0 ? proxy.getClass() : type);
        // &#21019;&#24314;&#21311;&#21517;&#31867;&#23545;&#35937;
        return new AbstractProxyInvoker&lt;T&gt;(proxy, type, url) {
            @Override
            protected Object doInvoke(T proxy, String methodName,
                                      Class&lt;?&gt;[] parameterTypes,
                                      Object[] arguments) throws Throwable {
                // &#35843;&#29992; invokeMethod &#26041;&#27861;&#36827;&#34892;&#21518;&#32493;&#30340;&#35843;&#29992;
                return wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);
            }
        };
    }
}</pre>
 <p class="ne-p" id="u32a68330">
  <br>
 </p>
 <p class="ne-p" id="u893b9f3e">
  <span class="ne-text">
   Wrapper &#26159;&#19968;&#20010;&#25277;&#35937;&#31867;&#65292;&#20854;&#20013; invokeMethod &#26159;&#19968;&#20010;&#25277;&#35937;&#26041;&#27861;&#12290;Dubbo &#20250;&#22312;&#36816;&#34892;&#26102;&#36890;&#36807; Javassist &#26694;&#26550;&#20026; Wrapper &#29983;&#25104;&#23454;&#29616;&#31867;&#65292;&#24182;&#23454;&#29616; invokeMethod &#26041;&#27861;&#65292;&#35813;&#26041;&#27861;&#26368;&#32456;&#20250;&#26681;&#25454;&#35843;&#29992;&#20449;&#24687;&#35843;&#29992;&#20855;&#20307;&#30340;&#26381;&#21153;&#12290;&#20197; DemoServiceImpl &#20026;&#20363;&#65292;Javassist &#20026;&#20854;&#29983;&#25104;&#30340;&#20195;&#29702;&#31867;&#22914;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="uc30461fc">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="2ba6f56f">/** Wrapper0 &#26159;&#22312;&#36816;&#34892;&#26102;&#29983;&#25104;&#30340;&#65292;&#22823;&#23478;&#21487;&#20351;&#29992; Arthas &#36827;&#34892;&#21453;&#32534;&#35793; */
public class Wrapper0 extends Wrapper implements ClassGenerator.DC {
    public static String[] pns;
    public static Map pts;
    public static String[] mns;
    public static String[] dmns;
    public static Class[] mts0;

    // &#30465;&#30053;&#20854;&#20182;&#26041;&#27861;

    public Object invokeMethod(Object object, String string, Class[] arrclass, Object[] arrobject) throws InvocationTargetException {
        DemoService demoService;
        try {
            // &#31867;&#22411;&#36716;&#25442;
            demoService = (DemoService)object;
        }
        catch (Throwable throwable) {
            throw new IllegalArgumentException(throwable);
        }
        try {
            // &#26681;&#25454;&#26041;&#27861;&#21517;&#35843;&#29992;&#25351;&#23450;&#30340;&#26041;&#27861;
            if ("sayHello".equals(string) &amp;&amp; arrclass.length == 1) {
                return demoService.sayHello((String)arrobject[0]);
            }
        }
        catch (Throwable throwable) {
            throw new InvocationTargetException(throwable);
        }
        throw new NoSuchMethodException(new StringBuffer().append("Not found method \"").append(string).append("\" in class com.alibaba.dubbo.demo.DemoService.").toString());
    }
}</pre>
 <p class="ne-p" id="ua181866c">
  <br>
 </p>
 <p class="ne-p" id="u33b73efa">
  <span class="ne-text">
   &#21040;&#36825;&#37324;&#65292;&#25972;&#20010;&#26381;&#21153;&#35843;&#29992;&#36807;&#31243;&#23601;&#20998;&#26512;&#23436;&#20102;&#12290;&#26368;&#21518;&#25226;&#35843;&#29992;&#36807;&#31243;&#36148;&#20986;&#26469;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ud033b0d7">
  <br>
 </p>
 <pre class="ne-codeblock language-fallback" data-language="fallback" id="8f07d83c">ChannelEventRunnable#run()
  &#8212;&gt; DecodeHandler#received(Channel, Object)
    &#8212;&gt; HeaderExchangeHandler#received(Channel, Object)
      &#8212;&gt; HeaderExchangeHandler#handleRequest(ExchangeChannel, Request)
        &#8212;&gt; DubboProtocol.requestHandler#reply(ExchangeChannel, Object)
          &#8212;&gt; Filter#invoke(Invoker, Invocation)
            &#8212;&gt; AbstractProxyInvoker#invoke(Invocation)
              &#8212;&gt; Wrapper0#invokeMethod(Object, String, Class[], Object[])
                &#8212;&gt; DemoServiceImpl#sayHello(String)</pre>
 <p class="ne-p" id="u04c2fdd3">
  <br>
 </p>
 <h3 id="1f022a5e">
  <span class="ne-text">
   2.4 &#26381;&#21153;&#25552;&#20379;&#26041;&#36820;&#22238;&#35843;&#29992;&#32467;&#26524;
  </span>
 </h3>
 <p class="ne-p" id="u01ed8d3a">
  <br>
 </p>
 <p class="ne-p" id="uc11feadf">
  <span class="ne-text">
   &#26381;&#21153;&#25552;&#20379;&#26041;&#35843;&#29992;&#25351;&#23450;&#26381;&#21153;&#21518;&#65292;&#20250;&#23558;&#35843;&#29992;&#32467;&#26524;&#23553;&#35013;&#21040; Response &#23545;&#35937;&#20013;&#65292;&#24182;&#23558;&#35813;&#23545;&#35937;&#36820;&#22238;&#32473;&#26381;&#21153;&#28040;&#36153;&#26041;&#12290;&#26381;&#21153;&#25552;&#20379;&#26041;&#20063;&#26159;&#36890;&#36807; NettyChannel &#30340; send &#26041;&#27861;&#23558; Response &#23545;&#35937;&#36820;&#22238;&#65292;&#36825;&#20010;&#26041;&#27861;&#22312; 2.2.1 &#33410;&#20998;&#26512;&#36807;&#65292;&#36825;&#37324;&#23601;&#19981;&#22312;&#37325;&#22797;&#20998;&#26512;&#20102;&#12290;&#26412;&#33410;&#25105;&#20204;&#20165;&#38656;&#20851;&#27880; Response &#23545;&#35937;&#30340;&#32534;&#30721;&#36807;&#31243;&#21363;&#21487;&#65292;&#36825;&#37324;&#20173;&#28982;&#30465;&#30053;&#19968;&#20123;&#20013;&#38388;&#35843;&#29992;&#65292;&#30452;&#25509;&#20998;&#26512;&#20855;&#20307;&#30340;&#32534;&#30721;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ud6b66bb7">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="c72aa6ce">public class ExchangeCodec extends TelnetCodec {
	public void encode(Channel channel, ChannelBuffer buffer, Object msg) throws IOException {
        if (msg instanceof Request) {
            encodeRequest(channel, buffer, (Request) msg);
        } else if (msg instanceof Response) {
            // &#23545;&#21709;&#24212;&#23545;&#35937;&#36827;&#34892;&#32534;&#30721;
            encodeResponse(channel, buffer, (Response) msg);
        } else {
            super.encode(channel, buffer, msg);
        }
    }
    
    protected void encodeResponse(Channel channel, ChannelBuffer buffer, Response res) throws IOException {
        int savedWriteIndex = buffer.writerIndex();
        try {
            Serialization serialization = getSerialization(channel);
            // &#21019;&#24314;&#28040;&#24687;&#22836;&#23383;&#33410;&#25968;&#32452;
            byte[] header = new byte[HEADER_LENGTH];
            // &#35774;&#32622;&#39764;&#25968;
            Bytes.short2bytes(MAGIC, header);
            // &#35774;&#32622;&#24207;&#21015;&#21270;&#22120;&#32534;&#21495;
            header[2] = serialization.getContentTypeId();
            if (res.isHeartbeat()) header[2] |= FLAG_EVENT;
            // &#33719;&#21462;&#21709;&#24212;&#29366;&#24577;
            byte status = res.getStatus();
            // &#35774;&#32622;&#21709;&#24212;&#29366;&#24577;
            header[3] = status;
            // &#35774;&#32622;&#35831;&#27714;&#32534;&#21495;
            Bytes.long2bytes(res.getId(), header, 4);

            // &#26356;&#26032; writerIndex&#65292;&#20026;&#28040;&#24687;&#22836;&#39044;&#30041; 16 &#20010;&#23383;&#33410;&#30340;&#31354;&#38388;
            buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);
            ChannelBufferOutputStream bos = new ChannelBufferOutputStream(buffer);
            ObjectOutput out = serialization.serialize(channel.getUrl(), bos);
           
            if (status == Response.OK) {
                if (res.isHeartbeat()) {
                    // &#23545;&#24515;&#36339;&#21709;&#24212;&#32467;&#26524;&#36827;&#34892;&#24207;&#21015;&#21270;&#65292;&#24050;&#24223;&#24323;
                    encodeHeartbeatData(channel, out, res.getResult());
                } else {
                    // &#23545;&#35843;&#29992;&#32467;&#26524;&#36827;&#34892;&#24207;&#21015;&#21270;
                    encodeResponseData(channel, out, res.getResult(), res.getVersion());
                }
            } else { 
                // &#23545;&#38169;&#35823;&#20449;&#24687;&#36827;&#34892;&#24207;&#21015;&#21270;
                out.writeUTF(res.getErrorMessage())
            };
            out.flushBuffer();
            if (out instanceof Cleanable) {
                ((Cleanable) out).cleanup();
            }
            bos.flush();
            bos.close();

            // &#33719;&#21462;&#20889;&#20837;&#30340;&#23383;&#33410;&#25968;&#65292;&#20063;&#23601;&#26159;&#28040;&#24687;&#20307;&#38271;&#24230;
            int len = bos.writtenBytes();
            checkPayload(channel, len);
            
            // &#23558;&#28040;&#24687;&#20307;&#38271;&#24230;&#20889;&#20837;&#21040;&#28040;&#24687;&#22836;&#20013;
            Bytes.int2bytes(len, header, 12);
            // &#23558; buffer &#25351;&#38024;&#31227;&#21160;&#21040; savedWriteIndex&#65292;&#20026;&#20889;&#28040;&#24687;&#22836;&#20570;&#20934;&#22791;
            buffer.writerIndex(savedWriteIndex);
            // &#20174; savedWriteIndex &#19979;&#26631;&#22788;&#20889;&#20837;&#28040;&#24687;&#22836;
            buffer.writeBytes(header); 
            // &#35774;&#32622;&#26032;&#30340; writerIndex&#65292;writerIndex = &#21407;&#20889;&#19979;&#26631; + &#28040;&#24687;&#22836;&#38271;&#24230; + &#28040;&#24687;&#20307;&#38271;&#24230;
            buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);
        } catch (Throwable t) {
            // &#24322;&#24120;&#22788;&#29702;&#36923;&#36753;&#19981;&#26159;&#24456;&#38590;&#29702;&#35299;&#65292;&#20294;&#26159;&#20195;&#30721;&#30053;&#22810;&#65292;&#36825;&#37324;&#24573;&#30053;&#20102;
        }
    }
}

public class DubboCodec extends ExchangeCodec implements Codec2 {
    
	protected void encodeResponseData(Channel channel, ObjectOutput out, Object data, String version) throws IOException {
        Result result = (Result) data;
        // &#26816;&#27979;&#24403;&#21069;&#21327;&#35758;&#29256;&#26412;&#26159;&#21542;&#25903;&#25345;&#24102;&#26377; attachment &#38598;&#21512;&#30340; Response &#23545;&#35937;
        boolean attach = Version.isSupportResponseAttachment(version);
        Throwable th = result.getException();
        
        // &#24322;&#24120;&#20449;&#24687;&#20026;&#31354;
        if (th == null) {
            Object ret = result.getValue();
            // &#35843;&#29992;&#32467;&#26524;&#20026;&#31354;
            if (ret == null) {
                // &#24207;&#21015;&#21270;&#21709;&#24212;&#31867;&#22411;
                out.writeByte(attach ? RESPONSE_NULL_VALUE_WITH_ATTACHMENTS : RESPONSE_NULL_VALUE);
            } 
            // &#35843;&#29992;&#32467;&#26524;&#38750;&#31354;
            else {
                // &#24207;&#21015;&#21270;&#21709;&#24212;&#31867;&#22411;
                out.writeByte(attach ? RESPONSE_VALUE_WITH_ATTACHMENTS : RESPONSE_VALUE);
                // &#24207;&#21015;&#21270;&#35843;&#29992;&#32467;&#26524;
                out.writeObject(ret);
            }
        } 
        // &#24322;&#24120;&#20449;&#24687;&#38750;&#31354;
        else {
            // &#24207;&#21015;&#21270;&#21709;&#24212;&#31867;&#22411;
            out.writeByte(attach ? RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS : RESPONSE_WITH_EXCEPTION);
            // &#24207;&#21015;&#21270;&#24322;&#24120;&#23545;&#35937;
            out.writeObject(th);
        }

        if (attach) {
            // &#35760;&#24405; Dubbo &#21327;&#35758;&#29256;&#26412;
            result.getAttachments().put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());
            // &#24207;&#21015;&#21270; attachments &#38598;&#21512;
            out.writeObject(result.getAttachments());
        }
    }
}</pre>
 <p class="ne-p" id="u34a70256">
  <br>
 </p>
 <p class="ne-p" id="u662e5d08">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159; Response &#23545;&#35937;&#32534;&#30721;&#30340;&#36807;&#31243;&#65292;&#21644;&#21069;&#38754;&#20998;&#26512;&#30340; Request &#23545;&#35937;&#32534;&#30721;&#36807;&#31243;&#24456;&#30456;&#20284;&#12290;&#22914;&#26524;&#22823;&#23478;&#33021;&#30475; Request &#23545;&#35937;&#30340;&#32534;&#30721;&#36923;&#36753;&#65292;&#37027;&#20040;&#36825;&#37324;&#30340; Response &#23545;&#35937;&#30340;&#32534;&#30721;&#36923;&#36753;&#20063;&#19981;&#38590;&#29702;&#35299;&#65292;&#23601;&#19981;&#22810;&#35828;&#20102;&#12290;&#25509;&#19979;&#26469;&#25105;&#20204;&#20877;&#26469;&#20998;&#26512;&#21452;&#21521;&#36890;&#20449;&#30340;&#26368;&#21518;&#19968;&#29615; &#8212;&#8212; &#26381;&#21153;&#28040;&#36153;&#26041;&#25509;&#25910;&#35843;&#29992;&#32467;&#26524;&#12290;
  </span>
 </p>
 <p class="ne-p" id="uba649fb5">
  <br>
 </p>
 <h3 id="4577a1a0">
  <span class="ne-text">
   2.5 &#26381;&#21153;&#28040;&#36153;&#26041;&#25509;&#25910;&#35843;&#29992;&#32467;&#26524;
  </span>
 </h3>
 <p class="ne-p" id="u5bc69cfe">
  <br>
 </p>
 <p class="ne-p" id="u4b996dd5">
  <span class="ne-text">
   &#26381;&#21153;&#28040;&#36153;&#26041;&#22312;&#25910;&#21040;&#21709;&#24212;&#25968;&#25454;&#21518;&#65292;&#39318;&#20808;&#35201;&#20570;&#30340;&#20107;&#24773;&#26159;&#23545;&#21709;&#24212;&#25968;&#25454;&#36827;&#34892;&#35299;&#30721;&#65292;&#24471;&#21040; Response &#23545;&#35937;&#12290;&#28982;&#21518;&#20877;&#23558;&#35813;&#23545;&#35937;&#20256;&#36882;&#32473;&#19979;&#19968;&#20010;&#20837;&#31449;&#22788;&#29702;&#22120;&#65292;&#36825;&#20010;&#20837;&#31449;&#22788;&#29702;&#22120;&#23601;&#26159; NettyHandler&#12290;&#25509;&#19979;&#26469; NettyHandler &#20250;&#23558;&#36825;&#20010;&#23545;&#35937;&#32487;&#32493;&#21521;&#19979;&#20256;&#36882;&#65292;&#26368;&#21518; AllChannelHandler &#30340; received &#26041;&#27861;&#20250;&#25910;&#21040;&#36825;&#20010;&#23545;&#35937;&#65292;&#24182;&#23558;&#36825;&#20010;&#23545;&#35937;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#20013;&#12290;&#36825;&#20010;&#36807;&#31243;&#21644;&#26381;&#21153;&#25552;&#20379;&#26041;&#25509;&#25910;&#35831;&#27714;&#30340;&#36807;&#31243;&#26159;&#19968;&#26679;&#30340;&#65292;&#22240;&#27492;&#36825;&#37324;&#23601;&#19981;&#37325;&#22797;&#20998;&#26512;&#20102;&#12290;&#26412;&#33410;&#25105;&#20204;&#37325;&#28857;&#20998;&#26512;&#20004;&#20010;&#26041;&#38754;&#30340;&#20869;&#23481;&#65292;&#19968;&#26159;&#21709;&#24212;&#25968;&#25454;&#30340;&#35299;&#30721;&#36807;&#31243;&#65292;&#20108;&#26159; Dubbo &#22914;&#20309;&#23558;&#35843;&#29992;&#32467;&#26524;&#20256;&#36882;&#32473;&#29992;&#25143;&#32447;&#31243;&#30340;&#12290;&#19979;&#38754;&#20808;&#26469;&#20998;&#26512;&#21709;&#24212;&#25968;&#25454;&#30340;&#35299;&#30721;&#36807;&#31243;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u049051bc">
  <br>
 </p>
 <h4 id="16614745">
  <span class="ne-text">
   2.5.1 &#21709;&#24212;&#25968;&#25454;&#35299;&#30721;
  </span>
 </h4>
 <p class="ne-p" id="u2cb51a76">
  <br>
 </p>
 <p class="ne-p" id="uf136f953">
  <span class="ne-text">
   &#21709;&#24212;&#25968;&#25454;&#35299;&#30721;&#36923;&#36753;&#20027;&#35201;&#30340;&#36923;&#36753;&#23553;&#35013;&#22312; DubboCodec &#20013;&#65292;&#25105;&#20204;&#30452;&#25509;&#20998;&#26512;&#36825;&#20010;&#31867;&#30340;&#20195;&#30721;&#12290;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u084fd857">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="7b53299a">public class DubboCodec extends ExchangeCodec implements Codec2 {

    @Override
    protected Object decodeBody(Channel channel, InputStream is, byte[] header) throws IOException {
        byte flag = header[2], proto = (byte) (flag &amp; SERIALIZATION_MASK);
        Serialization s = CodecSupport.getSerialization(channel.getUrl(), proto);
        // &#33719;&#21462;&#35831;&#27714;&#32534;&#21495;
        long id = Bytes.bytes2long(header, 4);
        // &#26816;&#27979;&#28040;&#24687;&#31867;&#22411;&#65292;&#33509;&#19979;&#38754;&#30340;&#26465;&#20214;&#25104;&#31435;&#65292;&#34920;&#26126;&#28040;&#24687;&#31867;&#22411;&#20026; Response
        if ((flag &amp; FLAG_REQUEST) == 0) {
            // &#21019;&#24314; Response &#23545;&#35937;
            Response res = new Response(id);
            // &#26816;&#27979;&#20107;&#20214;&#26631;&#24535;&#20301;
            if ((flag &amp; FLAG_EVENT) != 0) {
                // &#35774;&#32622;&#24515;&#36339;&#20107;&#20214;
                res.setEvent(Response.HEARTBEAT_EVENT);
            }
            // &#33719;&#21462;&#21709;&#24212;&#29366;&#24577;
            byte status = header[3];
            // &#35774;&#32622;&#21709;&#24212;&#29366;&#24577;
            res.setStatus(status);
            
            // &#22914;&#26524;&#21709;&#24212;&#29366;&#24577;&#20026; OK&#65292;&#34920;&#26126;&#35843;&#29992;&#36807;&#31243;&#27491;&#24120;
            if (status == Response.OK) {
                try {
                    Object data;
                    if (res.isHeartbeat()) {
                        // &#21453;&#24207;&#21015;&#21270;&#24515;&#36339;&#25968;&#25454;&#65292;&#24050;&#24223;&#24323;
                        data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));
                    } else if (res.isEvent()) {
                        // &#21453;&#24207;&#21015;&#21270;&#20107;&#20214;&#25968;&#25454;
                        data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));
                    } else {
                        DecodeableRpcResult result;
                        // &#26681;&#25454; url &#21442;&#25968;&#20915;&#23450;&#26159;&#21542;&#22312; IO &#32447;&#31243;&#19978;&#25191;&#34892;&#35299;&#30721;&#36923;&#36753;
                        if (channel.getUrl().getParameter(
                                Constants.DECODE_IN_IO_THREAD_KEY,
                                Constants.DEFAULT_DECODE_IN_IO_THREAD)) {
                            // &#21019;&#24314; DecodeableRpcResult &#23545;&#35937;
                            result = new DecodeableRpcResult(channel, res, is,
                                    (Invocation) getRequestData(id), proto);
                            // &#36827;&#34892;&#21518;&#32493;&#30340;&#35299;&#30721;&#24037;&#20316;
                            result.decode();
                        } else {
                            // &#21019;&#24314; DecodeableRpcResult &#23545;&#35937;
                            result = new DecodeableRpcResult(channel, res,
                                    new UnsafeByteArrayInputStream(readMessageData(is)),
                                    (Invocation) getRequestData(id), proto);
                        }
                        data = result;
                    }
                    
                    // &#35774;&#32622; DecodeableRpcResult &#23545;&#35937;&#21040; Response &#23545;&#35937;&#20013;
                    res.setResult(data);
                } catch (Throwable t) {
                    // &#35299;&#30721;&#36807;&#31243;&#20013;&#20986;&#29616;&#20102;&#38169;&#35823;&#65292;&#27492;&#26102;&#35774;&#32622; CLIENT_ERROR &#29366;&#24577;&#30721;&#21040; Response &#23545;&#35937;&#20013;
                    res.setStatus(Response.CLIENT_ERROR);
                    res.setErrorMessage(StringUtils.toString(t));
                }
            } 
            // &#21709;&#24212;&#29366;&#24577;&#38750; OK&#65292;&#34920;&#26126;&#35843;&#29992;&#36807;&#31243;&#20986;&#29616;&#20102;&#24322;&#24120;
            else {
                // &#21453;&#24207;&#21015;&#21270;&#24322;&#24120;&#20449;&#24687;&#65292;&#24182;&#35774;&#32622;&#21040; Response &#23545;&#35937;&#20013;
                res.setErrorMessage(deserialize(s, channel.getUrl(), is).readUTF());
            }
            return res;
        } else {
            // &#23545;&#35831;&#27714;&#25968;&#25454;&#36827;&#34892;&#35299;&#30721;&#65292;&#21069;&#38754;&#24050;&#20998;&#26512;&#36807;&#65292;&#27492;&#22788;&#24573;&#30053;
        }
    }
}</pre>
 <p class="ne-p" id="u9e461900">
  <br>
 </p>
 <p class="ne-p" id="u04d6c238">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159;&#21709;&#24212;&#25968;&#25454;&#30340;&#35299;&#30721;&#36807;&#31243;&#65292;&#19978;&#38754;&#36923;&#36753;&#30475;&#36215;&#26469;&#26159;&#19981;&#26159;&#20284;&#26366;&#30456;&#35782;&#12290;&#23545;&#30340;&#65292;&#25105;&#20204;&#22312;&#21069;&#38754;&#31456;&#33410;&#20998;&#26512;&#36807; DubboCodec &#30340; decodeBody &#26041;&#27861;&#20013;&#20851;&#20110;&#35831;&#27714;&#25968;&#25454;&#30340;&#35299;&#30721;&#36807;&#31243;&#65292;&#35813;&#36807;&#31243;&#21644;&#21709;&#24212;&#25968;&#25454;&#30340;&#35299;&#30721;&#36807;&#31243;&#24456;&#30456;&#20284;&#12290;&#19979;&#38754;&#65292;&#25105;&#20204;&#32487;&#32493;&#20998;&#26512;&#35843;&#29992;&#32467;&#26524;&#30340;&#21453;&#24207;&#21015;&#21270;&#36807;&#31243;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u7a916a30">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="7eb51c97">public class DecodeableRpcResult extends RpcResult implements Codec, Decodeable {
    
    private Invocation invocation;
	
    @Override
    public void decode() throws Exception {
        if (!hasDecoded &amp;&amp; channel != null &amp;&amp; inputStream != null) {
            try {
                // &#25191;&#34892;&#21453;&#24207;&#21015;&#21270;&#25805;&#20316;
                decode(channel, inputStream);
            } catch (Throwable e) {
                // &#21453;&#24207;&#21015;&#21270;&#22833;&#36133;&#65292;&#35774;&#32622; CLIENT_ERROR &#29366;&#24577;&#21040; Response &#23545;&#35937;&#20013;
                response.setStatus(Response.CLIENT_ERROR);
                // &#35774;&#32622;&#24322;&#24120;&#20449;&#24687;
                response.setErrorMessage(StringUtils.toString(e));
            } finally {
                hasDecoded = true;
            }
        }
    }
    
    @Override
    public Object decode(Channel channel, InputStream input) throws IOException {
        ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), serializationType)
                .deserialize(channel.getUrl(), input);
        
        // &#21453;&#24207;&#21015;&#21270;&#21709;&#24212;&#31867;&#22411;
        byte flag = in.readByte();
        switch (flag) {
            case DubboCodec.RESPONSE_NULL_VALUE:
                break;
            case DubboCodec.RESPONSE_VALUE:
                // ...
                break;
            case DubboCodec.RESPONSE_WITH_EXCEPTION:
                // ...
                break;
                
            // &#36820;&#22238;&#20540;&#20026;&#31354;&#65292;&#19988;&#25658;&#24102;&#20102; attachments &#38598;&#21512;
            case DubboCodec.RESPONSE_NULL_VALUE_WITH_ATTACHMENTS:
                try {
                    // &#21453;&#24207;&#21015;&#21270; attachments &#38598;&#21512;&#65292;&#24182;&#23384;&#20648;&#36215;&#26469; 
                    setAttachments((Map&lt;String, String&gt;) in.readObject(Map.class));
                } catch (ClassNotFoundException e) {
                    throw new IOException(StringUtils.toString("Read response data failed.", e));
                }
                break;
                
            // &#36820;&#22238;&#20540;&#19981;&#20026;&#31354;&#65292;&#19988;&#25658;&#24102;&#20102; attachments &#38598;&#21512;
            case DubboCodec.RESPONSE_VALUE_WITH_ATTACHMENTS:
                try {
                    // &#33719;&#21462;&#36820;&#22238;&#20540;&#31867;&#22411;
                    Type[] returnType = RpcUtils.getReturnTypes(invocation);
                    // &#21453;&#24207;&#21015;&#21270;&#35843;&#29992;&#32467;&#26524;&#65292;&#24182;&#20445;&#23384;&#36215;&#26469;
                    setValue(returnType == null || returnType.length == 0 ? in.readObject() :
                            (returnType.length == 1 ? in.readObject((Class&lt;?&gt;) returnType[0])
                                    : in.readObject((Class&lt;?&gt;) returnType[0], returnType[1])));
                    // &#21453;&#24207;&#21015;&#21270; attachments &#38598;&#21512;&#65292;&#24182;&#23384;&#20648;&#36215;&#26469;
                    setAttachments((Map&lt;String, String&gt;) in.readObject(Map.class));
                } catch (ClassNotFoundException e) {
                    throw new IOException(StringUtils.toString("Read response data failed.", e));
                }
                break;
                
            // &#24322;&#24120;&#23545;&#35937;&#19981;&#20026;&#31354;&#65292;&#19988;&#25658;&#24102;&#20102; attachments &#38598;&#21512;
            case DubboCodec.RESPONSE_WITH_EXCEPTION_WITH_ATTACHMENTS:
                try {
                    // &#21453;&#24207;&#21015;&#21270;&#24322;&#24120;&#23545;&#35937;
                    Object obj = in.readObject();
                    if (obj instanceof Throwable == false)
                        throw new IOException("Response data error, expect Throwable, but get " + obj);
                    // &#35774;&#32622;&#24322;&#24120;&#23545;&#35937;
                    setException((Throwable) obj);
                    // &#21453;&#24207;&#21015;&#21270; attachments &#38598;&#21512;&#65292;&#24182;&#23384;&#20648;&#36215;&#26469;
                    setAttachments((Map&lt;String, String&gt;) in.readObject(Map.class));
                } catch (ClassNotFoundException e) {
                    throw new IOException(StringUtils.toString("Read response data failed.", e));
                }
                break;
            default:
                throw new IOException("Unknown result flag, expect '0' '1' '2', get " + flag);
        }
        if (in instanceof Cleanable) {
            ((Cleanable) in).cleanup();
        }
        return this;
    }
}</pre>
 <p class="ne-p" id="ub51f4199">
  <br>
 </p>
 <p class="ne-p" id="u3189ff61">
  <span class="ne-text">
   &#26412;&#31687;&#25991;&#31456;&#25152;&#20998;&#26512;&#30340;&#28304;&#30721;&#29256;&#26412;&#20026; 2.6.4&#65292;&#35813;&#29256;&#26412;&#19979;&#30340; Response &#25903;&#25345; attachments &#38598;&#21512;&#65292;&#25152;&#20197;&#19978;&#38754;&#20165;&#23545;&#37096;&#20998; case &#20998;&#25903;&#36827;&#34892;&#20102;&#27880;&#37322;&#12290;&#20854;&#20182; case &#20998;&#25903;&#30340;&#36923;&#36753;&#27604;&#34987;&#27880;&#37322;&#20998;&#25903;&#30340;&#36923;&#36753;&#26356;&#20026;&#31616;&#21333;&#65292;&#36825;&#37324;&#23601;&#24573;&#30053;&#20102;&#12290;&#25105;&#20204;&#25152;&#20351;&#29992;&#30340;&#27979;&#35797;&#26381;&#21153;&#25509;&#21475; DemoService &#21253;&#21547;&#20102;&#19968;&#20010;&#20855;&#26377;&#36820;&#22238;&#20540;&#30340;&#26041;&#27861;&#65292;&#27491;&#24120;&#35843;&#29992;&#19979;&#65292;&#32447;&#31243;&#20250;&#36827;&#20837; RESPONSE_VALUE_WITH_ATTACHMENTS &#20998;&#25903;&#20013;&#12290;&#28982;&#21518;&#32447;&#31243;&#20250;&#20174; invocation &#21464;&#37327;&#65288;&#22823;&#23478;&#25506;&#32034;&#19968;&#19979; invocation &#21464;&#37327;&#30340;&#30001;&#26469;&#65289;&#20013;&#33719;&#21462;&#36820;&#22238;&#20540;&#31867;&#22411;&#65292;&#25509;&#30528;&#23545;&#35843;&#29992;&#32467;&#26524;&#36827;&#34892;&#21453;&#24207;&#21015;&#21270;&#65292;&#24182;&#23558;&#24207;&#21015;&#21270;&#21518;&#30340;&#32467;&#26524;&#23384;&#20648;&#36215;&#26469;&#12290;&#26368;&#21518;&#23545; attachments &#38598;&#21512;&#36827;&#34892;&#21453;&#24207;&#21015;&#21270;&#65292;&#24182;&#23384;&#21040;&#25351;&#23450;&#23383;&#27573;&#20013;&#12290;&#21040;&#27492;&#65292;&#20851;&#20110;&#21709;&#24212;&#25968;&#25454;&#30340;&#35299;&#30721;&#36807;&#31243;&#23601;&#20998;&#26512;&#23436;&#20102;&#12290;&#25509;&#19979;&#26469;&#65292;&#25105;&#20204;&#20877;&#26469;&#25506;&#32034;&#19968;&#19979;&#21709;&#24212;&#23545;&#35937; Response &#30340;&#21435;&#21521;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ufc018de3">
  <br>
 </p>
 <h4 id="bc0423a1">
  <span class="ne-text">
   2.5.2 &#21521;&#29992;&#25143;&#32447;&#31243;&#20256;&#36882;&#35843;&#29992;&#32467;&#26524;
  </span>
 </h4>
 <p class="ne-p" id="uf6911899">
  <br>
 </p>
 <p class="ne-p" id="udad918c4">
  <span class="ne-text">
   &#21709;&#24212;&#25968;&#25454;&#35299;&#30721;&#23436;&#25104;&#21518;&#65292;Dubbo &#20250;&#23558;&#21709;&#24212;&#23545;&#35937;&#27966;&#21457;&#21040;&#32447;&#31243;&#27744;&#19978;&#12290;&#35201;&#27880;&#24847;&#30340;&#26159;&#65292;&#32447;&#31243;&#27744;&#20013;&#30340;&#32447;&#31243;&#24182;&#38750;&#29992;&#25143;&#30340;&#35843;&#29992;&#32447;&#31243;&#65292;&#25152;&#20197;&#35201;&#24819;&#21150;&#27861;&#23558;&#21709;&#24212;&#23545;&#35937;&#20174;&#32447;&#31243;&#27744;&#32447;&#31243;&#20256;&#36882;&#21040;&#29992;&#25143;&#32447;&#31243;&#19978;&#12290;&#25105;&#20204;&#22312; 2.1 &#33410;&#20998;&#26512;&#36807;&#29992;&#25143;&#32447;&#31243;&#22312;&#21457;&#36865;&#23436;&#35831;&#27714;&#21518;&#30340;&#21160;&#20316;&#65292;&#21363;&#35843;&#29992; DefaultFuture &#30340; get &#26041;&#27861;&#31561;&#24453;&#21709;&#24212;&#23545;&#35937;&#30340;&#21040;&#26469;&#12290;&#24403;&#21709;&#24212;&#23545;&#35937;&#21040;&#26469;&#21518;&#65292;&#29992;&#25143;&#32447;&#31243;&#20250;&#34987;&#21796;&#37266;&#65292;&#24182;&#36890;&#36807;
  </span>
  <strong>
   <span class="ne-text">
    &#35843;&#29992;&#32534;&#21495;
   </span>
  </strong>
  <span class="ne-text">
   &#33719;&#21462;&#23646;&#20110;&#33258;&#24049;&#30340;&#21709;&#24212;&#23545;&#35937;&#12290;&#19979;&#38754;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979;&#25972;&#20010;&#36807;&#31243;&#23545;&#24212;&#30340;&#20195;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u35a1212c">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="70e39539">public class HeaderExchangeHandler implements ChannelHandlerDelegate {
    
    @Override
    public void received(Channel channel, Object message) throws RemotingException {
        channel.setAttribute(KEY_READ_TIMESTAMP, System.currentTimeMillis());
        ExchangeChannel exchangeChannel = HeaderExchangeChannel.getOrAddChannel(channel);
        try {
            if (message instanceof Request) {
                // &#22788;&#29702;&#35831;&#27714;&#65292;&#21069;&#38754;&#24050;&#20998;&#26512;&#36807;&#65292;&#30465;&#30053;
            } else if (message instanceof Response) {
                // &#22788;&#29702;&#21709;&#24212;
                handleResponse(channel, (Response) message);
            } else if (message instanceof String) {
                // telnet &#30456;&#20851;&#65292;&#24573;&#30053;
            } else {
                handler.received(exchangeChannel, message);
            }
        } finally {
            HeaderExchangeChannel.removeChannelIfDisconnected(channel);
        }
    }

    static void handleResponse(Channel channel, Response response) throws RemotingException {
        if (response != null &amp;&amp; !response.isHeartbeat()) {
            // &#32487;&#32493;&#21521;&#19979;&#35843;&#29992;
            DefaultFuture.received(channel, response);
        }
    }
}

public class DefaultFuture implements ResponseFuture {  
    
    private final Lock lock = new ReentrantLock();
    private final Condition done = lock.newCondition();
    private volatile Response response;
    
	public static void received(Channel channel, Response response) {
        try {
            // &#26681;&#25454;&#35843;&#29992;&#32534;&#21495;&#20174; FUTURES &#38598;&#21512;&#20013;&#26597;&#25214;&#25351;&#23450;&#30340; DefaultFuture &#23545;&#35937;
            DefaultFuture future = FUTURES.remove(response.getId());
            if (future != null) {
                // &#32487;&#32493;&#21521;&#19979;&#35843;&#29992;
                future.doReceived(response);
            } else {
                logger.warn("The timeout response finally returned at ...");
            }
        } finally {
            CHANNELS.remove(response.getId());
        }
    }

	private void doReceived(Response res) {
        lock.lock();
        try {
            // &#20445;&#23384;&#21709;&#24212;&#23545;&#35937;
            response = res;
            if (done != null) {
                // &#21796;&#37266;&#29992;&#25143;&#32447;&#31243;
                done.signal();
            }
        } finally {
            lock.unlock();
        }
        if (callback != null) {
            invokeCallback(callback);
        }
    }
}</pre>
 <p class="ne-p" id="u29a7b0a8">
  <br>
 </p>
 <p class="ne-p" id="uc330af7e">
  <span class="ne-text">
   &#20197;&#19978;&#36923;&#36753;&#26159;&#23558;&#21709;&#24212;&#23545;&#35937;&#20445;&#23384;&#21040;&#30456;&#24212;&#30340; DefaultFuture &#23454;&#20363;&#20013;&#65292;&#28982;&#21518;&#20877;&#21796;&#37266;&#29992;&#25143;&#32447;&#31243;&#65292;&#38543;&#21518;&#29992;&#25143;&#32447;&#31243;&#21363;&#21487;&#20174; DefaultFuture &#23454;&#20363;&#20013;&#33719;&#21462;&#21040;&#30456;&#24212;&#32467;&#26524;&#12290;
  </span>
 </p>
 <p class="ne-p" id="uc763cfa3">
  <br>
 </p>
 <p class="ne-p" id="u65803f1c">
  <span class="ne-text">
   &#26412;&#31687;&#25991;&#31456;&#22312;&#22810;&#20010;&#22320;&#26041;&#37117;&#24378;&#35843;&#36807;&#35843;&#29992;&#32534;&#21495;&#24456;&#37325;&#35201;&#65292;&#20294;&#19968;&#30452;&#27809;&#26377;&#35299;&#37322;&#21407;&#22240;&#65292;&#36825;&#37324;&#31616;&#21333;&#35828;&#26126;&#19968;&#19979;&#12290;&#19968;&#33324;&#24773;&#20917;&#19979;&#65292;&#26381;&#21153;&#28040;&#36153;&#26041;&#20250;&#24182;&#21457;&#35843;&#29992;&#22810;&#20010;&#26381;&#21153;&#65292;&#27599;&#20010;&#29992;&#25143;&#32447;&#31243;&#21457;&#36865;&#35831;&#27714;&#21518;&#65292;&#20250;&#35843;&#29992;&#19981;&#21516; DefaultFuture &#23545;&#35937;&#30340; get &#26041;&#27861;&#36827;&#34892;&#31561;&#24453;&#12290; &#19968;&#27573;&#26102;&#38388;&#21518;&#65292;&#26381;&#21153;&#28040;&#36153;&#26041;&#30340;&#32447;&#31243;&#27744;&#20250;&#25910;&#21040;&#22810;&#20010;&#21709;&#24212;&#23545;&#35937;&#12290;&#36825;&#20010;&#26102;&#20505;&#35201;&#32771;&#34385;&#19968;&#20010;&#38382;&#39064;&#65292;&#22914;&#20309;&#23558;&#27599;&#20010;&#21709;&#24212;&#23545;&#35937;&#20256;&#36882;&#32473;&#30456;&#24212;&#30340; DefaultFuture &#23545;&#35937;&#65292;&#19988;&#19981;&#20986;&#38169;&#12290;&#31572;&#26696;&#26159;&#36890;&#36807;&#35843;&#29992;&#32534;&#21495;&#12290;DefaultFuture &#34987;&#21019;&#24314;&#26102;&#65292;&#20250;&#35201;&#27714;&#20256;&#20837;&#19968;&#20010; Request &#23545;&#35937;&#12290;&#27492;&#26102; DefaultFuture &#21487;&#20174; Request &#23545;&#35937;&#20013;&#33719;&#21462;&#35843;&#29992;&#32534;&#21495;&#65292;&#24182;&#23558; &lt;&#35843;&#29992;&#32534;&#21495;, DefaultFuture &#23545;&#35937;&gt; &#26144;&#23556;&#20851;&#31995;&#23384;&#20837;&#21040;&#38745;&#24577; Map &#20013;&#65292;&#21363; FUTURES&#12290;&#32447;&#31243;&#27744;&#20013;&#30340;&#32447;&#31243;&#22312;&#25910;&#21040; Response &#23545;&#35937;&#21518;&#65292;&#20250;&#26681;&#25454; Response &#23545;&#35937;&#20013;&#30340;&#35843;&#29992;&#32534;&#21495;&#21040; FUTURES &#38598;&#21512;&#20013;&#21462;&#20986;&#30456;&#24212;&#30340; DefaultFuture &#23545;&#35937;&#65292;&#28982;&#21518;&#20877;&#23558; Response &#23545;&#35937;&#35774;&#32622;&#21040; DefaultFuture &#23545;&#35937;&#20013;&#12290;&#26368;&#21518;&#20877;&#21796;&#37266;&#29992;&#25143;&#32447;&#31243;&#65292;&#36825;&#26679;&#29992;&#25143;&#32447;&#31243;&#21363;&#21487;&#20174; DefaultFuture &#23545;&#35937;&#20013;&#33719;&#21462;&#35843;&#29992;&#32467;&#26524;&#20102;&#12290;&#25972;&#20010;&#36807;&#31243;&#22823;&#33268;&#22914;&#19979;&#22270;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ud981ea11">
  <br>
 </p>
 <p class="ne-p" id="u238caee3">
  <img class="ne-image" id="nPTmv" src="EPUB/imgnPTmv">
 </p>
 <p class="ne-p" id="u0c7606c5">
  <br>
 </p>
 <h2 id="393a3509">
  <span class="ne-text">
   3. &#24635;&#32467;
  </span>
 </h2>
 <p class="ne-p" id="u58ee8020">
  <br>
 </p>
 <p class="ne-p" id="ubc77ce6b">
  <span class="ne-text">
   &#26412;&#31687;&#25991;&#31456;&#20027;&#35201;&#23545; Dubbo &#20013;&#30340;&#20960;&#31181;&#26381;&#21153;&#35843;&#29992;&#26041;&#24335;&#65292;&#20197;&#21450;&#20174;&#21452;&#21521;&#36890;&#20449;&#30340;&#35282;&#24230;&#23545;&#25972;&#20010;&#36890;&#20449;&#36807;&#31243;&#36827;&#34892;&#20102;&#35814;&#32454;&#30340;&#20998;&#26512;&#12290;&#25353;&#29031;&#36890;&#20449;&#39034;&#24207;&#65292;&#36890;&#20449;&#36807;&#31243;&#21253;&#25324;&#26381;&#21153;&#28040;&#36153;&#26041;&#21457;&#36865;&#35831;&#27714;&#65292;&#26381;&#21153;&#25552;&#20379;&#26041;&#25509;&#25910;&#35831;&#27714;&#65292;&#26381;&#21153;&#25552;&#20379;&#26041;&#36820;&#22238;&#21709;&#24212;&#25968;&#25454;&#65292;&#26381;&#21153;&#28040;&#36153;&#26041;&#25509;&#25910;&#21709;&#24212;&#25968;&#25454;&#31561;&#36807;&#31243;&#12290;&#29702;&#35299;&#36825;&#20123;&#36807;&#31243;&#38656;&#35201;&#22823;&#23478;&#23545;&#32593;&#32476;&#32534;&#31243;&#65292;&#23588;&#20854;&#26159; Netty &#26377;&#19968;&#23450;&#30340;&#20102;&#35299;&#12290;&#38480;&#20110;&#31687;&#24133;&#21407;&#22240;&#65292;&#26412;&#31687;&#25991;&#31456;&#26080;&#27861;&#23558;&#26381;&#21153;&#35843;&#29992;&#30340;&#25152;&#26377;&#20869;&#23481;&#37117;&#19968;&#19968;&#36827;&#34892;&#20998;&#26512;&#12290;&#23545;&#20110;&#26412;&#31687;&#25991;&#31456;&#26410;&#35762;&#21040;&#25110;&#26410;&#35814;&#32454;&#20998;&#26512;&#30340;&#20869;&#23481;&#65292;&#27604;&#22914;&#26381;&#21153;&#38477;&#32423;&#12289;&#36807;&#28388;&#22120;&#38142;&#12289;&#20197;&#21450;&#24207;&#21015;&#21270;&#31561;&#12290;&#22823;&#23478;&#33509;&#24863;&#20852;&#36259;&#65292;&#21487;&#33258;&#34892;&#36827;&#34892;&#20998;&#26512;&#12290;&#24182;&#23558;&#20998;&#26512;&#25972;&#29702;&#25104;&#25991;&#65292;&#20998;&#20139;&#32473;&#31038;&#21306;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u1872f2f0">
  <br>
 </p>
 <p class="ne-p" id="u8f6b36f8">
  <span class="ne-text">
   &#26412;&#31687;&#25991;&#31456;&#23601;&#21040;&#36825;&#37324;&#20102;&#65292;&#24863;&#35874;&#38405;&#35835;&#12290;
  </span>
 </p>
</div>
</div>
</div>

        </body>
        
        