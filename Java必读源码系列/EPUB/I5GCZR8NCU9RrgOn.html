
        <html lang="en">
        <head>
        <meta charset="UTF-8"/>
        </head>
        <body>
        <div><div class="markdown-body">
    <h1>&#12300;&#28304;&#30721;&#35299;&#35835;&#12301;&#36127;&#36733;&#22343;&#34913;</h1><div class="lake-content" typography="classic">
 <p class="ne-p" id="ufa023383">
  <span class="ne-text">
   &#26412;&#25991;&#20171;&#32461;&#20102;&#36127;&#36733;&#22343;&#34913;&#30340;&#21407;&#29702;&#21644;&#23454;&#29616;&#32454;&#33410;
  </span>
 </p>
 <p class="ne-p" id="u9dd874f7">
  <br>
 </p>
 <h2 id="8814759b">
  <span class="ne-text">
   1.&#31616;&#20171;
  </span>
 </h2>
 <p class="ne-p" id="u757cf79b">
  <br>
 </p>
 <p class="ne-p" id="uedfc98ce">
  <span class="ne-text">
   LoadBalance &#20013;&#25991;&#24847;&#24605;&#20026;&#36127;&#36733;&#22343;&#34913;&#65292;&#23427;&#30340;&#32844;&#36131;&#26159;&#23558;&#32593;&#32476;&#35831;&#27714;&#65292;&#25110;&#32773;&#20854;&#20182;&#24418;&#24335;&#30340;&#36127;&#36733;&#8220;&#22343;&#25674;&#8221;&#21040;&#19981;&#21516;&#30340;&#26426;&#22120;&#19978;&#12290;&#36991;&#20813;&#38598;&#32676;&#20013;&#37096;&#20998;&#26381;&#21153;&#22120;&#21387;&#21147;&#36807;&#22823;&#65292;&#32780;&#21478;&#19968;&#20123;&#26381;&#21153;&#22120;&#27604;&#36739;&#31354;&#38386;&#30340;&#24773;&#20917;&#12290;&#36890;&#36807;&#36127;&#36733;&#22343;&#34913;&#65292;&#21487;&#20197;&#35753;&#27599;&#21488;&#26381;&#21153;&#22120;&#33719;&#21462;&#21040;&#36866;&#21512;&#33258;&#24049;&#22788;&#29702;&#33021;&#21147;&#30340;&#36127;&#36733;&#12290;&#22312;&#20026;&#39640;&#36127;&#36733;&#26381;&#21153;&#22120;&#20998;&#27969;&#30340;&#21516;&#26102;&#65292;&#36824;&#21487;&#20197;&#36991;&#20813;&#36164;&#28304;&#28010;&#36153;&#65292;&#19968;&#20030;&#20004;&#24471;&#12290;&#36127;&#36733;&#22343;&#34913;&#21487;&#20998;&#20026;&#36719;&#20214;&#36127;&#36733;&#22343;&#34913;&#21644;&#30828;&#20214;&#36127;&#36733;&#22343;&#34913;&#12290;&#22312;&#25105;&#20204;&#26085;&#24120;&#24320;&#21457;&#20013;&#65292;&#19968;&#33324;&#24456;&#38590;&#25509;&#35302;&#21040;&#30828;&#20214;&#36127;&#36733;&#22343;&#34913;&#12290;&#20294;&#36719;&#20214;&#36127;&#36733;&#22343;&#34913;&#36824;&#26159;&#21487;&#20197;&#25509;&#35302;&#21040;&#30340;&#65292;&#27604;&#22914; Nginx&#12290;&#22312; Dubbo &#20013;&#65292;&#20063;&#26377;&#36127;&#36733;&#22343;&#34913;&#30340;&#27010;&#24565;&#21644;&#30456;&#24212;&#30340;&#23454;&#29616;&#12290;Dubbo &#38656;&#35201;&#23545;&#26381;&#21153;&#28040;&#36153;&#32773;&#30340;&#35843;&#29992;&#35831;&#27714;&#36827;&#34892;&#20998;&#37197;&#65292;&#36991;&#20813;&#23569;&#25968;&#26381;&#21153;&#25552;&#20379;&#32773;&#36127;&#36733;&#36807;&#22823;&#12290;&#26381;&#21153;&#25552;&#20379;&#32773;&#36127;&#36733;&#36807;&#22823;&#65292;&#20250;&#23548;&#33268;&#37096;&#20998;&#35831;&#27714;&#36229;&#26102;&#12290;&#22240;&#27492;&#23558;&#36127;&#36733;&#22343;&#34913;&#21040;&#27599;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#19978;&#65292;&#26159;&#38750;&#24120;&#24517;&#35201;&#30340;&#12290;Dubbo &#25552;&#20379;&#20102;4&#31181;&#36127;&#36733;&#22343;&#34913;&#23454;&#29616;&#65292;&#20998;&#21035;&#26159;&#22522;&#20110;&#26435;&#37325;&#38543;&#26426;&#31639;&#27861;&#30340; RandomLoadBalance&#12289;&#22522;&#20110;&#26368;&#23569;&#27963;&#36291;&#35843;&#29992;&#25968;&#31639;&#27861;&#30340; LeastActiveLoadBalance&#12289;&#22522;&#20110; hash &#19968;&#33268;&#24615;&#30340; ConsistentHashLoadBalance&#65292;&#20197;&#21450;&#22522;&#20110;&#21152;&#26435;&#36718;&#35810;&#31639;&#27861;&#30340; RoundRobinLoadBalance&#12290;&#36825;&#20960;&#20010;&#36127;&#36733;&#22343;&#34913;&#31639;&#27861;&#20195;&#30721;&#19981;&#26159;&#24456;&#38271;&#65292;&#20294;&#26159;&#24819;&#30475;&#25026;&#20063;&#19981;&#26159;&#24456;&#23481;&#26131;&#65292;&#38656;&#35201;&#22823;&#23478;&#23545;&#36825;&#20960;&#20010;&#31639;&#27861;&#30340;&#21407;&#29702;&#26377;&#19968;&#23450;&#20102;&#35299;&#25165;&#34892;&#12290;&#22914;&#26524;&#19981;&#26159;&#24456;&#20102;&#35299;&#65292;&#20063;&#27809;&#19981;&#29992;&#22826;&#25285;&#24515;&#12290;&#25105;&#20204;&#20250;&#22312;&#20998;&#26512;&#27599;&#20010;&#31639;&#27861;&#30340;&#28304;&#30721;&#20043;&#21069;&#65292;&#23545;&#31639;&#27861;&#21407;&#29702;&#36827;&#34892;&#31616;&#21333;&#30340;&#35762;&#35299;&#65292;&#24110;&#21161;&#22823;&#23478;&#24314;&#31435;&#21021;&#27493;&#30340;&#21360;&#35937;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u1a8230fa">
  <br>
 </p>
 <p class="ne-p" id="u0ede2e34">
  <span class="ne-text">
   &#26412;&#31995;&#21015;&#25991;&#31456;&#22312;&#32534;&#20889;&#20043;&#21021;&#26159;&#22522;&#20110; Dubbo 2.6.4 &#30340;&#65292;&#36817;&#26399;&#65292;Dubbo 2.6.5 &#21457;&#24067;&#20102;&#65292;&#20854;&#20013;&#23601;&#26377;&#38024;&#23545;&#23545;&#36127;&#36733;&#22343;&#34913;&#37096;&#20998;&#30340;&#20248;&#21270;&#12290;&#22240;&#27492;&#25105;&#20204;&#22312;&#20998;&#26512;&#23436; 2.6.4 &#29256;&#26412;&#21518;&#30340;&#28304;&#30721;&#21518;&#65292;&#20250;&#21478;&#22806;&#20998;&#26512; 2.6.5 &#26356;&#26032;&#30340;&#37096;&#20998;&#12290;&#20854;&#20182;&#30340;&#23601;&#19981;&#22810;&#35828;&#20102;&#65292;&#36827;&#20837;&#27491;&#39064;&#21543;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u7f73ac12">
  <br>
 </p>
 <h2 id="4bb2d8a9">
  <span class="ne-text">
   2.&#28304;&#30721;&#20998;&#26512;
  </span>
 </h2>
 <p class="ne-p" id="u9b7c2d03">
  <br>
 </p>
 <p class="ne-p" id="u2c99eb87">
  <span class="ne-text">
   &#22312; Dubbo &#20013;&#65292;&#25152;&#26377;&#36127;&#36733;&#22343;&#34913;&#23454;&#29616;&#31867;&#22343;&#32487;&#25215;&#33258; AbstractLoadBalance&#65292;&#35813;&#31867;&#23454;&#29616;&#20102; LoadBalance &#25509;&#21475;&#65292;&#24182;&#23553;&#35013;&#20102;&#19968;&#20123;&#20844;&#20849;&#30340;&#36923;&#36753;&#12290;&#25152;&#20197;&#22312;&#20998;&#26512;&#36127;&#36733;&#22343;&#34913;&#23454;&#29616;&#20043;&#21069;&#65292;&#20808;&#26469;&#30475;&#19968;&#19979; AbstractLoadBalance &#30340;&#36923;&#36753;&#12290;&#39318;&#20808;&#26469;&#30475;&#19968;&#19979;&#36127;&#36733;&#22343;&#34913;&#30340;&#20837;&#21475;&#26041;&#27861; select&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u3eb6b186">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="6e1109ee">@Override
public &lt;T&gt; Invoker&lt;T&gt; select(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
    if (invokers == null || invokers.isEmpty())
        return null;
    // &#22914;&#26524; invokers &#21015;&#34920;&#20013;&#20165;&#26377;&#19968;&#20010; Invoker&#65292;&#30452;&#25509;&#36820;&#22238;&#21363;&#21487;&#65292;&#26080;&#38656;&#36827;&#34892;&#36127;&#36733;&#22343;&#34913;
    if (invokers.size() == 1)
        return invokers.get(0);
    
    // &#35843;&#29992; doSelect &#26041;&#27861;&#36827;&#34892;&#36127;&#36733;&#22343;&#34913;&#65292;&#35813;&#26041;&#27861;&#20026;&#25277;&#35937;&#26041;&#27861;&#65292;&#30001;&#23376;&#31867;&#23454;&#29616;
    return doSelect(invokers, url, invocation);
}

protected abstract &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation);</pre>
 <p class="ne-p" id="ubfdd06f9">
  <br>
 </p>
 <p class="ne-p" id="u550ea90c">
  <span class="ne-text">
   select &#26041;&#27861;&#30340;&#36923;&#36753;&#27604;&#36739;&#31616;&#21333;&#65292;&#39318;&#20808;&#20250;&#26816;&#27979; invokers &#38598;&#21512;&#30340;&#21512;&#27861;&#24615;&#65292;&#28982;&#21518;&#20877;&#26816;&#27979; invokers &#38598;&#21512;&#20803;&#32032;&#25968;&#37327;&#12290;&#22914;&#26524;&#21482;&#21253;&#21547;&#19968;&#20010; Invoker&#65292;&#30452;&#25509;&#36820;&#22238;&#35813; Inovker &#21363;&#21487;&#12290;&#22914;&#26524;&#21253;&#21547;&#22810;&#20010; Invoker&#65292;&#27492;&#26102;&#38656;&#35201;&#36890;&#36807;&#36127;&#36733;&#22343;&#34913;&#31639;&#27861;&#36873;&#25321;&#19968;&#20010; Invoker&#12290;&#20855;&#20307;&#30340;&#36127;&#36733;&#22343;&#34913;&#31639;&#27861;&#30001;&#23376;&#31867;&#23454;&#29616;&#65292;&#25509;&#19979;&#26469;&#31456;&#33410;&#20250;&#23545;&#36825;&#20123;&#23376;&#31867;&#19968;&#19968;&#36827;&#34892;&#35814;&#32454;&#20998;&#26512;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u5fee8375">
  <br>
 </p>
 <p class="ne-p" id="ubc05de9a">
  <span class="ne-text">
   AbstractLoadBalance &#38500;&#20102;&#23454;&#29616;&#20102; LoadBalance &#25509;&#21475;&#26041;&#27861;&#65292;&#36824;&#23553;&#35013;&#20102;&#19968;&#20123;&#20844;&#20849;&#36923;&#36753;&#65292;&#27604;&#22914;&#26381;&#21153;&#25552;&#20379;&#32773;&#26435;&#37325;&#35745;&#31639;&#36923;&#36753;&#12290;&#20855;&#20307;&#23454;&#29616;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u8beaee9c">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="565b84d8">protected int getWeight(Invoker&lt;?&gt; invoker, Invocation invocation) {
    // &#20174; url &#20013;&#33719;&#21462;&#26435;&#37325; weight &#37197;&#32622;&#20540;
    int weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);
    if (weight &gt; 0) {
        // &#33719;&#21462;&#26381;&#21153;&#25552;&#20379;&#32773;&#21551;&#21160;&#26102;&#38388;&#25139;
        long timestamp = invoker.getUrl().getParameter(Constants.REMOTE_TIMESTAMP_KEY, 0L);
        if (timestamp &gt; 0L) {
            // &#35745;&#31639;&#26381;&#21153;&#25552;&#20379;&#32773;&#36816;&#34892;&#26102;&#38271;
            int uptime = (int) (System.currentTimeMillis() - timestamp);
            // &#33719;&#21462;&#26381;&#21153;&#39044;&#28909;&#26102;&#38388;&#65292;&#40664;&#35748;&#20026;10&#20998;&#38047;
            int warmup = invoker.getUrl().getParameter(Constants.WARMUP_KEY, Constants.DEFAULT_WARMUP);
            // &#22914;&#26524;&#26381;&#21153;&#36816;&#34892;&#26102;&#38388;&#23567;&#20110;&#39044;&#28909;&#26102;&#38388;&#65292;&#21017;&#37325;&#26032;&#35745;&#31639;&#26381;&#21153;&#26435;&#37325;&#65292;&#21363;&#38477;&#26435;
            if (uptime &gt; 0 &amp;&amp; uptime &lt; warmup) {
                // &#37325;&#26032;&#35745;&#31639;&#26381;&#21153;&#26435;&#37325;
                weight = calculateWarmupWeight(uptime, warmup, weight);
            }
        }
    }
    return weight;
}

static int calculateWarmupWeight(int uptime, int warmup, int weight) {
    // &#35745;&#31639;&#26435;&#37325;&#65292;&#19979;&#38754;&#20195;&#30721;&#36923;&#36753;&#19978;&#24418;&#20284;&#20110; (uptime / warmup) * weight&#12290;
    // &#38543;&#30528;&#26381;&#21153;&#36816;&#34892;&#26102;&#38388; uptime &#22686;&#22823;&#65292;&#26435;&#37325;&#35745;&#31639;&#20540; ww &#20250;&#24930;&#24930;&#25509;&#36817;&#37197;&#32622;&#20540; weight
    int ww = (int) ((float) uptime / ((float) warmup / (float) weight));
    return ww &lt; 1 ? 1 : (ww &gt; weight ? weight : ww);
}</pre>
 <p class="ne-p" id="u4212fbe8">
  <br>
 </p>
 <p class="ne-p" id="u0c480b4b">
  <span class="ne-text">
   &#19978;&#38754;&#26159;&#26435;&#37325;&#30340;&#35745;&#31639;&#36807;&#31243;&#65292;&#35813;&#36807;&#31243;&#20027;&#35201;&#29992;&#20110;&#20445;&#35777;&#24403;&#26381;&#21153;&#36816;&#34892;&#26102;&#38271;&#23567;&#20110;&#26381;&#21153;&#39044;&#28909;&#26102;&#38388;&#26102;&#65292;&#23545;&#26381;&#21153;&#36827;&#34892;&#38477;&#26435;&#65292;&#36991;&#20813;&#35753;&#26381;&#21153;&#22312;&#21551;&#21160;&#20043;&#21021;&#23601;&#22788;&#20110;&#39640;&#36127;&#36733;&#29366;&#24577;&#12290;&#26381;&#21153;&#39044;&#28909;&#26159;&#19968;&#20010;&#20248;&#21270;&#25163;&#27573;&#65292;&#19982;&#27492;&#31867;&#20284;&#30340;&#36824;&#26377; JVM &#39044;&#28909;&#12290;&#20027;&#35201;&#30446;&#30340;&#26159;&#35753;&#26381;&#21153;&#21551;&#21160;&#21518;&#8220;&#20302;&#21151;&#29575;&#8221;&#36816;&#34892;&#19968;&#27573;&#26102;&#38388;&#65292;&#20351;&#20854;&#25928;&#29575;&#24930;&#24930;&#25552;&#21319;&#33267;&#26368;&#20339;&#29366;&#24577;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ued9415bc">
  <br>
 </p>
 <p class="ne-p" id="u59bd3fb6">
  <span class="ne-text">
   &#20851;&#20110; AbstractLoadBalance &#23601;&#20808;&#20998;&#26512;&#21040;&#36825;&#65292;&#25509;&#19979;&#26469;&#20998;&#26512;&#21508;&#20010;&#23454;&#29616;&#31867;&#30340;&#20195;&#30721;&#12290;&#39318;&#20808;&#65292;&#25105;&#20204;&#20174; Dubbo &#32570;&#30465;&#30340;&#23454;&#29616;&#31867; RandomLoadBalance &#30475;&#36215;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u9b9b34ec">
  <br>
 </p>
 <h3 id="8b92c286">
  <span class="ne-text">
   2.1 RandomLoadBalance
  </span>
 </h3>
 <p class="ne-p" id="u2e4b024f">
  <br>
 </p>
 <p class="ne-p" id="u06f45968">
  <span class="ne-text">
   RandomLoadBalance &#26159;&#21152;&#26435;&#38543;&#26426;&#31639;&#27861;&#30340;&#20855;&#20307;&#23454;&#29616;&#65292;&#23427;&#30340;&#31639;&#27861;&#24605;&#24819;&#24456;&#31616;&#21333;&#12290;&#20551;&#35774;&#25105;&#20204;&#26377;&#19968;&#32452;&#26381;&#21153;&#22120; servers = [A, B, C]&#65292;&#20182;&#20204;&#23545;&#24212;&#30340;&#26435;&#37325;&#20026; weights = [5, 3, 2]&#65292;&#26435;&#37325;&#24635;&#21644;&#20026;10&#12290;&#29616;&#22312;&#25226;&#36825;&#20123;&#26435;&#37325;&#20540;&#24179;&#38138;&#22312;&#19968;&#32500;&#22352;&#26631;&#20540;&#19978;&#65292;[0, 5) &#21306;&#38388;&#23646;&#20110;&#26381;&#21153;&#22120; A&#65292;[5, 8) &#21306;&#38388;&#23646;&#20110;&#26381;&#21153;&#22120; B&#65292;[8, 10) &#21306;&#38388;&#23646;&#20110;&#26381;&#21153;&#22120; C&#12290;&#25509;&#19979;&#26469;&#36890;&#36807;&#38543;&#26426;&#25968;&#29983;&#25104;&#22120;&#29983;&#25104;&#19968;&#20010;&#33539;&#22260;&#22312; [0, 10) &#20043;&#38388;&#30340;&#38543;&#26426;&#25968;&#65292;&#28982;&#21518;&#35745;&#31639;&#36825;&#20010;&#38543;&#26426;&#25968;&#20250;&#33853;&#21040;&#21738;&#20010;&#21306;&#38388;&#19978;&#12290;&#27604;&#22914;&#25968;&#23383;3&#20250;&#33853;&#21040;&#26381;&#21153;&#22120; A &#23545;&#24212;&#30340;&#21306;&#38388;&#19978;&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; A &#21363;&#21487;&#12290;&#26435;&#37325;&#36234;&#22823;&#30340;&#26426;&#22120;&#65292;&#22312;&#22352;&#26631;&#36724;&#19978;&#23545;&#24212;&#30340;&#21306;&#38388;&#33539;&#22260;&#23601;&#36234;&#22823;&#65292;&#22240;&#27492;&#38543;&#26426;&#25968;&#29983;&#25104;&#22120;&#29983;&#25104;&#30340;&#25968;&#23383;&#23601;&#20250;&#26377;&#26356;&#22823;&#30340;&#27010;&#29575;&#33853;&#21040;&#27492;&#21306;&#38388;&#20869;&#12290;&#21482;&#35201;&#38543;&#26426;&#25968;&#29983;&#25104;&#22120;&#20135;&#29983;&#30340;&#38543;&#26426;&#25968;&#20998;&#24067;&#24615;&#24456;&#22909;&#65292;&#22312;&#32463;&#36807;&#22810;&#27425;&#36873;&#25321;&#21518;&#65292;&#27599;&#20010;&#26381;&#21153;&#22120;&#34987;&#36873;&#20013;&#30340;&#27425;&#25968;&#27604;&#20363;&#25509;&#36817;&#20854;&#26435;&#37325;&#27604;&#20363;&#12290;&#27604;&#22914;&#65292;&#32463;&#36807;&#19968;&#19975;&#27425;&#36873;&#25321;&#21518;&#65292;&#26381;&#21153;&#22120; A &#34987;&#36873;&#20013;&#30340;&#27425;&#25968;&#22823;&#32422;&#20026;5000&#27425;&#65292;&#26381;&#21153;&#22120; B &#34987;&#36873;&#20013;&#30340;&#27425;&#25968;&#32422;&#20026;3000&#27425;&#65292;&#26381;&#21153;&#22120; C &#34987;&#36873;&#20013;&#30340;&#27425;&#25968;&#32422;&#20026;2000&#27425;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u76992b9c">
  <br>
 </p>
 <p class="ne-p" id="u8c244630">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159; RandomLoadBalance &#32972;&#21518;&#30340;&#31639;&#27861;&#24605;&#24819;&#65292;&#27604;&#36739;&#31616;&#21333;&#12290;&#19979;&#38754;&#24320;&#22987;&#20998;&#26512;&#28304;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u8428c12b">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="05d3a094">public class RandomLoadBalance extends AbstractLoadBalance {

    public static final String NAME = "random";

    private final Random random = new Random();

    @Override
    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
        int length = invokers.size();
        int totalWeight = 0;
        boolean sameWeight = true;
        // &#19979;&#38754;&#36825;&#20010;&#24490;&#29615;&#26377;&#20004;&#20010;&#20316;&#29992;&#65292;&#31532;&#19968;&#26159;&#35745;&#31639;&#24635;&#26435;&#37325; totalWeight&#65292;
        // &#31532;&#20108;&#26159;&#26816;&#27979;&#27599;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#30340;&#26435;&#37325;&#26159;&#21542;&#30456;&#21516;
        for (int i = 0; i &lt; length; i++) {
            int weight = getWeight(invokers.get(i), invocation);
            // &#32047;&#21152;&#26435;&#37325;
            totalWeight += weight;
            // &#26816;&#27979;&#24403;&#21069;&#26381;&#21153;&#25552;&#20379;&#32773;&#30340;&#26435;&#37325;&#19982;&#19978;&#19968;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#30340;&#26435;&#37325;&#26159;&#21542;&#30456;&#21516;&#65292;
            // &#19981;&#30456;&#21516;&#30340;&#35805;&#65292;&#21017;&#23558; sameWeight &#32622;&#20026; false&#12290;
            if (sameWeight &amp;&amp; i &gt; 0
                    &amp;&amp; weight != getWeight(invokers.get(i - 1), invocation)) {
                sameWeight = false;
            }
        }
        
        // &#19979;&#38754;&#30340; if &#20998;&#25903;&#20027;&#35201;&#29992;&#20110;&#33719;&#21462;&#38543;&#26426;&#25968;&#65292;&#24182;&#35745;&#31639;&#38543;&#26426;&#25968;&#33853;&#22312;&#21738;&#20010;&#21306;&#38388;&#19978;
        if (totalWeight &gt; 0 &amp;&amp; !sameWeight) {
            // &#38543;&#26426;&#33719;&#21462;&#19968;&#20010; [0, totalWeight) &#21306;&#38388;&#20869;&#30340;&#25968;&#23383;
            int offset = random.nextInt(totalWeight);
            // &#24490;&#29615;&#35753; offset &#25968;&#20943;&#21435;&#26381;&#21153;&#25552;&#20379;&#32773;&#26435;&#37325;&#20540;&#65292;&#24403; offset &#23567;&#20110;0&#26102;&#65292;&#36820;&#22238;&#30456;&#24212;&#30340; Invoker&#12290;
            // &#20030;&#20363;&#35828;&#26126;&#19968;&#19979;&#65292;&#25105;&#20204;&#26377; servers = [A, B, C]&#65292;weights = [5, 3, 2]&#65292;offset = 7&#12290;
            // &#31532;&#19968;&#27425;&#24490;&#29615;&#65292;offset - 5 = 2 &gt; 0&#65292;&#21363; offset &gt; 5&#65292;
            // &#34920;&#26126;&#20854;&#19981;&#20250;&#33853;&#22312;&#26381;&#21153;&#22120; A &#23545;&#24212;&#30340;&#21306;&#38388;&#19978;&#12290;
            // &#31532;&#20108;&#27425;&#24490;&#29615;&#65292;offset - 3 = -1 &lt; 0&#65292;&#21363; 5 &lt; offset &lt; 8&#65292;
            // &#34920;&#26126;&#20854;&#20250;&#33853;&#22312;&#26381;&#21153;&#22120; B &#23545;&#24212;&#30340;&#21306;&#38388;&#19978;
            for (int i = 0; i &lt; length; i++) {
                // &#35753;&#38543;&#26426;&#20540; offset &#20943;&#21435;&#26435;&#37325;&#20540;
                offset -= getWeight(invokers.get(i), invocation);
                if (offset &lt; 0) {
                    // &#36820;&#22238;&#30456;&#24212;&#30340; Invoker
                    return invokers.get(i);
                }
            }
        }
        
        // &#22914;&#26524;&#25152;&#26377;&#26381;&#21153;&#25552;&#20379;&#32773;&#26435;&#37325;&#20540;&#30456;&#21516;&#65292;&#27492;&#26102;&#30452;&#25509;&#38543;&#26426;&#36820;&#22238;&#19968;&#20010;&#21363;&#21487;
        return invokers.get(random.nextInt(length));
    }
}</pre>
 <p class="ne-p" id="u3599b83a">
  <br>
 </p>
 <p class="ne-p" id="u0052cdda">
  <span class="ne-text">
   RandomLoadBalance &#30340;&#31639;&#27861;&#24605;&#24819;&#27604;&#36739;&#31616;&#21333;&#65292;&#22312;&#32463;&#36807;&#22810;&#27425;&#35831;&#27714;&#21518;&#65292;&#33021;&#22815;&#23558;&#35843;&#29992;&#35831;&#27714;&#25353;&#29031;&#26435;&#37325;&#20540;&#36827;&#34892;&#8220;&#22343;&#21248;&#8221;&#20998;&#37197;&#12290;&#24403;&#28982; RandomLoadBalance &#20063;&#23384;&#22312;&#19968;&#23450;&#30340;&#32570;&#28857;&#65292;&#24403;&#35843;&#29992;&#27425;&#25968;&#27604;&#36739;&#23569;&#26102;&#65292;Random &#20135;&#29983;&#30340;&#38543;&#26426;&#25968;&#21487;&#33021;&#20250;&#27604;&#36739;&#38598;&#20013;&#65292;&#27492;&#26102;&#22810;&#25968;&#35831;&#27714;&#20250;&#33853;&#21040;&#21516;&#19968;&#21488;&#26381;&#21153;&#22120;&#19978;&#12290;&#36825;&#20010;&#32570;&#28857;&#24182;&#19981;&#26159;&#24456;&#20005;&#37325;&#65292;&#22810;&#25968;&#24773;&#20917;&#19979;&#21487;&#20197;&#24573;&#30053;&#12290;RandomLoadBalance &#26159;&#19968;&#20010;&#31616;&#21333;&#65292;&#39640;&#25928;&#30340;&#36127;&#36733;&#22343;&#34913;&#23454;&#29616;&#65292;&#22240;&#27492; Dubbo &#36873;&#25321;&#23427;&#20316;&#20026;&#32570;&#30465;&#23454;&#29616;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u2fbc2fe7">
  <br>
 </p>
 <p class="ne-p" id="ubc13fefa">
  <span class="ne-text">
   &#20851;&#20110; RandomLoadBalance &#23601;&#20808;&#21040;&#36825;&#20102;&#65292;&#25509;&#19979;&#26469;&#20998;&#26512; LeastActiveLoadBalance&#12290;
  </span>
 </p>
 <p class="ne-p" id="u2e43dbf9">
  <br>
 </p>
 <h3 id="f1de93ea">
  <span class="ne-text">
   2.2 LeastActiveLoadBalance
  </span>
 </h3>
 <p class="ne-p" id="u41be2045">
  <br>
 </p>
 <p class="ne-p" id="u2a79896a">
  <span class="ne-text">
   LeastActiveLoadBalance &#32763;&#35793;&#36807;&#26469;&#26159;&#26368;&#23567;&#27963;&#36291;&#25968;&#36127;&#36733;&#22343;&#34913;&#12290;&#27963;&#36291;&#35843;&#29992;&#25968;&#36234;&#23567;&#65292;&#34920;&#26126;&#35813;&#26381;&#21153;&#25552;&#20379;&#32773;&#25928;&#29575;&#36234;&#39640;&#65292;&#21333;&#20301;&#26102;&#38388;&#20869;&#21487;&#22788;&#29702;&#26356;&#22810;&#30340;&#35831;&#27714;&#12290;&#27492;&#26102;&#24212;&#20248;&#20808;&#23558;&#35831;&#27714;&#20998;&#37197;&#32473;&#35813;&#26381;&#21153;&#25552;&#20379;&#32773;&#12290;&#22312;&#20855;&#20307;&#23454;&#29616;&#20013;&#65292;&#27599;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#23545;&#24212;&#19968;&#20010;&#27963;&#36291;&#25968; active&#12290;&#21021;&#22987;&#24773;&#20917;&#19979;&#65292;&#25152;&#26377;&#26381;&#21153;&#25552;&#20379;&#32773;&#27963;&#36291;&#25968;&#22343;&#20026;0&#12290;&#27599;&#25910;&#21040;&#19968;&#20010;&#35831;&#27714;&#65292;&#27963;&#36291;&#25968;&#21152;1&#65292;&#23436;&#25104;&#35831;&#27714;&#21518;&#21017;&#23558;&#27963;&#36291;&#25968;&#20943;1&#12290;&#22312;&#26381;&#21153;&#36816;&#34892;&#19968;&#27573;&#26102;&#38388;&#21518;&#65292;&#24615;&#33021;&#22909;&#30340;&#26381;&#21153;&#25552;&#20379;&#32773;&#22788;&#29702;&#35831;&#27714;&#30340;&#36895;&#24230;&#26356;&#24555;&#65292;&#22240;&#27492;&#27963;&#36291;&#25968;&#19979;&#38477;&#30340;&#20063;&#36234;&#24555;&#65292;&#27492;&#26102;&#36825;&#26679;&#30340;&#26381;&#21153;&#25552;&#20379;&#32773;&#33021;&#22815;&#20248;&#20808;&#33719;&#21462;&#21040;&#26032;&#30340;&#26381;&#21153;&#35831;&#27714;&#12289;&#36825;&#23601;&#26159;&#26368;&#23567;&#27963;&#36291;&#25968;&#36127;&#36733;&#22343;&#34913;&#31639;&#27861;&#30340;&#22522;&#26412;&#24605;&#24819;&#12290;&#38500;&#20102;&#26368;&#23567;&#27963;&#36291;&#25968;&#65292;LeastActiveLoadBalance &#22312;&#23454;&#29616;&#19978;&#36824;&#24341;&#20837;&#20102;&#26435;&#37325;&#20540;&#12290;&#25152;&#20197;&#20934;&#30830;&#30340;&#26469;&#35828;&#65292;LeastActiveLoadBalance &#26159;&#22522;&#20110;&#21152;&#26435;&#26368;&#23567;&#27963;&#36291;&#25968;&#31639;&#27861;&#23454;&#29616;&#30340;&#12290;&#20030;&#20010;&#20363;&#23376;&#35828;&#26126;&#19968;&#19979;&#65292;&#22312;&#19968;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#38598;&#32676;&#20013;&#65292;&#26377;&#20004;&#20010;&#24615;&#33021;&#20248;&#24322;&#30340;&#26381;&#21153;&#25552;&#20379;&#32773;&#12290;&#26576;&#19968;&#26102;&#21051;&#23427;&#20204;&#30340;&#27963;&#36291;&#25968;&#30456;&#21516;&#65292;&#27492;&#26102; Dubbo &#20250;&#26681;&#25454;&#23427;&#20204;&#30340;&#26435;&#37325;&#21435;&#20998;&#37197;&#35831;&#27714;&#65292;&#26435;&#37325;&#36234;&#22823;&#65292;&#33719;&#21462;&#21040;&#26032;&#35831;&#27714;&#30340;&#27010;&#29575;&#23601;&#36234;&#22823;&#12290;&#22914;&#26524;&#20004;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#26435;&#37325;&#30456;&#21516;&#65292;&#27492;&#26102;&#38543;&#26426;&#36873;&#25321;&#19968;&#20010;&#21363;&#21487;&#12290;&#20851;&#20110; LeastActiveLoadBalance &#30340;&#32972;&#26223;&#30693;&#35782;&#23601;&#20808;&#20171;&#32461;&#21040;&#36825;&#37324;&#65292;&#19979;&#38754;&#24320;&#22987;&#20998;&#26512;&#28304;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u759f480b">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="661836d6">public class LeastActiveLoadBalance extends AbstractLoadBalance {

    public static final String NAME = "leastactive";

    private final Random random = new Random();

    @Override
    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
        int length = invokers.size();
        // &#26368;&#23567;&#30340;&#27963;&#36291;&#25968;
        int leastActive = -1;
        // &#20855;&#26377;&#30456;&#21516;&#8220;&#26368;&#23567;&#27963;&#36291;&#25968;&#8221;&#30340;&#26381;&#21153;&#32773;&#25552;&#20379;&#32773;&#65288;&#20197;&#19979;&#29992; Invoker &#20195;&#31216;&#65289;&#25968;&#37327;
        int leastCount = 0; 
        // leastIndexs &#29992;&#20110;&#35760;&#24405;&#20855;&#26377;&#30456;&#21516;&#8220;&#26368;&#23567;&#27963;&#36291;&#25968;&#8221;&#30340; Invoker &#22312; invokers &#21015;&#34920;&#20013;&#30340;&#19979;&#26631;&#20449;&#24687;
        int[] leastIndexs = new int[length];
        int totalWeight = 0;
        // &#31532;&#19968;&#20010;&#26368;&#23567;&#27963;&#36291;&#25968;&#30340; Invoker &#26435;&#37325;&#20540;&#65292;&#29992;&#20110;&#19982;&#20854;&#20182;&#20855;&#26377;&#30456;&#21516;&#26368;&#23567;&#27963;&#36291;&#25968;&#30340; Invoker &#30340;&#26435;&#37325;&#36827;&#34892;&#23545;&#27604;&#65292;
        // &#20197;&#26816;&#27979;&#26159;&#21542;&#8220;&#25152;&#26377;&#20855;&#26377;&#30456;&#21516;&#26368;&#23567;&#27963;&#36291;&#25968;&#30340; Invoker &#30340;&#26435;&#37325;&#8221;&#22343;&#30456;&#31561;
        int firstWeight = 0;
        boolean sameWeight = true;

        // &#36941;&#21382; invokers &#21015;&#34920;
        for (int i = 0; i &lt; length; i++) {
            Invoker&lt;T&gt; invoker = invokers.get(i);
            // &#33719;&#21462; Invoker &#23545;&#24212;&#30340;&#27963;&#36291;&#25968;
            int active = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName()).getActive();
            // &#33719;&#21462;&#26435;&#37325; - &#11088;&#65039;
            int weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);
            // &#21457;&#29616;&#26356;&#23567;&#30340;&#27963;&#36291;&#25968;&#65292;&#37325;&#26032;&#24320;&#22987;
            if (leastActive == -1 || active &lt; leastActive) {
            	// &#20351;&#29992;&#24403;&#21069;&#27963;&#36291;&#25968; active &#26356;&#26032;&#26368;&#23567;&#27963;&#36291;&#25968; leastActive
                leastActive = active;
                // &#26356;&#26032; leastCount &#20026; 1
                leastCount = 1;
                // &#35760;&#24405;&#24403;&#21069;&#19979;&#26631;&#20540;&#21040; leastIndexs &#20013;
                leastIndexs[0] = i;
                totalWeight = weight;
                firstWeight = weight;
                sameWeight = true;

            // &#24403;&#21069; Invoker &#30340;&#27963;&#36291;&#25968; active &#19982;&#26368;&#23567;&#27963;&#36291;&#25968; leastActive &#30456;&#21516; 
            } else if (active == leastActive) {
            	// &#22312; leastIndexs &#20013;&#35760;&#24405;&#19979;&#24403;&#21069; Invoker &#22312; invokers &#38598;&#21512;&#20013;&#30340;&#19979;&#26631;
                leastIndexs[leastCount++] = i;
                // &#32047;&#21152;&#26435;&#37325;
                totalWeight += weight;
                // &#26816;&#27979;&#24403;&#21069; Invoker &#30340;&#26435;&#37325;&#19982; firstWeight &#26159;&#21542;&#30456;&#31561;&#65292;
                // &#19981;&#30456;&#31561;&#21017;&#23558; sameWeight &#32622;&#20026; false
                if (sameWeight &amp;&amp; i &gt; 0
                    &amp;&amp; weight != firstWeight) {
                    sameWeight = false;
                }
            }
        }
        
        // &#24403;&#21482;&#26377;&#19968;&#20010; Invoker &#20855;&#26377;&#26368;&#23567;&#27963;&#36291;&#25968;&#65292;&#27492;&#26102;&#30452;&#25509;&#36820;&#22238;&#35813; Invoker &#21363;&#21487;
        if (leastCount == 1) {
            return invokers.get(leastIndexs[0]);
        }

        // &#26377;&#22810;&#20010; Invoker &#20855;&#26377;&#30456;&#21516;&#30340;&#26368;&#23567;&#27963;&#36291;&#25968;&#65292;&#20294;&#23427;&#20204;&#20043;&#38388;&#30340;&#26435;&#37325;&#19981;&#21516;
        if (!sameWeight &amp;&amp; totalWeight &gt; 0) {
        	// &#38543;&#26426;&#29983;&#25104;&#19968;&#20010; [0, totalWeight) &#20043;&#38388;&#30340;&#25968;&#23383;
            int offsetWeight = random.nextInt(totalWeight);
            // &#24490;&#29615;&#35753;&#38543;&#26426;&#25968;&#20943;&#21435;&#20855;&#26377;&#26368;&#23567;&#27963;&#36291;&#25968;&#30340; Invoker &#30340;&#26435;&#37325;&#20540;&#65292;
            // &#24403; offset &#23567;&#20110;&#31561;&#20110;0&#26102;&#65292;&#36820;&#22238;&#30456;&#24212;&#30340; Invoker
            for (int i = 0; i &lt; leastCount; i++) {
                int leastIndex = leastIndexs[i];
                // &#33719;&#21462;&#26435;&#37325;&#20540;&#65292;&#24182;&#35753;&#38543;&#26426;&#25968;&#20943;&#21435;&#26435;&#37325;&#20540; - &#11088;&#65039;
                offsetWeight -= getWeight(invokers.get(leastIndex), invocation);
                if (offsetWeight &lt;= 0)
                    return invokers.get(leastIndex);
            }
        }
        // &#22914;&#26524;&#26435;&#37325;&#30456;&#21516;&#25110;&#26435;&#37325;&#20026;0&#26102;&#65292;&#38543;&#26426;&#36820;&#22238;&#19968;&#20010; Invoker
        return invokers.get(leastIndexs[random.nextInt(leastCount)]);
    }
}</pre>
 <p class="ne-p" id="u275620a7">
  <br>
 </p>
 <p class="ne-p" id="u50472916">
  <span class="ne-text">
   &#19978;&#38754;&#20195;&#30721;&#30340;&#36923;&#36753;&#27604;&#36739;&#22810;&#65292;&#25105;&#20204;&#22312;&#20195;&#30721;&#20013;&#20889;&#20102;&#22823;&#37327;&#30340;&#27880;&#37322;&#65292;&#26377;&#24110;&#21161;&#22823;&#23478;&#29702;&#35299;&#20195;&#30721;&#36923;&#36753;&#12290;&#19979;&#38754;&#31616;&#21333;&#24635;&#32467;&#19968;&#19979;&#20197;&#19978;&#20195;&#30721;&#25152;&#20570;&#30340;&#20107;&#24773;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ua77c824f">
  <br>
 </p>
 <ol class="ne-ol">
  <li id="u70150463">
   <span class="ne-text">
    &#36941;&#21382; invokers &#21015;&#34920;&#65292;&#23547;&#25214;&#27963;&#36291;&#25968;&#26368;&#23567;&#30340; Invoker
   </span>
  </li>
  <li id="u73824fa8">
   <span class="ne-text">
    &#22914;&#26524;&#26377;&#22810;&#20010; Invoker &#20855;&#26377;&#30456;&#21516;&#30340;&#26368;&#23567;&#27963;&#36291;&#25968;&#65292;&#27492;&#26102;&#35760;&#24405;&#19979;&#36825;&#20123; Invoker &#22312; invokers &#38598;&#21512;&#20013;&#30340;&#19979;&#26631;&#65292;&#24182;&#32047;&#21152;&#23427;&#20204;&#30340;&#26435;&#37325;&#65292;&#27604;&#36739;&#23427;&#20204;&#30340;&#26435;&#37325;&#20540;&#26159;&#21542;&#30456;&#31561;
   </span>
  </li>
 </ol>
 <ol class="ne-ol" start="3">
  <li id="u0f2377ef">
   <span class="ne-text">
    &#22914;&#26524;&#21482;&#26377;&#19968;&#20010; Invoker &#20855;&#26377;&#26368;&#23567;&#30340;&#27963;&#36291;&#25968;&#65292;&#27492;&#26102;&#30452;&#25509;&#36820;&#22238;&#35813; Invoker &#21363;&#21487;
   </span>
  </li>
  <li id="u79f83048">
   <span class="ne-text">
    &#22914;&#26524;&#26377;&#22810;&#20010; Invoker &#20855;&#26377;&#26368;&#23567;&#27963;&#36291;&#25968;&#65292;&#19988;&#23427;&#20204;&#30340;&#26435;&#37325;&#19981;&#30456;&#31561;&#65292;&#27492;&#26102;&#22788;&#29702;&#26041;&#24335;&#21644; RandomLoadBalance &#19968;&#33268;
   </span>
  </li>
 </ol>
 <ol class="ne-ol" start="5">
  <li id="uaffee197">
   <span class="ne-text">
    &#22914;&#26524;&#26377;&#22810;&#20010; Invoker &#20855;&#26377;&#26368;&#23567;&#27963;&#36291;&#25968;&#65292;&#20294;&#23427;&#20204;&#30340;&#26435;&#37325;&#30456;&#31561;&#65292;&#27492;&#26102;&#38543;&#26426;&#36820;&#22238;&#19968;&#20010;&#21363;&#21487;
   </span>
  </li>
 </ol>
 <p class="ne-p" id="u333e2bf3">
  <br>
 </p>
 <p class="ne-p" id="u68926215">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159; LeastActiveLoadBalance &#22823;&#33268;&#30340;&#23454;&#29616;&#36923;&#36753;&#65292;&#22823;&#23478;&#22312;&#38405;&#35835;&#30340;&#28304;&#30721;&#30340;&#36807;&#31243;&#20013;&#35201;&#27880;&#24847;&#21306;&#20998;&#27963;&#36291;&#25968;&#19982;&#26435;&#37325;&#36825;&#20004;&#20010;&#27010;&#24565;&#65292;&#19981;&#35201;&#28151;&#20026;&#19968;&#35848;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ub540a15b">
  <br>
 </p>
 <p class="ne-p" id="u15123131">
  <span class="ne-text">
   &#20197;&#19978;&#20998;&#26512;&#26159;&#22522;&#20110; Dubbo 2.6.4 &#29256;&#26412;&#36827;&#34892;&#30340;&#65292;&#30001;&#20110;&#36817;&#26399; Dubbo 2.6.5 &#21457;&#24067;&#20102;&#65292;&#24182;&#23545; LeastActiveLoadBalance &#36827;&#34892;&#20102;&#19968;&#20123;&#20462;&#25913;&#65292;&#19979;&#38754;&#31616;&#21333;&#26469;&#20171;&#32461;&#19968;&#19979;&#20462;&#25913;&#20869;&#23481;&#12290;&#22238;&#21040;&#19978;&#38754;&#30340;&#28304;&#30721;&#20013;&#65292;&#25105;&#20204;&#22312;&#19978;&#38754;&#30340;&#20195;&#30721;&#20013;&#26631;&#27880;&#20102;&#20004;&#20010;&#40644;&#33394;&#30340;&#20116;&#35282;&#26143;&#11088;&#65039;&#12290;&#20004;&#22788;&#26631;&#35760;&#23545;&#24212;&#30340;&#20195;&#30721;&#20998;&#21035;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="ueacf0f59">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="375f0128">int weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);
offsetWeight -= getWeight(invokers.get(leastIndex), invocation);</pre>
 <p class="ne-p" id="ue262dab8">
  <br>
 </p>
 <p class="ne-p" id="u1aa1661c">
  <span class="ne-text">
   &#38382;&#39064;&#20986;&#22312;&#26381;&#21153;&#39044;&#28909;&#38454;&#27573;&#65292;&#31532;&#19968;&#34892;&#20195;&#30721;&#30452;&#25509;&#20174; url &#20013;&#21462;&#26435;&#37325;&#20540;&#65292;&#26410;&#34987;&#38477;&#26435;&#36807;&#12290;&#31532;&#20108;&#34892;&#20195;&#30721;&#33719;&#21462;&#21040;&#30340;&#26159;&#32463;&#36807;&#38477;&#26435;&#21518;&#30340;&#26435;&#37325;&#12290;&#31532;&#19968;&#34892;&#20195;&#30721;&#33719;&#21462;&#21040;&#30340;&#26435;&#37325;&#20540;&#26368;&#32456;&#20250;&#34987;&#32047;&#21152;&#21040;&#26435;&#37325;&#24635;&#21644; totalWeight &#20013;&#65292;&#36825;&#20010;&#26102;&#20505;&#20250;&#23548;&#33268;&#19968;&#20010;&#38382;&#39064;&#12290;offsetWeight &#26159;&#19968;&#20010;&#22312; [0, totalWeight) &#33539;&#22260;&#20869;&#30340;&#38543;&#26426;&#25968;&#65292;&#32780;&#23427;&#25152;&#20943;&#21435;&#30340;&#26159;&#32463;&#36807;&#38477;&#26435;&#30340;&#26435;&#37325;&#12290;&#24456;&#26377;&#21487;&#33021;&#22312;&#32463;&#36807; leastCount &#27425;&#36816;&#31639;&#21518;&#65292;offsetWeight &#20173;&#28982;&#26159;&#22823;&#20110;0&#30340;&#65292;&#23548;&#33268;&#26080;&#27861;&#36873;&#20013; Invoker&#12290;&#36825;&#20010;&#38382;&#39064;&#23545;&#24212;&#30340; issue &#20026;
  </span>
  <a class="ne-link" data-href="https://github.com/apache/dubbo/issues/904" href="https://github.com/apache/dubbo/issues/904" target="_blank">
   <span class="ne-text">
    #904
   </span>
  </a>
  <span class="ne-text">
   &#65292;&#24182;&#22312; pull request
  </span>
  <a class="ne-link" data-href="https://github.com/apache/dubbo/pull/2172" href="https://github.com/apache/dubbo/pull/2172" target="_blank">
   <span class="ne-text">
    #2172
   </span>
  </a>
  <span class="ne-text">
   &#20013;&#34987;&#20462;&#22797;&#12290;&#20855;&#20307;&#30340;&#20462;&#22797;&#36923;&#36753;&#26159;&#23558;&#26631;&#27880;&#19968;&#22788;&#30340;&#20195;&#30721;&#20462;&#25913;&#20026;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u37ab4b91">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="d76afd98">// afterWarmup &#31561;&#20215;&#20110;&#19978;&#38754;&#30340; weight &#21464;&#37327;&#65292;&#36825;&#26679;&#21629;&#21517;&#26159;&#20026;&#20102;&#24378;&#35843;&#35813;&#21464;&#37327;&#32463;&#36807;&#20102; warmup &#38477;&#26435;&#22788;&#29702;
int afterWarmup = getWeight(invoker, invocation);</pre>
 <p class="ne-p" id="uc976baae">
  <br>
 </p>
 <p class="ne-p" id="u0bdb5ce9">
  <span class="ne-text">
   &#21478;&#22806;&#65292;2.6.4 &#29256;&#26412;&#20013;&#30340; LeastActiveLoadBalance &#36824;&#26377;&#19968;&#20010;&#32570;&#38519;&#65292;&#21363;&#24403;&#19968;&#32452; Invoker &#20855;&#26377;&#30456;&#21516;&#30340;&#26368;&#23567;&#27963;&#36291;&#25968;&#65292;&#19988;&#20854;&#20013;&#19968;&#20010; Invoker &#30340;&#26435;&#37325;&#20540;&#20026;1&#65292;&#27492;&#26102;&#36825;&#20010; Invoker &#26080;&#27861;&#34987;&#36873;&#20013;&#12290;&#32570;&#38519;&#20195;&#30721;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u85a57255">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="90722d54">int offsetWeight = random.nextInt(totalWeight);
for (int i = 0; i &lt; leastCount; i++) {
    int leastIndex = leastIndexs[i];
    offsetWeight -= getWeight(invokers.get(leastIndex), invocation);
    if (offsetWeight &lt;= 0)    // &#10060;
        return invokers.get(leastIndex);
}</pre>
 <p class="ne-p" id="u7b833a08">
  <br>
 </p>
 <p class="ne-p" id="uf18f4ff5">
  <span class="ne-text">
   &#38382;&#39064;&#20986;&#22312;&#20102;
  </span>
  <code class="ne-code">
   <span class="ne-text">
    offsetWeight &lt;= 0
   </span>
  </code>
  <span class="ne-text">
   &#19978;&#65292;&#20030;&#20363;&#35828;&#26126;&#65292;&#20551;&#35774;&#26377;&#19968;&#32452; Invoker &#30340;&#26435;&#37325;&#20026; 5&#12289;2&#12289;1&#65292;offsetWeight &#26368;&#22823;&#20540;&#20026; 7&#12290;&#20551;&#35774; offsetWeight = 7&#65292;&#20320;&#20250;&#21457;&#29616;&#65292;&#24403; for &#24490;&#29615;&#36827;&#34892;&#31532;&#20108;&#27425;&#36941;&#21382;&#21518; offsetWeight = 7 - 5 - 2 = 0&#65292;&#25552;&#21069;&#36820;&#22238;&#20102;&#12290;&#27492;&#26102;&#65292;&#27492;&#26102;&#26435;&#37325;&#20026;1&#30340; Invoker &#23601;&#27809;&#26377;&#26426;&#20250;&#34987;&#36873;&#20013;&#20102;&#12290;&#35813;&#38382;&#39064;&#22312; Dubbo 2.6.5 &#20013;&#34987;&#20462;&#22797;&#20102;&#65292;&#20462;&#25913;&#21518;&#30340;&#20195;&#30721;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u51132940">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="d28ab17f">int offsetWeight = random.nextInt(totalWeight) + 1;</pre>
 <p class="ne-p" id="u0f8bd4bc">
  <br>
 </p>
 <p class="ne-p" id="u9608e6fc">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159; Dubbo 2.6.5 &#23545; LeastActiveLoadBalance &#30340;&#26356;&#26032;&#65292;&#20869;&#23481;&#19981;&#26159;&#24456;&#22810;&#65292;&#20808;&#20998;&#26512;&#21040;&#36825;&#12290;&#25509;&#19979;&#26469;&#20998;&#26512;&#22522;&#20110;&#19968;&#33268;&#24615; hash &#24605;&#24819;&#30340; ConsistentHashLoadBalance&#12290;
  </span>
 </p>
 <p class="ne-p" id="ue969e178">
  <br>
 </p>
 <h3 id="729d69ba">
  <span class="ne-text">
   2.3 ConsistentHashLoadBalance
  </span>
 </h3>
 <p class="ne-p" id="u48df6677">
  <br>
 </p>
 <p class="ne-p" id="u0b0a926c">
  <span class="ne-text">
   &#19968;&#33268;&#24615; hash &#31639;&#27861;&#30001;&#40635;&#30465;&#29702;&#24037;&#23398;&#38498;&#30340; Karger &#21450;&#20854;&#21512;&#20316;&#32773;&#20110;1997&#24180;&#25552;&#20986;&#30340;&#65292;&#31639;&#27861;&#25552;&#20986;&#20043;&#21021;&#26159;&#29992;&#20110;&#22823;&#35268;&#27169;&#32531;&#23384;&#31995;&#32479;&#30340;&#36127;&#36733;&#22343;&#34913;&#12290;&#23427;&#30340;&#24037;&#20316;&#36807;&#31243;&#26159;&#36825;&#26679;&#30340;&#65292;&#39318;&#20808;&#26681;&#25454; ip &#25110;&#32773;&#20854;&#20182;&#30340;&#20449;&#24687;&#20026;&#32531;&#23384;&#33410;&#28857;&#29983;&#25104;&#19968;&#20010; hash&#65292;&#24182;&#23558;&#36825;&#20010; hash &#25237;&#23556;&#21040; [0, 2^32 - 1] &#30340;&#22278;&#29615;&#19978;&#12290;&#24403;&#26377;&#26597;&#35810;&#25110;&#20889;&#20837;&#35831;&#27714;&#26102;&#65292;&#21017;&#20026;&#32531;&#23384;&#39033;&#30340; key &#29983;&#25104;&#19968;&#20010; hash &#20540;&#12290;&#28982;&#21518;&#26597;&#25214;&#31532;&#19968;&#20010;&#22823;&#20110;&#25110;&#31561;&#20110;&#35813; hash &#20540;&#30340;&#32531;&#23384;&#33410;&#28857;&#65292;&#24182;&#21040;&#36825;&#20010;&#33410;&#28857;&#20013;&#26597;&#35810;&#25110;&#20889;&#20837;&#32531;&#23384;&#39033;&#12290;&#22914;&#26524;&#24403;&#21069;&#33410;&#28857;&#25346;&#20102;&#65292;&#21017;&#22312;&#19979;&#19968;&#27425;&#26597;&#35810;&#25110;&#20889;&#20837;&#32531;&#23384;&#26102;&#65292;&#20026;&#32531;&#23384;&#39033;&#26597;&#25214;&#21478;&#19968;&#20010;&#22823;&#20110;&#20854; hash &#20540;&#30340;&#32531;&#23384;&#33410;&#28857;&#21363;&#21487;&#12290;&#22823;&#33268;&#25928;&#26524;&#22914;&#19979;&#22270;&#25152;&#31034;&#65292;&#27599;&#20010;&#32531;&#23384;&#33410;&#28857;&#22312;&#22278;&#29615;&#19978;&#21344;&#25454;&#19968;&#20010;&#20301;&#32622;&#12290;&#22914;&#26524;&#32531;&#23384;&#39033;&#30340; key &#30340; hash &#20540;&#23567;&#20110;&#32531;&#23384;&#33410;&#28857; hash &#20540;&#65292;&#21017;&#21040;&#35813;&#32531;&#23384;&#33410;&#28857;&#20013;&#23384;&#20648;&#25110;&#35835;&#21462;&#32531;&#23384;&#39033;&#12290;&#27604;&#22914;&#19979;&#38754;&#32511;&#33394;&#28857;&#23545;&#24212;&#30340;&#32531;&#23384;&#39033;&#23558;&#20250;&#34987;&#23384;&#20648;&#21040; cache-2 &#33410;&#28857;&#20013;&#12290;&#30001;&#20110; cache-3 &#25346;&#20102;&#65292;&#21407;&#26412;&#24212;&#35813;&#23384;&#21040;&#35813;&#33410;&#28857;&#20013;&#30340;&#32531;&#23384;&#39033;&#26368;&#32456;&#20250;&#23384;&#20648;&#21040; cache-4 &#33410;&#28857;&#20013;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ucf6394dc">
  <br>
 </p>
 <p class="ne-p" id="udd41bf0d">
  <img class="ne-image" id="J857I" src="EPUB/imgJ857I" width="1608">
 </p>
 <p class="ne-p" id="u69a285ee">
  <br>
 </p>
 <p class="ne-p" id="uff16929b">
  <span class="ne-text">
   &#19979;&#38754;&#26469;&#30475;&#30475;&#19968;&#33268;&#24615; hash &#22312; Dubbo &#20013;&#30340;&#24212;&#29992;&#12290;&#25105;&#20204;&#25226;&#19978;&#22270;&#30340;&#32531;&#23384;&#33410;&#28857;&#26367;&#25442;&#25104; Dubbo &#30340;&#26381;&#21153;&#25552;&#20379;&#32773;&#65292;&#20110;&#26159;&#24471;&#21040;&#20102;&#19979;&#22270;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u64505ee4">
  <br>
 </p>
 <p class="ne-p" id="u92d35264">
  <img class="ne-image" id="nfeC6" src="EPUB/imgnfeC6" width="1622">
 </p>
 <p class="ne-p" id="u987da782">
  <br>
 </p>
 <p class="ne-p" id="u55cbd143">
  <span class="ne-text">
   &#36825;&#37324;&#30456;&#21516;&#39068;&#33394;&#30340;&#33410;&#28857;&#22343;&#23646;&#20110;&#21516;&#19968;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#65292;&#27604;&#22914; Invoker1-1&#65292;Invoker1-2&#65292;&#8230;&#8230;, Invoker1-160&#12290;&#36825;&#26679;&#20570;&#30340;&#30446;&#30340;&#26159;&#36890;&#36807;&#24341;&#20837;&#34394;&#25311;&#33410;&#28857;&#65292;&#35753; Invoker &#22312;&#22278;&#29615;&#19978;&#20998;&#25955;&#24320;&#26469;&#65292;&#36991;&#20813;&#25968;&#25454;&#20542;&#26012;&#38382;&#39064;&#12290;&#25152;&#35859;&#25968;&#25454;&#20542;&#26012;&#26159;&#25351;&#65292;&#30001;&#20110;&#33410;&#28857;&#19981;&#22815;&#20998;&#25955;&#65292;&#23548;&#33268;&#22823;&#37327;&#35831;&#27714;&#33853;&#21040;&#20102;&#21516;&#19968;&#20010;&#33410;&#28857;&#19978;&#65292;&#32780;&#20854;&#20182;&#33410;&#28857;&#21482;&#20250;&#25509;&#25910;&#21040;&#20102;&#23569;&#37327;&#35831;&#27714;&#30340;&#24773;&#20917;&#12290;&#27604;&#22914;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u403ddb9b">
  <br>
 </p>
 <p class="ne-p" id="ua64c41c4">
  <img class="ne-image" id="SVP0I" src="EPUB/imgSVP0I" width="1594">
 </p>
 <p class="ne-p" id="ub4943c63">
  <br>
 </p>
 <p class="ne-p" id="u406f3236">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#30001;&#20110; Invoker-1 &#21644; Invoker-2 &#22312;&#22278;&#29615;&#19978;&#20998;&#24067;&#19981;&#22343;&#65292;&#23548;&#33268;&#31995;&#32479;&#20013;75%&#30340;&#35831;&#27714;&#37117;&#20250;&#33853;&#21040; Invoker-1 &#19978;&#65292;&#21482;&#26377; 25% &#30340;&#35831;&#27714;&#20250;&#33853;&#21040; Invoker-2 &#19978;&#12290;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;&#21150;&#27861;&#26159;&#24341;&#20837;&#34394;&#25311;&#33410;&#28857;&#65292;&#36890;&#36807;&#34394;&#25311;&#33410;&#28857;&#22343;&#34913;&#21508;&#20010;&#33410;&#28857;&#30340;&#35831;&#27714;&#37327;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ud19878e2">
  <br>
 </p>
 <p class="ne-p" id="u398c7da9">
  <span class="ne-text">
   &#21040;&#36825;&#37324;&#32972;&#26223;&#30693;&#35782;&#23601;&#26222;&#21450;&#23436;&#20102;&#65292;&#25509;&#19979;&#26469;&#24320;&#22987;&#20998;&#26512;&#28304;&#30721;&#12290;&#25105;&#20204;&#20808;&#20174; ConsistentHashLoadBalance &#30340; doSelect &#26041;&#27861;&#24320;&#22987;&#30475;&#36215;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u096a5362">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="0720866c">public class ConsistentHashLoadBalance extends AbstractLoadBalance {

    private final ConcurrentMap&lt;String, ConsistentHashSelector&lt;?&gt;&gt; selectors = 
        new ConcurrentHashMap&lt;String, ConsistentHashSelector&lt;?&gt;&gt;();

    @Override
    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
        String methodName = RpcUtils.getMethodName(invocation);
        String key = invokers.get(0).getUrl().getServiceKey() + "." + methodName;

        // &#33719;&#21462; invokers &#21407;&#22987;&#30340; hashcode
        int identityHashCode = System.identityHashCode(invokers);
        ConsistentHashSelector&lt;T&gt; selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);
        // &#22914;&#26524; invokers &#26159;&#19968;&#20010;&#26032;&#30340; List &#23545;&#35937;&#65292;&#24847;&#21619;&#30528;&#26381;&#21153;&#25552;&#20379;&#32773;&#25968;&#37327;&#21457;&#29983;&#20102;&#21464;&#21270;&#65292;&#21487;&#33021;&#26032;&#22686;&#20063;&#21487;&#33021;&#20943;&#23569;&#20102;&#12290;
        // &#27492;&#26102; selector.identityHashCode != identityHashCode &#26465;&#20214;&#25104;&#31435;
        if (selector == null || selector.identityHashCode != identityHashCode) {
            // &#21019;&#24314;&#26032;&#30340; ConsistentHashSelector
            selectors.put(key, new ConsistentHashSelector&lt;T&gt;(invokers, methodName, identityHashCode));
            selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);
        }

        // &#35843;&#29992; ConsistentHashSelector &#30340; select &#26041;&#27861;&#36873;&#25321; Invoker
        return selector.select(invocation);
    }
    
    private static final class ConsistentHashSelector&lt;T&gt; {...}
}</pre>
 <p class="ne-p" id="u4c5d8f57">
  <br>
 </p>
 <p class="ne-p" id="u1e78e332">
  <span class="ne-text">
   &#22914;&#19978;&#65292;doSelect &#26041;&#27861;&#20027;&#35201;&#20570;&#20102;&#19968;&#20123;&#21069;&#32622;&#24037;&#20316;&#65292;&#27604;&#22914;&#26816;&#27979; invokers &#21015;&#34920;&#26159;&#19981;&#26159;&#21464;&#21160;&#36807;&#65292;&#20197;&#21450;&#21019;&#24314; ConsistentHashSelector&#12290;&#36825;&#20123;&#24037;&#20316;&#20570;&#23436;&#21518;&#65292;&#25509;&#19979;&#26469;&#24320;&#22987;&#35843;&#29992; ConsistentHashSelector &#30340; select &#26041;&#27861;&#25191;&#34892;&#36127;&#36733;&#22343;&#34913;&#36923;&#36753;&#12290;&#22312;&#20998;&#26512; select &#26041;&#27861;&#20043;&#21069;&#65292;&#25105;&#20204;&#20808;&#26469;&#30475;&#19968;&#19979;&#19968;&#33268;&#24615; hash &#36873;&#25321;&#22120; ConsistentHashSelector &#30340;&#21021;&#22987;&#21270;&#36807;&#31243;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u71ef4ea3">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="edb65dad">private static final class ConsistentHashSelector&lt;T&gt; {

    // &#20351;&#29992; TreeMap &#23384;&#20648; Invoker &#34394;&#25311;&#33410;&#28857;
    private final TreeMap&lt;Long, Invoker&lt;T&gt;&gt; virtualInvokers;

    private final int replicaNumber;

    private final int identityHashCode;

    private final int[] argumentIndex;

    ConsistentHashSelector(List&lt;Invoker&lt;T&gt;&gt; invokers, String methodName, int identityHashCode) {
        this.virtualInvokers = new TreeMap&lt;Long, Invoker&lt;T&gt;&gt;();
        this.identityHashCode = identityHashCode;
        URL url = invokers.get(0).getUrl();
        // &#33719;&#21462;&#34394;&#25311;&#33410;&#28857;&#25968;&#65292;&#40664;&#35748;&#20026;160
        this.replicaNumber = url.getMethodParameter(methodName, "hash.nodes", 160);
        // &#33719;&#21462;&#21442;&#19982; hash &#35745;&#31639;&#30340;&#21442;&#25968;&#19979;&#26631;&#20540;&#65292;&#40664;&#35748;&#23545;&#31532;&#19968;&#20010;&#21442;&#25968;&#36827;&#34892; hash &#36816;&#31639;
        String[] index = Constants.COMMA_SPLIT_PATTERN.split(url.getMethodParameter(methodName, "hash.arguments", "0"));
        argumentIndex = new int[index.length];
        for (int i = 0; i &lt; index.length; i++) {
            argumentIndex[i] = Integer.parseInt(index[i]);
        }
        for (Invoker&lt;T&gt; invoker : invokers) {
            String address = invoker.getUrl().getAddress();
            for (int i = 0; i &lt; replicaNumber / 4; i++) {
                // &#23545; address + i &#36827;&#34892; md5 &#36816;&#31639;&#65292;&#24471;&#21040;&#19968;&#20010;&#38271;&#24230;&#20026;16&#30340;&#23383;&#33410;&#25968;&#32452;
                byte[] digest = md5(address + i);
                // &#23545; digest &#37096;&#20998;&#23383;&#33410;&#36827;&#34892;4&#27425; hash &#36816;&#31639;&#65292;&#24471;&#21040;&#22235;&#20010;&#19981;&#21516;&#30340; long &#22411;&#27491;&#25972;&#25968;
                for (int h = 0; h &lt; 4; h++) {
                    // h = 0 &#26102;&#65292;&#21462; digest &#20013;&#19979;&#26631;&#20026; 0 ~ 3 &#30340;4&#20010;&#23383;&#33410;&#36827;&#34892;&#20301;&#36816;&#31639;
                    // h = 1 &#26102;&#65292;&#21462; digest &#20013;&#19979;&#26631;&#20026; 4 ~ 7 &#30340;4&#20010;&#23383;&#33410;&#36827;&#34892;&#20301;&#36816;&#31639;
                    // h = 2, h = 3 &#26102;&#36807;&#31243;&#21516;&#19978;
                    long m = hash(digest, h);
                    // &#23558; hash &#21040; invoker &#30340;&#26144;&#23556;&#20851;&#31995;&#23384;&#20648;&#21040; virtualInvokers &#20013;&#65292;
                    // virtualInvokers &#38656;&#35201;&#25552;&#20379;&#39640;&#25928;&#30340;&#26597;&#35810;&#25805;&#20316;&#65292;&#22240;&#27492;&#36873;&#29992; TreeMap &#20316;&#20026;&#23384;&#20648;&#32467;&#26500;
                    virtualInvokers.put(m, invoker);
                }
            }
        }
    }
}</pre>
 <p class="ne-p" id="u01188c1a">
  <br>
 </p>
 <p class="ne-p" id="ub4c0b0f8">
  <span class="ne-text">
   ConsistentHashSelector &#30340;&#26500;&#36896;&#26041;&#27861;&#25191;&#34892;&#20102;&#19968;&#31995;&#21015;&#30340;&#21021;&#22987;&#21270;&#36923;&#36753;&#65292;&#27604;&#22914;&#20174;&#37197;&#32622;&#20013;&#33719;&#21462;&#34394;&#25311;&#33410;&#28857;&#25968;&#20197;&#21450;&#21442;&#19982; hash &#35745;&#31639;&#30340;&#21442;&#25968;&#19979;&#26631;&#65292;&#40664;&#35748;&#24773;&#20917;&#19979;&#21482;&#20351;&#29992;&#31532;&#19968;&#20010;&#21442;&#25968;&#36827;&#34892; hash&#12290;&#38656;&#35201;&#29305;&#21035;&#35828;&#26126;&#30340;&#26159;&#65292;ConsistentHashLoadBalance &#30340;&#36127;&#36733;&#22343;&#34913;&#36923;&#36753;&#21482;&#21463;&#21442;&#25968;&#20540;&#24433;&#21709;&#65292;&#20855;&#26377;&#30456;&#21516;&#21442;&#25968;&#20540;&#30340;&#35831;&#27714;&#23558;&#20250;&#34987;&#20998;&#37197;&#32473;&#21516;&#19968;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#12290;ConsistentHashLoadBalance &#19981; &#20851;&#31995;&#26435;&#37325;&#65292;&#22240;&#27492;&#20351;&#29992;&#26102;&#38656;&#35201;&#27880;&#24847;&#19968;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="uf840c26d">
  <br>
 </p>
 <p class="ne-p" id="u1447eb30">
  <span class="ne-text">
   &#22312;&#33719;&#21462;&#34394;&#25311;&#33410;&#28857;&#25968;&#21644;&#21442;&#25968;&#19979;&#26631;&#37197;&#32622;&#21518;&#65292;&#25509;&#19979;&#26469;&#35201;&#20570;&#30340;&#20107;&#24773;&#26159;&#35745;&#31639;&#34394;&#25311;&#33410;&#28857; hash &#20540;&#65292;&#24182;&#23558;&#34394;&#25311;&#33410;&#28857;&#23384;&#20648;&#21040; TreeMap &#20013;&#12290;&#21040;&#27492;&#65292;ConsistentHashSelector &#21021;&#22987;&#21270;&#24037;&#20316;&#23601;&#23436;&#25104;&#20102;&#12290;&#25509;&#19979;&#26469;&#65292;&#25105;&#20204;&#26469;&#30475;&#30475; select &#26041;&#27861;&#30340;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u1dd27925">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="37f78da4">public Invoker&lt;T&gt; select(Invocation invocation) {
    // &#23558;&#21442;&#25968;&#36716;&#20026; key
    String key = toKey(invocation.getArguments());
    // &#23545;&#21442;&#25968; key &#36827;&#34892; md5 &#36816;&#31639;
    byte[] digest = md5(key);
    // &#21462; digest &#25968;&#32452;&#30340;&#21069;&#22235;&#20010;&#23383;&#33410;&#36827;&#34892; hash &#36816;&#31639;&#65292;&#20877;&#23558; hash &#20540;&#20256;&#32473; selectForKey &#26041;&#27861;&#65292;
    // &#23547;&#25214;&#21512;&#36866;&#30340; Invoker
    return selectForKey(hash(digest, 0));
}

private Invoker&lt;T&gt; selectForKey(long hash) {
    // &#21040; TreeMap &#20013;&#26597;&#25214;&#31532;&#19968;&#20010;&#33410;&#28857;&#20540;&#22823;&#20110;&#25110;&#31561;&#20110;&#24403;&#21069; hash &#30340; Invoker
    Map.Entry&lt;Long, Invoker&lt;T&gt;&gt; entry = virtualInvokers.tailMap(hash, true).firstEntry();
    // &#22914;&#26524; hash &#22823;&#20110; Invoker &#22312;&#22278;&#29615;&#19978;&#26368;&#22823;&#30340;&#20301;&#32622;&#65292;&#27492;&#26102; entry = null&#65292;
    // &#38656;&#35201;&#23558; TreeMap &#30340;&#22836;&#33410;&#28857;&#36171;&#20540;&#32473; entry
    if (entry == null) {
        entry = virtualInvokers.firstEntry();
    }

    // &#36820;&#22238; Invoker
    return entry.getValue();
}</pre>
 <p class="ne-p" id="uf308423c">
  <br>
 </p>
 <p class="ne-p" id="u33d911d5">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#36873;&#25321;&#30340;&#36807;&#31243;&#30456;&#23545;&#27604;&#36739;&#31616;&#21333;&#20102;&#12290;&#39318;&#20808;&#26159;&#23545;&#21442;&#25968;&#36827;&#34892; md5 &#20197;&#21450; hash &#36816;&#31639;&#65292;&#24471;&#21040;&#19968;&#20010; hash &#20540;&#12290;&#28982;&#21518;&#20877;&#25343;&#36825;&#20010;&#20540;&#21040; TreeMap &#20013;&#26597;&#25214;&#30446;&#26631; Invoker &#21363;&#21487;&#12290;
  </span>
 </p>
 <p class="ne-p" id="udd134aa5">
  <br>
 </p>
 <p class="ne-p" id="u87e2d33d">
  <span class="ne-text">
   &#21040;&#27492;&#20851;&#20110; ConsistentHashLoadBalance &#23601;&#20998;&#26512;&#23436;&#20102;&#12290;&#22312;&#38405;&#35835; ConsistentHashLoadBalance &#28304;&#30721;&#20043;&#21069;&#65292;&#22823;&#23478;&#19968;&#23450;&#35201;&#20808;&#34917;&#20805;&#32972;&#26223;&#30693;&#35782;&#65292;&#19981;&#28982;&#24456;&#38590;&#30475;&#25026;&#20195;&#30721;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u98a1ff1f">
  <br>
 </p>
 <h3 id="d234e10f">
  <span class="ne-text">
   2.4 RoundRobinLoadBalance
  </span>
 </h3>
 <p class="ne-p" id="uec3013c2">
  <br>
 </p>
 <p class="ne-p" id="u5583c5ee">
  <span class="ne-text">
   &#26412;&#33410;&#65292;&#25105;&#20204;&#26469;&#30475;&#19968;&#19979; Dubbo &#20013;&#21152;&#26435;&#36718;&#35810;&#36127;&#36733;&#22343;&#34913;&#30340;&#23454;&#29616; RoundRobinLoadBalance&#12290;&#22312;&#35814;&#32454;&#20998;&#26512;&#28304;&#30721;&#21069;&#65292;&#25105;&#20204;&#20808;&#26469;&#20102;&#35299;&#19968;&#19979;&#20160;&#20040;&#26159;&#21152;&#26435;&#36718;&#35810;&#12290;&#36825;&#37324;&#20174;&#26368;&#31616;&#21333;&#30340;&#36718;&#35810;&#24320;&#22987;&#35762;&#36215;&#65292;&#25152;&#35859;&#36718;&#35810;&#26159;&#25351;&#23558;&#35831;&#27714;&#36718;&#27969;&#20998;&#37197;&#32473;&#27599;&#21488;&#26381;&#21153;&#22120;&#12290;&#20030;&#20010;&#20363;&#23376;&#65292;&#25105;&#20204;&#26377;&#19977;&#21488;&#26381;&#21153;&#22120; A&#12289;B&#12289;C&#12290;&#25105;&#20204;&#23558;&#31532;&#19968;&#20010;&#35831;&#27714;&#20998;&#37197;&#32473;&#26381;&#21153;&#22120; A&#65292;&#31532;&#20108;&#20010;&#35831;&#27714;&#20998;&#37197;&#32473;&#26381;&#21153;&#22120; B&#65292;&#31532;&#19977;&#20010;&#35831;&#27714;&#20998;&#37197;&#32473;&#26381;&#21153;&#22120; C&#65292;&#31532;&#22235;&#20010;&#35831;&#27714;&#20877;&#27425;&#20998;&#37197;&#32473;&#26381;&#21153;&#22120; A&#12290;&#36825;&#20010;&#36807;&#31243;&#23601;&#21483;&#20570;&#36718;&#35810;&#12290;&#36718;&#35810;&#26159;&#19968;&#31181;&#26080;&#29366;&#24577;&#36127;&#36733;&#22343;&#34913;&#31639;&#27861;&#65292;&#23454;&#29616;&#31616;&#21333;&#65292;&#36866;&#29992;&#20110;&#27599;&#21488;&#26381;&#21153;&#22120;&#24615;&#33021;&#30456;&#36817;&#30340;&#22330;&#26223;&#19979;&#12290;&#20294;&#29616;&#23454;&#24773;&#20917;&#19979;&#65292;&#25105;&#20204;&#24182;&#19981;&#33021;&#20445;&#35777;&#27599;&#21488;&#26381;&#21153;&#22120;&#24615;&#33021;&#22343;&#30456;&#36817;&#12290;&#22914;&#26524;&#25105;&#20204;&#23558;&#31561;&#37327;&#30340;&#35831;&#27714;&#20998;&#37197;&#32473;&#24615;&#33021;&#36739;&#24046;&#30340;&#26381;&#21153;&#22120;&#65292;&#36825;&#26174;&#28982;&#26159;&#19981;&#21512;&#29702;&#30340;&#12290;&#22240;&#27492;&#65292;&#36825;&#20010;&#26102;&#20505;&#25105;&#20204;&#38656;&#35201;&#23545;&#36718;&#35810;&#36807;&#31243;&#36827;&#34892;&#21152;&#26435;&#65292;&#20197;&#35843;&#25511;&#27599;&#21488;&#26381;&#21153;&#22120;&#30340;&#36127;&#36733;&#12290;&#32463;&#36807;&#21152;&#26435;&#21518;&#65292;&#27599;&#21488;&#26381;&#21153;&#22120;&#33021;&#22815;&#24471;&#21040;&#30340;&#35831;&#27714;&#25968;&#27604;&#20363;&#65292;&#25509;&#36817;&#25110;&#31561;&#20110;&#20182;&#20204;&#30340;&#26435;&#37325;&#27604;&#12290;&#27604;&#22914;&#26381;&#21153;&#22120; A&#12289;B&#12289;C &#26435;&#37325;&#27604;&#20026; 5:2:1&#12290;&#37027;&#20040;&#22312;8&#27425;&#35831;&#27714;&#20013;&#65292;&#26381;&#21153;&#22120; A &#23558;&#25910;&#21040;&#20854;&#20013;&#30340;5&#27425;&#35831;&#27714;&#65292;&#26381;&#21153;&#22120; B &#20250;&#25910;&#21040;&#20854;&#20013;&#30340;2&#27425;&#35831;&#27714;&#65292;&#26381;&#21153;&#22120; C &#21017;&#25910;&#21040;&#20854;&#20013;&#30340;1&#27425;&#35831;&#27714;&#12290;
  </span>
 </p>
 <p class="ne-p" id="uc9211410">
  <br>
 </p>
 <p class="ne-p" id="u008742e1">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159;&#21152;&#26435;&#36718;&#35810;&#30340;&#31639;&#27861;&#24605;&#24819;&#65292;&#25630;&#25026;&#20102;&#36825;&#20010;&#24605;&#24819;&#65292;&#25509;&#19979;&#26469;&#25105;&#20204;&#23601;&#21487;&#20197;&#20998;&#26512;&#28304;&#30721;&#20102;&#12290;&#25105;&#20204;&#20808;&#26469;&#30475;&#19968;&#19979; 2.6.4 &#29256;&#26412;&#30340; RoundRobinLoadBalance&#12290;
  </span>
 </p>
 <p class="ne-p" id="u7a98be63">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="bbd935ff">public class RoundRobinLoadBalance extends AbstractLoadBalance {

    public static final String NAME = "roundrobin";

    private final ConcurrentMap&lt;String, AtomicPositiveInteger&gt; sequences = 
        new ConcurrentHashMap&lt;String, AtomicPositiveInteger&gt;();

    @Override
    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
        // key = &#20840;&#38480;&#23450;&#31867;&#21517; + "." + &#26041;&#27861;&#21517;&#65292;&#27604;&#22914; com.xxx.DemoService.sayHello
        String key = invokers.get(0).getUrl().getServiceKey() + "." + invocation.getMethodName();
        int length = invokers.size();
        // &#26368;&#22823;&#26435;&#37325;
        int maxWeight = 0;
        // &#26368;&#23567;&#26435;&#37325;
        int minWeight = Integer.MAX_VALUE;
        final LinkedHashMap&lt;Invoker&lt;T&gt;, IntegerWrapper&gt; invokerToWeightMap = new LinkedHashMap&lt;Invoker&lt;T&gt;, IntegerWrapper&gt;();
        // &#26435;&#37325;&#24635;&#21644;
        int weightSum = 0;

        // &#19979;&#38754;&#36825;&#20010;&#24490;&#29615;&#20027;&#35201;&#29992;&#20110;&#26597;&#25214;&#26368;&#22823;&#21644;&#26368;&#23567;&#26435;&#37325;&#65292;&#35745;&#31639;&#26435;&#37325;&#24635;&#21644;&#31561;
        for (int i = 0; i &lt; length; i++) {
            int weight = getWeight(invokers.get(i), invocation);
            // &#33719;&#21462;&#26368;&#22823;&#21644;&#26368;&#23567;&#26435;&#37325;
            maxWeight = Math.max(maxWeight, weight);
            minWeight = Math.min(minWeight, weight);
            if (weight &gt; 0) {
                // &#23558; weight &#23553;&#35013;&#21040; IntegerWrapper &#20013;
                invokerToWeightMap.put(invokers.get(i), new IntegerWrapper(weight));
                // &#32047;&#21152;&#26435;&#37325;
                weightSum += weight;
            }
        }

        // &#26597;&#25214; key &#23545;&#24212;&#30340;&#23545;&#24212; AtomicPositiveInteger &#23454;&#20363;&#65292;&#20026;&#31354;&#21017;&#21019;&#24314;&#12290;
        // &#36825;&#37324;&#21487;&#20197;&#25226; AtomicPositiveInteger &#30475;&#25104;&#19968;&#20010;&#40657;&#30418;&#65292;&#22823;&#23478;&#21482;&#35201;&#30693;&#36947;
        // AtomicPositiveInteger &#29992;&#20110;&#35760;&#24405;&#26381;&#21153;&#30340;&#35843;&#29992;&#32534;&#21495;&#21363;&#21487;&#12290;&#33267;&#20110;&#32454;&#33410;&#65292;
        // &#22823;&#23478;&#22914;&#26524;&#24863;&#20852;&#36259;&#65292;&#21487;&#20197;&#33258;&#34892;&#20998;&#26512;
        AtomicPositiveInteger sequence = sequences.get(key);
        if (sequence == null) {
            sequences.putIfAbsent(key, new AtomicPositiveInteger());
            sequence = sequences.get(key);
        }

        // &#33719;&#21462;&#24403;&#21069;&#30340;&#35843;&#29992;&#32534;&#21495;
        int currentSequence = sequence.getAndIncrement();
        // &#22914;&#26524;&#26368;&#23567;&#26435;&#37325;&#23567;&#20110;&#26368;&#22823;&#26435;&#37325;&#65292;&#34920;&#26126;&#26381;&#21153;&#25552;&#20379;&#32773;&#20043;&#38388;&#30340;&#26435;&#37325;&#26159;&#19981;&#30456;&#31561;&#30340;
        if (maxWeight &gt; 0 &amp;&amp; minWeight &lt; maxWeight) {
            // &#20351;&#29992;&#35843;&#29992;&#32534;&#21495;&#23545;&#26435;&#37325;&#24635;&#21644;&#36827;&#34892;&#21462;&#20313;&#25805;&#20316;
            int mod = currentSequence % weightSum;
            // &#36827;&#34892; maxWeight &#27425;&#36941;&#21382;
            for (int i = 0; i &lt; maxWeight; i++) {
                // &#36941;&#21382; invokerToWeightMap
                for (Map.Entry&lt;Invoker&lt;T&gt;, IntegerWrapper&gt; each : invokerToWeightMap.entrySet()) {
					// &#33719;&#21462; Invoker
                    final Invoker&lt;T&gt; k = each.getKey();
                    // &#33719;&#21462;&#26435;&#37325;&#21253;&#35013;&#31867; IntegerWrapper
                    final IntegerWrapper v = each.getValue();
                    
                    // &#22914;&#26524; mod = 0&#65292;&#19988;&#26435;&#37325;&#22823;&#20110;0&#65292;&#27492;&#26102;&#36820;&#22238;&#30456;&#24212;&#30340; Invoker
                    if (mod == 0 &amp;&amp; v.getValue() &gt; 0) {
                        return k;
                    }
                    
                    // mod != 0&#65292;&#19988;&#26435;&#37325;&#22823;&#20110;0&#65292;&#27492;&#26102;&#23545;&#26435;&#37325;&#21644; mod &#20998;&#21035;&#36827;&#34892;&#33258;&#20943;&#25805;&#20316;
                    if (v.getValue() &gt; 0) {
                        v.decrement();
                        mod--;
                    }
                }
            }
        }
        
        // &#26381;&#21153;&#25552;&#20379;&#32773;&#20043;&#38388;&#30340;&#26435;&#37325;&#30456;&#31561;&#65292;&#27492;&#26102;&#36890;&#36807;&#36718;&#35810;&#36873;&#25321; Invoker
        return invokers.get(currentSequence % length);
    }

    // IntegerWrapper &#26159;&#19968;&#20010; int &#21253;&#35013;&#31867;&#65292;&#20027;&#35201;&#21253;&#21547;&#20102;&#19968;&#20010;&#33258;&#20943;&#26041;&#27861;&#12290;
    private static final class IntegerWrapper {
        private int value;

        public void decrement() {
            this.value--;
        }
        
        // &#30465;&#30053;&#37096;&#20998;&#20195;&#30721;
    }
}</pre>
 <p class="ne-p" id="u799b8348">
  <br>
 </p>
 <p class="ne-p" id="uab405b7e">
  <span class="ne-text">
   &#22914;&#19978;&#65292;RoundRobinLoadBalance &#30340;&#27599;&#34892;&#20195;&#30721;&#37117;&#19981;&#26159;&#24456;&#38590;&#29702;&#35299;&#65292;&#20294;&#26159;&#23558;&#23427;&#20204;&#32452;&#21512;&#22312;&#19968;&#36215;&#20043;&#21518;&#65292;&#23601;&#19981;&#26159;&#24456;&#22909;&#29702;&#35299;&#20102;&#12290;&#25152;&#20197;&#19979;&#38754;&#25105;&#20204;&#20030;&#20363;&#36827;&#34892;&#35828;&#26126;&#65292;&#20551;&#35774;&#25105;&#20204;&#26377;&#19977;&#21488;&#26381;&#21153;&#22120; servers = [A, B, C]&#65292;&#23545;&#24212;&#30340;&#26435;&#37325;&#20026; weights = [2, 5, 1]&#12290;&#25509;&#19979;&#26469;&#23545;&#19978;&#38754;&#30340;&#36923;&#36753;&#36827;&#34892;&#31616;&#21333;&#30340;&#27169;&#25311;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u570b6346">
  <br>
 </p>
 <p class="ne-p" id="u6badc68d">
  <span class="ne-text">
   mod = 0&#65306;&#28385;&#36275;&#26465;&#20214;&#65292;&#27492;&#26102;&#30452;&#25509;&#36820;&#22238;&#26381;&#21153;&#22120; A
  </span>
 </p>
 <p class="ne-p" id="ucdffb998">
  <br>
 </p>
 <p class="ne-p" id="u49a21ec5">
  <span class="ne-text">
   mod = 1&#65306;&#38656;&#35201;&#36827;&#34892;&#19968;&#27425;&#36882;&#20943;&#25805;&#20316;&#25165;&#33021;&#28385;&#36275;&#26465;&#20214;&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; B
  </span>
 </p>
 <p class="ne-p" id="u252c0368">
  <br>
 </p>
 <p class="ne-p" id="u970b1e4d">
  <span class="ne-text">
   mod = 2&#65306;&#38656;&#35201;&#36827;&#34892;&#20004;&#27425;&#36882;&#20943;&#25805;&#20316;&#25165;&#33021;&#28385;&#36275;&#26465;&#20214;&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; C
  </span>
 </p>
 <p class="ne-p" id="u9a1116cf">
  <br>
 </p>
 <p class="ne-p" id="u7b45b4fe">
  <span class="ne-text">
   mod = 3&#65306;&#38656;&#35201;&#36827;&#34892;&#19977;&#27425;&#36882;&#20943;&#25805;&#20316;&#25165;&#33021;&#28385;&#36275;&#26465;&#20214;&#65292;&#32463;&#36807;&#36882;&#20943;&#21518;&#65292;&#26381;&#21153;&#22120;&#26435;&#37325;&#20026; [1, 4, 0]&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; A
  </span>
 </p>
 <p class="ne-p" id="u1f76ed29">
  <br>
 </p>
 <p class="ne-p" id="u1e449ac1">
  <span class="ne-text">
   mod = 4&#65306;&#38656;&#35201;&#36827;&#34892;&#22235;&#27425;&#36882;&#20943;&#25805;&#20316;&#25165;&#33021;&#28385;&#36275;&#26465;&#20214;&#65292;&#32463;&#36807;&#36882;&#20943;&#21518;&#65292;&#26381;&#21153;&#22120;&#26435;&#37325;&#20026; [0, 4, 0]&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; B
  </span>
 </p>
 <p class="ne-p" id="ube9b39c8">
  <br>
 </p>
 <p class="ne-p" id="u9e613de4">
  <span class="ne-text">
   mod = 5&#65306;&#38656;&#35201;&#36827;&#34892;&#20116;&#27425;&#36882;&#20943;&#25805;&#20316;&#25165;&#33021;&#28385;&#36275;&#26465;&#20214;&#65292;&#32463;&#36807;&#36882;&#20943;&#21518;&#65292;&#26381;&#21153;&#22120;&#26435;&#37325;&#20026; [0, 3, 0]&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; B
  </span>
 </p>
 <p class="ne-p" id="u347f6199">
  <br>
 </p>
 <p class="ne-p" id="u672b9537">
  <span class="ne-text">
   mod = 6&#65306;&#38656;&#35201;&#36827;&#34892;&#20845;&#27425;&#36882;&#20943;&#25805;&#20316;&#25165;&#33021;&#28385;&#36275;&#26465;&#20214;&#65292;&#32463;&#36807;&#36882;&#20943;&#21518;&#65292;&#26381;&#21153;&#22120;&#26435;&#37325;&#20026; [0, 2, 0]&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; B
  </span>
 </p>
 <p class="ne-p" id="u2337825b">
  <br>
 </p>
 <p class="ne-p" id="uf56afb70">
  <span class="ne-text">
   mod = 7&#65306;&#38656;&#35201;&#36827;&#34892;&#19971;&#27425;&#36882;&#20943;&#25805;&#20316;&#25165;&#33021;&#28385;&#36275;&#26465;&#20214;&#65292;&#32463;&#36807;&#36882;&#20943;&#21518;&#65292;&#26381;&#21153;&#22120;&#26435;&#37325;&#20026; [0, 1, 0]&#65292;&#27492;&#26102;&#36820;&#22238;&#26381;&#21153;&#22120; B
  </span>
 </p>
 <p class="ne-p" id="uda487ae2">
  <br>
 </p>
 <p class="ne-p" id="u51f203bb">
  <span class="ne-text">
   &#32463;&#36807;8&#27425;&#35843;&#29992;&#21518;&#65292;&#25105;&#20204;&#24471;&#21040;&#30340;&#36127;&#36733;&#22343;&#34913;&#32467;&#26524;&#20026; [A, B, C, A, B, B, B, B]&#65292;&#27425;&#25968;&#27604; A:B:C = 2:5:1&#65292;&#31561;&#20110;&#26435;&#37325;&#27604;&#12290;&#24403; sequence = 8 &#26102;&#65292;mod = 0&#65292;&#27492;&#26102;&#37325;&#22836;&#20877;&#26469;&#12290;&#20174;&#19978;&#38754;&#30340;&#27169;&#25311;&#36807;&#31243;&#21487;&#20197;&#30475;&#20986;&#65292;&#24403; mod &gt;= 3 &#21518;&#65292;&#26381;&#21153;&#22120; C &#23601;&#19981;&#20250;&#34987;&#36873;&#20013;&#20102;&#65292;&#22240;&#20026;&#23427;&#30340;&#26435;&#37325;&#34987;&#20943;&#20026;0&#20102;&#12290;&#24403; mod &gt;= 4 &#21518;&#65292;&#26381;&#21153;&#22120; A &#30340;&#26435;&#37325;&#34987;&#20943;&#20026;0&#65292;&#27492;&#21518; A &#23601;&#19981;&#20250;&#20877;&#34987;&#36873;&#20013;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ud9206f53">
  <br>
 </p>
 <p class="ne-p" id="ucfca5df1">
  <span class="ne-text">
   &#20197;&#19978;&#26159; 2.6.4 &#29256;&#26412;&#30340; RoundRobinLoadBalance &#20998;&#26512;&#36807;&#31243;&#65292;2.6.4 &#29256;&#26412;&#30340; RoundRobinLoadBalance &#22312;&#26576;&#20123;&#24773;&#20917;&#19979;&#23384;&#22312;&#30528;&#27604;&#36739;&#20005;&#37325;&#30340;&#24615;&#33021;&#38382;&#39064;&#65292;&#35813;&#38382;&#39064;&#26368;&#21021;&#26159;&#22312;
  </span>
  <a class="ne-link" data-href="https://github.com/apache/dubbo/issues/2578" href="https://github.com/apache/dubbo/issues/2578" target="_blank">
   <span class="ne-text">
    issue #2578
   </span>
  </a>
  <span class="ne-text">
   &#20013;&#34987;&#21453;&#39304;&#20986;&#26469;&#12290;&#38382;&#39064;&#20986;&#22312;&#20102; Invoker &#30340;&#36820;&#22238;&#26102;&#26426;&#19978;&#65292;RoundRobinLoadBalance &#38656;&#35201;&#22312;
  </span>
  <code class="ne-code">
   <span class="ne-text">
    mod == 0 &amp;&amp; v.getValue() &gt; 0
   </span>
  </code>
  <span class="ne-text">
   &#26465;&#20214;&#25104;&#31435;&#30340;&#24773;&#20917;&#19979;&#25165;&#20250;&#34987;&#36820;&#22238;&#30456;&#24212;&#30340; Invoker&#12290;&#20551;&#22914; mod &#24456;&#22823;&#65292;&#27604;&#22914; 10000&#65292;50000&#65292;&#29978;&#33267;&#26356;&#22823;&#26102;&#65292;doSelect &#26041;&#27861;&#38656;&#35201;&#36827;&#34892;&#24456;&#22810;&#27425;&#35745;&#31639;&#25165;&#33021;&#23558; mod &#20943;&#20026;0&#12290;&#30001;&#27492;&#21487;&#30693;&#65292;doSelect &#30340;&#25928;&#29575;&#19982; mod &#26377;&#20851;&#65292;&#26102;&#38388;&#22797;&#26434;&#24230;&#20026; O(mod)&#12290;mod &#21448;&#21463;&#26368;&#22823;&#26435;&#37325; maxWeight &#30340;&#24433;&#21709;&#65292;&#22240;&#27492;&#24403;&#26576;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#37197;&#32622;&#20102;&#38750;&#24120;&#22823;&#30340;&#26435;&#37325;&#65292;&#27492;&#26102; RoundRobinLoadBalance &#20250;&#20135;&#29983;&#27604;&#36739;&#20005;&#37325;&#30340;&#24615;&#33021;&#38382;&#39064;&#12290;&#36825;&#20010;&#38382;&#39064;&#34987;&#21453;&#39304;&#21518;&#65292;&#31038;&#21306;&#24456;&#24555;&#20570;&#20102;&#22238;&#24212;&#12290;&#24182;&#23545; RoundRobinLoadBalance &#30340;&#20195;&#30721;&#36827;&#34892;&#20102;&#37325;&#26500;&#65292;&#23558;&#26102;&#38388;&#22797;&#26434;&#24230;&#20248;&#21270;&#33267;&#20102;&#24120;&#37327;&#32423;&#21035;&#12290;&#36825;&#20010;&#20248;&#21270;&#21487;&#20197;&#35828;&#24456;&#22909;&#20102;&#65292;&#19979;&#38754;&#25105;&#20204;&#26469;&#23398;&#20064;&#19968;&#19979;&#20248;&#21270;&#21518;&#30340;&#20195;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u42be2197">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="678a971c">public class RoundRobinLoadBalance extends AbstractLoadBalance {

    public static final String NAME = "roundrobin";

    private final ConcurrentMap&lt;String, AtomicPositiveInteger&gt; sequences = new ConcurrentHashMap&lt;String, AtomicPositiveInteger&gt;();

    private final ConcurrentMap&lt;String, AtomicPositiveInteger&gt; indexSeqs = new ConcurrentHashMap&lt;String, AtomicPositiveInteger&gt;();

    @Override
    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
        String key = invokers.get(0).getUrl().getServiceKey() + "." + invocation.getMethodName();
        int length = invokers.size();
        int maxWeight = 0;
        int minWeight = Integer.MAX_VALUE;
        final List&lt;Invoker&lt;T&gt;&gt; invokerToWeightList = new ArrayList&lt;&gt;();
        
        // &#26597;&#25214;&#26368;&#22823;&#21644;&#26368;&#23567;&#26435;&#37325;
        for (int i = 0; i &lt; length; i++) {
            int weight = getWeight(invokers.get(i), invocation);
            maxWeight = Math.max(maxWeight, weight);
            minWeight = Math.min(minWeight, weight);
            if (weight &gt; 0) {
                invokerToWeightList.add(invokers.get(i));
            }
        }
        
        // &#33719;&#21462;&#24403;&#21069;&#26381;&#21153;&#23545;&#24212;&#30340;&#35843;&#29992;&#24207;&#21015;&#23545;&#35937; AtomicPositiveInteger
        AtomicPositiveInteger sequence = sequences.get(key);
        if (sequence == null) {
            // &#21019;&#24314; AtomicPositiveInteger&#65292;&#40664;&#35748;&#20540;&#20026;0
            sequences.putIfAbsent(key, new AtomicPositiveInteger());
            sequence = sequences.get(key);
        }
        
        // &#33719;&#21462;&#19979;&#26631;&#24207;&#21015;&#23545;&#35937; AtomicPositiveInteger
        AtomicPositiveInteger indexSeq = indexSeqs.get(key);
        if (indexSeq == null) {
            // &#21019;&#24314; AtomicPositiveInteger&#65292;&#40664;&#35748;&#20540;&#20026; -1
            indexSeqs.putIfAbsent(key, new AtomicPositiveInteger(-1));
            indexSeq = indexSeqs.get(key);
        }

        if (maxWeight &gt; 0 &amp;&amp; minWeight &lt; maxWeight) {
            length = invokerToWeightList.size();
            while (true) {
                int index = indexSeq.incrementAndGet() % length;
                int currentWeight = sequence.get() % maxWeight;

                // &#27599;&#24490;&#29615;&#19968;&#36718;&#65288;index = 0&#65289;&#65292;&#37325;&#26032;&#35745;&#31639; currentWeight
                if (index == 0) {
                    currentWeight = sequence.incrementAndGet() % maxWeight;
                }
                
                // &#26816;&#27979; Invoker &#30340;&#26435;&#37325;&#26159;&#21542;&#22823;&#20110; currentWeight&#65292;&#22823;&#20110;&#21017;&#36820;&#22238;
                if (getWeight(invokerToWeightList.get(index), invocation) &gt; currentWeight) {
                    return invokerToWeightList.get(index);
                }
            }
        }
        
        // &#25152;&#26377; Invoker &#26435;&#37325;&#30456;&#31561;&#65292;&#27492;&#26102;&#36827;&#34892;&#26222;&#36890;&#30340;&#36718;&#35810;&#21363;&#21487;
        return invokers.get(sequence.incrementAndGet() % length);
    }
}</pre>
 <p class="ne-p" id="u75f040f2">
  <br>
 </p>
 <p class="ne-p" id="u783e669a">
  <span class="ne-text">
   &#19978;&#38754;&#20195;&#30721;&#30340;&#36923;&#36753;&#26159;&#36825;&#26679;&#30340;&#65292;&#27599;&#36827;&#34892;&#19968;&#36718;&#24490;&#29615;&#65292;&#37325;&#26032;&#35745;&#31639; currentWeight&#12290;&#22914;&#26524;&#24403;&#21069; Invoker &#26435;&#37325;&#22823;&#20110; currentWeight&#65292;&#21017;&#36820;&#22238;&#35813; Invoker&#12290;&#19979;&#38754;&#20030;&#20363;&#35828;&#26126;&#65292;&#20551;&#35774;&#26381;&#21153;&#22120; [A, B, C] &#23545;&#24212;&#26435;&#37325; [5, 2, 1]&#12290;
  </span>
 </p>
 <p class="ne-p" id="u88d3b9f9">
  <br>
 </p>
 <p class="ne-p" id="u5fe8990f">
  <span class="ne-text">
   &#31532;&#19968;&#36718;&#24490;&#29615;&#65292;currentWeight = 1&#65292;&#21487;&#36820;&#22238; A &#21644; B
  </span>
 </p>
 <p class="ne-p" id="uf12c99ff">
  <br>
 </p>
 <p class="ne-p" id="u17aee75c">
  <span class="ne-text">
   &#31532;&#20108;&#36718;&#24490;&#29615;&#65292;currentWeight = 2&#65292;&#36820;&#22238; A
  </span>
 </p>
 <p class="ne-p" id="uac5432e4">
  <br>
 </p>
 <p class="ne-p" id="u2e98c0da">
  <span class="ne-text">
   &#31532;&#19977;&#36718;&#24490;&#29615;&#65292;currentWeight = 3&#65292;&#36820;&#22238; A
  </span>
 </p>
 <p class="ne-p" id="ub262740f">
  <br>
 </p>
 <p class="ne-p" id="uf22b51a2">
  <span class="ne-text">
   &#31532;&#22235;&#36718;&#24490;&#29615;&#65292;currentWeight = 4&#65292;&#36820;&#22238; A
  </span>
 </p>
 <p class="ne-p" id="ue414d265">
  <br>
 </p>
 <p class="ne-p" id="u9de52745">
  <span class="ne-text">
   &#31532;&#20116;&#36718;&#24490;&#29615;&#65292;currentWeight = 0&#65292;&#36820;&#22238; A, B, C
  </span>
 </p>
 <p class="ne-p" id="u9e1817dd">
  <br>
 </p>
 <p class="ne-p" id="u0245a79c">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#36825;&#37324;&#30340;&#19968;&#36718;&#24490;&#29615;&#26159;&#25351; index &#20877;&#27425;&#21464;&#20026;0&#25152;&#32463;&#21382;&#36807;&#30340;&#24490;&#29615;&#65292;&#36825;&#37324;&#21487;&#20197;&#25226; index = 0 &#30475;&#20570;&#26159;&#19968;&#36718;&#24490;&#29615;&#30340;&#24320;&#22987;&#12290;&#27599;&#19968;&#36718;&#24490;&#29615;&#30340;&#27425;&#25968;&#19982; Invoker &#30340;&#25968;&#37327;&#26377;&#20851;&#65292;Invoker &#25968;&#37327;&#36890;&#24120;&#19981;&#20250;&#22826;&#22810;&#65292;&#25152;&#20197;&#25105;&#20204;&#21487;&#20197;&#35748;&#20026;&#19978;&#38754;&#20195;&#30721;&#30340;&#26102;&#38388;&#22797;&#26434;&#24230;&#20026;&#24120;&#25968;&#32423;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u77983bb9">
  <br>
 </p>
 <p class="ne-p" id="uc55f9218">
  <span class="ne-text">
   &#37325;&#26500;&#21518;&#30340; RoundRobinLoadBalance &#30475;&#36215;&#26469;&#24050;&#32463;&#24456;&#19981;&#38169;&#20102;&#65292;&#20294;&#26159;&#22312;&#20195;&#30721;&#26356;&#26032;&#19981;&#20037;&#21518;&#65292;&#24456;&#24555;&#21448;&#34987;&#37325;&#26500;&#20102;&#12290;&#36825;&#27425;&#37325;&#26500;&#21407;&#22240;&#26159;&#26032;&#30340; RoundRobinLoadBalance &#22312;&#26576;&#20123;&#24773;&#20917;&#19979;&#36873;&#20986;&#30340;&#26381;&#21153;&#22120;&#24207;&#21015;&#19981;&#22815;&#22343;&#21248;&#12290;&#27604;&#22914;&#65292;&#26381;&#21153;&#22120; [A, B, C] &#23545;&#24212;&#26435;&#37325; [5, 1, 1]&#12290;&#36827;&#34892;7&#27425;&#36127;&#36733;&#22343;&#34913;&#21518;&#65292;&#36873;&#25321;&#20986;&#26469;&#30340;&#24207;&#21015;&#20026; [A, A, A, A, A, B, C]&#12290;&#21069;5&#20010;&#35831;&#27714;&#20840;&#37096;&#37117;&#33853;&#22312;&#20102;&#26381;&#21153;&#22120; A&#19978;&#65292;&#36825;&#23558;&#20250;&#20351;&#26381;&#21153;&#22120; A &#30701;&#26102;&#38388;&#20869;&#25509;&#25910;&#22823;&#37327;&#30340;&#35831;&#27714;&#65292;&#21387;&#21147;&#38497;&#22686;&#12290;&#32780; B &#21644; C &#27492;&#26102;&#26080;&#35831;&#27714;&#65292;&#22788;&#20110;&#31354;&#38386;&#29366;&#24577;&#12290;&#32780;&#25105;&#20204;&#26399;&#26395;&#30340;&#32467;&#26524;&#26159;&#36825;&#26679;&#30340; [A, A, B, A, C, A, A]&#65292;&#19981;&#21516;&#26381;&#21153;&#22120;&#21487;&#20197;&#31359;&#25554;&#33719;&#21462;&#35831;&#27714;&#12290;&#20026;&#20102;&#22686;&#21152;&#36127;&#36733;&#22343;&#34913;&#32467;&#26524;&#30340;&#24179;&#28369;&#24615;&#65292;&#31038;&#21306;&#20877;&#27425;&#23545; RoundRobinLoadBalance &#30340;&#23454;&#29616;&#36827;&#34892;&#20102;&#37325;&#26500;&#65292;&#36825;&#27425;&#37325;&#26500;&#21442;&#32771;&#33258; Nginx &#30340;&#24179;&#28369;&#21152;&#26435;&#36718;&#35810;&#36127;&#36733;&#22343;&#34913;&#12290;&#27599;&#20010;&#26381;&#21153;&#22120;&#23545;&#24212;&#20004;&#20010;&#26435;&#37325;&#65292;&#20998;&#21035;&#20026; weight &#21644; currentWeight&#12290;&#20854;&#20013; weight &#26159;&#22266;&#23450;&#30340;&#65292;currentWeight &#20250;&#21160;&#24577;&#35843;&#25972;&#65292;&#21021;&#22987;&#20540;&#20026;0&#12290;&#24403;&#26377;&#26032;&#30340;&#35831;&#27714;&#36827;&#26469;&#26102;&#65292;&#36941;&#21382;&#26381;&#21153;&#22120;&#21015;&#34920;&#65292;&#35753;&#23427;&#30340; currentWeight &#21152;&#19978;&#33258;&#36523;&#26435;&#37325;&#12290;&#36941;&#21382;&#23436;&#25104;&#21518;&#65292;&#25214;&#21040;&#26368;&#22823;&#30340; currentWeight&#65292;&#24182;&#23558;&#20854;&#20943;&#21435;&#26435;&#37325;&#24635;&#21644;&#65292;&#28982;&#21518;&#36820;&#22238;&#30456;&#24212;&#30340;&#26381;&#21153;&#22120;&#21363;&#21487;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u87f64937">
  <br>
 </p>
 <p class="ne-p" id="u4dd847d7">
  <span class="ne-text">
   &#19978;&#38754;&#25551;&#36848;&#19981;&#26159;&#24456;&#22909;&#29702;&#35299;&#65292;&#19979;&#38754;&#36824;&#26159;&#20030;&#20363;&#36827;&#34892;&#35828;&#26126;&#12290;&#36825;&#37324;&#20173;&#28982;&#20351;&#29992;&#26381;&#21153;&#22120; [A, B, C] &#23545;&#24212;&#26435;&#37325; [5, 1, 1] &#30340;&#20363;&#23376;&#35828;&#26126;&#65292;&#29616;&#22312;&#26377;7&#20010;&#35831;&#27714;&#20381;&#27425;&#36827;&#20837;&#36127;&#36733;&#22343;&#34913;&#36923;&#36753;&#65292;&#36873;&#25321;&#36807;&#31243;&#22914;&#19979;&#65306;
  </span>
 </p>
 <table class="ne-table" id="e541547f" style="width: 748px">
  <tbody>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="uec502ab6">
      <span class="ne-text">
       &#35831;&#27714;&#32534;&#21495;
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="udd2be9d1">
      <span class="ne-text">
       currentWeight &#25968;&#32452;
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u4216562c">
      <span class="ne-text">
       &#36873;&#25321;&#32467;&#26524;
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="uefb50cf8">
      <span class="ne-text">
       &#20943;&#21435;&#26435;&#37325;&#24635;&#21644;&#21518;&#30340; currentWeight &#25968;&#32452;
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="u19b012ad">
      <span class="ne-text">
       1
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u6b8c0040">
      <span class="ne-text">
       [5, 1, 1]
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u84ab8036">
      <span class="ne-text">
       A
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u259244b1">
      <span class="ne-text">
       [-2, 1, 1]
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="u84ef0ede">
      <span class="ne-text">
       2
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u7af67fb3">
      <span class="ne-text">
       [3, 2, 2]
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u0f9f7bc3">
      <span class="ne-text">
       A
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="uddc852a9">
      <span class="ne-text">
       [-4, 2, 2]
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="u707b22f7">
      <span class="ne-text">
       3
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u0a8781e6">
      <span class="ne-text">
       [1, 3, 3]
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="ucfeabe53">
      <span class="ne-text">
       B
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u48149b0f">
      <span class="ne-text">
       [1, -4, 3]
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="u858314dd">
      <span class="ne-text">
       4
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="uede51da8">
      <span class="ne-text">
       [6, -3, 4]
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="ue3636887">
      <span class="ne-text">
       A
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u34628af9">
      <span class="ne-text">
       [-1, -3, 4]
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="u514ea5fc">
      <span class="ne-text">
       5
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u44441825">
      <span class="ne-text">
       [4, -2, 5]
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="ue9624d5f">
      <span class="ne-text">
       C
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u57a64df5">
      <span class="ne-text">
       [4, -2, -2]
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="u8009891e">
      <span class="ne-text">
       6
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u466985e3">
      <span class="ne-text">
       [9, -1, -1]
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u4847b6e9">
      <span class="ne-text">
       A
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u670b9e4b">
      <span class="ne-text">
       [2, -1, -1]
      </span>
     </p>
    </td>
   </tr>
   <tr style="height: 33px">
    <td width="187">
     <p class="ne-p" id="u8a6ba9eb">
      <span class="ne-text">
       7
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u46929a91">
      <span class="ne-text">
       [7, 0, 0]
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u7da02f73">
      <span class="ne-text">
       A
      </span>
     </p>
    </td>
    <td width="187">
     <p class="ne-p" id="u55930fe8">
      <span class="ne-text">
       [0, 0, 0]
      </span>
     </p>
    </td>
   </tr>
  </tbody>
 </table>
 <p class="ne-p" id="u1897992f">
  <br>
 </p>
 <p class="ne-p" id="ue43c1753">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#32463;&#36807;&#24179;&#28369;&#24615;&#22788;&#29702;&#21518;&#65292;&#24471;&#21040;&#30340;&#26381;&#21153;&#22120;&#24207;&#21015;&#20026; [A, A, B, A, C, A, A]&#65292;&#30456;&#27604;&#20043;&#21069;&#30340;&#24207;&#21015; [A, A, A, A, A, B, C]&#65292;&#20998;&#24067;&#24615;&#35201;&#22909;&#19968;&#20123;&#12290;&#21021;&#22987;&#24773;&#20917;&#19979; currentWeight = [0, 0, 0]&#65292;&#31532;7&#20010;&#35831;&#27714;&#22788;&#29702;&#23436;&#21518;&#65292;currentWeight &#20877;&#27425;&#21464;&#20026; [0, 0, 0]&#12290;
  </span>
 </p>
 <p class="ne-p" id="u4a012c67">
  <br>
 </p>
 <p class="ne-p" id="u7eb8c973">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159;&#24179;&#28369;&#21152;&#26435;&#36718;&#35810;&#30340;&#35745;&#31639;&#36807;&#31243;&#65292;&#25509;&#19979;&#26469;&#65292;&#25105;&#20204;&#26469;&#30475;&#30475; Dubbo-2.6.5 &#26159;&#22914;&#20309;&#23454;&#29616;&#19978;&#38754;&#30340;&#35745;&#31639;&#36807;&#31243;&#30340;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u125eb5a1">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="589f6dba">public class RoundRobinLoadBalance extends AbstractLoadBalance {
    public static final String NAME = "roundrobin";
    
    private static int RECYCLE_PERIOD = 60000;
    
    protected static class WeightedRoundRobin {
        // &#26381;&#21153;&#25552;&#20379;&#32773;&#26435;&#37325;
        private int weight;
        // &#24403;&#21069;&#26435;&#37325;
        private AtomicLong current = new AtomicLong(0);
        // &#26368;&#21518;&#19968;&#27425;&#26356;&#26032;&#26102;&#38388;
        private long lastUpdate;
        
        public void setWeight(int weight) {
            this.weight = weight;
            // &#21021;&#22987;&#24773;&#20917;&#19979;&#65292;current = 0
            current.set(0);
        }
        public long increaseCurrent() {
            // current = current + weight&#65307;
            return current.addAndGet(weight);
        }
        public void sel(int total) {
            // current = current - total;
            current.addAndGet(-1 * total);
        }
    }

    // &#23884;&#22871; Map &#32467;&#26500;&#65292;&#23384;&#20648;&#30340;&#25968;&#25454;&#32467;&#26500;&#31034;&#20363;&#22914;&#19979;&#65306;
    // {
    //     "UserService.query": {
    //         "url1": WeightedRoundRobin@123, 
    //         "url2": WeightedRoundRobin@456, 
    //     },
    //     "UserService.update": {
    //         "url1": WeightedRoundRobin@123, 
    //         "url2": WeightedRoundRobin@456,
    //     }
    // }
    // &#26368;&#22806;&#23618;&#20026;&#26381;&#21153;&#31867;&#21517; + &#26041;&#27861;&#21517;&#65292;&#31532;&#20108;&#23618;&#20026; url &#21040; WeightedRoundRobin &#30340;&#26144;&#23556;&#20851;&#31995;&#12290;
    // &#36825;&#37324;&#25105;&#20204;&#21487;&#20197;&#23558; url &#30475;&#25104;&#26159;&#26381;&#21153;&#25552;&#20379;&#32773;&#30340; id
    private ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt; methodWeightMap = new ConcurrentHashMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt;();
    
    // &#21407;&#23376;&#26356;&#26032;&#38145;
    private AtomicBoolean updateLock = new AtomicBoolean();
    
    @Override
    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
        String key = invokers.get(0).getUrl().getServiceKey() + "." + invocation.getMethodName();
        // &#33719;&#21462; url &#21040; WeightedRoundRobin &#26144;&#23556;&#34920;&#65292;&#22914;&#26524;&#20026;&#31354;&#65292;&#21017;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340;
        ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);
        if (map == null) {
            methodWeightMap.putIfAbsent(key, new ConcurrentHashMap&lt;String, WeightedRoundRobin&gt;());
            map = methodWeightMap.get(key);
        }
        int totalWeight = 0;
        long maxCurrent = Long.MIN_VALUE;
        
        // &#33719;&#21462;&#24403;&#21069;&#26102;&#38388;
        long now = System.currentTimeMillis();
        Invoker&lt;T&gt; selectedInvoker = null;
        WeightedRoundRobin selectedWRR = null;

        // &#19979;&#38754;&#36825;&#20010;&#24490;&#29615;&#20027;&#35201;&#20570;&#20102;&#36825;&#26679;&#20960;&#20214;&#20107;&#24773;&#65306;
        //   1. &#36941;&#21382; Invoker &#21015;&#34920;&#65292;&#26816;&#27979;&#24403;&#21069; Invoker &#26159;&#21542;&#26377;
        //      &#30456;&#24212;&#30340; WeightedRoundRobin&#65292;&#27809;&#26377;&#21017;&#21019;&#24314;
        //   2. &#26816;&#27979; Invoker &#26435;&#37325;&#26159;&#21542;&#21457;&#29983;&#20102;&#21464;&#21270;&#65292;&#33509;&#21464;&#21270;&#20102;&#65292;
        //      &#21017;&#26356;&#26032; WeightedRoundRobin &#30340; weight &#23383;&#27573;
        //   3. &#35753; current &#23383;&#27573;&#21152;&#19978;&#33258;&#36523;&#26435;&#37325;&#65292;&#31561;&#20215;&#20110; current += weight
        //   4. &#35774;&#32622; lastUpdate &#23383;&#27573;&#65292;&#21363; lastUpdate = now
        //   5. &#23547;&#25214;&#20855;&#26377;&#26368;&#22823; current &#30340; Invoker&#65292;&#20197;&#21450; Invoker &#23545;&#24212;&#30340; WeightedRoundRobin&#65292;
        //      &#26242;&#23384;&#36215;&#26469;&#65292;&#30041;&#20316;&#21518;&#29992;
        //   6. &#35745;&#31639;&#26435;&#37325;&#24635;&#21644;
        for (Invoker&lt;T&gt; invoker : invokers) {
            String identifyString = invoker.getUrl().toIdentityString();
            WeightedRoundRobin weightedRoundRobin = map.get(identifyString);
            int weight = getWeight(invoker, invocation);
            if (weight &lt; 0) {
                weight = 0;
            }
            
            // &#26816;&#27979;&#24403;&#21069; Invoker &#26159;&#21542;&#26377;&#23545;&#24212;&#30340; WeightedRoundRobin&#65292;&#27809;&#26377;&#21017;&#21019;&#24314;
            if (weightedRoundRobin == null) {
                weightedRoundRobin = new WeightedRoundRobin();
                // &#35774;&#32622; Invoker &#26435;&#37325;
                weightedRoundRobin.setWeight(weight);
                // &#23384;&#20648; url &#21807;&#19968;&#26631;&#35782; identifyString &#21040; weightedRoundRobin &#30340;&#26144;&#23556;&#20851;&#31995;
                map.putIfAbsent(identifyString, weightedRoundRobin);
                weightedRoundRobin = map.get(identifyString);
            }
            // Invoker &#26435;&#37325;&#19981;&#31561;&#20110; WeightedRoundRobin &#20013;&#20445;&#23384;&#30340;&#26435;&#37325;&#65292;&#35828;&#26126;&#26435;&#37325;&#21464;&#21270;&#20102;&#65292;&#27492;&#26102;&#36827;&#34892;&#26356;&#26032;
            if (weight != weightedRoundRobin.getWeight()) {
                weightedRoundRobin.setWeight(weight);
            }
            
            // &#35753; current &#21152;&#19978;&#33258;&#36523;&#26435;&#37325;&#65292;&#31561;&#20215;&#20110; current += weight
            long cur = weightedRoundRobin.increaseCurrent();
            // &#35774;&#32622; lastUpdate&#65292;&#34920;&#31034;&#36817;&#26399;&#26356;&#26032;&#36807;
            weightedRoundRobin.setLastUpdate(now);
            // &#25214;&#20986;&#26368;&#22823;&#30340; current 
            if (cur &gt; maxCurrent) {
                maxCurrent = cur;
                // &#23558;&#20855;&#26377;&#26368;&#22823; current &#26435;&#37325;&#30340; Invoker &#36171;&#20540;&#32473; selectedInvoker
                selectedInvoker = invoker;
                // &#23558; Invoker &#23545;&#24212;&#30340; weightedRoundRobin &#36171;&#20540;&#32473; selectedWRR&#65292;&#30041;&#20316;&#21518;&#29992;
                selectedWRR = weightedRoundRobin;
            }
            
            // &#35745;&#31639;&#26435;&#37325;&#24635;&#21644;
            totalWeight += weight;
        }

        // &#23545; &lt;identifyString, WeightedRoundRobin&gt; &#36827;&#34892;&#26816;&#26597;&#65292;&#36807;&#28388;&#25481;&#38271;&#26102;&#38388;&#26410;&#34987;&#26356;&#26032;&#30340;&#33410;&#28857;&#12290;
        // &#35813;&#33410;&#28857;&#21487;&#33021;&#25346;&#20102;&#65292;invokers &#20013;&#19981;&#21253;&#21547;&#35813;&#33410;&#28857;&#65292;&#25152;&#20197;&#35813;&#33410;&#28857;&#30340; lastUpdate &#38271;&#26102;&#38388;&#26080;&#27861;&#34987;&#26356;&#26032;&#12290;
        // &#33509;&#26410;&#26356;&#26032;&#26102;&#38271;&#36229;&#36807;&#38408;&#20540;&#21518;&#65292;&#23601;&#20250;&#34987;&#31227;&#38500;&#25481;&#65292;&#40664;&#35748;&#38408;&#20540;&#20026;60&#31186;&#12290;
        if (!updateLock.get() &amp;&amp; invokers.size() != map.size()) {
            if (updateLock.compareAndSet(false, true)) {
                try {
                    ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = new ConcurrentHashMap&lt;String, WeightedRoundRobin&gt;();
                    // &#25335;&#36125;
                    newMap.putAll(map);
                    
                    // &#36941;&#21382;&#20462;&#25913;&#65292;&#21363;&#31227;&#38500;&#36807;&#26399;&#35760;&#24405;
                    Iterator&lt;Entry&lt;String, WeightedRoundRobin&gt;&gt; it = newMap.entrySet().iterator();
                    while (it.hasNext()) {
                        Entry&lt;String, WeightedRoundRobin&gt; item = it.next();
                        if (now - item.getValue().getLastUpdate() &gt; RECYCLE_PERIOD) {
                            it.remove();
                        }
                    }
                    
                    // &#26356;&#26032;&#24341;&#29992;
                    methodWeightMap.put(key, newMap);
                } finally {
                    updateLock.set(false);
                }
            }
        }

        if (selectedInvoker != null) {
            // &#35753; current &#20943;&#21435;&#26435;&#37325;&#24635;&#21644;&#65292;&#31561;&#20215;&#20110; current -= totalWeight
            selectedWRR.sel(totalWeight);
            // &#36820;&#22238;&#20855;&#26377;&#26368;&#22823; current &#30340; Invoker
            return selectedInvoker;
        }
        
        // should not happen here
        return invokers.get(0);
    }
}</pre>
 <p class="ne-p" id="u9a039ae1">
  <br>
 </p>
 <p class="ne-p" id="u1f905b61">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159; Dubbo-2.6.5 &#29256;&#26412;&#30340; RoundRobinLoadBalance&#65292;&#22823;&#23478;&#22914;&#26524;&#33021;&#22815;&#29702;&#35299;&#24179;&#28369;&#21152;&#26435;&#36718;&#35810;&#31639;&#27861;&#30340;&#35745;&#31639;&#36807;&#31243;&#65292;&#20877;&#37197;&#21512;&#20195;&#30721;&#20013;&#27880;&#37322;&#65292;&#29702;&#35299;&#19978;&#38754;&#30340;&#20195;&#30721;&#24212;&#35813;&#19981;&#38590;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u36a00953">
  <br>
 </p>
 <h2 id="39fd2046">
  <span class="ne-text">
   3.&#24635;&#32467;
  </span>
 </h2>
 <p class="ne-p" id="u5c118768">
  <br>
 </p>
 <p class="ne-p" id="u9f805585">
  <span class="ne-text">
   &#26412;&#31687;&#25991;&#31456;&#23545; Dubbo &#20013;&#30340;&#20960;&#31181;&#36127;&#36733;&#22343;&#34913;&#23454;&#29616;&#36827;&#34892;&#20102;&#35814;&#32454;&#30340;&#20998;&#26512;&#65292;&#20869;&#23481;&#27604;&#36739;&#22810;&#65292;&#22823;&#23478;&#24930;&#24930;&#28040;&#21270;&#12290;&#29702;&#35299;&#36127;&#36733;&#22343;&#34913;&#20195;&#30721;&#36923;&#36753;&#30340;&#20851;&#38190;&#20043;&#22788;&#22312;&#20110;&#23545;&#32972;&#26223;&#30693;&#35782;&#30340;&#29702;&#35299;&#65292;&#22240;&#27492;&#22823;&#23478;&#22312;&#38405;&#35835;&#28304;&#30721;&#21069;&#65292;&#21153;&#24517;&#20808;&#20102;&#35299;&#27599;&#31181;&#36127;&#36733;&#22343;&#34913;&#23545;&#24212;&#30340;&#32972;&#26223;&#30693;&#35782;&#12290;
  </span>
 </p>
</div>
</div>
</div>

        </body>
        
        