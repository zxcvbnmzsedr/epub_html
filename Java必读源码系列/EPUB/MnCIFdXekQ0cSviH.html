
        <html lang="en">
        <head>
        <meta charset="UTF-8"/>
        </head>
        <body>
        <div><div class="markdown-body">
    <h1>&#12300;&#28304;&#30721;&#35299;&#35835;&#12301;&#26381;&#21153;&#24341;&#29992;</h1><div class="lake-content" typography="classic">
 <div class="ne-quote">
  <p class="ne-p" id="uab84f341">
   <span class="ne-text">
    &#21407;&#25991;&#22320;&#22336;&#65306;
   </span>
   <a class="ne-link" data-href="https://dubbo.apache.org/zh/docsv2.7/dev/source/refer-service/" href="https://dubbo.apache.org/zh/docsv2.7/dev/source/refer-service/" target="_blank">
    <span class="ne-text">
     https://dubbo.apache.org/zh/docsv2.7/dev/source/refer-service/
    </span>
   </a>
  </p>
  <p class="ne-p" id="uef1f0c1c">
   <span class="ne-text">
   </span>
  </p>
  <p class="ne-p" id="uf028dbd0">
   <span class="ne-text">
    &#20316;&#32773;&#65306; Dubbo &#23448;&#26041;
   </span>
  </p>
 </div>
 <p class="ne-p" id="uc6bea5a9">
  <br>
 </p>
 <p class="ne-p" id="u1262554d">
  <span class="ne-text">
   &#26412;&#25991;&#20171;&#32461;&#20102; Dubbo &#26381;&#21153;&#24341;&#29992;&#30340;&#36807;&#31243;&#21644;&#23454;&#29616;&#32454;&#33410;
  </span>
 </p>
 <p class="ne-p" id="uc2815d77">
  <br>
 </p>
 <h2 id="25970172">
  <span class="ne-text">
   1. &#31616;&#20171;
  </span>
 </h2>
 <p class="ne-p" id="u06184cdf">
  <br>
 </p>
 <p class="ne-p" id="uc190a1dd">
  <span class="ne-text">
   &#19978;&#19968;&#31687;&#25991;&#31456;&#35814;&#32454;&#20998;&#26512;&#20102;&#26381;&#21153;&#23548;&#20986;&#30340;&#36807;&#31243;&#65292;&#26412;&#31687;&#25991;&#31456;&#25105;&#20204;&#36225;&#28909;&#25171;&#38081;&#65292;&#32487;&#32493;&#20998;&#26512;&#26381;&#21153;&#24341;&#29992;&#36807;&#31243;&#12290;&#22312; Dubbo &#20013;&#65292;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#20004;&#31181;&#26041;&#24335;&#24341;&#29992;&#36828;&#31243;&#26381;&#21153;&#12290;&#31532;&#19968;&#31181;&#26159;&#20351;&#29992;&#26381;&#21153;&#30452;&#36830;&#30340;&#26041;&#24335;&#24341;&#29992;&#26381;&#21153;&#65292;&#31532;&#20108;&#31181;&#26041;&#24335;&#26159;&#22522;&#20110;&#27880;&#20876;&#20013;&#24515;&#36827;&#34892;&#24341;&#29992;&#12290;&#26381;&#21153;&#30452;&#36830;&#30340;&#26041;&#24335;&#20165;&#36866;&#21512;&#22312;&#35843;&#35797;&#25110;&#27979;&#35797;&#26381;&#21153;&#30340;&#22330;&#26223;&#19979;&#20351;&#29992;&#65292;&#19981;&#36866;&#21512;&#22312;&#32447;&#19978;&#29615;&#22659;&#20351;&#29992;&#12290;&#22240;&#27492;&#65292;&#26412;&#25991;&#25105;&#23558;&#37325;&#28857;&#20998;&#26512;&#36890;&#36807;&#27880;&#20876;&#20013;&#24515;&#24341;&#29992;&#26381;&#21153;&#30340;&#36807;&#31243;&#12290;&#20174;&#27880;&#20876;&#20013;&#24515;&#20013;&#33719;&#21462;&#26381;&#21153;&#37197;&#32622;&#21482;&#26159;&#26381;&#21153;&#24341;&#29992;&#36807;&#31243;&#20013;&#30340;&#19968;&#29615;&#65292;&#38500;&#27492;&#20043;&#22806;&#65292;&#26381;&#21153;&#28040;&#36153;&#32773;&#36824;&#38656;&#35201;&#32463;&#21382; Invoker &#21019;&#24314;&#12289;&#20195;&#29702;&#31867;&#21019;&#24314;&#31561;&#27493;&#39588;&#12290;&#36825;&#20123;&#27493;&#39588;&#65292;&#23558;&#22312;&#21518;&#32493;&#31456;&#33410;&#20013;&#19968;&#19968;&#36827;&#34892;&#20998;&#26512;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u81ad3fcc">
  <br>
 </p>
 <h2 id="bdc765fc">
  <span class="ne-text">
   2.&#26381;&#21153;&#24341;&#29992;&#21407;&#29702;
  </span>
 </h2>
 <p class="ne-p" id="uf4818f16">
  <br>
 </p>
 <p class="ne-p" id="u4c37f322">
  <span class="ne-text">
   Dubbo &#26381;&#21153;&#24341;&#29992;&#30340;&#26102;&#26426;&#26377;&#20004;&#20010;&#65292;&#31532;&#19968;&#20010;&#26159;&#22312; Spring &#23481;&#22120;&#35843;&#29992; ReferenceBean &#30340; afterPropertiesSet &#26041;&#27861;&#26102;&#24341;&#29992;&#26381;&#21153;&#65292;&#31532;&#20108;&#20010;&#26159;&#22312; ReferenceBean &#23545;&#24212;&#30340;&#26381;&#21153;&#34987;&#27880;&#20837;&#21040;&#20854;&#20182;&#31867;&#20013;&#26102;&#24341;&#29992;&#12290;&#36825;&#20004;&#20010;&#24341;&#29992;&#26381;&#21153;&#30340;&#26102;&#26426;&#21306;&#21035;&#22312;&#20110;&#65292;&#31532;&#19968;&#20010;&#26159;&#39295;&#27721;&#24335;&#30340;&#65292;&#31532;&#20108;&#20010;&#26159;&#25042;&#27721;&#24335;&#30340;&#12290;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;Dubbo &#20351;&#29992;&#25042;&#27721;&#24335;&#24341;&#29992;&#26381;&#21153;&#12290;&#22914;&#26524;&#38656;&#35201;&#20351;&#29992;&#39295;&#27721;&#24335;&#65292;&#21487;&#36890;&#36807;&#37197;&#32622;
  </span>
  <span class="ne-text">
   dubbo:reference
  </span>
  <span class="ne-text">
   &#30340; init &#23646;&#24615;&#24320;&#21551;&#12290;&#19979;&#38754;&#25105;&#20204;&#25353;&#29031; Dubbo &#40664;&#35748;&#37197;&#32622;&#36827;&#34892;&#20998;&#26512;&#65292;&#25972;&#20010;&#20998;&#26512;&#36807;&#31243;&#20174; ReferenceBean &#30340; getObject &#26041;&#27861;&#24320;&#22987;&#12290;&#24403;&#25105;&#20204;&#30340;&#26381;&#21153;&#34987;&#27880;&#20837;&#21040;&#20854;&#20182;&#31867;&#20013;&#26102;&#65292;Spring &#20250;&#31532;&#19968;&#26102;&#38388;&#35843;&#29992; getObject &#26041;&#27861;&#65292;&#24182;&#30001;&#35813;&#26041;&#27861;&#25191;&#34892;&#26381;&#21153;&#24341;&#29992;&#36923;&#36753;&#12290;&#25353;&#29031;&#24815;&#20363;&#65292;&#22312;&#36827;&#34892;&#20855;&#20307;&#24037;&#20316;&#20043;&#21069;&#65292;&#38656;&#20808;&#36827;&#34892;&#37197;&#32622;&#26816;&#26597;&#19982;&#25910;&#38598;&#24037;&#20316;&#12290;&#25509;&#30528;&#26681;&#25454;&#25910;&#38598;&#21040;&#30340;&#20449;&#24687;&#20915;&#23450;&#26381;&#21153;&#29992;&#30340;&#26041;&#24335;&#65292;&#26377;&#19977;&#31181;&#65292;&#31532;&#19968;&#31181;&#26159;&#24341;&#29992;&#26412;&#22320; (JVM) &#26381;&#21153;&#65292;&#31532;&#20108;&#26159;&#36890;&#36807;&#30452;&#36830;&#26041;&#24335;&#24341;&#29992;&#36828;&#31243;&#26381;&#21153;&#65292;&#31532;&#19977;&#26159;&#36890;&#36807;&#27880;&#20876;&#20013;&#24515;&#24341;&#29992;&#36828;&#31243;&#26381;&#21153;&#12290;&#19981;&#31649;&#26159;&#21738;&#31181;&#24341;&#29992;&#26041;&#24335;&#65292;&#26368;&#21518;&#37117;&#20250;&#24471;&#21040;&#19968;&#20010; Invoker &#23454;&#20363;&#12290;&#22914;&#26524;&#26377;&#22810;&#20010;&#27880;&#20876;&#20013;&#24515;&#65292;&#22810;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#65292;&#36825;&#20010;&#26102;&#20505;&#20250;&#24471;&#21040;&#19968;&#32452; Invoker &#23454;&#20363;&#65292;&#27492;&#26102;&#38656;&#35201;&#36890;&#36807;&#38598;&#32676;&#31649;&#29702;&#31867; Cluster &#23558;&#22810;&#20010; Invoker &#21512;&#24182;&#25104;&#19968;&#20010;&#23454;&#20363;&#12290;&#21512;&#24182;&#21518;&#30340; Invoker &#23454;&#20363;&#24050;&#32463;&#20855;&#22791;&#35843;&#29992;&#26412;&#22320;&#25110;&#36828;&#31243;&#26381;&#21153;&#30340;&#33021;&#21147;&#20102;&#65292;&#20294;&#24182;&#19981;&#33021;&#23558;&#27492;&#23454;&#20363;&#26292;&#38706;&#32473;&#29992;&#25143;&#20351;&#29992;&#65292;&#36825;&#20250;&#23545;&#29992;&#25143;&#19994;&#21153;&#20195;&#30721;&#36896;&#25104;&#20405;&#20837;&#12290;&#27492;&#26102;&#26694;&#26550;&#36824;&#38656;&#35201;&#36890;&#36807;&#20195;&#29702;&#24037;&#21378;&#31867; (ProxyFactory) &#20026;&#26381;&#21153;&#25509;&#21475;&#29983;&#25104;&#20195;&#29702;&#31867;&#65292;&#24182;&#35753;&#20195;&#29702;&#31867;&#21435;&#35843;&#29992; Invoker &#36923;&#36753;&#12290;&#36991;&#20813;&#20102; Dubbo &#26694;&#26550;&#20195;&#30721;&#23545;&#19994;&#21153;&#20195;&#30721;&#30340;&#20405;&#20837;&#65292;&#21516;&#26102;&#20063;&#35753;&#26694;&#26550;&#26356;&#23481;&#26131;&#20351;&#29992;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u54de1bb1">
  <br>
 </p>
 <p class="ne-p" id="u31fc64a5">
  <span class="ne-text">
   &#20197;&#19978;&#23601;&#26159;&#26381;&#21153;&#24341;&#29992;&#30340;&#22823;&#33268;&#21407;&#29702;&#65292;&#19979;&#38754;&#25105;&#20204;&#28145;&#20837;&#21040;&#20195;&#30721;&#20013;&#65292;&#35814;&#32454;&#20998;&#26512;&#26381;&#21153;&#24341;&#29992;&#32454;&#33410;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u8ccc901d">
  <br>
 </p>
 <h2 id="9efff3e2">
  <span class="ne-text">
   3.&#28304;&#30721;&#20998;&#26512;
  </span>
 </h2>
 <p class="ne-p" id="ub973f21a">
  <br>
 </p>
 <p class="ne-p" id="ufeb875d5">
  <span class="ne-text">
   &#26381;&#21153;&#24341;&#29992;&#30340;&#20837;&#21475;&#26041;&#27861;&#20026; ReferenceBean &#30340; getObject &#26041;&#27861;&#65292;&#35813;&#26041;&#27861;&#23450;&#20041;&#22312; Spring &#30340; FactoryBean &#25509;&#21475;&#20013;&#65292;ReferenceBean &#23454;&#29616;&#20102;&#36825;&#20010;&#26041;&#27861;&#12290;&#23454;&#29616;&#20195;&#30721;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="uf4dc5e1f">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="b95e7395">public Object getObject() throws Exception {
    return get();
}

public synchronized T get() {
    if (destroyed) {
        throw new IllegalStateException("Already destroyed!");
    }
    // &#26816;&#27979; ref &#26159;&#21542;&#20026;&#31354;&#65292;&#20026;&#31354;&#21017;&#36890;&#36807; init &#26041;&#27861;&#21019;&#24314;
    if (ref == null) {
        // init &#26041;&#27861;&#20027;&#35201;&#29992;&#20110;&#22788;&#29702;&#37197;&#32622;&#65292;&#20197;&#21450;&#35843;&#29992; createProxy &#29983;&#25104;&#20195;&#29702;&#31867;
        init();
    }
    return ref;
}</pre>
 <p class="ne-p" id="uf934adca">
  <br>
 </p>
 <p class="ne-p" id="u3433499c">
  <span class="ne-text">
   &#20197;&#19978;&#20004;&#20010;&#26041;&#27861;&#30340;&#20195;&#30721;&#27604;&#36739;&#31616;&#30701;&#65292;&#24182;&#19981;&#38590;&#29702;&#35299;&#12290;&#36825;&#37324;&#38656;&#35201;&#29305;&#21035;&#35828;&#26126;&#19968;&#19979;&#65292;&#22914;&#26524;&#20320;&#23545; 2.6.4 &#21450;&#20197;&#19979;&#29256;&#26412;&#30340; getObject &#26041;&#27861;&#36827;&#34892;&#35843;&#35797;&#26102;&#65292;&#20250;&#30896;&#21040;&#27604;&#36739;&#22855;&#24618;&#30340;&#30340;&#38382;&#39064;&#12290;&#36825;&#37324;&#20551;&#35774;&#20320;&#20351;&#29992; IDEA&#65292;&#19988;&#20445;&#25345;&#20102; IDEA &#30340;&#40664;&#35748;&#37197;&#32622;&#12290;&#24403;&#20320;&#38754;&#35843;&#35797;&#21040; get &#26041;&#27861;&#30340;
  </span>
  <code class="ne-code">
   <span class="ne-text">
    if (ref == null)
   </span>
  </code>
  <span class="ne-text">
   &#26102;&#65292;&#20320;&#20250;&#21457;&#29616; ref &#19981;&#20026;&#31354;&#65292;&#23548;&#33268;&#20320;&#26080;&#27861;&#36827;&#20837;&#21040; init &#26041;&#27861;&#20013;&#32487;&#32493;&#35843;&#35797;&#12290;&#23548;&#33268;&#36825;&#20010;&#29616;&#35937;&#30340;&#21407;&#22240;&#26159; Dubbo &#26694;&#26550;&#26412;&#36523;&#26377;&#19968;&#20123;&#23567;&#38382;&#39064;&#12290;&#35813;&#38382;&#39064;&#24050;&#32463;&#22312; pull request
  </span>
  <a class="ne-link" data-href="https://github.com/apache/dubbo/pull/2754" href="https://github.com/apache/dubbo/pull/2754" target="_blank">
   <span class="ne-text">
    #2754
   </span>
  </a>
  <span class="ne-text">
   &#20462;&#22797;&#20102;&#27492;&#38382;&#39064;&#65292;&#24182;&#36319;&#38543; 2.6.5 &#29256;&#26412;&#21457;&#24067;&#20102;&#12290;&#22914;&#26524;&#20320;&#27491;&#22312;&#23398;&#20064; 2.6.4 &#21450;&#20197;&#19979;&#29256;&#26412;&#65292;&#21487;&#36890;&#36807;&#20462;&#25913; IDEA &#37197;&#32622;&#35268;&#36991;&#36825;&#20010;&#38382;&#39064;&#12290;&#39318;&#20808; IDEA &#37197;&#32622;&#24377;&#31383;&#20013;&#25628;&#32034; toString&#65292;&#28982;&#21518;&#21462;&#28040;
  </span>
  <code class="ne-code">
   <span class="ne-text">
    Enable 'toString' object view
   </span>
  </code>
  <span class="ne-text">
   &#21246;&#36873;&#12290;&#20855;&#20307;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u47492792">
  <br>
 </p>
 <p class="ne-p" id="ufe40ae3d">
  <img class="ne-image" id="joDsq" src="EPUB/imgjoDsq" width="1586">
 </p>
 <p class="ne-p" id="u048b7dae">
  <br>
 </p>
 <h3 id="7b5e4f33">
  <span class="ne-text">
   3.1 &#22788;&#29702;&#37197;&#32622;
  </span>
 </h3>
 <p class="ne-p" id="u5c02f7a0">
  <br>
 </p>
 <p class="ne-p" id="u42ab9e40">
  <span class="ne-text">
   Dubbo &#25552;&#20379;&#20102;&#20016;&#23500;&#30340;&#37197;&#32622;&#65292;&#29992;&#20110;&#35843;&#25972;&#21644;&#20248;&#21270;&#26694;&#26550;&#34892;&#20026;&#65292;&#24615;&#33021;&#31561;&#12290;Dubbo &#22312;&#24341;&#29992;&#25110;&#23548;&#20986;&#26381;&#21153;&#26102;&#65292;&#39318;&#20808;&#20250;&#23545;&#36825;&#20123;&#37197;&#32622;&#36827;&#34892;&#26816;&#26597;&#21644;&#22788;&#29702;&#65292;&#20197;&#20445;&#35777;&#37197;&#32622;&#30340;&#27491;&#30830;&#24615;&#12290;&#37197;&#32622;&#35299;&#26512;&#36923;&#36753;&#23553;&#35013;&#22312; ReferenceConfig &#30340; init &#26041;&#27861;&#20013;&#65292;&#19979;&#38754;&#36827;&#34892;&#20998;&#26512;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u081dcc64">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="1c2acf0b">private void init() {
    // &#36991;&#20813;&#37325;&#22797;&#21021;&#22987;&#21270;
    if (initialized) {
        return;
    }
    initialized = true;
    // &#26816;&#27979;&#25509;&#21475;&#21517;&#21512;&#27861;&#24615;
    if (interfaceName == null || interfaceName.length() == 0) {
        throw new IllegalStateException("interface not allow null!");
    }

    // &#26816;&#27979; consumer &#21464;&#37327;&#26159;&#21542;&#20026;&#31354;&#65292;&#20026;&#31354;&#21017;&#21019;&#24314;
    checkDefault();
    appendProperties(this);
    if (getGeneric() == null &amp;&amp; getConsumer() != null) {
        // &#35774;&#32622; generic
        setGeneric(getConsumer().getGeneric());
    }

    // &#26816;&#27979;&#26159;&#21542;&#20026;&#27867;&#21270;&#25509;&#21475;
    if (ProtocolUtils.isGeneric(getGeneric())) {
        interfaceClass = GenericService.class;
    } else {
        try {
            // &#21152;&#36733;&#31867;
            interfaceClass = Class.forName(interfaceName, true, Thread.currentThread()
                    .getContextClassLoader());
        } catch (ClassNotFoundException e) {
            throw new IllegalStateException(e.getMessage(), e);
        }
        checkInterfaceAndMethods(interfaceClass, methods);
    }
    
    // -------------------------------&#10024; &#20998;&#21106;&#32447;1 &#10024;------------------------------

    // &#20174;&#31995;&#32479;&#21464;&#37327;&#20013;&#33719;&#21462;&#19982;&#25509;&#21475;&#21517;&#23545;&#24212;&#30340;&#23646;&#24615;&#20540;
    String resolve = System.getProperty(interfaceName);
    String resolveFile = null;
    if (resolve == null || resolve.length() == 0) {
        // &#20174;&#31995;&#32479;&#23646;&#24615;&#20013;&#33719;&#21462;&#35299;&#26512;&#25991;&#20214;&#36335;&#24452;
        resolveFile = System.getProperty("dubbo.resolve.file");
        if (resolveFile == null || resolveFile.length() == 0) {
            // &#20174;&#25351;&#23450;&#20301;&#32622;&#21152;&#36733;&#37197;&#32622;&#25991;&#20214;
            File userResolveFile = new File(new File(System.getProperty("user.home")), "dubbo-resolve.properties");
            if (userResolveFile.exists()) {
                // &#33719;&#21462;&#25991;&#20214;&#32477;&#23545;&#36335;&#24452;
                resolveFile = userResolveFile.getAbsolutePath();
            }
        }
        if (resolveFile != null &amp;&amp; resolveFile.length() &gt; 0) {
            Properties properties = new Properties();
            FileInputStream fis = null;
            try {
                fis = new FileInputStream(new File(resolveFile));
                // &#20174;&#25991;&#20214;&#20013;&#21152;&#36733;&#37197;&#32622;
                properties.load(fis);
            } catch (IOException e) {
                throw new IllegalStateException("Unload ..., cause:...");
            } finally {
                try {
                    if (null != fis) fis.close();
                } catch (IOException e) {
                    logger.warn(e.getMessage(), e);
                }
            }
            // &#33719;&#21462;&#19982;&#25509;&#21475;&#21517;&#23545;&#24212;&#30340;&#37197;&#32622;
            resolve = properties.getProperty(interfaceName);
        }
    }
    if (resolve != null &amp;&amp; resolve.length() &gt; 0) {
        // &#23558; resolve &#36171;&#20540;&#32473; url
        url = resolve;
    }
    
    // -------------------------------&#10024; &#20998;&#21106;&#32447;2 &#10024;------------------------------
    if (consumer != null) {
        if (application == null) {
            // &#20174; consumer &#20013;&#33719;&#21462; Application &#23454;&#20363;&#65292;&#19979;&#21516;
            application = consumer.getApplication();
        }
        if (module == null) {
            module = consumer.getModule();
        }
        if (registries == null) {
            registries = consumer.getRegistries();
        }
        if (monitor == null) {
            monitor = consumer.getMonitor();
        }
    }
    if (module != null) {
        if (registries == null) {
            registries = module.getRegistries();
        }
        if (monitor == null) {
            monitor = module.getMonitor();
        }
    }
    if (application != null) {
        if (registries == null) {
            registries = application.getRegistries();
        }
        if (monitor == null) {
            monitor = application.getMonitor();
        }
    }
    
    // &#26816;&#27979; Application &#21512;&#27861;&#24615;
    checkApplication();
    // &#26816;&#27979;&#26412;&#22320;&#23384;&#26681;&#37197;&#32622;&#21512;&#27861;&#24615;
    checkStubAndMock(interfaceClass);
    
	// -------------------------------&#10024; &#20998;&#21106;&#32447;3 &#10024;------------------------------
    
    Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();
    Map&lt;Object, Object&gt; attributes = new HashMap&lt;Object, Object&gt;();

    // &#28155;&#21152; side&#12289;&#21327;&#35758;&#29256;&#26412;&#20449;&#24687;&#12289;&#26102;&#38388;&#25139;&#21644;&#36827;&#31243;&#21495;&#31561;&#20449;&#24687;&#21040; map &#20013;
    map.put(Constants.SIDE_KEY, Constants.CONSUMER_SIDE);
    map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());
    map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));
    if (ConfigUtils.getPid() &gt; 0) {
        map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));
    }

    // &#38750;&#27867;&#21270;&#26381;&#21153;
    if (!isGeneric()) {
        // &#33719;&#21462;&#29256;&#26412;
        String revision = Version.getVersion(interfaceClass, version);
        if (revision != null &amp;&amp; revision.length() &gt; 0) {
            map.put("revision", revision);
        }

        // &#33719;&#21462;&#25509;&#21475;&#26041;&#27861;&#21015;&#34920;&#65292;&#24182;&#28155;&#21152;&#21040; map &#20013;
        String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();
        if (methods.length == 0) {
            map.put("methods", Constants.ANY_VALUE);
        } else {
            map.put("methods", StringUtils.join(new HashSet&lt;String&gt;(Arrays.asList(methods)), ","));
        }
    }
    map.put(Constants.INTERFACE_KEY, interfaceName);
    // &#23558; ApplicationConfig&#12289;ConsumerConfig&#12289;ReferenceConfig &#31561;&#23545;&#35937;&#30340;&#23383;&#27573;&#20449;&#24687;&#28155;&#21152;&#21040; map &#20013;
    appendParameters(map, application);
    appendParameters(map, module);
    appendParameters(map, consumer, Constants.DEFAULT_KEY);
    appendParameters(map, this);
    
	// -------------------------------&#10024; &#20998;&#21106;&#32447;4 &#10024;------------------------------
    
    String prefix = StringUtils.getServiceKey(map);
    if (methods != null &amp;&amp; !methods.isEmpty()) {
        // &#36941;&#21382; MethodConfig &#21015;&#34920;
        for (MethodConfig method : methods) {
            appendParameters(map, method, method.getName());
            String retryKey = method.getName() + ".retry";
            // &#26816;&#27979; map &#26159;&#21542;&#21253;&#21547; methodName.retry
            if (map.containsKey(retryKey)) {
                String retryValue = map.remove(retryKey);
                if ("false".equals(retryValue)) {
                    // &#28155;&#21152;&#37325;&#35797;&#27425;&#25968;&#37197;&#32622; methodName.retries
                    map.put(method.getName() + ".retries", "0");
                }
            }
 
            // &#28155;&#21152; MethodConfig &#20013;&#30340;&#8220;&#23646;&#24615;&#8221;&#23383;&#27573;&#21040; attributes
            // &#27604;&#22914; onreturn&#12289;onthrow&#12289;oninvoke &#31561;
            appendAttributes(attributes, method, prefix + "." + method.getName());
            checkAndConvertImplicitConfig(method, map, attributes);
        }
    }
    
	// -------------------------------&#10024; &#20998;&#21106;&#32447;5 &#10024;------------------------------

    // &#33719;&#21462;&#26381;&#21153;&#28040;&#36153;&#32773; ip &#22320;&#22336;
    String hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY);
    if (hostToRegistry == null || hostToRegistry.length() == 0) {
        hostToRegistry = NetUtils.getLocalHost();
    } else if (isInvalidLocalHost(hostToRegistry)) {
        throw new IllegalArgumentException("Specified invalid registry ip from property..." );
    }
    map.put(Constants.REGISTER_IP_KEY, hostToRegistry);

    // &#23384;&#20648; attributes &#21040;&#31995;&#32479;&#19978;&#19979;&#25991;&#20013;
    StaticContext.getSystemContext().putAll(attributes);

    // &#21019;&#24314;&#20195;&#29702;&#31867;
    ref = createProxy(map);

    // &#26681;&#25454;&#26381;&#21153;&#21517;&#65292;ReferenceConfig&#65292;&#20195;&#29702;&#31867;&#26500;&#24314; ConsumerModel&#65292;
    // &#24182;&#23558; ConsumerModel &#23384;&#20837;&#21040; ApplicationModel &#20013;
    ConsumerModel consumerModel = new ConsumerModel(getUniqueServiceName(), this, ref, interfaceClass.getMethods());
    ApplicationModel.initConsumerModel(getUniqueServiceName(), consumerModel);
}</pre>
 <p class="ne-p" id="u9b523225">
  <br>
 </p>
 <p class="ne-p" id="u5ce03abf">
  <span class="ne-text">
   &#19978;&#38754;&#30340;&#20195;&#30721;&#24456;&#38271;&#65292;&#20570;&#30340;&#20107;&#24773;&#27604;&#36739;&#22810;&#12290;&#36825;&#37324;&#26681;&#25454;&#20195;&#30721;&#36923;&#36753;&#65292;&#23545;&#20195;&#30721;&#36827;&#34892;&#20102;&#20998;&#22359;&#65292;&#19979;&#38754;&#25105;&#20204;&#19968;&#36215;&#26469;&#30475;&#19968;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ub0ddb1ac">
  <br>
 </p>
 <p class="ne-p" id="ucee6b678">
  <span class="ne-text">
   &#39318;&#20808;&#26159;&#26041;&#27861;&#24320;&#22987;&#21040;&#20998;&#21106;&#32447;1&#20043;&#38388;&#30340;&#20195;&#30721;&#12290;&#36825;&#27573;&#20195;&#30721;&#20027;&#35201;&#29992;&#20110;&#26816;&#27979; ConsumerConfig &#23454;&#20363;&#26159;&#21542;&#23384;&#22312;&#65292;&#22914;&#19981;&#23384;&#22312;&#21017;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340;&#23454;&#20363;&#65292;&#28982;&#21518;&#36890;&#36807;&#31995;&#32479;&#21464;&#37327;&#25110; dubbo.properties &#37197;&#32622;&#25991;&#20214;&#22635;&#20805; ConsumerConfig &#30340;&#23383;&#27573;&#12290;&#25509;&#30528;&#26159;&#26816;&#27979;&#27867;&#21270;&#37197;&#32622;&#65292;&#24182;&#26681;&#25454;&#37197;&#32622;&#35774;&#32622; interfaceClass &#30340;&#20540;&#12290;&#25509;&#30528;&#26469;&#30475;&#20998;&#21106;&#32447;1&#21040;&#20998;&#21106;&#32447;2&#20043;&#38388;&#30340;&#36923;&#36753;&#12290;&#36825;&#27573;&#36923;&#36753;&#29992;&#20110;&#20174;&#31995;&#32479;&#23646;&#24615;&#25110;&#37197;&#32622;&#25991;&#20214;&#20013;&#21152;&#36733;&#19982;&#25509;&#21475;&#21517;&#30456;&#23545;&#24212;&#30340;&#37197;&#32622;&#65292;&#24182;&#23558;&#35299;&#26512;&#32467;&#26524;&#36171;&#20540;&#32473; url &#23383;&#27573;&#12290;url &#23383;&#27573;&#30340;&#20316;&#29992;&#19968;&#33324;&#26159;&#29992;&#20110;&#28857;&#23545;&#28857;&#35843;&#29992;&#12290;&#32487;&#32493;&#21521;&#19979;&#30475;&#65292;&#20998;&#21106;&#32447;2&#21644;&#20998;&#21106;&#32447;3&#20043;&#38388;&#30340;&#20195;&#30721;&#29992;&#20110;&#26816;&#27979;&#20960;&#20010;&#26680;&#24515;&#37197;&#32622;&#31867;&#26159;&#21542;&#20026;&#31354;&#65292;&#20026;&#31354;&#21017;&#23581;&#35797;&#20174;&#20854;&#20182;&#37197;&#32622;&#31867;&#20013;&#33719;&#21462;&#12290;&#20998;&#21106;&#32447;3&#19982;&#20998;&#21106;&#32447;4&#20043;&#38388;&#30340;&#20195;&#30721;&#20027;&#35201;&#29992;&#20110;&#25910;&#38598;&#21508;&#31181;&#37197;&#32622;&#65292;&#24182;&#23558;&#37197;&#32622;&#23384;&#20648;&#21040; map &#20013;&#12290;&#20998;&#21106;&#32447;4&#21644;&#20998;&#21106;&#32447;5&#20043;&#38388;&#30340;&#20195;&#30721;&#29992;&#20110;&#22788;&#29702; MethodConfig &#23454;&#20363;&#12290;&#35813;&#23454;&#20363;&#21253;&#21547;&#20102;&#20107;&#20214;&#36890;&#30693;&#37197;&#32622;&#65292;&#27604;&#22914; onreturn&#12289;onthrow&#12289;oninvoke &#31561;&#12290;&#20998;&#21106;&#32447;5&#21040;&#26041;&#27861;&#32467;&#23614;&#30340;&#20195;&#30721;&#20027;&#35201;&#29992;&#20110;&#35299;&#26512;&#26381;&#21153;&#28040;&#36153;&#32773; ip&#65292;&#20197;&#21450;&#35843;&#29992; createProxy &#21019;&#24314;&#20195;&#29702;&#23545;&#35937;&#12290;&#20851;&#20110;&#35813;&#26041;&#27861;&#30340;&#35814;&#32454;&#20998;&#26512;&#65292;&#23558;&#20250;&#22312;&#25509;&#19979;&#26469;&#30340;&#31456;&#33410;&#20013;&#23637;&#24320;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u26d09643">
  <br>
 </p>
 <h3 id="72edc8bd">
  <span class="ne-text">
   3.2 &#24341;&#29992;&#26381;&#21153;
  </span>
 </h3>
 <p class="ne-p" id="u23f747f0">
  <br>
 </p>
 <p class="ne-p" id="udb18b688">
  <span class="ne-text">
   &#26412;&#33410;&#25105;&#20204;&#35201;&#20174; createProxy &#24320;&#22987;&#30475;&#36215;&#12290;&#20174;&#23383;&#38754;&#24847;&#24605;&#19978;&#26469;&#30475;&#65292;createProxy &#20284;&#20046;&#21482;&#26159;&#29992;&#20110;&#21019;&#24314;&#20195;&#29702;&#23545;&#35937;&#30340;&#12290;&#20294;&#23454;&#38469;&#19978;&#24182;&#38750;&#22914;&#27492;&#65292;&#35813;&#26041;&#27861;&#36824;&#20250;&#35843;&#29992;&#20854;&#20182;&#26041;&#27861;&#26500;&#24314;&#20197;&#21450;&#21512;&#24182; Invoker &#23454;&#20363;&#12290;&#20855;&#20307;&#32454;&#33410;&#22914;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u617594f2">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="59fc7009">private T createProxy(Map&lt;String, String&gt; map) {
    URL tmpUrl = new URL("temp", "localhost", 0, map);
    final boolean isJvmRefer;
    if (isInjvm() == null) {
        // url &#37197;&#32622;&#34987;&#25351;&#23450;&#65292;&#21017;&#19981;&#20570;&#26412;&#22320;&#24341;&#29992;
        if (url != null &amp;&amp; url.length() &gt; 0) {
            isJvmRefer = false;
        // &#26681;&#25454; url &#30340;&#21327;&#35758;&#12289;scope &#20197;&#21450; injvm &#31561;&#21442;&#25968;&#26816;&#27979;&#26159;&#21542;&#38656;&#35201;&#26412;&#22320;&#24341;&#29992;
        // &#27604;&#22914;&#22914;&#26524;&#29992;&#25143;&#26174;&#24335;&#37197;&#32622;&#20102; scope=local&#65292;&#27492;&#26102; isInjvmRefer &#36820;&#22238; true
        } else if (InjvmProtocol.getInjvmProtocol().isInjvmRefer(tmpUrl)) {
            isJvmRefer = true;
        } else {
            isJvmRefer = false;
        }
    } else {
        // &#33719;&#21462; injvm &#37197;&#32622;&#20540;
        isJvmRefer = isInjvm().booleanValue();
    }

    // &#26412;&#22320;&#24341;&#29992;
    if (isJvmRefer) {
        // &#29983;&#25104;&#26412;&#22320;&#24341;&#29992; URL&#65292;&#21327;&#35758;&#20026; injvm
        URL url = new URL(Constants.LOCAL_PROTOCOL, NetUtils.LOCALHOST, 0, interfaceClass.getName()).addParameters(map);
        // &#35843;&#29992; refer &#26041;&#27861;&#26500;&#24314; InjvmInvoker &#23454;&#20363;
        invoker = refprotocol.refer(interfaceClass, url);
        
    // &#36828;&#31243;&#24341;&#29992;
    } else {
        // url &#19981;&#20026;&#31354;&#65292;&#34920;&#26126;&#29992;&#25143;&#21487;&#33021;&#24819;&#36827;&#34892;&#28857;&#23545;&#28857;&#35843;&#29992;
        if (url != null &amp;&amp; url.length() &gt; 0) {
            // &#24403;&#38656;&#35201;&#37197;&#32622;&#22810;&#20010; url &#26102;&#65292;&#21487;&#29992;&#20998;&#21495;&#36827;&#34892;&#20998;&#21106;&#65292;&#36825;&#37324;&#20250;&#36827;&#34892;&#20999;&#20998;
            String[] us = Constants.SEMICOLON_SPLIT_PATTERN.split(url);
            if (us != null &amp;&amp; us.length &gt; 0) {
                for (String u : us) {
                    URL url = URL.valueOf(u);
                    if (url.getPath() == null || url.getPath().length() == 0) {
                        // &#35774;&#32622;&#25509;&#21475;&#20840;&#38480;&#23450;&#21517;&#20026; url &#36335;&#24452;
                        url = url.setPath(interfaceName);
                    }
                    
                    // &#26816;&#27979; url &#21327;&#35758;&#26159;&#21542;&#20026; registry&#65292;&#33509;&#26159;&#65292;&#34920;&#26126;&#29992;&#25143;&#24819;&#20351;&#29992;&#25351;&#23450;&#30340;&#27880;&#20876;&#20013;&#24515;
                    if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {
                        // &#23558; map &#36716;&#25442;&#20026;&#26597;&#35810;&#23383;&#31526;&#20018;&#65292;&#24182;&#20316;&#20026; refer &#21442;&#25968;&#30340;&#20540;&#28155;&#21152;&#21040; url &#20013;
                        urls.add(url.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));
                    } else {
                        // &#21512;&#24182; url&#65292;&#31227;&#38500;&#26381;&#21153;&#25552;&#20379;&#32773;&#30340;&#19968;&#20123;&#37197;&#32622;&#65288;&#36825;&#20123;&#37197;&#32622;&#26469;&#28304;&#20110;&#29992;&#25143;&#37197;&#32622;&#30340; url &#23646;&#24615;&#65289;&#65292;
                        // &#27604;&#22914;&#32447;&#31243;&#27744;&#30456;&#20851;&#37197;&#32622;&#12290;&#24182;&#20445;&#30041;&#26381;&#21153;&#25552;&#20379;&#32773;&#30340;&#37096;&#20998;&#37197;&#32622;&#65292;&#27604;&#22914;&#29256;&#26412;&#65292;group&#65292;&#26102;&#38388;&#25139;&#31561;
                        // &#26368;&#21518;&#23558;&#21512;&#24182;&#21518;&#30340;&#37197;&#32622;&#35774;&#32622;&#20026; url &#26597;&#35810;&#23383;&#31526;&#20018;&#20013;&#12290;
                        urls.add(ClusterUtils.mergeUrl(url, map));
                    }
                }
            }
        } else {
            // &#21152;&#36733;&#27880;&#20876;&#20013;&#24515; url
            List&lt;URL&gt; us = loadRegistries(false);
            if (us != null &amp;&amp; !us.isEmpty()) {
                for (URL u : us) {
                    URL monitorUrl = loadMonitor(u);
                    if (monitorUrl != null) {
                        map.put(Constants.MONITOR_KEY, URL.encode(monitorUrl.toFullString()));
                    }
                    // &#28155;&#21152; refer &#21442;&#25968;&#21040; url &#20013;&#65292;&#24182;&#23558; url &#28155;&#21152;&#21040; urls &#20013;
                    urls.add(u.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));
                }
            }

            // &#26410;&#37197;&#32622;&#27880;&#20876;&#20013;&#24515;&#65292;&#25243;&#20986;&#24322;&#24120;
            if (urls.isEmpty()) {
                throw new IllegalStateException("No such any registry to reference...");
            }
        }

        // &#21333;&#20010;&#27880;&#20876;&#20013;&#24515;&#25110;&#26381;&#21153;&#25552;&#20379;&#32773;(&#26381;&#21153;&#30452;&#36830;&#65292;&#19979;&#21516;)
        if (urls.size() == 1) {
            // &#35843;&#29992; RegistryProtocol &#30340; refer &#26500;&#24314; Invoker &#23454;&#20363;
            invoker = refprotocol.refer(interfaceClass, urls.get(0));
            
        // &#22810;&#20010;&#27880;&#20876;&#20013;&#24515;&#25110;&#22810;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#65292;&#25110;&#32773;&#20004;&#32773;&#28151;&#21512;
        } else {
            List&lt;Invoker&lt;?&gt;&gt; invokers = new ArrayList&lt;Invoker&lt;?&gt;&gt;();
            URL registryURL = null;

            // &#33719;&#21462;&#25152;&#26377;&#30340; Invoker
            for (URL url : urls) {
                // &#36890;&#36807; refprotocol &#35843;&#29992; refer &#26500;&#24314; Invoker&#65292;refprotocol &#20250;&#22312;&#36816;&#34892;&#26102;
                // &#26681;&#25454; url &#21327;&#35758;&#22836;&#21152;&#36733;&#25351;&#23450;&#30340; Protocol &#23454;&#20363;&#65292;&#24182;&#35843;&#29992;&#23454;&#20363;&#30340; refer &#26041;&#27861;
                invokers.add(refprotocol.refer(interfaceClass, url));
                if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {
                    registryURL = url;
                }
            }
            if (registryURL != null) {
                // &#22914;&#26524;&#27880;&#20876;&#20013;&#24515;&#38142;&#25509;&#19981;&#20026;&#31354;&#65292;&#21017;&#23558;&#20351;&#29992; AvailableCluster
                URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME);
                // &#21019;&#24314; StaticDirectory &#23454;&#20363;&#65292;&#24182;&#30001; Cluster &#23545;&#22810;&#20010; Invoker &#36827;&#34892;&#21512;&#24182;
                invoker = cluster.join(new StaticDirectory(u, invokers));
            } else {
                invoker = cluster.join(new StaticDirectory(invokers));
            }
        }
    }

    Boolean c = check;
    if (c == null &amp;&amp; consumer != null) {
        c = consumer.isCheck();
    }
    if (c == null) {
        c = true;
    }
    
    // invoker &#21487;&#29992;&#24615;&#26816;&#26597;
    if (c &amp;&amp; !invoker.isAvailable()) {
        throw new IllegalStateException("No provider available for the service...");
    }

    // &#29983;&#25104;&#20195;&#29702;&#31867;
    return (T) proxyFactory.getProxy(invoker);
}</pre>
 <p class="ne-p" id="u16042dc5">
  <br>
 </p>
 <p class="ne-p" id="uefeff291">
  <span class="ne-text">
   &#19978;&#38754;&#20195;&#30721;&#24456;&#22810;&#65292;&#19981;&#36807;&#36923;&#36753;&#27604;&#36739;&#28165;&#26224;&#12290;&#39318;&#20808;&#26681;&#25454;&#37197;&#32622;&#26816;&#26597;&#26159;&#21542;&#20026;&#26412;&#22320;&#35843;&#29992;&#65292;&#33509;&#26159;&#65292;&#21017;&#35843;&#29992; InjvmProtocol &#30340; refer &#26041;&#27861;&#29983;&#25104; InjvmInvoker &#23454;&#20363;&#12290;&#33509;&#19981;&#26159;&#65292;&#21017;&#35835;&#21462;&#30452;&#36830;&#37197;&#32622;&#39033;&#65292;&#25110;&#27880;&#20876;&#20013;&#24515; url&#65292;&#24182;&#23558;&#35835;&#21462;&#21040;&#30340; url &#23384;&#20648;&#21040; urls &#20013;&#12290;&#28982;&#21518;&#26681;&#25454; urls &#20803;&#32032;&#25968;&#37327;&#36827;&#34892;&#21518;&#32493;&#25805;&#20316;&#12290;&#33509; urls &#20803;&#32032;&#25968;&#37327;&#20026;1&#65292;&#21017;&#30452;&#25509;&#36890;&#36807; Protocol &#33258;&#36866;&#24212;&#25299;&#23637;&#31867;&#26500;&#24314; Invoker &#23454;&#20363;&#25509;&#21475;&#12290;&#33509; urls &#20803;&#32032;&#25968;&#37327;&#22823;&#20110;1&#65292;&#21363;&#23384;&#22312;&#22810;&#20010;&#27880;&#20876;&#20013;&#24515;&#25110;&#26381;&#21153;&#30452;&#36830; url&#65292;&#27492;&#26102;&#20808;&#26681;&#25454; url &#26500;&#24314; Invoker&#12290;&#28982;&#21518;&#20877;&#36890;&#36807; Cluster &#21512;&#24182;&#22810;&#20010; Invoker&#65292;&#26368;&#21518;&#35843;&#29992; ProxyFactory &#29983;&#25104;&#20195;&#29702;&#31867;&#12290;Invoker &#30340;&#26500;&#24314;&#36807;&#31243;&#20197;&#21450;&#20195;&#29702;&#31867;&#30340;&#36807;&#31243;&#27604;&#36739;&#37325;&#35201;&#65292;&#22240;&#27492;&#25509;&#19979;&#26469;&#23558;&#20998;&#20004;&#23567;&#33410;&#23545;&#36825;&#20004;&#20010;&#36807;&#31243;&#36827;&#34892;&#20998;&#26512;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ufd9827ab">
  <br>
 </p>
 <h4 id="7835d482">
  <span class="ne-text">
   3.2.1 &#21019;&#24314; Invoker
  </span>
 </h4>
 <p class="ne-p" id="u9fe7ef93">
  <br>
 </p>
 <p class="ne-p" id="u1c44aa8f">
  <span class="ne-text">
   Invoker &#26159; Dubbo &#30340;&#26680;&#24515;&#27169;&#22411;&#65292;&#20195;&#34920;&#19968;&#20010;&#21487;&#25191;&#34892;&#20307;&#12290;&#22312;&#26381;&#21153;&#25552;&#20379;&#26041;&#65292;Invoker &#29992;&#20110;&#35843;&#29992;&#26381;&#21153;&#25552;&#20379;&#31867;&#12290;&#22312;&#26381;&#21153;&#28040;&#36153;&#26041;&#65292;Invoker &#29992;&#20110;&#25191;&#34892;&#36828;&#31243;&#35843;&#29992;&#12290;Invoker &#26159;&#30001; Protocol &#23454;&#29616;&#31867;&#26500;&#24314;&#32780;&#26469;&#12290;Protocol &#23454;&#29616;&#31867;&#26377;&#24456;&#22810;&#65292;&#26412;&#33410;&#20250;&#20998;&#26512;&#26368;&#24120;&#29992;&#30340;&#20004;&#20010;&#65292;&#20998;&#21035;&#26159; RegistryProtocol &#21644; DubboProtocol&#65292;&#20854;&#20182;&#30340;&#22823;&#23478;&#33258;&#34892;&#20998;&#26512;&#12290;&#19979;&#38754;&#20808;&#26469;&#20998;&#26512; DubboProtocol &#30340; refer &#26041;&#27861;&#28304;&#30721;&#12290;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u5f12db4a">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="53c3ecdb">public &lt;T&gt; Invoker&lt;T&gt; refer(Class&lt;T&gt; serviceType, URL url) throws RpcException {
    optimizeSerialization(url);
    // &#21019;&#24314; DubboInvoker
    DubboInvoker&lt;T&gt; invoker = new DubboInvoker&lt;T&gt;(serviceType, url, getClients(url), invokers);
    invokers.add(invoker);
    return invoker;
}</pre>
 <p class="ne-p" id="u6314f539">
  <br>
 </p>
 <p class="ne-p" id="u11720cc0">
  <span class="ne-text">
   &#19978;&#38754;&#26041;&#27861;&#30475;&#36215;&#26469;&#27604;&#36739;&#31616;&#21333;&#65292;&#19981;&#36807;&#36825;&#37324;&#26377;&#19968;&#20010;&#35843;&#29992;&#38656;&#35201;&#25105;&#20204;&#27880;&#24847;&#19968;&#19979;&#65292;&#21363; getClients&#12290;&#36825;&#20010;&#26041;&#27861;&#29992;&#20110;&#33719;&#21462;&#23458;&#25143;&#31471;&#23454;&#20363;&#65292;&#23454;&#20363;&#31867;&#22411;&#20026; ExchangeClient&#12290;ExchangeClient &#23454;&#38469;&#19978;&#24182;&#19981;&#20855;&#22791;&#36890;&#20449;&#33021;&#21147;&#65292;&#23427;&#38656;&#35201;&#22522;&#20110;&#26356;&#24213;&#23618;&#30340;&#23458;&#25143;&#31471;&#23454;&#20363;&#36827;&#34892;&#36890;&#20449;&#12290;&#27604;&#22914; NettyClient&#12289;MinaClient &#31561;&#65292;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;Dubbo &#20351;&#29992; NettyClient &#36827;&#34892;&#36890;&#20449;&#12290;&#25509;&#19979;&#26469;&#65292;&#25105;&#20204;&#31616;&#21333;&#30475;&#19968;&#19979; getClients &#26041;&#27861;&#30340;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u68bd8f38">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="b90bdcee">private ExchangeClient[] getClients(URL url) {
    // &#26159;&#21542;&#20849;&#20139;&#36830;&#25509;
    boolean service_share_connect = false;
  	// &#33719;&#21462;&#36830;&#25509;&#25968;&#65292;&#40664;&#35748;&#20026;0&#65292;&#34920;&#31034;&#26410;&#37197;&#32622;
    int connections = url.getParameter(Constants.CONNECTIONS_KEY, 0);
    // &#22914;&#26524;&#26410;&#37197;&#32622; connections&#65292;&#21017;&#20849;&#20139;&#36830;&#25509;
    if (connections == 0) {
        service_share_connect = true;
        connections = 1;
    }

    ExchangeClient[] clients = new ExchangeClient[connections];
    for (int i = 0; i &lt; clients.length; i++) {
        if (service_share_connect) {
            // &#33719;&#21462;&#20849;&#20139;&#23458;&#25143;&#31471;
            clients[i] = getSharedClient(url);
        } else {
            // &#21021;&#22987;&#21270;&#26032;&#30340;&#23458;&#25143;&#31471;
            clients[i] = initClient(url);
        }
    }
    return clients;
}</pre>
 <p class="ne-p" id="u16f8edf0">
  <br>
 </p>
 <p class="ne-p" id="u57daa438">
  <span class="ne-text">
   &#36825;&#37324;&#26681;&#25454; connections &#25968;&#37327;&#20915;&#23450;&#26159;&#33719;&#21462;&#20849;&#20139;&#23458;&#25143;&#31471;&#36824;&#26159;&#21019;&#24314;&#26032;&#30340;&#23458;&#25143;&#31471;&#23454;&#20363;&#65292;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#20351;&#29992;&#20849;&#20139;&#23458;&#25143;&#31471;&#23454;&#20363;&#12290;getSharedClient &#26041;&#27861;&#20013;&#20063;&#20250;&#35843;&#29992; initClient &#26041;&#27861;&#65292;&#22240;&#27492;&#19979;&#38754;&#25105;&#20204;&#19968;&#36215;&#30475;&#19968;&#19979;&#36825;&#20004;&#20010;&#26041;&#27861;&#12290;
  </span>
 </p>
 <p class="ne-p" id="uefef17e4">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="51967fce">private ExchangeClient getSharedClient(URL url) {
    String key = url.getAddress();
    // &#33719;&#21462;&#24102;&#26377;&#8220;&#24341;&#29992;&#35745;&#25968;&#8221;&#21151;&#33021;&#30340; ExchangeClient
    ReferenceCountExchangeClient client = referenceClientMap.get(key);
    if (client != null) {
        if (!client.isClosed()) {
            // &#22686;&#21152;&#24341;&#29992;&#35745;&#25968;
            client.incrementAndGetCount();
            return client;
        } else {
            referenceClientMap.remove(key);
        }
    }

    locks.putIfAbsent(key, new Object());
    synchronized (locks.get(key)) {
        if (referenceClientMap.containsKey(key)) {
            return referenceClientMap.get(key);
        }

        // &#21019;&#24314; ExchangeClient &#23458;&#25143;&#31471;
        ExchangeClient exchangeClient = initClient(url);
        // &#23558; ExchangeClient &#23454;&#20363;&#20256;&#32473; ReferenceCountExchangeClient&#65292;&#36825;&#37324;&#20351;&#29992;&#20102;&#35013;&#39280;&#27169;&#24335;
        client = new ReferenceCountExchangeClient(exchangeClient, ghostClientMap);
        referenceClientMap.put(key, client);
        ghostClientMap.remove(key);
        locks.remove(key);
        return client;
    }
}</pre>
 <p class="ne-p" id="uf8ff596c">
  <br>
 </p>
 <p class="ne-p" id="uf97d247b">
  <span class="ne-text">
   &#19978;&#38754;&#26041;&#27861;&#20808;&#35775;&#38382;&#32531;&#23384;&#65292;&#33509;&#32531;&#23384;&#26410;&#21629;&#20013;&#65292;&#21017;&#36890;&#36807; initClient &#26041;&#27861;&#21019;&#24314;&#26032;&#30340; ExchangeClient &#23454;&#20363;&#65292;&#24182;&#23558;&#35813;&#23454;&#20363;&#20256;&#32473; ReferenceCountExchangeClient &#26500;&#36896;&#26041;&#27861;&#21019;&#24314;&#19968;&#20010;&#24102;&#26377;&#24341;&#29992;&#35745;&#25968;&#21151;&#33021;&#30340; ExchangeClient &#23454;&#20363;&#12290;ReferenceCountExchangeClient &#20869;&#37096;&#23454;&#29616;&#27604;&#36739;&#31616;&#21333;&#65292;&#23601;&#19981;&#20998;&#26512;&#20102;&#12290;&#19979;&#38754;&#25105;&#20204;&#20877;&#26469;&#30475;&#19968;&#19979; initClient &#26041;&#27861;&#30340;&#20195;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ua91afe71">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="77330b7f">private ExchangeClient initClient(URL url) {

    // &#33719;&#21462;&#23458;&#25143;&#31471;&#31867;&#22411;&#65292;&#40664;&#35748;&#20026; netty
    String str = url.getParameter(Constants.CLIENT_KEY, url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_CLIENT));

    // &#28155;&#21152;&#32534;&#35299;&#30721;&#21644;&#24515;&#36339;&#21253;&#21442;&#25968;&#21040; url &#20013;
    url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);
    url = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));

    // &#26816;&#27979;&#23458;&#25143;&#31471;&#31867;&#22411;&#26159;&#21542;&#23384;&#22312;&#65292;&#19981;&#23384;&#22312;&#21017;&#25243;&#20986;&#24322;&#24120;
    if (str != null &amp;&amp; str.length() &gt; 0 &amp;&amp; !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str)) {
        throw new RpcException("Unsupported client type: ...");
    }

    ExchangeClient client;
    try {
        // &#33719;&#21462; lazy &#37197;&#32622;&#65292;&#24182;&#26681;&#25454;&#37197;&#32622;&#20540;&#20915;&#23450;&#21019;&#24314;&#30340;&#23458;&#25143;&#31471;&#31867;&#22411;
        if (url.getParameter(Constants.LAZY_CONNECT_KEY, false)) {
            // &#21019;&#24314;&#25042;&#21152;&#36733; ExchangeClient &#23454;&#20363;
            client = new LazyConnectExchangeClient(url, requestHandler);
        } else {
            // &#21019;&#24314;&#26222;&#36890; ExchangeClient &#23454;&#20363;
            client = Exchangers.connect(url, requestHandler);
        }
    } catch (RemotingException e) {
        throw new RpcException("Fail to create remoting client for service...");
    }
    return client;
}</pre>
 <p class="ne-p" id="u6f05f7b5">
  <br>
 </p>
 <p class="ne-p" id="u1904e9e9">
  <span class="ne-text">
   initClient &#26041;&#27861;&#39318;&#20808;&#33719;&#21462;&#29992;&#25143;&#37197;&#32622;&#30340;&#23458;&#25143;&#31471;&#31867;&#22411;&#65292;&#40664;&#35748;&#20026; netty&#12290;&#28982;&#21518;&#26816;&#27979;&#29992;&#25143;&#37197;&#32622;&#30340;&#23458;&#25143;&#31471;&#31867;&#22411;&#26159;&#21542;&#23384;&#22312;&#65292;&#19981;&#23384;&#22312;&#21017;&#25243;&#20986;&#24322;&#24120;&#12290;&#26368;&#21518;&#26681;&#25454; lazy &#37197;&#32622;&#20915;&#23450;&#21019;&#24314;&#20160;&#20040;&#31867;&#22411;&#30340;&#23458;&#25143;&#31471;&#12290;&#36825;&#37324;&#30340; LazyConnectExchangeClient &#20195;&#30721;&#24182;&#19981;&#26159;&#24456;&#22797;&#26434;&#65292;&#35813;&#31867;&#20250;&#22312; request &#26041;&#27861;&#34987;&#35843;&#29992;&#26102;&#36890;&#36807; Exchangers &#30340; connect &#26041;&#27861;&#21019;&#24314; ExchangeClient &#23458;&#25143;&#31471;&#65292;&#35813;&#31867;&#30340;&#20195;&#30721;&#26412;&#33410;&#23601;&#19981;&#20998;&#26512;&#20102;&#12290;&#19979;&#38754;&#25105;&#20204;&#20998;&#26512;&#19968;&#19979; Exchangers &#30340; connect &#26041;&#27861;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u3c6e3b21">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="74fdbe7b">public static ExchangeClient connect(URL url, ExchangeHandler handler) throws RemotingException {
    if (url == null) {
        throw new IllegalArgumentException("url == null");
    }
    if (handler == null) {
        throw new IllegalArgumentException("handler == null");
    }
    url = url.addParameterIfAbsent(Constants.CODEC_KEY, "exchange");
    // &#33719;&#21462; Exchanger &#23454;&#20363;&#65292;&#40664;&#35748;&#20026; HeaderExchangeClient
    return getExchanger(url).connect(url, handler);
}</pre>
 <p class="ne-p" id="u09f4d920">
  <br>
 </p>
 <p class="ne-p" id="uf6bcbe08">
  <span class="ne-text">
   &#22914;&#19978;&#65292;getExchanger &#20250;&#36890;&#36807; SPI &#21152;&#36733; HeaderExchanger &#23454;&#20363;&#65292;&#36825;&#20010;&#26041;&#27861;&#27604;&#36739;&#31616;&#21333;&#65292;&#22823;&#23478;&#33258;&#24049;&#30475;&#19968;&#19979;&#21543;&#12290;&#25509;&#19979;&#26469;&#20998;&#26512; HeaderExchanger.connect &#30340;&#23454;&#29616;&#12290;
  </span>
 </p>
 <p class="ne-p" id="udad11422">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="56e0a116">public ExchangeClient connect(URL url, ExchangeHandler handler) throws RemotingException {
    // &#36825;&#37324;&#21253;&#21547;&#20102;&#22810;&#20010;&#35843;&#29992;&#65292;&#20998;&#21035;&#22914;&#19979;&#65306;
    // 1. &#21019;&#24314; HeaderExchangeHandler &#23545;&#35937;
    // 2. &#21019;&#24314; DecodeHandler &#23545;&#35937;
    // 3. &#36890;&#36807; Transporters &#26500;&#24314; Client &#23454;&#20363;
    // 4. &#21019;&#24314; HeaderExchangeClient &#23545;&#35937;
    return new HeaderExchangeClient(Transporters.connect(url, new DecodeHandler(new HeaderExchangeHandler(handler))), true);
}</pre>
 <p class="ne-p" id="ud1367700">
  <br>
 </p>
 <p class="ne-p" id="ue9579d69">
  <span class="ne-text">
   &#36825;&#37324;&#30340;&#35843;&#29992;&#27604;&#36739;&#22810;&#65292;&#25105;&#20204;&#36825;&#37324;&#37325;&#28857;&#30475;&#19968;&#19979; Transporters &#30340; connect &#26041;&#27861;&#12290;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u0c2383d1">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="db7519a8">public static Client connect(URL url, ChannelHandler... handlers) throws RemotingException {
    if (url == null) {
        throw new IllegalArgumentException("url == null");
    }
    ChannelHandler handler;
    if (handlers == null || handlers.length == 0) {
        handler = new ChannelHandlerAdapter();
    } else if (handlers.length == 1) {
        handler = handlers[0];
    } else {
        // &#22914;&#26524; handler &#25968;&#37327;&#22823;&#20110;1&#65292;&#21017;&#21019;&#24314;&#19968;&#20010; ChannelHandler &#20998;&#21457;&#22120;
        handler = new ChannelHandlerDispatcher(handlers);
    }
    
    // &#33719;&#21462; Transporter &#33258;&#36866;&#24212;&#25299;&#23637;&#31867;&#65292;&#24182;&#35843;&#29992; connect &#26041;&#27861;&#29983;&#25104; Client &#23454;&#20363;
    return getTransporter().connect(url, handler);
}</pre>
 <p class="ne-p" id="u864374c9">
  <br>
 </p>
 <p class="ne-p" id="u54e85699">
  <span class="ne-text">
   &#22914;&#19978;&#65292;getTransporter &#26041;&#27861;&#36820;&#22238;&#30340;&#26159;&#33258;&#36866;&#24212;&#25299;&#23637;&#31867;&#65292;&#35813;&#31867;&#20250;&#22312;&#36816;&#34892;&#26102;&#26681;&#25454;&#23458;&#25143;&#31471;&#31867;&#22411;&#21152;&#36733;&#25351;&#23450;&#30340; Transporter &#23454;&#29616;&#31867;&#12290;&#33509;&#29992;&#25143;&#26410;&#37197;&#32622;&#23458;&#25143;&#31471;&#31867;&#22411;&#65292;&#21017;&#40664;&#35748;&#21152;&#36733; NettyTransporter&#65292;&#24182;&#35843;&#29992;&#35813;&#31867;&#30340; connect &#26041;&#27861;&#12290;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u224d637a">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="914f3b39">public Client connect(URL url, ChannelHandler listener) throws RemotingException {
    // &#21019;&#24314; NettyClient &#23545;&#35937;
    return new NettyClient(url, listener);
}</pre>
 <p class="ne-p" id="uf8b48c0e">
  <br>
 </p>
 <p class="ne-p" id="u7508b7b0">
  <span class="ne-text">
   &#21040;&#36825;&#37324;&#23601;&#19981;&#32487;&#32493;&#36319;&#19979;&#21435;&#20102;&#65292;&#22312;&#24448;&#19979;&#23601;&#26159;&#36890;&#36807; Netty &#25552;&#20379;&#30340; API &#26500;&#24314; Netty &#23458;&#25143;&#31471;&#20102;&#65292;&#22823;&#23478;&#26377;&#20852;&#36259;&#33258;&#24049;&#30475;&#30475;&#12290;&#21040;&#36825;&#37324;&#65292;&#20851;&#20110; DubboProtocol &#30340; refer &#26041;&#27861;&#23601;&#20998;&#26512;&#23436;&#20102;&#12290;&#25509;&#19979;&#26469;&#65292;&#32487;&#32493;&#20998;&#26512; RegistryProtocol &#30340; refer &#26041;&#27861;&#36923;&#36753;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ufde2ac0f">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="d3cd73da">public &lt;T&gt; Invoker&lt;T&gt; refer(Class&lt;T&gt; type, URL url) throws RpcException {
    // &#21462; registry &#21442;&#25968;&#20540;&#65292;&#24182;&#23558;&#20854;&#35774;&#32622;&#20026;&#21327;&#35758;&#22836;
    url = url.setProtocol(url.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_REGISTRY)).removeParameter(Constants.REGISTRY_KEY);
    // &#33719;&#21462;&#27880;&#20876;&#20013;&#24515;&#23454;&#20363;
    Registry registry = registryFactory.getRegistry(url);
    if (RegistryService.class.equals(type)) {
        return proxyFactory.getInvoker((T) registry, type, url);
    }

    // &#23558; url &#26597;&#35810;&#23383;&#31526;&#20018;&#36716;&#20026; Map
    Map&lt;String, String&gt; qs = StringUtils.parseQueryString(url.getParameterAndDecoded(Constants.REFER_KEY));
    // &#33719;&#21462; group &#37197;&#32622;
    String group = qs.get(Constants.GROUP_KEY);
    if (group != null &amp;&amp; group.length() &gt; 0) {
        if ((Constants.COMMA_SPLIT_PATTERN.split(group)).length &gt; 1
                || "*".equals(group)) {
            // &#36890;&#36807; SPI &#21152;&#36733; MergeableCluster &#23454;&#20363;&#65292;&#24182;&#35843;&#29992; doRefer &#32487;&#32493;&#25191;&#34892;&#26381;&#21153;&#24341;&#29992;&#36923;&#36753;
            return doRefer(getMergeableCluster(), registry, type, url);
        }
    }
    
    // &#35843;&#29992; doRefer &#32487;&#32493;&#25191;&#34892;&#26381;&#21153;&#24341;&#29992;&#36923;&#36753;
    return doRefer(cluster, registry, type, url);
}</pre>
 <p class="ne-p" id="ub4b1f834">
  <br>
 </p>
 <p class="ne-p" id="ud86e9c7b">
  <span class="ne-text">
   &#19978;&#38754;&#20195;&#30721;&#39318;&#20808;&#20026; url &#35774;&#32622;&#21327;&#35758;&#22836;&#65292;&#28982;&#21518;&#26681;&#25454; url &#21442;&#25968;&#21152;&#36733;&#27880;&#20876;&#20013;&#24515;&#23454;&#20363;&#12290;&#28982;&#21518;&#33719;&#21462; group &#37197;&#32622;&#65292;&#26681;&#25454; group &#37197;&#32622;&#20915;&#23450; doRefer &#31532;&#19968;&#20010;&#21442;&#25968;&#30340;&#31867;&#22411;&#12290;&#36825;&#37324;&#30340;&#37325;&#28857;&#26159; doRefer &#26041;&#27861;&#65292;&#22914;&#19979;&#65306;
  </span>
 </p>
 <p class="ne-p" id="u7189247a">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="a0a87a7c">private &lt;T&gt; Invoker&lt;T&gt; doRefer(Cluster cluster, Registry registry, Class&lt;T&gt; type, URL url) {
    // &#21019;&#24314; RegistryDirectory &#23454;&#20363;
    RegistryDirectory&lt;T&gt; directory = new RegistryDirectory&lt;T&gt;(type, url);
    // &#35774;&#32622;&#27880;&#20876;&#20013;&#24515;&#21644;&#21327;&#35758;
    directory.setRegistry(registry);
    directory.setProtocol(protocol);
    Map&lt;String, String&gt; parameters = new HashMap&lt;String, String&gt;(directory.getUrl().getParameters());
    // &#29983;&#25104;&#26381;&#21153;&#28040;&#36153;&#32773;&#38142;&#25509;
    URL subscribeUrl = new URL(Constants.CONSUMER_PROTOCOL, parameters.remove(Constants.REGISTER_IP_KEY), 0, type.getName(), parameters);

    // &#27880;&#20876;&#26381;&#21153;&#28040;&#36153;&#32773;&#65292;&#22312; consumers &#30446;&#24405;&#19979;&#26032;&#33410;&#28857;
    if (!Constants.ANY_VALUE.equals(url.getServiceInterface())
            &amp;&amp; url.getParameter(Constants.REGISTER_KEY, true)) {
        registry.register(subscribeUrl.addParameters(Constants.CATEGORY_KEY, Constants.CONSUMERS_CATEGORY,
                Constants.CHECK_KEY, String.valueOf(false)));
    }

    // &#35746;&#38405; providers&#12289;configurators&#12289;routers &#31561;&#33410;&#28857;&#25968;&#25454;
    directory.subscribe(subscribeUrl.addParameter(Constants.CATEGORY_KEY,
            Constants.PROVIDERS_CATEGORY
                    + "," + Constants.CONFIGURATORS_CATEGORY
                    + "," + Constants.ROUTERS_CATEGORY));

    // &#19968;&#20010;&#27880;&#20876;&#20013;&#24515;&#21487;&#33021;&#26377;&#22810;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#65292;&#22240;&#27492;&#36825;&#37324;&#38656;&#35201;&#23558;&#22810;&#20010;&#26381;&#21153;&#25552;&#20379;&#32773;&#21512;&#24182;&#20026;&#19968;&#20010;
    Invoker invoker = cluster.join(directory);
    ProviderConsumerRegTable.registerConsumer(invoker, url, subscribeUrl, directory);
    return invoker;
}</pre>
 <p class="ne-p" id="u17d5a1a5">
  <br>
 </p>
 <p class="ne-p" id="ua7c0ede5">
  <span class="ne-text">
   &#22914;&#19978;&#65292;doRefer &#26041;&#27861;&#21019;&#24314;&#19968;&#20010; RegistryDirectory &#23454;&#20363;&#65292;&#28982;&#21518;&#29983;&#25104;&#26381;&#21153;&#32773;&#28040;&#36153;&#32773;&#38142;&#25509;&#65292;&#24182;&#21521;&#27880;&#20876;&#20013;&#24515;&#36827;&#34892;&#27880;&#20876;&#12290;&#27880;&#20876;&#23436;&#27605;&#21518;&#65292;&#32039;&#25509;&#30528;&#35746;&#38405; providers&#12289;configurators&#12289;routers &#31561;&#33410;&#28857;&#19979;&#30340;&#25968;&#25454;&#12290;&#23436;&#25104;&#35746;&#38405;&#21518;&#65292;RegistryDirectory &#20250;&#25910;&#21040;&#36825;&#20960;&#20010;&#33410;&#28857;&#19979;&#30340;&#23376;&#33410;&#28857;&#20449;&#24687;&#12290;&#30001;&#20110;&#19968;&#20010;&#26381;&#21153;&#21487;&#33021;&#37096;&#32626;&#22312;&#22810;&#21488;&#26381;&#21153;&#22120;&#19978;&#65292;&#36825;&#26679;&#23601;&#20250;&#22312; providers &#20135;&#29983;&#22810;&#20010;&#33410;&#28857;&#65292;&#36825;&#20010;&#26102;&#20505;&#23601;&#38656;&#35201; Cluster &#23558;&#22810;&#20010;&#26381;&#21153;&#33410;&#28857;&#21512;&#24182;&#20026;&#19968;&#20010;&#65292;&#24182;&#29983;&#25104;&#19968;&#20010; Invoker&#12290;&#20851;&#20110; RegistryDirectory &#21644; Cluster&#65292;&#26412;&#25991;&#19981;&#25171;&#31639;&#36827;&#34892;&#20998;&#26512;&#65292;&#30456;&#20851;&#20998;&#26512;&#23558;&#20250;&#22312;&#38543;&#21518;&#30340;&#25991;&#31456;&#20013;&#23637;&#24320;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ub7581495">
  <br>
 </p>
 <h4 id="135c7d61">
  <span class="ne-text">
   3.2.2 &#21019;&#24314;&#20195;&#29702;
  </span>
 </h4>
 <p class="ne-p" id="u0f911864">
  <br>
 </p>
 <p class="ne-p" id="u4a07f6da">
  <span class="ne-text">
   Invoker &#21019;&#24314;&#23436;&#27605;&#21518;&#65292;&#25509;&#19979;&#26469;&#35201;&#20570;&#30340;&#20107;&#24773;&#26159;&#20026;&#26381;&#21153;&#25509;&#21475;&#29983;&#25104;&#20195;&#29702;&#23545;&#35937;&#12290;&#26377;&#20102;&#20195;&#29702;&#23545;&#35937;&#65292;&#21363;&#21487;&#36827;&#34892;&#36828;&#31243;&#35843;&#29992;&#12290;&#20195;&#29702;&#23545;&#35937;&#29983;&#25104;&#30340;&#20837;&#21475;&#26041;&#27861;&#20026; ProxyFactory &#30340; getProxy&#65292;&#25509;&#19979;&#26469;&#36827;&#34892;&#20998;&#26512;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u5853b232">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="85a5d30f">public &lt;T&gt; T getProxy(Invoker&lt;T&gt; invoker) throws RpcException {
    // &#35843;&#29992;&#37325;&#36733;&#26041;&#27861;
    return getProxy(invoker, false);
}

public &lt;T&gt; T getProxy(Invoker&lt;T&gt; invoker, boolean generic) throws RpcException {
    Class&lt;?&gt;[] interfaces = null;
    // &#33719;&#21462;&#25509;&#21475;&#21015;&#34920;
    String config = invoker.getUrl().getParameter("interfaces");
    if (config != null &amp;&amp; config.length() &gt; 0) {
        // &#20999;&#20998;&#25509;&#21475;&#21015;&#34920;
        String[] types = Constants.COMMA_SPLIT_PATTERN.split(config);
        if (types != null &amp;&amp; types.length &gt; 0) {
            interfaces = new Class&lt;?&gt;[types.length + 2];
            // &#35774;&#32622;&#26381;&#21153;&#25509;&#21475;&#31867;&#21644; EchoService.class &#21040; interfaces &#20013;
            interfaces[0] = invoker.getInterface();
            interfaces[1] = EchoService.class;
            for (int i = 0; i &lt; types.length; i++) {
                // &#21152;&#36733;&#25509;&#21475;&#31867;
                interfaces[i + 1] = ReflectUtils.forName(types[i]);
            }
        }
    }
    if (interfaces == null) {
        interfaces = new Class&lt;?&gt;[]{invoker.getInterface(), EchoService.class};
    }

    // &#20026; http &#21644; hessian &#21327;&#35758;&#25552;&#20379;&#27867;&#21270;&#35843;&#29992;&#25903;&#25345;&#65292;&#21442;&#32771; pull request #1827
    if (!invoker.getInterface().equals(GenericService.class) &amp;&amp; generic) {
        int len = interfaces.length;
        Class&lt;?&gt;[] temp = interfaces;
        // &#21019;&#24314;&#26032;&#30340; interfaces &#25968;&#32452;
        interfaces = new Class&lt;?&gt;[len + 1];
        System.arraycopy(temp, 0, interfaces, 0, len);
        // &#35774;&#32622; GenericService.class &#21040;&#25968;&#32452;&#20013;
        interfaces[len] = GenericService.class;
    }

    // &#35843;&#29992;&#37325;&#36733;&#26041;&#27861;
    return getProxy(invoker, interfaces);
}

public abstract &lt;T&gt; T getProxy(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] types);</pre>
 <p class="ne-p" id="ua3189e55">
  <br>
 </p>
 <p class="ne-p" id="uc1bb29b4">
  <span class="ne-text">
   &#22914;&#19978;&#65292;&#19978;&#38754;&#22823;&#27573;&#20195;&#30721;&#37117;&#26159;&#29992;&#26469;&#33719;&#21462; interfaces &#25968;&#32452;&#30340;&#65292;&#25105;&#20204;&#32487;&#32493;&#24448;&#19979;&#30475;&#12290;getProxy(Invoker, Class&lt;?&gt;[]) &#36825;&#20010;&#26041;&#27861;&#26159;&#19968;&#20010;&#25277;&#35937;&#26041;&#27861;&#65292;&#19979;&#38754;&#25105;&#20204;&#21040; JavassistProxyFactory &#31867;&#20013;&#30475;&#19968;&#19979;&#35813;&#26041;&#27861;&#30340;&#23454;&#29616;&#20195;&#30721;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u43425a7b">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="46e7306d">public &lt;T&gt; T getProxy(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces) {
    // &#29983;&#25104; Proxy &#23376;&#31867;&#65288;Proxy &#26159;&#25277;&#35937;&#31867;&#65289;&#12290;&#24182;&#35843;&#29992; Proxy &#23376;&#31867;&#30340; newInstance &#26041;&#27861;&#21019;&#24314; Proxy &#23454;&#20363;
    return (T) Proxy.getProxy(interfaces).newInstance(new InvokerInvocationHandler(invoker));
}</pre>
 <p class="ne-p" id="u2f847c41">
  <br>
 </p>
 <p class="ne-p" id="u6cc88292">
  <span class="ne-text">
   &#19978;&#38754;&#20195;&#30721;&#24182;&#19981;&#22810;&#65292;&#39318;&#20808;&#26159;&#36890;&#36807; Proxy &#30340; getProxy &#26041;&#27861;&#33719;&#21462; Proxy &#23376;&#31867;&#65292;&#28982;&#21518;&#21019;&#24314; InvokerInvocationHandler &#23545;&#35937;&#65292;&#24182;&#23558;&#35813;&#23545;&#35937;&#20256;&#32473; newInstance &#29983;&#25104; Proxy &#23454;&#20363;&#12290;InvokerInvocationHandler &#23454;&#29616; JDK &#30340; InvocationHandler &#25509;&#21475;&#65292;&#20855;&#20307;&#30340;&#29992;&#36884;&#26159;&#25318;&#25130;&#25509;&#21475;&#31867;&#35843;&#29992;&#12290;&#35813;&#31867;&#36923;&#36753;&#27604;&#36739;&#31616;&#21333;&#65292;&#36825;&#37324;&#23601;&#19981;&#20998;&#26512;&#20102;&#12290;&#19979;&#38754;&#25105;&#20204;&#37325;&#28857;&#20851;&#27880;&#19968;&#19979; Proxy &#30340; getProxy &#26041;&#27861;&#65292;&#22914;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="ua41f02a6">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="284476e1">public static Proxy getProxy(Class&lt;?&gt;... ics) {
    // &#35843;&#29992;&#37325;&#36733;&#26041;&#27861;
    return getProxy(ClassHelper.getClassLoader(Proxy.class), ics);
}

public static Proxy getProxy(ClassLoader cl, Class&lt;?&gt;... ics) {
    if (ics.length &gt; 65535)
        throw new IllegalArgumentException("interface limit exceeded");

    StringBuilder sb = new StringBuilder();
    // &#36941;&#21382;&#25509;&#21475;&#21015;&#34920;
    for (int i = 0; i &lt; ics.length; i++) {
        String itf = ics[i].getName();
        // &#26816;&#27979;&#31867;&#22411;&#26159;&#21542;&#20026;&#25509;&#21475;
        if (!ics[i].isInterface())
            throw new RuntimeException(itf + " is not a interface.");

        Class&lt;?&gt; tmp = null;
        try {
            // &#37325;&#26032;&#21152;&#36733;&#25509;&#21475;&#31867;
            tmp = Class.forName(itf, false, cl);
        } catch (ClassNotFoundException e) {
        }

        // &#26816;&#27979;&#25509;&#21475;&#26159;&#21542;&#30456;&#21516;&#65292;&#36825;&#37324; tmp &#26377;&#21487;&#33021;&#20026;&#31354;
        if (tmp != ics[i])
            throw new IllegalArgumentException(ics[i] + " is not visible from class loader");

        // &#25340;&#25509;&#25509;&#21475;&#20840;&#38480;&#23450;&#21517;&#65292;&#20998;&#38548;&#31526;&#20026; ;
        sb.append(itf).append(';');
    }

    // &#20351;&#29992;&#25340;&#25509;&#21518;&#30340;&#25509;&#21475;&#21517;&#20316;&#20026; key
    String key = sb.toString();

    Map&lt;String, Object&gt; cache;
    synchronized (ProxyCacheMap) {
        cache = ProxyCacheMap.get(cl);
        if (cache == null) {
            cache = new HashMap&lt;String, Object&gt;();
            ProxyCacheMap.put(cl, cache);
        }
    }

    Proxy proxy = null;
    synchronized (cache) {
        do {
            // &#20174;&#32531;&#23384;&#20013;&#33719;&#21462; Reference&lt;Proxy&gt; &#23454;&#20363;
            Object value = cache.get(key);
            if (value instanceof Reference&lt;?&gt;) {
                proxy = (Proxy) ((Reference&lt;?&gt;) value).get();
                if (proxy != null) {
                    return proxy;
                }
            }

            // &#24182;&#21457;&#25511;&#21046;&#65292;&#20445;&#35777;&#21482;&#26377;&#19968;&#20010;&#32447;&#31243;&#21487;&#20197;&#36827;&#34892;&#21518;&#32493;&#25805;&#20316;
            if (value == PendingGenerationMarker) {
                try {
                    // &#20854;&#20182;&#32447;&#31243;&#22312;&#27492;&#22788;&#36827;&#34892;&#31561;&#24453;
                    cache.wait();
                } catch (InterruptedException e) {
                }
            } else {
                // &#25918;&#32622;&#26631;&#24535;&#20301;&#21040;&#32531;&#23384;&#20013;&#65292;&#24182;&#36339;&#20986; while &#24490;&#29615;&#36827;&#34892;&#21518;&#32493;&#25805;&#20316;
                cache.put(key, PendingGenerationMarker);
                break;
            }
        }
        while (true);
    }

    long id = PROXY_CLASS_COUNTER.getAndIncrement();
    String pkg = null;
    ClassGenerator ccp = null, ccm = null;
    try {
        // &#21019;&#24314; ClassGenerator &#23545;&#35937;
        ccp = ClassGenerator.newInstance(cl);

        Set&lt;String&gt; worked = new HashSet&lt;String&gt;();
        List&lt;Method&gt; methods = new ArrayList&lt;Method&gt;();

        for (int i = 0; i &lt; ics.length; i++) {
            // &#26816;&#27979;&#25509;&#21475;&#35775;&#38382;&#32423;&#21035;&#26159;&#21542;&#20026; protected &#25110; private
            if (!Modifier.isPublic(ics[i].getModifiers())) {
                // &#33719;&#21462;&#25509;&#21475;&#21253;&#21517;
                String npkg = ics[i].getPackage().getName();
                if (pkg == null) {
                    pkg = npkg;
                } else {
                    if (!pkg.equals(npkg))
                        // &#38750; public &#32423;&#21035;&#30340;&#25509;&#21475;&#24517;&#39035;&#22312;&#21516;&#19968;&#20010;&#21253;&#19979;&#65292;&#21542;&#32773;&#25243;&#20986;&#24322;&#24120;
                        throw new IllegalArgumentException("non-public interfaces from different packages");
                }
            }
            
            // &#28155;&#21152;&#25509;&#21475;&#21040; ClassGenerator &#20013;
            ccp.addInterface(ics[i]);

            // &#36941;&#21382;&#25509;&#21475;&#26041;&#27861;
            for (Method method : ics[i].getMethods()) {
                // &#33719;&#21462;&#26041;&#27861;&#25551;&#36848;&#65292;&#21487;&#29702;&#35299;&#20026;&#26041;&#27861;&#31614;&#21517;
                String desc = ReflectUtils.getDesc(method);
                // &#22914;&#26524;&#26041;&#27861;&#25551;&#36848;&#23383;&#31526;&#20018;&#24050;&#22312; worked &#20013;&#65292;&#21017;&#24573;&#30053;&#12290;&#32771;&#34385;&#36825;&#31181;&#24773;&#20917;&#65292;
                // A &#25509;&#21475;&#21644; B &#25509;&#21475;&#20013;&#21253;&#21547;&#19968;&#20010;&#23436;&#20840;&#30456;&#21516;&#30340;&#26041;&#27861;
                if (worked.contains(desc))
                    continue;
                worked.add(desc);

                int ix = methods.size();
                // &#33719;&#21462;&#26041;&#27861;&#36820;&#22238;&#20540;&#31867;&#22411;
                Class&lt;?&gt; rt = method.getReturnType();
                // &#33719;&#21462;&#21442;&#25968;&#21015;&#34920;
                Class&lt;?&gt;[] pts = method.getParameterTypes();

                // &#29983;&#25104; Object[] args = new Object[1...N]
                StringBuilder code = new StringBuilder("Object[] args = new Object[").append(pts.length).append("];");
                for (int j = 0; j &lt; pts.length; j++)
                    // &#29983;&#25104; args[1...N] = ($w)$1...N;
                    code.append(" args[").append(j).append("] = ($w)$").append(j + 1).append(";");
                // &#29983;&#25104; InvokerHandler &#25509;&#21475;&#30340; invoker &#26041;&#27861;&#35843;&#29992;&#35821;&#21477;&#65292;&#22914;&#19979;&#65306;
                // Object ret = handler.invoke(this, methods[1...N], args);
                code.append(" Object ret = handler.invoke(this, methods[" + ix + "], args);");

                // &#36820;&#22238;&#20540;&#19981;&#20026; void
                if (!Void.TYPE.equals(rt))
                    // &#29983;&#25104;&#36820;&#22238;&#35821;&#21477;&#65292;&#24418;&#22914; return (java.lang.String) ret;
                    code.append(" return ").append(asArgument(rt, "ret")).append(";");

                methods.add(method);
                // &#28155;&#21152;&#26041;&#27861;&#21517;&#12289;&#35775;&#38382;&#25511;&#21046;&#31526;&#12289;&#21442;&#25968;&#21015;&#34920;&#12289;&#26041;&#27861;&#20195;&#30721;&#31561;&#20449;&#24687;&#21040; ClassGenerator &#20013; 
                ccp.addMethod(method.getName(), method.getModifiers(), rt, pts, method.getExceptionTypes(), code.toString());
            }
        }

        if (pkg == null)
            pkg = PACKAGE_NAME;

        // &#26500;&#24314;&#25509;&#21475;&#20195;&#29702;&#31867;&#21517;&#31216;&#65306;pkg + ".proxy" + id&#65292;&#27604;&#22914; org.apache.dubbo.proxy0
        String pcn = pkg + ".proxy" + id;
        ccp.setClassName(pcn);
        ccp.addField("public static java.lang.reflect.Method[] methods;");
        // &#29983;&#25104; private java.lang.reflect.InvocationHandler handler;
        ccp.addField("private " + InvocationHandler.class.getName() + " handler;");

        // &#20026;&#25509;&#21475;&#20195;&#29702;&#31867;&#28155;&#21152;&#24102;&#26377; InvocationHandler &#21442;&#25968;&#30340;&#26500;&#36896;&#26041;&#27861;&#65292;&#27604;&#22914;&#65306;
        // porxy0(java.lang.reflect.InvocationHandler arg0) {
        //     handler=$1;
    	// }
        ccp.addConstructor(Modifier.PUBLIC, new Class&lt;?&gt;[]{InvocationHandler.class}, new Class&lt;?&gt;[0], "handler=$1;");
        // &#20026;&#25509;&#21475;&#20195;&#29702;&#31867;&#28155;&#21152;&#40664;&#35748;&#26500;&#36896;&#26041;&#27861;
        ccp.addDefaultConstructor();
        
        // &#29983;&#25104;&#25509;&#21475;&#20195;&#29702;&#31867;
        Class&lt;?&gt; clazz = ccp.toClass();
        clazz.getField("methods").set(null, methods.toArray(new Method[0]));

        // &#26500;&#24314; Proxy &#23376;&#31867;&#21517;&#31216;&#65292;&#27604;&#22914; Proxy1&#65292;Proxy2 &#31561;
        String fcn = Proxy.class.getName() + id;
        ccm = ClassGenerator.newInstance(cl);
        ccm.setClassName(fcn);
        ccm.addDefaultConstructor();
        ccm.setSuperClass(Proxy.class);
        // &#20026; Proxy &#30340;&#25277;&#35937;&#26041;&#27861; newInstance &#29983;&#25104;&#23454;&#29616;&#20195;&#30721;&#65292;&#24418;&#22914;&#65306;
        // public Object newInstance(java.lang.reflect.InvocationHandler h) { 
        //     return new org.apache.dubbo.proxy0($1);
        // }
        ccm.addMethod("public Object newInstance(" + InvocationHandler.class.getName() + " h){ return new " + pcn + "($1); }");
        // &#29983;&#25104; Proxy &#23454;&#29616;&#31867;
        Class&lt;?&gt; pc = ccm.toClass();
        // &#36890;&#36807;&#21453;&#23556;&#21019;&#24314; Proxy &#23454;&#20363;
        proxy = (Proxy) pc.newInstance();
    } catch (RuntimeException e) {
        throw e;
    } catch (Exception e) {
        throw new RuntimeException(e.getMessage(), e);
    } finally {
        if (ccp != null)
            // &#37322;&#25918;&#36164;&#28304;
            ccp.release();
        if (ccm != null)
            ccm.release();
        synchronized (cache) {
            if (proxy == null)
                cache.remove(key);
            else
                // &#20889;&#32531;&#23384;
                cache.put(key, new WeakReference&lt;Proxy&gt;(proxy));
            // &#21796;&#37266;&#20854;&#20182;&#31561;&#24453;&#32447;&#31243;
            cache.notifyAll();
        }
    }
    return proxy;
}</pre>
 <p class="ne-p" id="u0cb8ed66">
  <br>
 </p>
 <p class="ne-p" id="u5d22aa59">
  <span class="ne-text">
   &#19978;&#38754;&#20195;&#30721;&#27604;&#36739;&#22797;&#26434;&#65292;&#25105;&#20204;&#20889;&#20102;&#22823;&#37327;&#30340;&#27880;&#37322;&#12290;&#22823;&#23478;&#22312;&#38405;&#35835;&#36825;&#27573;&#20195;&#30721;&#26102;&#65292;&#35201;&#25630;&#28165;&#26970; ccp &#21644; ccm &#30340;&#29992;&#36884;&#65292;&#19981;&#28982;&#20250;&#34987;&#25630;&#26197;&#12290;ccp &#29992;&#20110;&#20026;&#26381;&#21153;&#25509;&#21475;&#29983;&#25104;&#20195;&#29702;&#31867;&#65292;&#27604;&#22914;&#25105;&#20204;&#26377;&#19968;&#20010; DemoService &#25509;&#21475;&#65292;&#36825;&#20010;&#25509;&#21475;&#20195;&#29702;&#31867;&#23601;&#26159;&#30001; ccp &#29983;&#25104;&#30340;&#12290;ccm &#21017;&#26159;&#29992;&#20110;&#20026; org.apache.dubbo.common.bytecode.Proxy &#25277;&#35937;&#31867;&#29983;&#25104;&#23376;&#31867;&#65292;&#20027;&#35201;&#26159;&#23454;&#29616; Proxy &#31867;&#30340;&#25277;&#35937;&#26041;&#27861;&#12290;&#19979;&#38754;&#20197; org.apache.dubbo.demo.DemoService &#36825;&#20010;&#25509;&#21475;&#20026;&#20363;&#65292;&#26469;&#30475;&#19968;&#19979;&#35813;&#25509;&#21475;&#20195;&#29702;&#31867;&#20195;&#30721;&#22823;&#33268;&#26159;&#24590;&#26679;&#30340;&#65288;&#24573;&#30053; EchoService &#25509;&#21475;&#65289;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u6d0ee43c">
  <br>
 </p>
 <pre class="ne-codeblock language-java" data-language="java" id="aa03738e">package org.apache.dubbo.common.bytecode;

public class proxy0 implements org.apache.dubbo.demo.DemoService {

    public static java.lang.reflect.Method[] methods;

    private java.lang.reflect.InvocationHandler handler;

    public proxy0() {
    }

    public proxy0(java.lang.reflect.InvocationHandler arg0) {
        handler = $1;
    }

    public java.lang.String sayHello(java.lang.String arg0) {
        Object[] args = new Object[1];
        args[0] = ($w) $1;
        Object ret = handler.invoke(this, methods[0], args);
        return (java.lang.String) ret;
    }
}</pre>
 <p class="ne-p" id="u6696fdc3">
  <br>
 </p>
 <p class="ne-p" id="u62e2117c">
  <span class="ne-text">
   &#22909;&#20102;&#65292;&#21040;&#36825;&#37324;&#20195;&#29702;&#31867;&#29983;&#25104;&#36923;&#36753;&#23601;&#20998;&#26512;&#23436;&#20102;&#12290;&#25972;&#20010;&#36807;&#31243;&#27604;&#36739;&#22797;&#26434;&#65292;&#22823;&#23478;&#38656;&#35201;&#32784;&#24515;&#30475;&#19968;&#19979;&#12290;
  </span>
 </p>
 <p class="ne-p" id="u0ec389cc">
  <br>
 </p>
 <h2 id="76304aaf">
  <span class="ne-text">
   4.&#24635;&#32467;
  </span>
 </h2>
 <p class="ne-p" id="u6b46b7f5">
  <br>
 </p>
 <p class="ne-p" id="u67a94a3b">
  <span class="ne-text">
   &#26412;&#31687;&#25991;&#31456;&#23545;&#26381;&#21153;&#24341;&#29992;&#30340;&#36807;&#31243;&#36827;&#34892;&#20102;&#36739;&#20026;&#35814;&#23613;&#30340;&#20998;&#26512;&#65292;&#36824;&#26377;&#19968;&#20123;&#36923;&#36753;&#26242;&#26102;&#27809;&#26377;&#20998;&#26512;&#21040;&#65292;&#27604;&#22914; Directory&#12289;Cluster&#12290;&#36825;&#20123;&#25509;&#21475;&#21450;&#23454;&#29616;&#31867;&#21151;&#33021;&#27604;&#36739;&#29420;&#31435;&#65292;&#21518;&#32493;&#20250;&#21333;&#29420;&#25104;&#25991;&#36827;&#34892;&#20998;&#26512;&#12290;&#26242;&#26102;&#25105;&#20204;&#21487;&#20197;&#20808;&#25226;&#36825;&#20123;&#31867;&#30475;&#25104;&#40657;&#30418;&#65292;&#21482;&#35201;&#30693;&#36947;&#36825;&#20123;&#31867;&#30340;&#29992;&#36884;&#21363;&#21487;&#12290;&#20851;&#20110;&#26381;&#21153;&#24341;&#29992;&#36807;&#31243;&#23601;&#20998;&#26512;&#21040;&#36825;&#37324;&#12290;
  </span>
 </p>
</div>
</div>
</div>

        </body>
        
        